Bridge.assembly("CirnoGame",function($asm,globals){"use strict";Bridge.define("CirnoGame.GameMode",{statics:{fields:{TeamBattle:null,DeathMatch:null,gameModes:null},ctors:{init:function(){Bridge.ready(this.init)}},methods:{GetGameModesOfType:function(t){return new(System.Collections.Generic.List$1(CirnoGame.GameMode))(System.Linq.Enumerable.from(CirnoGame.GameMode.gameModes).where(function(e){return e.ModeType===t}))},GetGameModeByName:function(t){var e=new(System.Collections.Generic.List$1(CirnoGame.GameMode))(System.Linq.Enumerable.from(CirnoGame.GameMode.gameModes).where(function(e){return Bridge.referenceEquals(e.Name,t)}));return e.Count>0?e.getItem(0):null},init:function(){null==CirnoGame.GameMode.TeamBattle&&(CirnoGame.GameMode.gameModes=new(System.Collections.Generic.List$1(CirnoGame.GameMode)),CirnoGame.GameMode.TeamBattle=new CirnoGame.GameMode("Team Battle"),CirnoGame.GameMode.TeamBattle.Description="2 teams battle with limited lives\nuntil only 1 team remains.",CirnoGame.GameMode.DeathMatch=new CirnoGame.GameMode("Death Match"),CirnoGame.GameMode.DeathMatch.Description="A free for all match with\nlimited lives.",CirnoGame.GameMode.DeathMatch.Teams=!1)}}},$entryPoint:!0,props:{Teams:!1,StartingLives:0,Survival:!1,AllowOnlinePlay:!1,AllowCharacterSelect:!1,NumberOfPlayers:0,RespawnTime:0,Name:null,ModeType:0,unlocked:!1,Description:null},ctors:{ctor:function(t){this.$initialize(),this.Teams=!0,this.StartingLives=3,this.Survival=!0,this.AllowOnlinePlay=!0,this.AllowCharacterSelect=!0,this.NumberOfPlayers=6,this.RespawnTime=390,this.Name=t,this.ModeType=CirnoGame.GameMode.ModeTypes.Skirmish,this.Description=System.String.concat("Missing description for ",t),this.unlocked=!0,CirnoGame.GameMode.gameModes.add(this)}}}),Bridge.define("CirnoGame.EntityBehavior",{fields:{enabled:!1,FramesPerTick:0,entity:null},props:{BehaviorName:null},ctors:{init:function(){this.enabled=!0,this.FramesPerTick=0},ctor:function(t){if(this.$initialize(),this.entity=t,Bridge.referenceEquals(this.BehaviorName,"")||null==this.BehaviorName){var e=Bridge.getType(this),i=e.$$fullname;console.log(System.String.concat("FN:",i));var n=i.split(".");this.BehaviorName=n[System.Array.index(n.length-1|0,n)]}}},methods:{Update:function(){},Draw:function(t){},SendCustomEvent:function(t,e){void 0===e&&(e=!1);var i={};i.I=this.entity.ID,i.D=t,i.T=this.BehaviorName,this.entity.Game.SendEvent("CBE",i,e)},CustomEvent:function(t){}}}),Bridge.define("CirnoGame.Animation",{fields:{Images:null,_currentImage:null,CurrentFrame:0,ImageSpeed:0,Position:null,AnimationTimeElapsed:0,StretchWidth:0,StretchHeight:0,Rotation:0,Alpha:0,Looping:!1,Looped:!1,FrameChanged:!1,Flipped:!1,_transformed:!1,_shadow:0,_shadowColor:null,BufferNeedsRedraw:!1,_hueColor:null,_hueRecolorStrength:0,_buffer:null,_bg:null},props:{CurrentImage:{get:function(){return this._currentImage},set:function(t){Bridge.referenceEquals(this._currentImage,t)||(this.BufferNeedsRedraw=!0),this._currentImage=t}},X:{get:function(){return this.Position.X},set:function(t){this.Position.X=t}},Y:{get:function(){return this.Position.Y},set:function(t){this.Position.Y=t}},Shadow:{get:function(){return this._shadow},set:function(t){this._shadow!==t&&(this._shadow=t,this.BufferNeedsRedraw=!0)}},Shadowcolor:{get:function(){return this._shadowColor},set:function(t){Bridge.referenceEquals(this._shadowColor,t)||(this._shadowColor=t,this.BufferNeedsRedraw=!0)}},HueColor:{get:function(){return this._hueColor},set:function(t){Bridge.referenceEquals(this._hueColor,t)||(this.BufferNeedsRedraw=!0),this._hueColor=t}},HueRecolorStrength:{get:function(){return this._hueRecolorStrength},set:function(t){this._hueRecolorStrength!==t&&(this.BufferNeedsRedraw=!0),this._hueRecolorStrength=t}}},ctors:{init:function(){this.StretchWidth=0,this.StretchHeight=0,this.Rotation=0,this.Alpha=1,this.Looping=!0,this.Looped=!1,this.FrameChanged=!1,this.Flipped=!1,this._transformed=!1,this.BufferNeedsRedraw=!0},ctor:function(t){this.$initialize(),this.Images=t,null==this.Images&&(this.Images=new(System.Collections.Generic.List$1(HTMLImageElement))),this.ImageSpeed=1,this.Position=new CirnoGame.Vector2,this.AnimationTimeElapsed=0,this.Shadow=0,this.Shadowcolor="#FFFFFF",this.HueColor="",this.HueRecolorStrength=.6,this._buffer=document.createElement("canvas"),this._bg=this._buffer.getContext("2d"),this.Images.Count>0&&this.SetImage()}},methods:{Update:function(){var t=this.CurrentImage,e=Bridge.Int.clip32(this.CurrentFrame);this.CurrentFrame+=this.ImageSpeed;var i=Bridge.Int.clip32(this.CurrentFrame);if(i!==e){if(this.Images.Count>0){for(;i>=this.Images.Count&&i>0;)this.Looping?(i=i-this.Images.Count|0,this.CurrentFrame-=this.Images.Count):this.CurrentFrame-=this.ImageSpeed;for(;0>i;)i=i+this.Images.Count|0,this.CurrentFrame+=this.Images.Count}this.SetImage()}this.Looped=!1,Bridge.referenceEquals(t,this.CurrentImage)?this.FrameChanged=!1:(this.FrameChanged=!0,(this.ImageSpeed>0&&0===i||this.ImageSpeed<0&&i===(this.Images.Count-1|0))&&(this.Looped=!0)),this.AnimationTimeElapsed=this.AnimationTimeElapsed+1|0},ChangeAnimation:function(t,e){void 0===e&&(e=!0),e&&(this.CurrentFrame=0,this.AnimationTimeElapsed=0),this.Images=t,this.SetImage()},SetImage:function(){if(this.Images.Count<2)this.CurrentFrame=0;else{for(var t=this.Images.Count;this.CurrentFrame<0;)this.CurrentFrame+=t;for(;this.CurrentFrame>=t;)this.CurrentFrame-=t}var e=Bridge.Int.clip32(this.CurrentFrame);e>=0&&e<this.Images.Count&&(this.CurrentImage=this.Images.getItem(e))},Draw:function(t){this.Draw$1(t,this.Position)},Draw$1:function(t,e){var i=e.X,n=e.Y;if(null==this.CurrentImage){var r=Bridge.Int.clip32(this.CurrentFrame);if(r>=0&&r<this.Images.Count&&(this.CurrentImage=this.Images.getItem(r)),null==this.CurrentImage)return}var o=i,a=n,s=t.globalAlpha,h=!1,l=!1;if(!Bridge.referenceEquals(this.HueColor,"")){if(this.BufferNeedsRedraw){var m=!0;this._bg.globalCompositeOperation="source-over",this._buffer.width=this.CurrentImage.width,this._buffer.height=this.CurrentImage.height,this._bg.drawImage(this.CurrentImage,0,0),this._bg.globalAlpha=this.HueRecolorStrength,this._bg.globalCompositeOperation="hue",this._bg.fillStyle=this.HueColor,this._bg.fillRect(0,0,this._buffer.width,this._buffer.height),m&&(this._bg.globalAlpha=(1+this.HueRecolorStrength)/2,this._bg.globalCompositeOperation="source-over",this._bg.fillRect(0,0,this._buffer.width,this._buffer.height)),this._bg.globalAlpha=1,m&&(this._bg.globalCompositeOperation="luminosity",this._bg.drawImage(this.CurrentImage,0,0)),this._bg.globalCompositeOperation="destination-in",this._bg.drawImage(this.CurrentImage,0,0),m&&(this._bg.globalCompositeOperation="hue",this._bg.globalAlpha=.4*this.HueRecolorStrength,this._bg.drawImage(this.CurrentImage,0,0))}l=!0}if(this.Alpha<1){if(this.Alpha<=0)return;t.globalAlpha=t.globalAlpha*this.Alpha}var d=this.CurrentImage.width/2,u=this.CurrentImage.height/2;if(o=-d,a=-u,this._transformed||(t.save(),this._transformed=!0),t.translate(i+d,n+u),h=!0,t.rotate(this.Rotation),this.Flipped&&(this._transformed||(t.save(),this._transformed=!0),t.scale(-1,1),h||t.translate(this.CurrentImage.width,0)),this.Shadow>0){if(t.shadowBlur=this.Shadow,t.shadowColor=this.Shadowcolor,!l&&this.BufferNeedsRedraw&&(this._bg.shadowBlur=0,this._buffer.width=this.CurrentImage.width,this._buffer.height=this.CurrentImage.height,this._bg.drawImage(this.CurrentImage,0,0),l=!0),l=!0,this.BufferNeedsRedraw){var c=CirnoGame.Helper.CloneCanvas(this._buffer);CirnoGame.Helper.GetContext(c);this._buffer.width=this._buffer.width+Bridge.Int.clip32(2*this.Shadow)|0,this._buffer.height=this._buffer.height+Bridge.Int.clip32(2*this.Shadow)|0,this._bg.shadowBlur=this.Shadow,this._bg.shadowColor=this.Shadowcolor,this.drawWithShadows(this._bg,c,this.Shadow,this.Shadow,0,0,this.Shadow/3),l=!0}o-=this.Shadow,a-=this.Shadow,t.shadowBlur=0}if(0===this.StretchWidth&&0===this.StretchHeight)if(this.Shadow>0,1)l?t.drawImage(this._buffer,o,a):t.drawImage(this.CurrentImage,o,a);else{var p=this.CurrentImage;l&&(p=this._buffer),this.drawWithShadows(t,p,o,a,0,0,this.Shadow/3)}else if(this.Shadow>0,1)l?t.drawImage(this._buffer,o,a,this.StretchWidth,this.StretchHeight):t.drawImage(this.CurrentImage,o,a,this.StretchWidth,this.StretchHeight);else{var C=this.CurrentImage;l&&(C=this._buffer),this.drawWithShadows(t,C,o,a,this.StretchWidth,this.StretchHeight,this.Shadow/3)}this._transformed&&(t.restore(),this._transformed=!1),this.Shadow>0&&(t.shadowBlur=0),this.Alpha<1&&(t.globalAlpha=s),this.BufferNeedsRedraw=!1},drawWithShadows:function(t,e,i,n,r,o,a){0===r&&(r=e.width,o=e.height),t.shadowOffsetX=-a,t.drawImage(e,i,n,r,o),t.shadowOffsetX=a,t.drawImage(e,i,n,r,o),t.shadowOffsetX=0,t.shadowOffsetY=-a,t.drawImage(e,i,n,r,o),t.shadowOffsetY=a,t.drawImage(e,i,n,r,o),t.shadowOffsetY=0}}}),Bridge.define("CirnoGame.AnimationLoader",{statics:{fields:{__this:null},props:{_this:{get:function(){if(null==CirnoGame.AnimationLoader.__this)throw CirnoGame.AnimationLoader.__this=new CirnoGame.AnimationLoader,new System.Exception("Animation loader not initiated.");return CirnoGame.AnimationLoader.__this}}},methods:{Init:function(t){CirnoGame.AnimationLoader.__this=new CirnoGame.AnimationLoader,CirnoGame.AnimationLoader.__this.Archive=t},Get:function(t){return CirnoGame.AnimationLoader._this.GetAnimation(t)}}},fields:{_data:null,Archive:null},ctors:{ctor:function(){this.$initialize(),this._data=new(System.Collections.Generic.Dictionary$2(System.String,System.Collections.Generic.List$1(HTMLImageElement)))}},methods:{GetAnimation:function(t){if(this._data.containsKey(t))return this._data.get(t);var e=new(System.Collections.Generic.List$1(HTMLImageElement)),i=this.Archive.GetImage(System.String.concat(t,".png"));if(null!=i)e.add(i);else for(var n=0,r=System.String.concat(t,"_");;){if(i=this.Archive.GetImage(System.String.concat(r,Bridge.identity(n,n=n+1|0),".png")),null==i)break;e.add(i)}return this._data.set(t,e),e}}}),Bridge.define("CirnoGame.App",{main:function(){document.body.style.cssText="overflow: hidden;margin: 0;padding: 0;",CirnoGame.GamePadManager._this=new CirnoGame.GamePadManager,CirnoGame.GamePadManager._this.Update(),Bridge.global.setTimeout($asm.$.CirnoGame.App.f1,5);var t=!1;CirnoGame.JSONArchive.Open("Assets/Images.JSON",function(e){CirnoGame.App.JSON=e,CirnoGame.App.JSON.PreloadImages(function(){t=!0,CirnoGame.App.Finish()})})},statics:{fields:{Frame:0,Div:null,Canvas:null,ScreenBounds:null,JSON:null,G:null,TargetAspect:0,_lSize:0,_missingTime:0,_lTime:0,_frameRendered:!1,_gameRendered:!1,IC:null,CurrentView:null,GameName:null,GameVersion:null,DEBUG:!1},ctors:{init:function(){this.Frame=0,this._lSize=-1,this._missingTime=0,this._lTime=-1,this._frameRendered=!1,this._gameRendered=!1,this.GameName="Cirno's Mysterious Tower",this.GameVersion="0.1b",this.DEBUG=!1}},methods:{Finish:function(){CirnoGame.AnimationLoader.Init(CirnoGame.App.JSON);var t=document.getElementById("loadtext");t.textContent="",document.body.style.cursor="auto",document.title=System.String.concat(CirnoGame.App.GameName," ",CirnoGame.App.GameVersion," by:RSGmaker"),CirnoGame.App.Div=document.createElement("div");var e=document.createElement("canvas");CirnoGame.App.Canvas=e,CirnoGame.App.TargetAspect=.75,e.width=1024,e.height=Bridge.Int.clip32(e.width*CirnoGame.App.TargetAspect),CirnoGame.App.ScreenBounds=new CirnoGame.Rectangle(0,0,e.width,e.height),CirnoGame.App.Div.appendChild(e),document.body.appendChild(CirnoGame.App.Div),CirnoGame.App.G=CirnoGame.App.Canvas.getContext("2d"),CirnoGame.App.G.imageSmoothingEnabled=!1,CirnoGame.App.Canvas.style.imageRendering="pixelated";var i=CirnoGame.App.G;i.webkitImageSmoothingEnabled=!1,i.mozImageSmoothingEnabled=!1,CirnoGame.KeyboardManager.Init(),CirnoGame.App.CurrentView=new CirnoGame.Game;var n=CirnoGame.App.RAF;requestAnimationFrame(n)},updateWindow:function(){var t=Math.ceil(window.innerHeight*(1/CirnoGame.App.TargetAspect));t!==CirnoGame.App._lSize&&(CirnoGame.App.Canvas.style.width="100%",CirnoGame.App.Div.style.width=System.Double.format(t)+"px",CirnoGame.App.Div.style.position="relative",CirnoGame.App.Div.style.left=System.Double.format((0|Bridge.Int.div(window.innerWidth,2))-t/2)+"px",t=CirnoGame.App._lSize)},UpdateInputs:function(){if(null!=CirnoGame.App.IC){var t=CirnoGame.InputControllerManager._this.Controllers;t.Count>1}CirnoGame.KeyboardManager.Update()},Update:function(t){var e=0;if(t>=0&&(CirnoGame.App._lTime<0&&(CirnoGame.App._lTime=t),e=t-CirnoGame.App._lTime,CirnoGame.App._missingTime+=e,Bridge.is(CirnoGame.App.CurrentView,CirnoGame.Game))){var i=Bridge.cast(CirnoGame.App.CurrentView,CirnoGame.Game);i.running&&(i.totalTime+=e,i.timeRemaining>0&&(i.timeRemaining-=e),i.timeRemaining<=0&&(i.timeRemaining=0))}if(CirnoGame.App.updateWindow(),!(CirnoGame.App._missingTime>12))return void(CirnoGame.App._lTime=t);if(null!=CirnoGame.App.CurrentView&&CirnoGame.App.CurrentView.Update(),CirnoGame.App._missingTime-=16.666666666666668,CirnoGame.App._frameRendered=!1,CirnoGame.App._gameRendered=!1,t>=0){CirnoGame.App._missingTime>=3e3&&(CirnoGame.App._missingTime=0),CirnoGame.App._missingTime>=1e4;var n=16.666666666666668;for(n+=8;CirnoGame.App._missingTime>=n;)null!=CirnoGame.App.CurrentView&&CirnoGame.App.CurrentView.Update(),CirnoGame.App._missingTime-=16.666666666666668}CirnoGame.App._lTime=t,CirnoGame.App.Frame=CirnoGame.App.Frame+1|0,CirnoGame.HelperExtensions.Clear(CirnoGame.App.G),CirnoGame.GamePadManager._this.Update(),null!=CirnoGame.App.CurrentView&&(CirnoGame.App.CurrentView.Update(),CirnoGame.App.CurrentView.Render(),CirnoGame.App.G.drawImage(CirnoGame.App.CurrentView.spriteBuffer,0,0,CirnoGame.App.Canvas.width,CirnoGame.App.Canvas.height)),CirnoGame.App.UpdateInputs()},RAF:function(){var t=CirnoGame.App.RAF;requestAnimationFrame(t);var e=Bridge.global.performance.now();CirnoGame.App.Update(e)},ColorFromAhsb:function(t,e,i,n){if(0===i){var r=Bridge.Int.clip32(n/255);return CirnoGame.App.RGBToInt(r,r,r)}var o,a,s,h,l,m,d;switch(n>.5?(o=n-n*i+i,s=n+n*i-i):(o=n+n*i,s=n-n*i),h=Bridge.Int.clip32(Math.floor(e/60)),e>=300&&(e-=360),e/=60,e-=2*Math.floor((h+1)%6/2),a=0===h%2?e*(o-s)+s:s-e*(o-s),l=System.Convert.toInt32(Bridge.box(255*o,System.Single,System.Single.format,System.Single.getHashCode)),m=System.Convert.toInt32(Bridge.box(255*a,System.Single,System.Single.format,System.Single.getHashCode)),d=System.Convert.toInt32(Bridge.box(255*s,System.Single,System.Single.format,System.Single.getHashCode)),h){case 1:return CirnoGame.App.RGBToInt(m,l,d);case 2:return CirnoGame.App.RGBToInt(d,l,m);case 3:return CirnoGame.App.RGBToInt(d,m,l);case 4:return CirnoGame.App.RGBToInt(m,d,l);case 5:return CirnoGame.App.RGBToInt(l,d,m);default:return CirnoGame.App.RGBToInt(l,m,d)}},RGBToInt:function(t,e,i){return(t+(e<<8)|0)+(i<<16)|0}}}}),Bridge.ns("CirnoGame.App",$asm.$),Bridge.apply($asm.$.CirnoGame.App,{f1:function(){CirnoGame.GamePadManager._this.Update(),CirnoGame.App.IC=CirnoGame.InputControllerManager._this.Controllers.getItem(0);CirnoGame.InputControllerManager._this.Controllers.getItem(0).InputMapping.getItem(2)}}),Bridge.define("CirnoGame.Audio",{fields:{_AM:null,_audio:null,_hasPlayed:!1,_blast:null,_loop:!1,OnPlay:null,OnStop:null,lasttime:0},props:{ID:null,IsPlaying:{get:function(){return!(!this._hasPlayed||this._audio.paused||0===this._audio.currentTime)},set:function(t){t?this.Play():this.Pause()}},Loop:{get:function(){return this._loop},set:function(t){this._loop=t}},CurrentTime:{get:function(){return this._audio.currentTime},set:function(t){this._audio.currentTime=t}},Volume:{get:function(){return this._audio.volume},set:function(t){this._audio.volume=t}}},ctors:{init:function(){this.lasttime=0},ctor:function(t,e,i){this.$initialize(),this._audio=t,this.ID=e;var n=this;this._AM=i,this._audio.onplay=function(){n._OnPlay()},this._audio.onpause=function(){n._OnStop()},this._audio.onended=function(){n._OnEnd()},this._audio.ontimeupdate=function(){n._OnUpdate()},this._blast=new(System.Collections.Generic.List$1(HTMLAudioElement));for(var r=6,o=1;r>o;)this._blast.add(Bridge.cast(this._audio.cloneNode(),HTMLAudioElement)),o=o+1|0}},methods:{Play:function(){return this.IsPlaying?!1:(this.lasttime=this.CurrentTime,this._audio.play(),this._hasPlayed=!0,!0)},Pause:function(){return this.IsPlaying?(this._audio.pause(),!0):!1},Stop:function(){return this.IsPlaying?(this._audio.pause(),this._audio.currentTime=0,!0):!1},Blast:function(t){if(void 0===t&&(t=1),this.IsPlaying)for(var e=0;e<this._blast.Count;){var i=this._blast.getItem(e);(i.paused||i.currentTime<.1||0===i.played.length)&&(i.paused||0===i.currentTime||0===i.played.length)&&(i.volume=t,i.play(),e=this._blast.Count),e=e+1|0}else this.Volume=t,this.Play()},_OnPlay:function(){this._AM.OnPlay(this),this.OnPlay&&this.OnPlay(this)},_OnStop:function(){this._AM.OnStop(this),this.OnStop&&this.OnStop(this)},_OnEnd:function(){this._OnStop()},_OnUpdate:function(){this._loop&&(this.CurrentTime+.8*(this.CurrentTime-this.lasttime)>=this._audio.duration&&(this.CurrentTime=0,this.Play()),this.lasttime=this.CurrentTime)}}}),Bridge.define("CirnoGame.AudioManager",{statics:{fields:{Directory:null,__this:null},props:{_this:{get:function(){return null==CirnoGame.AudioManager.__this&&(CirnoGame.AudioManager.__this=new CirnoGame.AudioManager),CirnoGame.AudioManager.__this}}},ctors:{init:function(){this.Directory=""}},methods:{Init:function(){null==CirnoGame.AudioManager.__this&&(CirnoGame.AudioManager.__this=new CirnoGame.AudioManager)}}},fields:{data:null,playing:null},ctors:{ctor:function(){this.$initialize(),this.data=new(System.Collections.Generic.Dictionary$2(System.String,CirnoGame.Audio)),this.playing=new(System.Collections.Generic.List$1(CirnoGame.Audio))}},methods:{Get:function(t){if(t=System.String.concat(CirnoGame.AudioManager.Directory,t),this.data.containsKey(t))return this.data.get(t);var e=new Audio(t),i=new CirnoGame.Audio(e,t,this);return this.data.add(t,i),i},Play:function(t,e){void 0===e&&(e=!1);var i=this.Get(t);return i.Loop=e,i.Play(),i},Blast:function(t,e){void 0===e&&(e=1);var i=this.Get(t);i.Blast(e)},Stop:function(t){var e=this.Get(t);e.Stop()},Pause:function(t){var e=this.Get(t);e.Pause()},OnPlay:function(t){this.playing.contains(t)||this.playing.add(t)},OnStop:function(t){this.playing.contains(t)&&this.playing.remove(t)},StopAllFromDirectory:function(t){t=System.String.concat(CirnoGame.AudioManager.Directory,t),CirnoGame.HelperExtensions.ForEach(Bridge.global.CirnoGame.Audio,this.data.getValues(),function(e){System.String.startsWith(e.ID,t)&&e.Stop()})},StopAll:function(){CirnoGame.HelperExtensions.ForEach(Bridge.global.CirnoGame.Audio,this.data.getValues(),$asm.$.CirnoGame.AudioManager.f1)}}}),Bridge.ns("CirnoGame.AudioManager",$asm.$),Bridge.apply($asm.$.CirnoGame.AudioManager,{f1:function(t){t.Stop()}}),Bridge.define("CirnoGame.ButtonMenu",{fields:{rows:null,MenuWidth:0,MenuHeight:0,FontSize:0,SelectionMenu:!1,Selected:null,Self:null,OnChoose:null,Position:null},props:{SelectedData:{get:function(){return null!=this.Self.Selected?this.Self.Selected.Data:null}},SelectedText:{get:function(){return null!=this.Self.Selected&&Bridge.is(this.Self.Selected.Contents,CirnoGame.TextSprite)?Bridge.cast(this.Self.Selected.Contents,CirnoGame.TextSprite).Text:null}}},ctors:{init:function(){this.Position=new CirnoGame.Vector2},ctor:function(t,e,i,n){void 0===n&&(n=!1),this.$initialize(),this.rows=new(System.Collections.Generic.List$1(System.Collections.Generic.List$1(CirnoGame.ButtonSprite))),this.MenuWidth=t,this.MenuHeight=e,this.FontSize=i,this.SelectionMenu=n,this.Self=this}},methods:{GetAllButtons:function(){var t=new(System.Collections.Generic.List$1(CirnoGame.ButtonSprite));return this.rows.forEach(function(e){t.addRange(e)}),t},GetSpriteByData:function(t){var e=new(System.Collections.Generic.List$1(CirnoGame.ButtonSprite))(System.Linq.Enumerable.from(this.GetAllButtons()).where(function(e){return Bridge.referenceEquals(e.Data,t)}));return e.Count>0?e.getItem(0):null},AddButtons:function(t){CirnoGame.HelperExtensions.ForEach(System.String,t,Bridge.fn.bind(this,$asm.$.CirnoGame.ButtonMenu.f1))},AddButton:function(t,e,i){void 0===e&&(e=-1),void 0===i&&(i=null);var n=new CirnoGame.TextSprite;n.Text=t,n.FontSize=this.FontSize;var r=new CirnoGame.ButtonSprite(n,Bridge.Int.clip32(.1*this.FontSize));return null!=i&&(r.Data=i),this.AddButton$1(r,e),r},AddButton$1:function(t,e){void 0===e&&(e=-1),0===this.rows.Count&&this.rows.add(new(System.Collections.Generic.List$1(CirnoGame.ButtonSprite))),-1===e&&(e=this.rows.Count-1|0),null!=t&&(t.OnClick=Bridge.fn.bind(this,function(){this.Self.Select(t)})),this.rows.getItem(e).add(t)},Select:function(t){if(!Bridge.referenceEquals(this.Selected,t)||!this.SelectionMenu){null!=this.Selected&&this.SelectionMenu&&this.Selected.SetColorScheme$1(0),this.Selected=t;var e=this.OnChoose,i=this;this.SelectionMenu&&null!=this.Selected&&this.Selected.SetColorScheme$1(1),null!=this.Selected&&e&&i.OnChoose()}},CombineRows:function(){var t=new(System.Collections.Generic.List$1(CirnoGame.ButtonSprite));this.rows.forEach(function(e){t.addRange(e)}),this.rows=new(System.Collections.Generic.List$1(System.Collections.Generic.List$1(CirnoGame.ButtonSprite))),this.rows.add(t)},addRow:function(){var t=new(System.Collections.Generic.List$1(CirnoGame.ButtonSprite));return this.rows.add(t),t},BreakUp:function(t){this.CombineRows();var e=this.rows.getItem(0);this.rows=new(System.Collections.Generic.List$1(System.Collections.Generic.List$1(CirnoGame.ButtonSprite)));for(var i=Math.ceil(e.Count/t),n=this.addRow(),r=0;r<e.Count;)n.Count>=i&&(n=this.addRow()),this.AddButton$1(e.getItem(r)),r=r+1|0},CenterOn:function(t,e){t.Draw(null);var i=t.Size,n=CirnoGame.Vector2.op_Division(i,2);t.Position=CirnoGame.Vector2.op_Subtraction(e,n)},UpdateRow:function(t,e){var i=this.rows.getItem(t),n=this.MenuWidth/(i.Count+1),r=0,o=n;for(o+=this.Position.X;r<i.Count;){var a=i.getItem(r);null!=a&&this.CenterOn(a,new CirnoGame.Vector2(o,e)),o+=n,r=r+1|0}},Finish:function(t){void 0===t&&(t=-1),t>0&&this.BreakUp(t);var e=0,i=0;t>0&&this.rows.Count<t?(e=this.MenuHeight/(this.rows.Count+1|0),i=e):(e=this.MenuHeight/this.rows.Count,i=0),i+=this.Position.Y;for(var n=0;n<this.rows.Count;)this.UpdateRow(n,i),i+=e,n=n+1|0},Update:function(t,e){void 0===t&&(t=null),void 0===e&&(e=!0),CirnoGame.Vector2.op_Equality(t,null)&&(t=CirnoGame.KeyboardManager._this.CMouse,e=CirnoGame.KeyboardManager._this.TappedMouseButtons.contains(0)),e&&this.rows.forEach(function(e){e.forEach(function(e){null!=e&&e.CheckClick(t)})})},Draw:function(t){this.rows.forEach(function(e){e.forEach(function(e){null!=e&&e.Draw(t)})})}}}),Bridge.ns("CirnoGame.ButtonMenu",$asm.$),Bridge.apply($asm.$.CirnoGame.ButtonMenu,{f1:function(t){this.AddButton(t)}}),Bridge.define("CirnoGame.Sprite",{fields:{Position:null,spriteBuffer:null,Visible:!1,spriteGraphics:null},props:{Size:{get:function(){return new CirnoGame.Vector2(this.spriteBuffer.width,this.spriteBuffer.height)},set:function(t){CirnoGame.Vector2.op_Equality(t,null)&&(t=new CirnoGame.Vector2),this.spriteBuffer.width=Bridge.Int.clip32(t.X),this.spriteBuffer.height=Bridge.Int.clip32(t.Y)}}},ctors:{init:function(){this.Visible=!0},ctor:function(){this.$initialize(),this.spriteBuffer=document.createElement("canvas"),this.spriteGraphics=this.spriteBuffer.getContext("2d"),this.spriteGraphics.imageSmoothingEnabled=!1,this.Position=new CirnoGame.Vector2}},methods:{GetGraphics:function(){return this.spriteGraphics},OnFrame:function(){},Draw:function(t){this.Visible&&t.drawImage(this.spriteBuffer,this.Position.X,this.Position.Y)},GetBounds:function(){return new CirnoGame.Rectangle(this.Position.X,this.Position.Y,this.spriteBuffer.width,this.spriteBuffer.height)}}}),Bridge.define("CirnoGame.ButtonSprite.ColorScheme",{fields:{BorderColor:null,ButtonColor:null},ctors:{ctor:function(t,e){void 0===t&&(t="#00AA33"),void 0===e&&(e="#11CC55"),this.$initialize(),this.BorderColor=t,this.ButtonColor=e}}}),Bridge.define("CirnoGame.Camera",{fields:{instawarp:!1,Position:null,TargetPosition:null,LinearPanSpeed:0,LerpPanSpeed:0,_scale:0,speedmod:0,_invscale:0,_center:null,viewport_width:0,viewport_height:0,CameraBounds:null,StageBounds:null,tmp:null},props:{CenteredTargetPosition:{set:function(t){this.TargetPosition=new CirnoGame.Vector2(t.X-this.CameraBounds.width/2,t.Y-this.CameraBounds.height/2)}},Scale:{get:function(){return this._scale},set:function(t){this._scale=t,this._invscale=1/this._scale,this.UpdateCameraBounds()}},InvScale:{get:function(){return this._invscale},set:function(t){this._invscale=t,this._scale=1/this._invscale,this.UpdateCameraBounds()}},Center:{get:function(){var t=this.CameraBounds;return t.GetCenter(this._center),this._center},set:function(t){this.Position.X=t.X-this.CameraBounds.width/2,this.Position.Y=t.Y-this.CameraBounds.height/2}}},ctors:{init:function(){this.instawarp=!1,this.LinearPanSpeed=1.2,this.LerpPanSpeed=.075,this._scale=1,this.speedmod=1,this._invscale=1,this._center=new CirnoGame.Vector2,this.viewport_width=1,this.viewport_height=1,this.tmp=new CirnoGame.Vector2},ctor:function(t,e){void 0===t&&(t=-1),void 0===e&&(e=-1),this.$initialize(),this.Position=new CirnoGame.Vector2,this.TargetPosition=new CirnoGame.Vector2,this.viewport_width=t,this.viewport_height=e,this.CameraBounds=new CirnoGame.Rectangle(0,0,t,e),this._invscale=1/this._scale,this.UpdateCameraBounds()}},methods:{ScaleToSize:function(t){this.Scale=t/CirnoGame.App.Canvas.width},UpdateCameraBounds:function(){this.CameraBounds.width=this.viewport_width*this._invscale,this.CameraBounds.height=this.viewport_height*this._invscale},Update:function(){if(this.Position.X!==this.TargetPosition.X||this.Position.Y!==this.TargetPosition.Y){var t=this.Position.Distance(this.TargetPosition),e=this.LinearPanSpeed+t*this.LerpPanSpeed;if(e*=this.speedmod,e>=t||this.instawarp)return this.Position.X=this.TargetPosition.X,this.Position.Y=this.TargetPosition.Y,void(this.instawarp=!1);this.tmp.CopyFrom(this.Position),this.tmp.Subtract(this.TargetPosition),this.tmp.SetAsNormalize(e),this.Position.Subtract(this.tmp),null!=this.StageBounds&&(this.Position.X=CirnoGame.MathHelper.Clamp$1(this.Position.X,this.StageBounds.left,this.StageBounds.right-this.CameraBounds.width),this.Position.Y=CirnoGame.MathHelper.Clamp$1(this.Position.Y,this.StageBounds.top,this.StageBounds.bottom-this.CameraBounds.height),this.TargetPosition.X=CirnoGame.MathHelper.Clamp$1(this.TargetPosition.X,this.StageBounds.left,this.StageBounds.right-this.CameraBounds.width),this.TargetPosition.Y=CirnoGame.MathHelper.Clamp$1(this.TargetPosition.Y,this.StageBounds.top,this.StageBounds.bottom-this.CameraBounds.height))}this.CameraBounds.x=this.Position.X,this.CameraBounds.y=this.Position.Y},Apply:function(t){t.scale(this.Scale,this.Scale),t.translate(-this.Position.X,-this.Position.Y)}}}),Bridge.define("CirnoGame.Entity",{fields:{Ani:null,Alive:!1,Visible:!1,Speed:null,Game:null,_behaviors:null,_behaviorTicks:null,ZOrder:0,ID:null,HideHitbox:!1,HandledLocally:!1},props:{Hspeed:{get:function(){return this.Speed.X},set:function(t){this.Speed.X=t}},Vspeed:{get:function(){return this.Speed.Y},set:function(t){this.Speed.Y=t}},Position:{get:function(){return this.Ani.Position},set:function(t){this.Ani.Position=t}},x:{get:function(){return this.Ani.Position.X},set:function(t){this.Ani.Position.X=t}},y:{get:function(){return this.Ani.Position.Y},set:function(t){this.Ani.Position.Y=t}},Width:{get:function(){return null!=this.Ani.CurrentImage?this.Ani.CurrentImage.width:0}},Height:{get:function(){return null!=this.Ani.CurrentImage?this.Ani.CurrentImage.height:0}}},ctors:{init:function(){this.Alive=!0,this.Visible=!0,this.Speed=new CirnoGame.Vector2,this.ZOrder=0,this.HandledLocally=!0},ctor:function(t){this.$initialize(),this.ID=CirnoGame.Helper.GetRandomString(),this.Game=t}},methods:{AddBehavior:function(t){null==this._behaviors&&(this._behaviors=new(System.Collections.Generic.List$1(CirnoGame.EntityBehavior)),this._behaviorTicks=new(System.Collections.Generic.List$1(System.Int32))),this._behaviors.add(t),this._behaviorTicks.add(0)},AddBehavior$1:function(t){null==this._behaviors&&(this._behaviors=new(System.Collections.Generic.List$1(CirnoGame.EntityBehavior)),this._behaviorTicks=new(System.Collections.Generic.List$1(System.Int32)));var e=Bridge.createInstance(t,[this]);this._behaviors.add(Bridge.cast(e,CirnoGame.EntityBehavior)),this._behaviorTicks.add(0)},RemoveBehavior:function(t){null==this._behaviors&&(this._behaviors=new(System.Collections.Generic.List$1(CirnoGame.EntityBehavior)),this._behaviorTicks=new(System.Collections.Generic.List$1(System.Int32))),this._behaviors.contains(t)&&(this._behaviorTicks.removeAt(this._behaviors.indexOf(t)),this._behaviors.remove(t))},RemoveBehavior$1:function(t){var e;if(null!=this._behaviors){var i=new(System.Collections.Generic.List$1(CirnoGame.EntityBehavior))(System.Linq.Enumerable.from(this._behaviors).where(function(e){return Bridge.is(e,t)}));e=Bridge.getEnumerator(i);try{for(;e.moveNext();){var n=e.Current;this.RemoveBehavior(n)}}finally{Bridge.is(e,System.IDisposable)&&e.System$IDisposable$dispose()}}},GetBehavior:function(t){return null==this._behaviors?Bridge.getDefaultValue(t):Bridge.cast(System.Linq.Enumerable.from(this._behaviors).first(function(e){return Bridge.is(e,t)}),t)},GetBehavior$1:function(t,e){var i=new(System.Collections.Generic.List$1(CirnoGame.EntityBehavior))(System.Linq.Enumerable.from(this._behaviors).where(function(e){return Bridge.is(e,t)})),n=e;return Bridge.cast(System.Linq.Enumerable.from(i).first(n),t)},GetTeamColor:function(){return Bridge.is(this,CirnoGame.ICombatant)?this.Game.GamePlaySettings.GameMode.Teams?CirnoGame.Game.GetTeamColor(Bridge.cast(this,CirnoGame.ICombatant).CirnoGame$ICombatant$Team):Bridge.referenceEquals(this,this.Game.player)?CirnoGame.Game.GetTeamColor(1):CirnoGame.Game.GetTeamColor(2):""},SameTeam:function(t){return Bridge.referenceEquals(this,t)?!0:Bridge.is(this,CirnoGame.ICombatant)&&Bridge.is(t,CirnoGame.ICombatant)&&Bridge.cast(this,CirnoGame.ICombatant).CirnoGame$ICombatant$Team===Bridge.cast(t,CirnoGame.ICombatant).CirnoGame$ICombatant$Team?this.Game.GamePlaySettings.GameMode.Teams?!0:0===Bridge.cast(this,CirnoGame.ICombatant).CirnoGame$ICombatant$Team:!1},GetBehaviorFromName:function(t){if(null==this._behaviors)return null;try{return System.Linq.Enumerable.from(this._behaviors).first(function(e){return Bridge.referenceEquals(e.BehaviorName,t)})}catch(e){e=System.Exception.create(e),System.Console.WriteLine(System.String.concat("Behavior ",t," was not found."))}return null},CustomEvent:function(t){},PlaySound:function(t){this.Game.PlaySoundEffect(this.getCenter(),t)},getCenter:function(){return CirnoGame.Vector2.Add$1(this.Position,this.Width/2,this.Height/2)},GetHitbox:function(){return null!=this.Ani&&null!=this.Ani.CurrentImage?new CirnoGame.Rectangle(this.Ani.X,this.Ani.Y,this.Ani.CurrentImage.width,this.Ani.CurrentImage.height):null},Update:function(){var t;if(this.Ani.Position=CirnoGame.Vector2.op_Addition(this.Ani.Position,this.Speed),this.Ani.Update(),null!=this._behaviors)for(var e=0;e<this._behaviors.Count;){var i=this._behaviors.getItem(e);i.enabled&&Bridge.identity(this._behaviorTicks.getItem(e),(t=this._behaviorTicks.getItem(e)+1|0,this._behaviorTicks.setItem(e,t),t))>=i.FramesPerTick&&(this._behaviorTicks.setItem(e,0),i.Update()),e=e+1|0}},RefreshBehaviorTick:function(t){var e=this.GetBehavior(t);null!=e&&this._behaviorTicks.setItem(this._behaviors.indexOf(e),e.FramesPerTick)},Draw:function(t){var e;if(this.Ani.Draw(t),!this.HideHitbox&&this.Game.ShowHitbox&&this.DrawHitbox(t),null!=this._behaviors){e=Bridge.getEnumerator(this._behaviors);try{for(;e.moveNext();){var i=e.Current;i.Draw(t)}}finally{Bridge.is(e,System.IDisposable)&&e.System$IDisposable$dispose()}}},DrawHitbox:function(t){var e=this.GetHitbox();null!=e&&(t.strokeStyle="#FFFF00",t.strokeRect(e.x,e.y,e.width,e.height))},onRemove:function(){}}}),Bridge.define("CirnoGame.GameMode.ModeTypes",{
$kind:"enum",statics:{fields:{Skirmish:0,Challenge:1,CallengeCoop:2}}}),Bridge.define("CirnoGame.GamePad",{fields:{connected:!1,axes:null,buttons:null,id:null,index:System.Int64(0)},ctors:{ctor:function(t){this.$initialize(),this.id=t.id,this.index=System.Int64(t.index),this.connected=t.connected,this.axes=t.axes;var e=t.buttons.length;this.buttons=System.Array.init(e,null,CirnoGame.GamePadButton);for(var i=0;e>i;)this.buttons[System.Array.index(i,this.buttons)]=t.buttons[i],i=i+1|0}},methods:{Update:function(){for(var t=0;t<this.buttons.length;)this.buttons[System.Array.index(t,this.buttons)].tapped=!1,t=t+1|0},CombineData:function(t){Bridge.referenceEquals(this.id,t.id)&&(this.connected=t.connected,this.axes=t.axes,this.CombineButtonData(t.buttons))},CombineButtonData:function(t){var e=t;this.buttons=t;for(var i=0;i<t.length;)t[System.Array.index(i,t)].pressed&&!e[System.Array.index(i,e)].pressed&&(t[System.Array.index(i,t)].tapped=!0),i=i+1|0}}}),Bridge.define("CirnoGame.GamePadButton",{fields:{tapped:!1,pressed:!1,value:0},ctors:{ctor:function(t){this.$initialize(),this.pressed=t.pressed,this.value=t.value,this.tapped=!1}}}),Bridge.define("CirnoGame.GamePadManager",{statics:{fields:{_this:null}},fields:{keyboard:null,gamepads:null,tempgamepads:null},props:{activeGamepads:{get:function(){return new(System.Collections.Generic.List$1(CirnoGame.GamePad))(System.Linq.Enumerable.from(this.gamepads).where($asm.$.CirnoGame.GamePadManager.f1))}}},ctors:{ctor:function(){this.$initialize(),this.gamepads=new(System.Collections.Generic.List$1(CirnoGame.GamePad)),this.Update()}},methods:{CallBackTest:function(){Bridge.global.alert("Callback!")},GetPad:function(t){var e=new(System.Collections.Generic.List$1(CirnoGame.GamePad))(System.Linq.Enumerable.from(this.gamepads).where(function(e){return Bridge.referenceEquals(e.id,t)}));return e.Count>0?e.getItem(0):null},Update:function(){for(var t=0;t<this.gamepads.Count;)this.gamepads.getItem(t).Update(),t=t+1|0;t=0,this.tempgamepads=navigator.getGamepads()||navigator.webkitGetGamepads()||[];for(var e=new(System.Collections.Generic.List$1(CirnoGame.GamePad));t<this.tempgamepads.length;){if(null!=this.tempgamepads[t]){var i=new CirnoGame.GamePad(this.tempgamepads[t]);this._Update(i),e.add(i)}t=t+1|0}for(t=0;t<e.Count;){for(var n=e.getItem(t).id,r=0,o=!0;r<this.gamepads.Count;)Bridge.referenceEquals(this.gamepads.getItem(r).id,n)&&(o=!1),r=r+1|0;o&&this.gamepads.add(e.getItem(t)),t=t+1|0}},_Update:function(t){for(var e=0;e<this.gamepads.Count;){var i=this.gamepads.getItem(e);Bridge.referenceEquals(i.id,t.id)&&i.CombineData(t),e=e+1|0}}}}),Bridge.ns("CirnoGame.GamePadManager",$asm.$),Bridge.apply($asm.$.CirnoGame.GamePadManager,{f1:function(t){return t.connected}}),Bridge.define("CirnoGame.GamePlaySettings",{fields:{Online:!1,MyCharacter:null,GameMode:null,MyTeam:0,BlueNPCs:0,RedNPCs:0,RoomID:null,ComputerAIModifier:0},ctors:{init:function(){this.Online=!1,this.MyCharacter="Reisen",this.MyTeam=1,this.BlueNPCs=3,this.RedNPCs=2,this.RoomID="",this.ComputerAIModifier=1},ctor:function(){this.$initialize(),this.GameMode=CirnoGame.GameMode.TeamBattle}}}),Bridge.define("CirnoGame.Helper",{statics:{fields:{_namespaces:null},ctors:{init:function(){this._namespaces=new(System.Collections.Generic.Dictionary$2(System.String,System.Object))}},methods:{GetRandomString:function(){return(Math.random()*(new Date).getTime()).toString(36)},GetType:function(FullName){var name=FullName;if(Bridge.referenceEquals(name,"")||null==name||!System.String.contains(name,"."))return null;var s=name.split("."),i=1,obj;for(CirnoGame.Helper._namespaces.containsKey(s[System.Array.index(0,s)])?obj=CirnoGame.Helper._namespaces.get(s[System.Array.index(0,s)]):(obj=eval(s[System.Array.index(0,s)]),CirnoGame.Helper._namespaces.set(s[System.Array.index(0,s)],obj));i<s.length;){if(!obj)return null;obj=obj[s[System.Array.index(i,s)]],i=i+1|0}return obj},AddMultiple:function(t,e,i,n){for(;n>0;)e.push(i),n=n-1|0},Repeat:function(t,e){if(1>e)return"";for(var i=t,n=e-1|0;n>0;)i=System.String.concat(i,t),n=n-1|0;return i},CloneCanvas:function(t){var e=document.createElement("canvas");e.width=t.width,e.height=t.height;var i=e.getContext("2d");return i.drawImage(t,0,0),e},GetContext:function(t){return t.getContext("2d")},GetField:function(t,e){var i=t;if(CirnoGame.Helper.Has(i,e))return i[e];if(i[System.String.concat("get",e)])return i[System.String.concat("get",e)]();var n="";try{n=System.String.concat('Helper get field: Field "',e,'" was not in '+t.GetType().FullName,".")}catch(r){r=System.Exception.create(r),n=System.String.concat('Helper get field: Field "',e,'" was not in '+t,".")}return console.log(n),null},Has:function(t,e){return"undefined"!=typeof t[e]},ReloadPage:function(){window.location.href=window.location.href},SetField:function(t,e,i){var n=t;if(CirnoGame.Helper.Has(n,e))return void(n[e]=i);if(n[System.String.concat("set",e)])return void n[System.String.concat("set",e)](i);var r="";try{r=System.String.concat('Helper set field: Field "',e,'" was not in '+t.GetType().FullName,".")}catch(o){o=System.Exception.create(o),r=System.String.concat('Helper set field: Field "',e,'" was not in '+t,".")}console.log(r)},CopyFields:function(t,e,i){void 0===i&&(i=null),null==i&&(i=Object.keys(t));for(var n=0;n<i.length;){var r=i[System.Array.index(n,i)];CirnoGame.Helper.SetField(e,r,CirnoGame.Helper.GetField(t,r)),n=n+1|0}},KeyCodeToString:function(t){var e=System.Array.init(["","","","CANCEL","","","HELP","","BACK_SPACE","TAB","","","CLEAR","ENTER","ENTER_SPECIAL","","SHIFT","CONTROL","ALT","PAUSE","CAPS_LOCK","KANA","EISU","JUNJA","FINAL","HANJA","","ESCAPE","CONVERT","NONCONVERT","ACCEPT","MODECHANGE","SPACE","PAGE_UP","PAGE_DOWN","END","HOME","LEFT","UP","RIGHT","DOWN","SELECT","PRINT","EXECUTE","PRINTSCREEN","INSERT","DELETE","","0","1","2","3","4","5","6","7","8","9","COLON","SEMICOLON","LESS_THAN","EQUALS","GREATER_THAN","QUESTION_MARK","AT","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","OS_KEY","","CONTEXT_MENU","","SLEEP","NUMPAD0","NUMPAD1","NUMPAD2","NUMPAD3","NUMPAD4","NUMPAD5","NUMPAD6","NUMPAD7","NUMPAD8","NUMPAD9","MULTIPLY","ADD","SEPARATOR","SUBTRACT","DECIMAL","DIVIDE","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12","F13","F14","F15","F16","F17","F18","F19","F20","F21","F22","F23","F24","","","","","","","","","NUM_LOCK","SCROLL_LOCK","WIN_OEM_FJ_JISHO","WIN_OEM_FJ_MASSHOU","WIN_OEM_FJ_TOUROKU","WIN_OEM_FJ_LOYA","WIN_OEM_FJ_ROYA","","","","","","","","","","CIRCUMFLEX","EXCLAMATION","DOUBLE_QUOTE","HASH","DOLLAR","PERCENT","AMPERSAND","UNDERSCORE","OPEN_PAREN","CLOSE_PAREN","ASTERISK","PLUS","PIPE","HYPHEN_MINUS","OPEN_CURLY_BRACKET","CLOSE_CURLY_BRACKET","TILDE","","","","","VOLUME_MUTE","VOLUME_DOWN","VOLUME_UP","","","SEMICOLON","EQUALS","COMMA","MINUS","PERIOD","SLASH","BACK_QUOTE","","","","","","","","","","","","","","","","","","","","","","","","","","","OPEN_BRACKET","BACK_SLASH","CLOSE_BRACKET","QUOTE","","META","ALTGR","","WIN_ICO_HELP","WIN_ICO_00","","WIN_ICO_CLEAR","","","WIN_OEM_RESET","WIN_OEM_JUMP","WIN_OEM_PA1","WIN_OEM_PA2","WIN_OEM_PA3","WIN_OEM_WSCTRL","WIN_OEM_CUSEL","WIN_OEM_ATTN","WIN_OEM_FINISH","WIN_OEM_COPY","WIN_OEM_AUTO","WIN_OEM_ENLW","WIN_OEM_BACKTAB","ATTN","CRSEL","EXSEL","EREOF","PLAY","ZOOM","","PA1","WIN_OEM_CLEAR",""],System.String);if(t>=0&&t<e.length)return e[System.Array.index(t,e)];var i=t;return String.FromCharCode(i)},MakeShallowCopy:function(t,e){void 0===e&&(e=null);var i={},n=e;null==n&&(n=Object.keys(t));for(var r=0;r<n.length;){var o=n[System.Array.index(r,n)];i[o]=CirnoGame.Helper.GetField(t,o),r=r+1|0}return i}}}}),Bridge.define("CirnoGame.HelperExtensions",{statics:{methods:{Pick:function(t,e,i){var n;void 0===i&&(i=null),null==i&&(i=new System.Random.ctor);var r=new(System.Collections.Generic.List$1(t));n=Bridge.getEnumerator(e,t);try{for(;n.moveNext();){var o=n.Current;r.add(o)}}finally{Bridge.is(n,System.IDisposable)&&n.System$IDisposable$dispose()}return r.getItem(i.next$1(r.Count))},ForEach:function(t,e,i){var n;n=Bridge.getEnumerator(e,t);try{for(;n.moveNext();){var r=n.Current;i(r)}}finally{Bridge.is(n,System.IDisposable)&&n.System$IDisposable$dispose()}},ForEach$1:function(t,e,i){var n;n=Bridge.getEnumerator(e,t);try{for(;n.moveNext();){var r=n.Current,o=Bridge.unbox(r[i]);o()}}finally{Bridge.is(n,System.IDisposable)&&n.System$IDisposable$dispose()}},AddIfNew:function(t,e,i){for(var n=0,r=e.Count,o=i;r>n;){var a=e.getItem(n);if(o==a)return;n=n+1|0}e.add(i)},RemoveAll:function(t,e,i){for(var n=0;n<e.Count;){var r=e.getItem(n);i(r)&&(e.remove(r),n=n-1|0),n=n+1|0}},PushIfNew:function(t,e,i){CirnoGame.HelperExtensions.ContainsB(t,e,i)||e.push(i)},PushRange:function(t,e,i){void 0===i&&(i=[]);for(var n=0;n<i.length;)e.push(i[System.Array.index(n,i)]),n=n+1|0},Clear$1:function(t,e){for(var i=e.length;Bridge.identity(i,i=i-1|0)>0;)e.pop()},Clear:function(t){var e=t.canvas;t.clearRect(0,0,e.width,e.height)},ReplaceAll:function(t,e,i,n){var r=-1;r=CirnoGame.HelperExtensions.IndexOf(t,e,i,r+1|0,3);for(var o=i.length;r>=0;){for(var a=0;o>a;)e[System.Array.index(r+a|0,e)]=n[System.Array.index(a,n)],a=a+1|0;r=CirnoGame.HelperExtensions.IndexOf(t,e,i,r+1|0,3)}},WhereB:function(t,e,i){for(var n=System.Array.init(0,null,System.Object),r=0,o=e.length;o>r;){var a=e[System.Array.index(r,e)];i(a)&&n.push(a),r=r+1|0}return Bridge.unbox(n)},ContainsB$1:function(t,e,i){var n=Bridge.unbox(e.items);return CirnoGame.HelperExtensions.ContainsB(t,n,i)},ContainsB:function(t,e,i){for(var n=0,r=e.length;r>n;){var o=e[System.Array.index(n,e)];if(o==i)return!0;n=n+1|0}return!1},IndexOf:function(t,e,i,n,r){void 0===n&&(n=0),void 0===r&&(r=1);for(var o,a,s=n,h=e.length,l=i.length,m=i[System.Array.index(0,i)];h>s&&s>=0;){for(s=e.indexOf(Bridge.unbox(m),s+1|0);s>=0&&s%r>0;)s=e.indexOf(Bridge.unbox(m),s+1|0);if(-1===s)return-1;var d=1,u=s+1|0;if(h>s&&s>=0){for(var c=!0;c&&l>d;)o=e[System.Array.index(u,e)],a=i[System.Array.index(d,i)],Bridge.referenceEquals(o,a)||(c=!1),d=d+1|0,u=u+1|0;if(c)return s}}return-1},Identical:function(t,e,i){if(Bridge.referenceEquals(e,i))return!0;if(null==e||null==i)return!1;var n=e.length;if(n===i.length){for(var r=0;n>r;){var o=e[System.Array.index(r,e)],a=i[System.Array.index(r,i)];if(!Bridge.referenceEquals(o,a))return!1;r=r+1|0}return!0}return!1},ReverseOrderWithStructure:function(t,e,i){for(var n=new(System.Collections.Generic.List$1(t)),r=0,o=e.length;o>r;){for(var a=0;i>a;)n.insert(0,e[System.Array.index((i-1|0)-a|0,e)]),a=a+1|0;r=r+i|0}},IsInstanceOfTypeFast:function(t,e){var i=Bridge.unbox(e).ctor,n=Bridge.unbox(t.$$inheritors);return Bridge.referenceEquals(i,t)||null!=n&&n.indexOf(i)>=0}}}}),Bridge.define("CirnoGame.ICombatant",{$kind:"interface"}),Bridge.define("CirnoGame.IHarmfulEntity",{$kind:"interface"}),Bridge.define("CirnoGame.ILightSource",{$kind:"interface"}),Bridge.define("CirnoGame.InputController",{statics:{fields:{NumberOfActions:0,GM:null},ctors:{init:function(){this.NumberOfActions=8}}},fields:{InputMapping:null},props:{id:null},ctors:{ctor:function(t){void 0===t&&(t="Keyboard"),this.$initialize(),this.id=t,this.InputMapping=new(System.Collections.Generic.List$1(CirnoGame.InputMap)),Bridge.referenceEquals(t,"Keyboard")?this.initkeyboard():this.initgamepad(),null==CirnoGame.InputController.GM&&(null==CirnoGame.GamePadManager._this&&(CirnoGame.GamePadManager._this=new CirnoGame.GamePadManager),CirnoGame.InputController.GM=CirnoGame.GamePadManager._this)}},methods:{CopyMap:function(){for(var t=System.Array.init(["map","antimap","name","axis","controllerID"],System.String),e=System.Array.init(this.InputMapping.Count,null,System.Object),i=0;i<e.length;)e[System.Array.index(i,e)]=CirnoGame.Helper.MakeShallowCopy(this.InputMapping.getItem(i),t),i=i+1|0;return e},CopyFromMap:function(t){for(var e=System.Array.init(["map","antimap","name","axis","controllerID"],System.String),i=0;i<t.length;){i>=this.InputMapping.Count&&this.InputMapping.add(new CirnoGame.InputMap.ctor);var n=this.InputMapping.getItem(i);CirnoGame.Helper.CopyFields(t[System.Array.index(i,t)],n,e),i=i+1|0}},initkeyboard:function(){for(var t=0;t<CirnoGame.InputController.NumberOfActions;){var e=new CirnoGame.InputMap.$ctor1(-1);0===t&&(e.map=39,e.antimap=37),1===t&&(e.map=40,e.antimap=38),2===t&&(e.map=90),3===t&&(e.map=88),4===t&&(e.map=65),5===t&&(e.map=13),this.InputMapping.add(e),t=t+1|0}},initgamepad:function(){for(var t=0;t<CirnoGame.InputController.NumberOfActions;){var e=new CirnoGame.InputMap.$ctor1(-1);0===t&&(e.map=0,e.axis=!0),1===t&&(e.map=1,e.axis=!0),t>1&&(e.map=t-2|0),this.InputMapping.add(e),t=t+1|0}},getState:function(t,e){void 0===e&&(e=null),null==e&&(e=this.InputMapping.getItem(t));var i=this.id;return Bridge.referenceEquals(e.controllerID,"")||(i=e.controllerID),Bridge.referenceEquals(i,"Keyboard")?this.getKeyboardMapState(e):Bridge.referenceEquals(i,"Mouse")?this.getMouseMapState(e):this.getGamepadMapState(e)},getPressed:function(t,e){return void 0===e&&(e=null),this.getState(t,e)>=.7},FindAnyPressedGamePadInput:function(){var t=new CirnoGame.InputMap.ctor,e=CirnoGame.GamePadManager._this.activeGamepads;return e.forEach(function(e){if(-1===t.map){t.controllerID=e.id;var i=System.Linq.Enumerable.from(e.buttons).where($asm.$.CirnoGame.InputController.f1).toArray(CirnoGame.GamePadButton);if(i.length>0){t.axis=!1;var n=i[System.Array.index(0,i)];t.map=new(System.Collections.Generic.List$1(CirnoGame.GamePadButton))(e.buttons).indexOf(n)}else for(var r=0;r<e.axes.length&&-1===t.map;)Math.abs(e.axes[System.Array.index(r,e.axes)])>.7&&Math.abs(e.axes[System.Array.index(r,e.axes)])<2&&(t.axis=!0,t.map=r,e.axes[System.Array.index(r,e.axes)]<0&&(t.name="anti",t.antimap=r)),r=r+1|0}}),-1!==t.map?t:null},getMapControllerID:function(t){return Bridge.referenceEquals(t.controllerID,"")?this.id:t.controllerID},getMapControllerID$1:function(t){return this.getMapControllerID(this.InputMapping.getItem(t))},getGamepadMapState:function(t){var e=this.id;Bridge.referenceEquals(t.controllerID,"")||(e=t.controllerID);var i=CirnoGame.GamePadManager._this.GetPad(e);return null!=i&&i.connected?t.axis?i.axes[System.Array.index(t.map,i.axes)]:i.buttons[System.Array.index(t.map,i.buttons)].pressed?1:t.antimap>=0&&i.buttons[System.Array.index(t.antimap,i.buttons)].pressed?-1:0:0},getKeyboardMapState:function(t){var e=CirnoGame.KeyboardManager._this.PressedButtons;return e.contains(t.map)?1:e.contains(t.antimap)?-1:0},getMouseMapState:function(t){var e=CirnoGame.KeyboardManager._this.PressedMouseButtons;return e.contains(t.map)?1:e.contains(t.antimap)?-1:0}}}),Bridge.ns("CirnoGame.InputController",$asm.$),Bridge.apply($asm.$.CirnoGame.InputController,{f1:function(t){return t.pressed}}),Bridge.define("CirnoGame.InputControllerManager",{statics:{fields:{__this:null},props:{_this:{get:function(){return null==CirnoGame.InputControllerManager.__this&&(CirnoGame.InputControllerManager.__this=new CirnoGame.InputControllerManager),CirnoGame.InputControllerManager.__this}}},methods:{Init:function(){null==CirnoGame.InputControllerManager.__this&&(CirnoGame.InputControllerManager.__this=new CirnoGame.InputControllerManager)}}},fields:{Controllers:null},ctors:{ctor:function(){this.$initialize(),this.Controllers=new(System.Collections.Generic.List$1(CirnoGame.InputController)),this.Controllers.add(new CirnoGame.InputController);for(var t=CirnoGame.GamePadManager._this.activeGamepads,e=0;e<t.Count;)this.Controllers.add(new CirnoGame.InputController(t.getItem(e).id)),e=e+1|0}}}),Bridge.define("CirnoGame.InputMap",{fields:{map:0,antimap:0,name:null,axis:!1,controllerID:null},ctors:{init:function(){this.map=-1,this.antimap=-1,this.name="",this.axis=!1,this.controllerID=""},ctor:function(){this.$initialize(),this.axis=!1},$ctor1:function(t,e,i){void 0===e&&(e=-1),void 0===i&&(i=!1),this.$initialize(),this.map=t,this.antimap=e,this.axis=i}}}),Bridge.define("CirnoGame.JSONArchive",{statics:{methods:{Open:function(t,e){var i=new XMLHttpRequest;i.onload=function(t){e(new CirnoGame.JSONArchive(i.responseText))},i.open("GET",t,!1),i.send()}}},fields:{Data:null,Images:null},ctors:{init:function(){this.Data=new(System.Collections.Generic.Dictionary$2(System.String,System.String)),this.Images=new(System.Collections.Generic.Dictionary$2(System.String,HTMLImageElement))},ctor:function(t){this.$initialize();for(var e=JSON.parse(t),i=0,n=e.length;n>i;){var r=e[System.Array.index(Bridge.identity(i,i=i+1|0),e)];this.Data.set(r[System.Array.index(0,r)].toLowerCase(),r[System.Array.index(1,r)])}}},methods:{PreloadImages:function(t,e){void 0===e&&(e=100);for(var i=System.Linq.Enumerable.from(this.Data.getKeys()).toArray(),n=0;n<this.Data.count;){var r=i[System.Array.index(n,i)];this.GetImage(r),n=n+1|0}Bridge.global.setTimeout(t,e)},GetData:function(t){var e=t.toLowerCase();return this.Data.containsKey(e)?this.Data.get(e):null},GetImage:function(t){var e=t.toLowerCase();if(this.Images.containsKey(e))return this.Images.get(e);var i=this.GetData(e);if(null==i)return null;var n=new Image;return n.onload=function(t){console.log(System.String.concat("loaded ",e," from JSON!"))},n.src=System.String.concat("data:image/png;base64,",i),this.Images.set(e,n),n}}}),Bridge.define("CirnoGame.KeyboardManager",{statics:{fields:{AllowRightClick:!1,__this:null},props:{_this:{get:function(){return null==CirnoGame.KeyboardManager.__this&&(CirnoGame.KeyboardManager.__this=new CirnoGame.KeyboardManager),CirnoGame.KeyboardManager.__this}}},ctors:{init:function(){this.AllowRightClick=!1}},methods:{Init:function(){null==CirnoGame.KeyboardManager.__this&&(CirnoGame.KeyboardManager.__this=new CirnoGame.KeyboardManager)},Update:function(){CirnoGame.KeyboardManager.__this.TappedButtons.clear(),CirnoGame.KeyboardManager.__this.TappedMouseButtons.clear(),CirnoGame.KeyboardManager.__this.MouseDelta=0},NeverinBounds:function(t){return CirnoGame.KeyboardManager.AllowRightClick||!CirnoGame.App.ScreenBounds.containsPoint$1(CirnoGame.KeyboardManager._this.CMouse.X,CirnoGame.KeyboardManager._this.CMouse.Y)},onKeyDown:function(t){var e=t.keyCode;return CirnoGame.HelperExtensions.ContainsB$1(System.Int32,CirnoGame.KeyboardManager.__this.PressedButtons,Bridge.box(e,System.Int32))||(CirnoGame.KeyboardManager.__this.PressedButtons.add(e),CirnoGame.KeyboardManager.__this.TappedButtons.add(e)),e>=37&&40>=e||32===e||112===e?!1:!0},onKeyUp:function(t){var e=t.keyCode;CirnoGame.HelperExtensions.ContainsB$1(System.Int32,CirnoGame.KeyboardManager.__this.PressedButtons,Bridge.box(e,System.Int32))&&CirnoGame.KeyboardManager.__this.PressedButtons.remove(e)},onMouseDown:function(t){var e=t.button;return CirnoGame.HelperExtensions.ContainsB$1(System.Int32,CirnoGame.KeyboardManager.__this.PressedMouseButtons,Bridge.box(e,System.Int32))||(CirnoGame.KeyboardManager.__this.PressedMouseButtons.add(e),CirnoGame.KeyboardManager.__this.TappedMouseButtons.add(e)),1>e},onMouseUp:function(t){var e=t.button;return CirnoGame.HelperExtensions.ContainsB$1(System.Int32,CirnoGame.KeyboardManager.__this.PressedMouseButtons,Bridge.box(e,System.Int32))&&CirnoGame.KeyboardManager.__this.PressedMouseButtons.remove(e),1>e},onMouseWheel:function(t){return CirnoGame.KeyboardManager._this.MouseDelta+=t.detail,!0},onMouseMove:function(t){CirnoGame.KeyboardManager._this.MousePosition=new CirnoGame.Vector2(t.clientX,t.clientY);var e={v:0};if(System.Single.tryParse(System.String.replaceAll(CirnoGame.App.Div.style.left,"px",""),null,e)){var i=t.clientX-e.v,n=t.clientY,r=CirnoGame.App.Canvas.width/System.Single.parse(System.String.replaceAll(CirnoGame.App.Div.style.width,"px",""));CirnoGame.KeyboardManager._this.CMouse=new CirnoGame.Vector2(i*r,n*r)}}}},fields:{PressedButtons:null,TappedButtons:null,PressedMouseButtons:null,TappedMouseButtons:null,MousePosition:null,CMouse:null,MouseDelta:0},ctors:{init:function(){this.MousePosition=new CirnoGame.Vector2,this.CMouse=new CirnoGame.Vector2,this.MouseDelta=0},ctor:function(){this.$initialize(),this.PressedButtons=new(System.Collections.Generic.List$1(System.Int32)),this.TappedButtons=new(System.Collections.Generic.List$1(System.Int32)),this.PressedMouseButtons=new(System.Collections.Generic.List$1(System.Int32)),this.TappedMouseButtons=new(System.Collections.Generic.List$1(System.Int32));var t=CirnoGame.KeyboardManager.onKeyDown;document.onkeydown=t;var e=CirnoGame.KeyboardManager.onKeyUp;document.onkeyup=e;var i=CirnoGame.KeyboardManager.onMouseMove;document.onmousemove=i;var n=CirnoGame.KeyboardManager.onMouseDown;document.onmousedown=n;var r=CirnoGame.KeyboardManager.onMouseUp;document.onmouseup=r;var o=CirnoGame.KeyboardManager.onMouseWheel;document.onmousewheel=o,document.onDomMouseScroll=o,window.addEventListener("mousewheel",$asm.$.CirnoGame.KeyboardManager.f1),window.addEventListener("DOMMouseScroll",$asm.$.CirnoGame.KeyboardManager.f1),document.onmousewheel=$asm.$.CirnoGame.KeyboardManager.f1;var a=CirnoGame.KeyboardManager.NeverinBounds;document.oncontextmenu=a}}}),Bridge.ns("CirnoGame.KeyboardManager",$asm.$),Bridge.apply($asm.$.CirnoGame.KeyboardManager,{f1:function(t){CirnoGame.KeyboardManager.onMouseWheel(t)}}),Bridge.define("CirnoGame.MapGenerator",{statics:{fields:{blank:null},ctors:{init:function(){this.blank=new CirnoGame.TileData}},methods:{Generate:function(t){var e=t.player,i=t.TM,n=t.stageBounds,r=0,o=0;Math.random()<.5?r=Math.random()<.5?-1:1:o=Math.random()<.5?-1:1;var a=new CirnoGame.TileData;a.texture=1,a.enabled=!0,a.visible=!0,a.map=i,a.solid=!0,a.topSolid=!0,e.x=(n.left+n.right)/2,e.y=(n.top+n.bottom)/2,CirnoGame.MapGenerator.pathMiner(t,0|Bridge.Int.div(i.columns,2),0|Bridge.Int.div(i.rows,4),r,o,30);var s=CirnoGame.MapGenerator.FindEmptySpace(t);CirnoGame.Vector2.op_Inequality(s,null)?(e.x=s.X,e.y=s.Y,console.log("spawning at:"+Bridge.Int.clip32(s.X)+","+Bridge.Int.clip32(s.Y))):console.log("cannot locate a spawn point...")},BoxyGenerate:function(t){console.log("boxy generate");var e=t.player,i=t.TM;t.stageBounds;CirnoGame.MapRoom.PlacedRooms=new(System.Collections.Generic.List$1(CirnoGame.MapRoom));var n=0|Bridge.Int.div(i.columns,2),r=0|Bridge.Int.div(i.rows,3),o=new CirnoGame.MapRoom;o.SX=n,o.SY=r,o.EX=(n+6|0)+Bridge.Int.clip32(10*Math.random())|0,o.EY=(r+6|0)+Bridge.Int.clip32(10*Math.random())|0,o.game=t;var a=16+Bridge.Int.clip32(18*Math.random())|0,s=400;if(!o.PlaceAndExpand())return void console.log("Couldn't generate root room.");for(;CirnoGame.MapRoom.PlacedRooms.Count<a&&s>0;){var h=CirnoGame.HelperExtensions.Pick(Bridge.global.CirnoGame.MapRoom,CirnoGame.MapRoom.FindValidUnplacedRooms());h.PlaceAndExpand(),s=s-1|0}var l=CirnoGame.MapGenerator.FindEmptySpace(t);if(CirnoGame.Vector2.op_Inequality(l,null)){t.Door.Position.CopyFrom(l),t.Door.DropToGround();var m=e;m.MoveToNewSpawn(t.Door.Position),console.log("spawning at:"+Bridge.Int.clip32(l.X)+","+Bridge.Int.clip32(l.Y))}else console.log("cannot locate a spawn point...")},FindEmptySpace:function(t){for(var e=t.TM,i=t.stageBounds,n=0,r=new CirnoGame.Vector2,o=new CirnoGame.Vector2;2e3>n;){if(r.X=i.left+Math.random()*(i.width-e.tilesize),r.Y=i.top+Math.random()*(i.bottom-e.tilesize),!e.CheckForTile(r).visible&&(o.X=r.X,o.Y=r.Y-e.tilesize,!e.CheckForTile(r).visible))return r;n=n+1|0}return null},pathMiner:function(t,e,i,n,r,o){if(!(0>=o)){var a=(t.player,t.TM),s=(t.stageBounds,0),h=1;for(0!==r&&(h=2);7>s&&Math.random()<Math.pow(.95,h);)if(e=e+n|0,i=i+r|0,CirnoGame.MapGenerator.Erase(a,e,i,3),Math.random()<.2*h)0===n?e=e+(Math.random()<.5?1:-1)|0:i=i+(Math.random()<.5?1:-1)|0;else if(Math.random()<.02*h&&o>4){o=0|Bridge.Int.div(o,2);var l=Math.random()<.5?r:0|-r,m=Math.random()<.5?n:0|-n;CirnoGame.MapGenerator.pathMiner(t,e,i,l,m,o)}o=o-1|0,o>1&&CirnoGame.MapGenerator.roomMiner(t,e,i,n,r,o)}},roomMiner:function(t,e,i,n,r,o){if(!(0>=o)){var a=Bridge.Int.clip32(4+4*Math.random());e=e+Bridge.Int.mul(n,0|Bridge.Int.div(a,2))|0,i=i+Bridge.Int.mul(r,0|Bridge.Int.div(a,2))|0,CirnoGame.MapGenerator.EraseAndRando(t.TM,e,i,Bridge.Int.mul(a,2)+2|0);var s=n,h=r;(Math.random()<.2||0!==h&&Math.random()<.65||0>h)&&(s=Math.random()<.5?r:0|-r,h=Math.random()<.5?n:0|-n,0>h&&(h=0|-h)),n=s,r=h,e=e+Bridge.Int.mul(n,0|Bridge.Int.div(a,2))|0,i=i+Bridge.Int.mul(r,0|Bridge.Int.div(a,2))|0,o=o-1|0,CirnoGame.MapGenerator.pathMiner(t,e,i,n,r,o)}},Erase:function(t,e,i,n){t.ClearRect$1(e-(0|Bridge.Int.div(n,2))|0,i-(0|Bridge.Int.div(n,2))|0,n,n)},EraseAndRando:function(t,e,i,n){var r=e-(0|Bridge.Int.div(n,2))|0,o=i-(0|Bridge.Int.div(n,2))|0;t.ClearRect$1(r,o,n,n),t._GenRect(r,o,r+n|0,o+n|0)}}}}),Bridge.define("CirnoGame.MapRoom",{statics:{fields:{PlacedRooms:null,RNG:null},ctors:{init:function(){this.PlacedRooms=new(System.Collections.Generic.List$1(CirnoGame.MapRoom)),this.RNG=new System.Random.ctor}},methods:{FindValidUnplacedRooms:function(){for(var t=new(System.Collections.Generic.List$1(CirnoGame.MapRoom)),e=0;e<CirnoGame.MapRoom.PlacedRooms.Count;){var i=CirnoGame.MapRoom.PlacedRooms.getItem(e);t.addRange(System.Linq.Enumerable.from(i.ExitRooms).where($asm.$.CirnoGame.MapRoom.f1)),e=e+1|0}return t},FindAnyEmptySpot:function(){if(CirnoGame.MapRoom.PlacedRooms.Count<1)return null;for(var t=0;10>t;){var e=CirnoGame.HelperExtensions.Pick(Bridge.global.CirnoGame.MapRoom,CirnoGame.MapRoom.PlacedRooms,CirnoGame.MapRoom.RNG).FindEmptySpot();if(CirnoGame.Vector2.op_Inequality(e,null))return e;t=t+1|0}return null}}},fields:{SX:0,SY:0,EX:0,EY:0,placed:!1,ExitRooms:null,parent:null,game:null},ctors:{init:function(){this.placed=!1,this.ExitRooms=new(System.Collections.Generic.List$1(CirnoGame.MapRoom))}},methods:{IsValid:function(){var t=this.game.TM;return this.SX>=0&&this.SY>=0&&this.EX<t.columns&&this.EY<t.rows?!0:!1},CanBePlaced:function(){var t=this.game.TM;return this.IsValid()&&t.IsRectSolid(this.SX,this.SY,this.EX,this.EY)?!0:!1},GenerateAdjacentRooms:function(){var t=this.GenerateAdjacentRoom(-1,0);null!=t&&this.ExitRooms.add(t),t=this.GenerateAdjacentRoom(1,0),null!=t&&this.ExitRooms.add(t),Math.random()<.5&&(t=this.GenerateAdjacentRoom(0,-1),null!=t&&this.ExitRooms.add(t),t=this.GenerateAdjacentRoom(0,1),null!=t&&this.ExitRooms.add(t))},GenerateAdjacentRoom:function(t,e){var i=5,n=13,r=n-i|0,o=Bridge.Int.clip32(i+Math.random()*r),a=Bridge.Int.clip32(i+Math.random()*r),s=-1,h=-1;if(0!==t?(h=Bridge.Int.clip32(this.SY+Math.random()*(this.EY-this.SY|0)),s=0>t?this.SX-o|0:this.EX):0!==e&&(s=Bridge.Int.clip32(this.SX+Math.random()*(this.EX-this.SX|0)),h=0>e?this.SY-a|0:this.EY),s>=0&&h>=0){var l=new CirnoGame.MapRoom;if(l.SX=s,l.SY=h,l.EX=s+o|0,l.EY=h+a|0,l.parent=this,l.game=this.game,l.CanBePlaced())return l}return null},PlaceAndExpand:function(){return this.ExitRooms.Count<1&&!this.placed&&this.CanBePlaced()?(this.Place(),this.placed&&this.GenerateAdjacentRooms(),this.placed):(this.placed||null!=this.parent&&CirnoGame.HelperExtensions.ContainsB$1(Bridge.global.CirnoGame.MapRoom,this.parent.ExitRooms,this)&&this.parent.ExitRooms.remove(this),!1)},Place:function(){var t=this.game.TM;t.ClearRect$1(this.SX,this.SY,this.EX-this.SX|0,this.EY-this.SY|0),t._GenRect(this.SX,this.SY,this.EX,this.EY),CirnoGame.MapRoom.PlacedRooms.add(this),this.placed=!0},FindEmptySpot:function(){for(var t=this.EX-this.SX|0,e=this.EY-this.SY|0,i=0,n=this.game.TM;50>i;){var r=Bridge.Int.clip32(this.SX+Math.random()*t),o=Bridge.Int.clip32(this.SY+Math.random()*e),a=n.GetTile(r,o);if(!(null==a||a.enabled&&a.solid||(a=n.GetTile(r,o-1|0),null==a||a.enabled&&a.solid)))return new CirnoGame.Vector2(n.position.X+r*n.tilesize,n.position.Y+o*n.tilesize);i=i+1|0}return null}}}),Bridge.ns("CirnoGame.MapRoom",$asm.$),Bridge.apply($asm.$.CirnoGame.MapRoom,{f1:function(t){return t.CanBePlaced()&&!t.placed}}),Bridge.define("CirnoGame.MathHelper",{statics:{fields:{PI:0,PI2:0,PIOver2:0},ctors:{init:function(){this.PI=3.14159274,this.PI2=6.28318548,this.PIOver2=1.57079637}},methods:{DistanceBetweenPoints:function(t,e){return CirnoGame.MathHelper.DistanceBetweenPoints$1(t.X,t.Y,e.X,e.Y)},DistanceBetweenPoints$1:function(t,e,i,n){return Math.sqrt(Math.pow(t-i,2)+Math.pow(e-n,2))},Clamp$1:function(t,e,i){return Math.min(i,Math.max(e,t))},Clamp:function(t,e,i){return void 0===e&&(e=0),void 0===i&&(i=1),Math.min(i,Math.max(e,t))},Lerp$1:function(t,e,i){return t+(e-t)*i},Lerp:function(t,e,i){return i=CirnoGame.MathHelper.Clamp(i),t*(1-i)+e*i},DegreesToRadians:function(t){return.0174532924*t},RadiansToDegrees:function(t){return 57.29578*t},GetAngle$1:function(t,e){var i=Math.atan2(e.Y-t.Y,e.X-t.X);return i},GetAngle:function(t){var e=Math.atan2(t.Y,t.X);return e},RoughDistanceBetweenPoints:function(t,e){return CirnoGame.Vector2.op_Subtraction(t,e).RoughLength},MagnitudeOfRectangle:function(t){return t.width+t.height},WrapRadians:function(t){for(;-3.14159274>t;)t+=CirnoGame.MathHelper.PI2;for(;t>=CirnoGame.MathHelper.PI;)t-=CirnoGame.MathHelper.PI2;return t},incrementTowards:function(t,e,i){return e>t&&(t+=i,t>e&&(t=e)),t>e&&(t-=i,e>t&&(t=e)),t},incrementTowards$1:function(t,e,i,n){return e>t&&(t+=i,t>e&&(t=e)),t>e&&(t-=n,e>t&&(t=e)),t},RadianToVector:function(t){return new CirnoGame.Vector2(Math.cos(t),Math.sin(t))},Within:function(t,e,i){return t>=e&&i>=t},Mean:function(t){void 0===t&&(t=[]);for(var e=0,i=0;i<t.length;)e+=t[System.Array.index(i,t)],i=i+1|0;return e/=t.length},Decelerate:function(t,e){var i=t>=0;return t=(i?t:-t)-e,0>t?0:i?t:-t}}}}),Bridge.define("CirnoGame.Point",{fields:{X:0,Y:0},ctors:{ctor:function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.$initialize(),this.X=t,this.Y=e}}}),Bridge.define("CirnoGame.Rectangle",{statics:{methods:{op_Addition:function(t,e){return new CirnoGame.Rectangle(t.x+e.X,t.y+e.Y,t.width,t.height)},op_Subtraction:function(t,e){return new CirnoGame.Rectangle(t.x-e.X,t.y-e.Y,t.width,t.height)}}},fields:{x:0,y:0,width:0,height:0},props:{left:{get:function(){return this.x},set:function(t){this.x=t}},top:{get:function(){return this.y},set:function(t){this.y=t}},right:{get:function(){return this.x+this.width},set:function(t){this.width=t-this.x}},bottom:{get:function(){return this.y+this.height},set:function(t){this.height=t-this.y}},points:{get:function(){var t=System.Array.init(8,0,System.Single),e=0;return t[System.Array.index(Bridge.identity(e,e=e+1|0),t)]=this.x,t[System.Array.index(Bridge.identity(e,e=e+1|0),t)]=this.y,t[System.Array.index(Bridge.identity(e,e=e+1|0),t)]=this.right,t[System.Array.index(Bridge.identity(e,e=e+1|0),t)]=this.y,t[System.Array.index(Bridge.identity(e,e=e+1|0),t)]=this.right,t[System.Array.index(Bridge.identity(e,e=e+1|0),t)]=this.bottom,t[System.Array.index(Bridge.identity(e,e=e+1|0),t)]=this.x,t[System.Array.index(Bridge.identity(e,e=e+1|0),t)]=this.bottom,t}},Center:{get:function(){return new CirnoGame.Vector2(this.left+this.width/2,this.top+this.height/2)}},Min:{get:function(){return new CirnoGame.Vector2(this.x,this.y)},set:function(t){CirnoGame.Vector2.op_Equality(t,null)||(this.x=t.X,this.y=t.Y)}},Max:{get:function(){return new CirnoGame.Vector2(this.right,this.bottom)},set:function(t){CirnoGame.Vector2.op_Equality(t,null)||(this.right=t.X,this.bottom=t.Y)}}},ctors:{init:function(){this.x=0,this.y=0,this.width=0,this.height=0},ctor:function(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),this.$initialize(),this.x=t,this.y=e,this.width=i,this.height=n}},methods:{CopyFrom:function(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height},GetCenter:function(t){t.X=this.left+this.width/2,t.Y=this.top+this.height/2},containsPoint$1:function(t,e){return t>=this.x&&e>=this.y&&t<=this.right&&e<=this.bottom?!0:!1},containsPoint:function(t){return t.X>=this.x&&t.Y>=this.y&&t.X<=this.right&&t.Y<=this.bottom?!0:!1},intersects:function(t){for(var e=t.points,i=!1,n=!1,r=0;r<e.length;)this.containsPoint$1(e[System.Array.index(Bridge.identity(r,r=r+1|0),e)],e[System.Array.index(Bridge.identity(r,r=r+1|0),e)])?i=!0:n=!0;return i&&n?!0:t.left<this.left&&t.right>this.right&&(this.top<=t.top&&this.bottom>=t.top||this.top<=t.bottom&&this.bottom>=t.bottom)?!0:t.top<this.top&&t.bottom>this.bottom&&(this.left<=t.left&&this.right>=t.left||this.left<=t.right&&this.right>=t.right)?!0:!1;
},isTouching:function(t){if(null==t)return!1;for(var e=t.points,i=0;i<e.length;)if(this.containsPoint$1(e[System.Array.index(Bridge.identity(i,i=i+1|0),e)],e[System.Array.index(Bridge.identity(i,i=i+1|0),e)]))return!0;return this.intersects(t)?!0:!1},Set:function(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),this.x=t,this.y=e,this.width=i,this.height=n}}}),Bridge.define("CirnoGame.RectangleI",{statics:{methods:{op_Addition:function(t,e){return new CirnoGame.RectangleI(t.x+e.X|0,t.y+e.Y|0,t.width,t.height)},op_Subtraction:function(t,e){return new CirnoGame.RectangleI(t.x-e.X|0,t.y-e.Y|0,t.width,t.height)}}},fields:{x:0,y:0,width:0,height:0},props:{left:{get:function(){return this.x},set:function(t){this.x=t}},top:{get:function(){return this.y},set:function(t){this.y=t}},right:{get:function(){return this.x+this.width|0},set:function(t){this.width=t-this.x|0}},bottom:{get:function(){return this.y+this.height|0},set:function(t){this.height=t-this.y|0}},points:{get:function(){var t=System.Array.init(8,0,System.Int32),e=0;return t[System.Array.index(Bridge.identity(e,e=e+1|0),t)]=this.x,t[System.Array.index(Bridge.identity(e,e=e+1|0),t)]=this.y,t[System.Array.index(Bridge.identity(e,e=e+1|0),t)]=this.right,t[System.Array.index(Bridge.identity(e,e=e+1|0),t)]=this.y,t[System.Array.index(Bridge.identity(e,e=e+1|0),t)]=this.right,t[System.Array.index(Bridge.identity(e,e=e+1|0),t)]=this.bottom,t[System.Array.index(Bridge.identity(e,e=e+1|0),t)]=this.x,t[System.Array.index(Bridge.identity(e,e=e+1|0),t)]=this.bottom,t}},Center:{get:function(){return new CirnoGame.Point(this.left+(0|Bridge.Int.div(this.width,2))|0,this.top+(0|Bridge.Int.div(this.height,2))|0)}},Min:{get:function(){return new CirnoGame.Point(this.x,this.y)},set:function(t){null!=t&&(this.x=t.X,this.y=t.Y)}},Max:{get:function(){return new CirnoGame.Point(this.right,this.bottom)},set:function(t){null!=t&&(this.right=t.X,this.bottom=t.Y)}}},ctors:{init:function(){this.x=0,this.y=0,this.width=0,this.height=0},ctor:function(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),this.$initialize(),this.x=t,this.y=e,this.width=i,this.height=n}},methods:{containsPoint$1:function(t,e){return t>=this.x&&e>=this.y&&t<=this.right&&e<=this.bottom?!0:!1},containsPoint:function(t){return t.X>=this.x&&t.Y>=this.y&&t.X<=this.right&&t.Y<=this.bottom?!0:!1},intersects:function(t){for(var e=t.points,i=!1,n=!1,r=0;r<e.length;)this.containsPoint$1(e[System.Array.index(Bridge.identity(r,r=r+1|0),e)],e[System.Array.index(Bridge.identity(r,r=r+1|0),e)])?i=!0:n=!0;return i&&n?!0:t.left<this.left&&t.right>this.right&&(this.top<=t.top&&this.bottom>=t.top||this.top<=t.bottom&&this.bottom>=t.bottom)?!0:t.top<this.top&&t.bottom>this.bottom&&(this.left<=t.left&&this.right>=t.left||this.left<=t.right&&this.right>=t.right)?!0:!1},isTouching:function(t){if(null==t)return!1;for(var e=t.points,i=0;i<e.length;)if(this.containsPoint$1(e[System.Array.index(Bridge.identity(i,i=i+1|0),e)],e[System.Array.index(Bridge.identity(i,i=i+1|0),e)]))return!0;return this.intersects(t)?!0:!1}}}),Bridge.define("CirnoGame.Renderer",{fields:{view:null},ctors:{ctor:function(t,e,i){void 0===t&&(t=800),void 0===e&&(e=600),void 0===i&&(i=1087931),this.$initialize(),this.view=new PIXI.Application(t,e,{backgroundColor:i})}}}),Bridge.define("CirnoGame.TileData",{fields:{texture:0,row:0,column:0,enabled:!1,map:null,visible:!1,topSolid:!1,rightSolid:!1,leftSolid:!1,bottomSolid:!1,CanSlope:!1,Breakable:!1,HP:0,maxHP:0,_hitbox:null},props:{solid:{get:function(){return this.topSolid&&this.rightSolid&&this.leftSolid&&this.bottomSolid},set:function(t){this.topSolid=t,this.leftSolid=t,this.rightSolid=t,this.bottomSolid=t}},platform:{get:function(){return this.topSolid&&!this.rightSolid&&!this.leftSolid&&!this.bottomSolid}},IsSlope:{get:function(){return 0!==this.SlopeDirection}},SlopeDirection:{get:function(){if(!this.CanSlope)return 0;var t=this.GetTileData(0,1);if(null==t||!t.enabled||!t.solid)return 0;var e=this.GetTileData(-1,0),i=this.GetTileData(1,0),n=null!=e&&e.enabled&&e.solid,r=null!=i&&i.enabled&&i.solid;if(!this.CanSlope||!this.solid||n&&r||!r&&!n)return 0;var o=this.GetTileData(0,-1),a=null!=o&&o.enabled&&o.solid;return a?0:r?1:-1}}},ctors:{init:function(){this.Breakable=!1,this.HP=4,this.maxHP=4}},methods:{Clone:function(){var t=new CirnoGame.TileData;return t.texture=this.texture,t.enabled=this.enabled,t.map=this.map,t.visible=this.visible,t.topSolid=this.topSolid,t.rightSolid=this.rightSolid,t.leftSolid=this.leftSolid,t.bottomSolid=this.bottomSolid,t.CanSlope=this.CanSlope,t},Damage:function(t){this.HP-=t,this.HP<=0&&this.topSolid?(this.solid=!1,this.visible=!1,this.enabled=!1,this.UpdateTile(),this.SpawnParticles()):this.map.RedrawTile(this.column,this.row,!1)},UpdateTile:function(){this.map.RedrawTile(this.column,this.row)},SpawnParticles:function(){var t=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(this.texture,0,this.map.tiles.Count-1|0)),e=this.map.tiles.getItem(t),i=Bridge.Int.clip32(this.map.tilesize/2),n=this.map.game,r=this.GetHitbox(),o=1,a=document.createElement("canvas");a.width=i,a.height=i;var s=CirnoGame.Helper.GetContext(a);s.drawImage(e,0,0,i,i,0,0,i,i);var h=new CirnoGame.Particle(n,a);h.Hspeed=0|-o,h.Vspeed=0|-o,h.x=r.left,h.y=r.top,n.AddEntity(h),a=document.createElement("canvas"),a.width=i,a.height=i,s=CirnoGame.Helper.GetContext(a),s.drawImage(e,i,0,i,i,0,0,i,i),h=new CirnoGame.Particle(n,a),h.Hspeed=o,h.Vspeed=0|-o,h.x=r.left+i,h.y=r.top,n.AddEntity(h),a=document.createElement("canvas"),a.width=i,a.height=i,s=CirnoGame.Helper.GetContext(a),s.drawImage(e,0,i,i,i,0,0,i,i),h=new CirnoGame.Particle(n,a),h.Hspeed=0|-o,h.Vspeed=o,h.x=r.left,h.y=r.top+i,n.AddEntity(h),a=document.createElement("canvas"),a.width=i,a.height=i,s=CirnoGame.Helper.GetContext(a),s.drawImage(e,i,i,i,i,0,0,i,i),h=new CirnoGame.Particle(n,a),h.Hspeed=o,h.Vspeed=o,h.x=r.left+i,h.y=r.top+i,n.AddEntity(h)},GetHitbox:function(){var t=this.map.tilesize,e=this.map.position;return new CirnoGame.Rectangle(e.X+this.column*t,e.Y+this.row*t,t,t)},GetTileData:function(t,e){return this.map.GetTile(this.column+t|0,this.row+e|0)},solidToSpeed:function(t){return this.enabled?0===t.RoughLength?this.solid:t.X>0&&this.leftSolid||t.X<0&&this.rightSolid||t.Y>0&&this.topSolid||t.Y>0&&this.bottomSolid?!0:!1:!1},GetTop:function(t){var e=this.SlopeDirection,i=this.map.tilesize;if(0===e){var n=this.map.position;return n.Y+this.row*i}var r=this.GetHitbox(),o=(r.right-t.X)/r.width*i;return e>0&&(o=i-o),o=Math.min(i,Math.max(0,o)),r.bottom-o}}}),Bridge.define("CirnoGame.TileMap",{fields:{position:null,tilesize:0,rows:0,columns:0,data:null,tiles:null,cracks:null,game:null,buffer:null,bg:null,RND:null,Seed:0,needRedraw:!1,AllowSkyBridge:!1,rtmp:null},ctors:{init:function(){this.Seed=0,this.AllowSkyBridge=!1,this.rtmp=new CirnoGame.Rectangle},ctor:function(t,e){void 0===e&&(e=-1),this.$initialize(),this.RND=new System.Random.ctor,this.position=new CirnoGame.Vector2,this.tilesize=16,this.rows=Bridge.Int.clip32(Math.ceil((2*-this.position.Y+t.stageBounds.bottom)/this.tilesize)),this.columns=Bridge.Int.clip32(Math.ceil((2*-this.position.X+t.stageBounds.right)/this.tilesize)),this.data=System.Array.create(null,null,CirnoGame.TileData,this.columns,this.rows),this.tiles=CirnoGame.AnimationLoader.Get("images/land/brick"),this.cracks=CirnoGame.AnimationLoader.Get("images/land/cracks"),this.game=t,this.buffer=document.createElement("canvas"),this.bg=this.buffer.getContext("2d"),0>e?this.Seed=this.RND.next():this.Seed=e,this.Generate()}},methods:{IsRectSolid:function(t,e,i,n){for(var r=t,o=e;n>o;){for(r=e;i>r;){var a=this.data.get([r,o]);if(!a.enabled||!a.topSolid)return!1;r=r+1|0}o=o+1|0}return!0},ForceRedraw:function(){this.needRedraw=!0},Randomize:function(){for(var t=0,e=0;t<this.rows;){for(;e<this.columns;){var i=new CirnoGame.TileData;i.row=t,i.column=e,i.texture=1,i.enabled=this.RND.nextDouble()<.15||t>=(this.rows-1|0),i.topSolid=i.enabled,i.enabled&&t>=(this.rows-1|0)?(i.texture=2,i.solid=!0):i.enabled&&this.RND.nextDouble()<.3&&(i.solid=!0,i.texture=0,this.RND.nextDouble()<.5&&(i.texture=3)),i.visible=i.enabled,i.map=this,this.data.set([e,t],i),e=e+1|0}e=0,t=t+1|0}},Generate:function(){this.RND=new System.Random.$ctor1(this.Seed),this._Gen(),this.needRedraw=!0},_Gen:function(){for(var t=System.Array.init(this.columns,0,System.Int32),e=.6,i=Bridge.Int.clip32(this.rows*e),n=8,r=2,o=0;o<this.columns;)t[System.Array.index(o,t)]=Bridge.Int.clip32(this.RND.nextDouble()*i),o=o+1|0;for(var a=0;r>a;){var s=t;for(t=System.Array.init(this.columns,0,System.Int32),o=0;o<this.columns;)t[System.Array.index(o,t)]=this.blur(s,o,n),o=o+1|0;o=1,a=a+1|0}for(;o<(this.columns-1|0);){var h=t[System.Array.index(o-1|0,t)],l=t[System.Array.index(o+1|0,t)],m=t[System.Array.index(o,t)];h>m==l>m&&m!==h&&(t[System.Array.index(o,t)]=0|Bridge.Int.div(h+l|0,2)),o=o+1|0}for(var d=0,u=0,c=null,p=.9,C=0;d<this.rows;){for(;u<this.columns;){var g=this.rows-t[System.Array.index(u,t)]|0,f=d>=g,G=new CirnoGame.TileData;G.row=d,G.column=u,G.texture=1,G.enabled=f||d>=(this.rows-1|0),G.topSolid=G.enabled,G.bottomSolid=G.enabled,G.enabled&&d>=(this.rows-1|0)?(G.texture=2,G.solid=!0):G.enabled&&(G.solid=!0,G.texture=4,G.CanSlope=!0,this.RND.nextDouble()<.5&&(G.texture=5),d>g&&this.RND.nextDouble()<.02&&(G.texture=6)),G.enabled||(this.AllowSkyBridge&&20===d&&this.RND.nextDouble()<.93||(d+4|0)>=g&&g>(d+2|0)&&this.RND.nextDouble()<.025||null!=c&&c.enabled&&1===c.texture&&this.RND.nextDouble()<p?(G.enabled=!0,G.topSolid=G.enabled,p-=.075):(1>C&&this.RND.nextDouble()<.015&&(C=this.RND.next$1(8)),C>0?(G.enabled=!0,G.topSolid=G.enabled,C=C-1|0):this.RND.nextDouble()<.035?(G.enabled=!0,G.topSolid=G.enabled):(G.enabled=!0,G.topSolid=G.enabled,G.CanSlope=Math.random()<.5))),G.enabled&&1===G.texture||(p=.9),G.visible=G.enabled,G.map=this,G.solid=!0,this.data.set([u,d],G),c=G,u=u+1|0}u=0,d=d+1|0}},_GenRect:function(t,e,i,n){t=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(t,0,this.columns-1|0)),e=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(e,0,this.rows-1|0)),i=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(i,0,this.columns-1|0)),n=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(n,0,this.rows-1|0));for(var r=.6,o=(Bridge.Int.clip32(this.rows*r),e),a=t,s=null,h=.9,l=0;n>o;){for(;i>a;){var m=!1,d=new CirnoGame.TileData;d.row=o,d.column=a,d.texture=1,d.enabled=m||o>=(this.rows-1|0),d.topSolid=d.enabled,d.bottomSolid=d.enabled,d.enabled||(1>l&&this.RND.nextDouble()<.015&&(l=this.RND.next$1(6)),l>0?(d.enabled=!0,d.topSolid=d.enabled,l=l-1|0):this.RND.nextDouble()<.04&&(d.enabled=!0,d.topSolid=d.enabled)),d.enabled&&1===d.texture||(h=.9),d.visible=d.enabled,d.map=this,d.solid=!0,this.data.set([a,o],d),s=d,a=a+1|0}a=t,o=o+1|0}},DrawRect$1:function(t,e,i,n){for(var r=t,o=e,a=r,s=o,h=r+i|0,l=o+n|0;h>a;){var m=new CirnoGame.TileData;m.row=s,m.column=a,m.texture=1,m.enabled=!0,m.visible=!0,m.map=this,m.solid=!0,this.SetTile(a,s,m),a=a+1|0}for(a=r,s=l;h>a;){var d=new CirnoGame.TileData;d.row=s,d.column=a,d.texture=1,d.enabled=!0,d.visible=!0,d.map=this,d.solid=!0,this.SetTile(a,s,d),a=a+1|0}for(a=r,s=o;l>s;){var u=new CirnoGame.TileData;u.row=s,u.column=a,u.texture=1,u.enabled=!0,u.visible=!0,u.map=this,u.solid=!0,this.SetTile(a,s,u),s=s+1|0}for(a=h,s=o;l>s;){var c=new CirnoGame.TileData;c.row=s,c.column=a,c.texture=1,c.enabled=!0,c.visible=!0,c.map=this,c.solid=!0,this.SetTile(a,s,c),s=s+1|0}},DrawRect:function(t){this.DrawRect$1(Bridge.Int.clip32(t.left/this.tilesize),Bridge.Int.clip32(t.top/this.tilesize),Bridge.Int.clip32(t.width/this.tilesize),Bridge.Int.clip32(t.height/this.tilesize))},SetAll:function(t){for(var e=0,i=0;i<this.rows;){for(e=0;e<this.columns;){var n=t.Clone();n.column=e,n.row=i,this.data.set([e,i],t),e=e+1|0}i=i+1|0}},ClearRect$1:function(t,e,i,n){var r=t,o=e,a=r+i|0,s=o+n|0;r=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(r,0,this.columns-1|0)),o=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(o,0,this.rows-1|0)),a=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(a,0,this.columns-1|0)),s=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(s,0,this.rows-1|0));var h=r,l=o,m=new CirnoGame.TileData;for(m.map=this,m.visible=!1,m.solid=!1;s>l;){for(h=r;a>h;){var d=m.Clone();d.column=h,d.row=l,this.data.set([h,l],d),h=h+1|0}l=l+1|0}},ClearRect:function(t){var e=Bridge.Int.clip32(t.left/this.tilesize),i=Bridge.Int.clip32(t.top/this.tilesize),n=Bridge.Int.clip32(t.right/this.tilesize),r=Bridge.Int.clip32(t.height/this.tilesize),o=e,a=i,s=new CirnoGame.TileData;for(s.map=this,s.visible=!1,s.solid=!1;r>a;){for(o=e;n>o;){var h=s.Clone();h.column=o,h.row=a,this.data.set([o,a],h),o=o+1|0}a=a+1|0}},SetTile:function(t,e,i){t>=0&&e>=0&&t<System.Array.getLength(this.data,0)&&e<System.Array.getLength(this.data,1)&&this.data.set([t,e],i)},blur:function(t,e,i){void 0===i&&(i=1);var n=0,r=0,o=0,a=e;for(a>=0&&a<t.length&&(n=n+1|0,r=r+t[System.Array.index(a,t)]|0);i>o;)a=a-1|0,a>=0&&a<t.length&&(n=n+1|0,r=r+t[System.Array.index(a,t)]|0),o=o+1|0;for(o=0;i>o;)a=a+1|0,a>=0&&a<t.length&&(n=n+1|0,r=r+t[System.Array.index(a,t)]|0),o=o+1|0;return 0|Bridge.Int.div(r,n)},CheckForTile:function(t){var e=this.position,i=Bridge.Int.clip32((t.X-e.X)/this.tilesize),n=Bridge.Int.clip32((t.Y-e.Y)/this.tilesize);return i>=0&&i<this.columns&&n>=0&&n<this.rows?this.data.get([i,n]):null},GetTile:function(t,e){return t>=0&&e>=0&&t<this.columns&&e<this.rows?this.data.get([t,e]):null},_Draw:function(){if(this.needRedraw){var t=Bridge.Int.clip32(Math.ceil(this.columns*this.tilesize)),e=Bridge.Int.clip32(Math.ceil(this.rows*this.tilesize));this.buffer.width!==t||this.buffer.height!==e?(this.buffer.width=t,this.buffer.height=e):this.bg.clearRect(0,0,this.buffer.width,this.buffer.height),this.Redraw(this.bg),this.needRedraw=!1}},Draw:function(t){this._Draw(),this.rtmp.CopyFrom(this.game.camera.CameraBounds),this.rtmp.x-=1,this.rtmp.y-=1,this.rtmp.width+=2,this.rtmp.height+=2;var e=this.rtmp;t.drawImage(this.buffer,e.left-this.position.X,e.top-this.position.Y,e.width,e.height,e.left,e.top,e.width,e.height)},RedrawTile:function(t,e,i){if(void 0===i&&(i=!0),i){var n=Bridge.Int.mul(t-1|0,Bridge.Int.clip32(this.tilesize)),r=Bridge.Int.mul(e-1|0,Bridge.Int.clip32(this.tilesize));this.bg.clearRect(n,r,Bridge.Int.mul(Bridge.Int.clip32(this.tilesize),3),Bridge.Int.mul(Bridge.Int.clip32(this.tilesize),3)),this.Redraw(this.bg,t-1|0,e-1|0,3,3)}else{var o=Bridge.Int.mul(t,Bridge.Int.clip32(this.tilesize)),a=Bridge.Int.mul(e,Bridge.Int.clip32(this.tilesize));this.bg.clearRect(o,a,this.tilesize,this.tilesize),this.Redraw(this.bg,t,e,1,1)}},Redraw:function(t,e,i,n,r){void 0===e&&(e=-1),void 0===i&&(i=-1),void 0===n&&(n=-1),void 0===r&&(r=-1);var o=this.position.X,a=this.position.Y;o=0,a=0,-1===e&&(e=0),-1===i&&(i=0),-1===n&&(n=this.columns),-1===r&&(r=this.rows);var s=e+n|0,h=i+r|0;e=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(e,0,this.columns)),i=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(i,0,this.rows)),s=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(s,0,this.columns)),h=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(h,0,this.rows));for(var l=o+e*this.tilesize,m=a+i*this.tilesize,d=i,u=e,c=this.tiles.getItem(2),p=this.tiles.getItem(3);h>d;){for(;s>u;){var C=this.data.get([u,d]),g=Math.min(this.tiles.Count-1|0,C.texture);if(C.enabled&&g>=0&&g<this.tiles.Count){if(t.drawImage(this.tiles.getItem(g),l,m),C.Breakable&&C.HP<C.maxHP){var f=Bridge.Int.clip32(Math.max(1,Math.min(Bridge.Math.round(C.maxHP-C.HP,0,6),3)))-1|0;t.drawImage(this.cracks.getItem(f),l,m)}var G=C.SlopeDirection;if(0!==G){t.globalCompositeOperation="destination-out";var y=C.GetHitbox();y.x-=this.position.X,y.y-=this.position.Y,t.beginPath(),t.moveTo(y.left,y.top);var S;S=new CirnoGame.Vector2(y.left+y.width/2,y.top+y.height/2),G>0?t.lineTo(y.left,y.bottom):t.lineTo(y.right,y.bottom),t.lineTo(y.right,y.top),t.lineTo(y.left,y.top),t.fill(),t.globalCompositeOperation="destination-over",t.drawImage(c,l,m),t.globalCompositeOperation="source-over"}}else t.drawImage(Math.random()<.98?c:p,l,m);u=u+1|0,l+=this.tilesize}l=o+e*this.tilesize,m+=this.tilesize,u=e,d=d+1|0}},IsExposed:function(t,e){for(var i=e-2|0,n=t-2|0;(e+2|0)>=i;){for(;(t+2|0)>=n;){if(i>=0&&n>=0&&i<this.rows&&n<this.columns){var r=this.data.get([n,i]);if(!r.enabled||!r.solid)return!0}n=n+1|0}i=i+1|0,n=t-2|0}return!1},ApplyBreakable:function(){for(var t=0,e=0;t<this.rows;){for(;e<this.columns;){var i=this.data.get([e,t]),n=i.Clone();n.column=e,n.row=t,this.data.set([e,t],n),i=n,this.IsExposed(e,t)?(i.texture=1,Math.random()<.02&&(i.texture=Math.random()<.5?5:6),i.Breakable=!0):(i.texture=0,i.Breakable=!1),e=e+1|0}t=t+1|0,e=0}this.needRedraw=!0},testTexture:function(){for(var t=0,e=0;t<this.rows;){for(;e<this.columns;){var i=this.data.get([e,t]);i.texture=Math.random()<.5?0:1,e=e+1|0}t=t+1|0,e=0}this.needRedraw=!0}}}),Bridge.define("CirnoGame.Vector2",{statics:{props:{Empty:{get:function(){return new CirnoGame.Vector2}}},methods:{FromRadian:function(t){return CirnoGame.MathHelper.RadianToVector(t)},Add:function(t,e){return new CirnoGame.Vector2(t.X+e.X,t.Y+e.Y)},Add$1:function(t,e,i){return new CirnoGame.Vector2(t.X+e,t.Y+i)},Subtract:function(t,e){return new CirnoGame.Vector2(t.X-e.X,t.Y-e.Y)},Subtract$1:function(t,e,i){return new CirnoGame.Vector2(t.X-e,t.Y-i)},op_Equality:function(t,e){var i=t,n=e;return null!=i&&null!=n||null==i&&null==n?null==i&&null==n?!0:t.X===e.X&&t.Y===e.Y:!1},op_Inequality:function(t,e){return!CirnoGame.Vector2.op_Equality(t,e)},op_Multiply:function(t,e){return new CirnoGame.Vector2(t.X*e,t.Y*e)},op_Division:function(t,e){return new CirnoGame.Vector2(t.X/e,t.Y/e)},op_Addition:function(t,e){return new CirnoGame.Vector2(t.X+e.X,t.Y+e.Y)},op_Subtraction:function(t,e){return new CirnoGame.Vector2(t.X-e.X,t.Y-e.Y)}}},fields:{X:0,Y:0},props:{Length:{get:function(){return Math.sqrt(this.X*this.X+this.Y*this.Y)}},EstimatedLength:{get:function(){var t=Math.abs(this.X),e=Math.abs(this.Y);if(e>t){var i=t;t=e,e=i}return e*=.34,t+e}},RoughLength:{get:function(){return Math.abs(this.X)+Math.abs(this.Y)}}},ctors:{ctor:function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.$initialize(),this.X=t,this.Y=e}},methods:{Distance:function(t){var e=this.X-t.X,i=this.Y-t.Y;return Math.sqrt(e*e+i*i)},EstimatedDistance:function(t){var e=Math.abs(this.X-t.X),i=Math.abs(this.Y-t.Y);if(i>e){var n=e;e=i,i=n}return i*=.34,e+i},Multiply:function(t){this.X*=t,this.Y*=t},RoughNormalize:function(t){void 0===t&&(t=1);var e=this.Length/t;return new CirnoGame.Vector2(this.X/e,this.Y/e)},Normalize:function(t){void 0===t&&(t=1);var e=Math.sqrt(this.X*this.X+this.Y*this.Y),i=new CirnoGame.Vector2;return i.X=this.X/e,i.Y=this.Y/e,i.X*=t,i.Y*=t,i},SetAsNormalize:function(t){void 0===t&&(t=1);var e=Math.sqrt(this.X*this.X+this.Y*this.Y);this.X=this.X/e,this.Y=this.Y/e,this.X*=t,this.Y*=t},ToCardinal:function(){var t=this.X,e=this.Y,i=Math.abs(this.X),n=Math.abs(this.Y);return n>i?t=0:i>n&&(e=0),new CirnoGame.Vector2(t,e)},Equals:function(t){var e=t;return CirnoGame.Vector2.op_Inequality(this,e)&&CirnoGame.Vector2.op_Equality(e,null)?!1:e.X===this.X&&e.Y===this.Y},equals:function(t){if(Bridge.is(t,CirnoGame.Vector2)){var e=Bridge.cast(t,CirnoGame.Vector2);return CirnoGame.Vector2.op_Inequality(this,e)&&CirnoGame.Vector2.op_Equality(e,null)?!1:e.X===this.X&&e.Y===this.Y}return Bridge.equals(this,t)},ToAngle:function(){return CirnoGame.MathHelper.WrapRadians(CirnoGame.MathHelper.GetAngle(this))},Clone:function(){return new CirnoGame.Vector2(this.X,this.Y)},CopyFrom:function(t){CirnoGame.Vector2.op_Equality(t,null)||(this.X=t.X,this.Y=t.Y)},Rotate:function(t){var e=this.ToAngle()+t;return CirnoGame.Vector2.FromRadian(e).Normalize(this.Length)},Add:function(t){this.X+=t.X,this.Y+=t.Y},Subtract:function(t){this.X-=t.X,this.Y-=t.Y}}}),Bridge.define("CirnoGame.AimedShooter",{inherits:[CirnoGame.EntityBehavior],fields:{time:0,maxtime:0,Target:null,maxDistance:0,attackpower:0},ctors:{init:function(){this.time=0,this.maxtime=480,this.maxDistance=130,this.attackpower=1},ctor:function(t){this.$initialize(),CirnoGame.EntityBehavior.ctor.call(this,t),t.Ani.Shadowcolor="#FF0000"}},methods:{Update:function(){CirnoGame.EntityBehavior.prototype.Update.call(this),this.UpdateTarget();var t=this.entity.Ani;null!=this.Target?(this.time<60?t.Shadow=5:t.Shadow=0,this.time=this.time-1|0,this.time<=0&&(this.ResetTimer(),this.Shoot())):t.Shadow=0},UpdateTarget:function(){if(null!=this.Target){if(!(this.Target.Position.EstimatedDistance(this.entity.Position)>this.maxDistance))return;this.Target=null}var t=this.entity.Game.player;t.Position.EstimatedDistance(this.entity.Position)<this.maxDistance&&(this.Target=t,this.ResetTimer())},ResetTimer:function(){this.time=0|Bridge.Int.div(this.maxtime,2),this.time=this.time+Bridge.Int.clip32(Bridge.Math.round(this.time*Math.random(),0,6))|0},Shoot:function(){if(!(null==this.Target||Bridge.cast(this.Target,CirnoGame.ICombatant).CirnoGame$ICombatant$HP<=0)){var t=new CirnoGame.PlayerBullet(this.entity.Game,this.entity,"images/misc/ebullet");t.Position.CopyFrom(this.entity.getCenter());var e=CirnoGame.Vector2.op_Subtraction(this.Target.getCenter(),t.Position);e.SetAsNormalize(.5),t.Hspeed=e.X,t.Vspeed=e.Y,t.touchDamage=this.attackpower,this.entity.Game.AddEntity(t)}}}}),Bridge.define("CirnoGame.BoundsRestrictor",{inherits:[CirnoGame.EntityBehavior],fields:{bounds:null,bottom:!1},ctors:{init:function(){this.bottom=!1},ctor:function(t){this.$initialize(),CirnoGame.EntityBehavior.ctor.call(this,t)}},methods:{Update:function(){CirnoGame.EntityBehavior.prototype.Update.call(this);var t=this.bounds;null==t&&(t=this.entity.Game.stageBounds);var e=this.entity.Position;e.X=CirnoGame.MathHelper.Clamp$1(e.X,t.left,t.right),this.bottom?e.Y=CirnoGame.MathHelper.Clamp$1(e.Y,t.top,t.bottom):e.Y=Math.max(e.Y,t.top)}}}),Bridge.define("CirnoGame.ButtonSprite",{inherits:[CirnoGame.Sprite],fields:{_buttonNeedsRerender:!1,_buttonBuffer:null,_buttonGraphic:null,Data:null,_contents:null,_borderSize:0,_borderColor:null,LockedClickSound:null,ClickSound:null,_buttonColor:null,ColorSchemes:null,locked:!1,OnClick:null,LContentSize:null},props:{Contents:{get:function(){return this._contents},set:function(t){Bridge.referenceEquals(this._contents,t)||(this._contents=t,this._buttonNeedsRerender=!0)}},BorderSize:{get:function(){return this._borderSize},set:function(t){this._borderSize!==t&&(this._borderSize=t,this._buttonNeedsRerender=!0)}},BorderColor:{get:function(){return this._borderColor},set:function(t){Bridge.referenceEquals(this._borderColor,t)||(this._borderColor=t,this._buttonNeedsRerender=!0)}},ButtonColor:{get:function(){return this._buttonColor},set:function(t){Bridge.referenceEquals(this._buttonColor,t)||(this._buttonColor=t,this._buttonNeedsRerender=!0)}}},ctors:{init:function(){this.LockedClickSound="hit",this.ClickSound="select",this.locked=!1,this.LContentSize=new CirnoGame.Vector2},ctor:function(t,e,i,n,r){void 0===e&&(e=2),void 0===i&&(i="#00AA33"),void 0===n&&(n="#11CC55"),void 0===r&&(r=null),this.$initialize(),CirnoGame.Sprite.ctor.call(this),this.Contents=t,this.BorderSize=e,this.BorderColor=i,this.ButtonColor=n,this._buttonBuffer=new CirnoGame.Sprite,this._buttonBuffer.Size=t.Size,this._buttonGraphic=this._buttonBuffer.GetGraphics(),this._buttonNeedsRerender=!0,this.ColorSchemes=new(System.Collections.Generic.List$1(CirnoGame.ButtonSprite.ColorScheme)),this.ColorSchemes.add(new CirnoGame.ButtonSprite.ColorScheme(i,n)),this.ColorSchemes.add(new CirnoGame.ButtonSprite.ColorScheme("#FFFFFF","#FF0000")),this.ColorSchemes.add(new CirnoGame.ButtonSprite.ColorScheme("#777777","#CCCCCC")),this.Data=r,null==r&&Bridge.is(t,CirnoGame.TextSprite)&&(this.Data=Bridge.cast(t,CirnoGame.TextSprite).Text),this.Draw(null)}},methods:{SetColorScheme:function(t){this.BorderColor=t.BorderColor,this.ButtonColor=t.ButtonColor},SetColorScheme$1:function(t){var e=this.ColorSchemes.getItem(t);this.SetColorScheme(e)},drawButton:function(){var t=this._buttonGraphic,e=this._borderSize+this._borderSize|0;this._buttonBuffer.Size=CirnoGame.Vector2.op_Addition(this.Contents.Size,new CirnoGame.Vector2(e,e));var i=this._buttonBuffer.Size;t.fillStyle=this._borderColor,t.fillRect(0,0,i.X,i.Y),t.fillStyle=this.ButtonColor,t.fillRect(this._borderSize,this._borderSize,Bridge.Int.clip32(i.X)-e|0,Bridge.Int.clip32(i.Y)-e|0);var n="rgba(255,255,255,0)",r=t.createLinearGradient(0,0,0,i.Y);r.addColorStop(0,n),r.addColorStop(.4,"white"),r.addColorStop(1,n),t.fillStyle=r,t.fillRect(0,0,this._buttonBuffer.Size.X,this._buttonBuffer.Size.Y)},Lock:function(t){void 0===t&&(t=!0),this.locked||(this.locked=!0,t&&this.SetColorScheme$1(2))},Unlock:function(t){void 0===t&&(t=!0),this.locked&&(this.locked=!1,t&&this.SetColorScheme$1(0))},CheckClick:function(t){if(this.Visible&&this.GetBounds().containsPoint(t)){if(this.locked)return Bridge.referenceEquals(this.LockedClickSound,"")||null==this.LockedClickSound||CirnoGame.AudioManager._this.Blast(System.String.concat("SFX/",this.LockedClickSound,".ogg")),!1;Bridge.referenceEquals(this.ClickSound,"")||null==this.ClickSound||CirnoGame.AudioManager._this.Blast(System.String.concat("SFX/",this.ClickSound,".ogg"));var e=this.OnClick;return e&&this.OnClick(),!0}return!1},Draw:function(t){(this._contents.Size.X!==this.LContentSize.X||this._contents.Size.Y!==this.LContentSize.Y)&&(this._buttonNeedsRerender=!0,this.LContentSize=this._contents.Size.Clone()),this._buttonNeedsRerender&&(this.drawButton(),this._buttonNeedsRerender=!1),this.Size=this._buttonBuffer.Size.Clone(),this._buttonBuffer.Draw(this.spriteGraphics),this.Contents.Position=new CirnoGame.Vector2(this._borderSize,this._borderSize),this.Contents.Draw(this.spriteGraphics),null!=t&&CirnoGame.Sprite.prototype.Draw.call(this,t)}}}),Bridge.define("CirnoGame.Chest",{inherits:[CirnoGame.Entity],props:{Opened:!1},ctors:{ctor:function(t){this.$initialize(),CirnoGame.Entity.ctor.call(this,t),this.Ani=new CirnoGame.Animation(CirnoGame.AnimationLoader._this.GetAnimation("images/misc/chest")),this.Ani.ImageSpeed=0}},methods:{Update:function(){CirnoGame.Entity.prototype.Update.call(this);var t=this.GetFloor();null==t?this.Vspeed=1:(this.Vspeed=0,this.y=t.GetHitbox().top-this.Ani.CurrentImage.height);var e=this.Game.player;!this.Opened&&e.Position.EstimatedDistance(this.Position)<16&&e.Controller[System.Array.index(2,e.Controller)]&&e.keys>0&&(e.keys=e.keys-1|0,this.Open(e))},Open:function(t){if(!this.Opened){this.Ani.CurrentFrame=1,this.Ani.SetImage(),this.Ani.Update(),this.Opened=!0;for(var e="",i=!0,n="",r="#FFFFFF",o=null;i;){var a,s=System.Array.init(["point","point","point","point","point","point","heart","heart","tripleheart","singleorb"],System.String),h=System.Array.init(["attackpower","defensepower","mining"],System.String),l=System.Array.init(["triplejump","cheaperblocks","invincibility"],System.String),m=Math.random();(null==o||Math.random()<.2)&&(.7>m?(o=s,n="common",r="#FFFFFF"):(m=Math.random(),.9>m?(o=h,n="rare",r="#FFBB33"):(o=l,n="legendary",r="#FF55FF"))),a=CirnoGame.HelperExtensions.Pick(System.String,o),i=!1;var d;switch(a){case"point":var u=new CirnoGame.PointItem(this.Game);u.Position.CopyFrom(this.Position),u.Vspeed=-2,u.Hspeed=-2,u.collectionDelay=30,this.Game.AddEntity(u),u=new CirnoGame.PointItem(this.Game),u.Position.CopyFrom(this.Position),u.Vspeed=-2,u.Hspeed=2,u.collectionDelay=30,this.Game.AddEntity(u),e="Points";break;case"heart":if(t.HP>=t.maxHP){i=!0;break}var c=new CirnoGame.HealingItem(this.Game);c.Position.CopyFrom(this.Position),c.Vspeed=-2,c.collectionDelay=30,this.Game.AddEntity(c),e="Heal";break;case"tripleheart":if(t.HP>t.maxHP/3){i=!0;break}var p=new CirnoGame.HealingItem(this.Game);p.Position.CopyFrom(this.Position),p.Vspeed=-2,p.Hspeed=-2,p.collectionDelay=30,this.Game.AddEntity(p),p=new CirnoGame.HealingItem(this.Game),p.Position.CopyFrom(this.Position),p.Vspeed=-2,p.Hspeed=0,p.collectionDelay=30,this.Game.AddEntity(p),p=new CirnoGame.HealingItem(this.Game),p.Position.CopyFrom(this.Position),p.Vspeed=-2,p.Hspeed=2,p.collectionDelay=30,this.Game.AddEntity(p),e="Heal x3";break;case"singleorb":if(this.Game.timeRemaining>0){i=!0;break}d=new CirnoGame.Orb(this.Game),d.Position.CopyFrom(this.Position),d.Vspeed=-2,d.Hspeed=-2,d.collectionDelay=30,this.Game.AddEntity(d),e="Orb";break;case"mining":t.digpower<2?t.digpower+=.5:i=!0,e="Mining Power "+System.Single.format(t.digpower)+"x";break;case"triplejump":var C=t.GetBehavior(CirnoGame.PlatformerControls);C.maxAirJumps<2?C.maxAirJumps=2:i=!0,e="Triple Jump";break;case"cheaperblocks":if(9!==t.blockprice){i=!0;break}t.blockprice=6,e="Blocks are cheaper now";break;case"invincibility":if(1!==t.invincibilitymod){i=!0;break}t.invincibilitymod=2,e="invincibility extended";break;case"attackpower":t.attackpower+=1,e="Attack Power "+Bridge.Int.clip32(t.attackpower);break;case"defensepower":t.defensepower+=1,e="Defensive Power "+Bridge.Int.clip32(t.defensepower);break;default:i=!0}}if(!i&&!Bridge.referenceEquals(e,"")){var g=new CirnoGame.FloatingMessage(this.Game,e);g.Text.TextColor=r,g.Position=new CirnoGame.Vector2(this.x+8,this.y-20),this.Game.AddEntity(g),Bridge.referenceEquals(n,"")||Bridge.referenceEquals(n,"common")?this.PlaySound("jump"):this.PlaySound("ok2B")}}},GetFloor:function(){var t=null,e=this.Width/3,i=this.Height;return null!=t&&t.enabled&&t.topSolid||(t=this.Game.TM.CheckForTile(CirnoGame.Vector2.Add$1(this.Position,this.Width/2,i))),null!=t&&t.enabled&&t.topSolid||(t=this.Game.TM.CheckForTile(CirnoGame.Vector2.Add$1(this.Position,e,i))),null!=t&&t.enabled&&t.topSolid||(t=this.Game.TM.CheckForTile(CirnoGame.Vector2.Add$1(this.Position,this.Width-e,i))),null!=t&&t.enabled&&t.topSolid||(t=null),t}}}),Bridge.define("CirnoGame.CollectableItem",{inherits:[CirnoGame.Entity],fields:{floats:!1,magnetDistance:0,magnetSpeed:0,maxFallSpeed:0,fallaccel:0,itemName:null,collectionDelay:0},ctors:{init:function(){this.floats=!0,this.magnetDistance=35,this.magnetSpeed=8,this.maxFallSpeed=2,this.fallaccel=.1,this.collectionDelay=10},ctor:function(t,e){this.$initialize(),CirnoGame.Entity.ctor.call(this,t),this.Ani=new CirnoGame.Animation(CirnoGame.AnimationLoader.Get(System.String.concat("images/items/",e))),this.Ani.SetImage(),this.itemName=e}},methods:{CanCollect:function(t){return!0},Update:function(){this.collectionDelay>0&&(this.collectionDelay=this.collectionDelay-1|0);var t,e=this.Game.player;if(this.collectionDelay<=0&&this.CanCollect(e)&&(t=e.getCenter()).EstimatedDistance(this.Position)<this.magnetDistance){var i=this.getCenter(),n=CirnoGame.Vector2.op_Subtraction(t,i),r=n.Length,o=this.magnetSpeed,a=o/Math.max(1,r);if(a>=r)return this.Alive=!1,this.Hspeed=0,this.Vspeed=0,this.Position.CopyFrom(this.Game.player.Position),this.onCollected(this.Game.player),void this.PlaySound("powerup");n=n.Normalize(a),this.Hspeed=n.X,this.Vspeed=n.Y}else if(this.floats)this.Hspeed=CirnoGame.MathHelper.Decelerate(this.Hspeed,.1),this.Vspeed=CirnoGame.MathHelper.Decelerate(this.Vspeed,.1);else{var s=this.GetFloor();null==s?this.Vspeed<this.maxFallSpeed?this.Vspeed=Math.min(this.Vspeed+this.fallaccel,this.maxFallSpeed):this.Vspeed=this.maxFallSpeed:(this.Vspeed=0,this.y=s.GetHitbox().top-this.Ani.CurrentImage.height),this.Hspeed=CirnoGame.MathHelper.Decelerate(this.Hspeed,.1)}CirnoGame.Entity.prototype.Update.call(this)},GetFloor:function(){var t=null,e=this.Width/3,i=this.Height;return null!=t&&t.enabled&&t.topSolid||(t=this.Game.TM.CheckForTile(CirnoGame.Vector2.Add$1(this.Position,this.Width/2,i))),null!=t&&t.enabled&&t.topSolid||(t=this.Game.TM.CheckForTile(CirnoGame.Vector2.Add$1(this.Position,e,i))),null!=t&&t.enabled&&t.topSolid||(t=this.Game.TM.CheckForTile(CirnoGame.Vector2.Add$1(this.Position,this.Width-e,i))),null!=t&&t.enabled&&t.topSolid||(t=null),t}}}),Bridge.define("CirnoGame.ControllableEntity",{inherits:[CirnoGame.Entity],fields:{Controller:null,LController:null},ctors:{ctor:function(t){this.$initialize(),CirnoGame.Entity.ctor.call(this,t),this.Controller=System.Array.init(7,!1,System.Boolean),
this.LController=System.Array.init(this.Controller.length,!1,System.Boolean)}},methods:{Pressed:function(t){return this.Controller[System.Array.index(t,this.Controller)]!==this.LController[System.Array.index(t,this.LController)]&&this.Controller[System.Array.index(t,this.Controller)]},Released:function(t){return this.Controller[System.Array.index(t,this.Controller)]!==this.LController[System.Array.index(t,this.LController)]&&!this.Controller[System.Array.index(t,this.Controller)]}}}),Bridge.define("CirnoGame.ExitDoor",{inherits:[CirnoGame.Entity],fields:{reset:0,RT:null,_Opened:!1},props:{Opened:{get:function(){return this._Opened},set:function(t){this._Opened=t,this._Opened?(this.Ani.CurrentFrame=1,this.Ani.SetImage()):(this.Ani.CurrentFrame=0,this.Ani.SetImage())}}},ctors:{init:function(){this.reset=0,this._Opened=!1},ctor:function(t){this.$initialize(),CirnoGame.Entity.ctor.call(this,t),this.Ani=new CirnoGame.Animation(CirnoGame.AnimationLoader.Get("images/misc/door")),this.Ani.ImageSpeed=0,this.Ani.SetImage()}},methods:{DropToGround:function(){for(;null==this.GetFloor();)this.y+=16;var t=this.GetFloor(),e=t.GetHitbox();this.x=e.left,this.y=e.top-32;var i=this.Game.TM.GetTile(t.column,t.row-1|0);null!=i&&i.enabled&&i.topSolid&&(this.y-=16,t=i,console.log("dug door out of the ground")),this.RT=t,this.reset=0},Update:function(){if(CirnoGame.Entity.prototype.Update.call(this),this._Opened){var t=this.Game.player;if(t.Position.EstimatedDistance(this.Position)<20&&t.Controller[System.Array.index(2,t.Controller)]&&(this.Opened=!1,t.score=t.score+Bridge.Int.mul(this.Game.level,10)|0,this.Game.StartNextLevel()),this.reset<2){this.reset=this.reset+1|0;var e=this.RT;null!=e&&2===this.reset&&(e.Breakable=!1,e.texture=0,this.Game.TM.RedrawTile(e.column,e.row))}}},GetFloor:function(){var t=null,e=this.Width/3,i=this.Height;return null!=t&&t.enabled&&t.topSolid||(t=this.Game.TM.CheckForTile(CirnoGame.Vector2.Add$1(this.Position,this.Width/2,i))),null!=t&&t.enabled&&t.topSolid||(t=this.Game.TM.CheckForTile(CirnoGame.Vector2.Add$1(this.Position,e,i))),null!=t&&t.enabled&&t.topSolid||(t=this.Game.TM.CheckForTile(CirnoGame.Vector2.Add$1(this.Position,this.Width-e,i))),null!=t&&t.enabled&&t.topSolid||(t=null),t}}}),Bridge.define("CirnoGame.FlightControls",{inherits:[CirnoGame.EntityBehavior],fields:{accel:0,maxSpeed:0,_platformer:null},ctors:{init:function(){this.accel=.35,this.maxSpeed=1.5},ctor:function(t){this.$initialize(),CirnoGame.EntityBehavior.ctor.call(this,t),this._platformer=t}},methods:{Update:function(){var t=this._platformer.Controller;t[System.Array.index(0,t)]&&this._platformer.Hspeed>-this.maxSpeed&&(this._platformer.Hspeed=Math.max(this._platformer.Hspeed-(this.accel+this._platformer.friction),-this.maxSpeed)),t[System.Array.index(1,t)]&&this._platformer.Hspeed<this.maxSpeed&&(this._platformer.Hspeed=Math.min(this._platformer.Hspeed+(this.accel+this._platformer.friction),this.maxSpeed)),t[System.Array.index(2,t)]&&this._platformer.Vspeed>-this.maxSpeed&&(this._platformer.Vspeed=Math.max(this._platformer.Vspeed-(this.accel+this._platformer.friction),-this.maxSpeed)),t[System.Array.index(3,t)]&&this._platformer.Vspeed<this.maxSpeed&&(this._platformer.Vspeed=Math.min(this._platformer.Vspeed+(this.accel+this._platformer.friction),this.maxSpeed)),CirnoGame.EntityBehavior.prototype.Update.call(this)}}}),Bridge.define("CirnoGame.FloatingMessage",{inherits:[CirnoGame.Entity],fields:{time:0,Text:null,alpha:0},ctors:{init:function(){this.time=30,this.alpha=1},ctor:function(t,e){this.$initialize(),CirnoGame.Entity.ctor.call(this,t),this.Ani=new CirnoGame.Animation(null),this.Text=new CirnoGame.TextSprite,this.Text.Text=e,this.Text.TextColor="#FFFFFF",this.Text.ShadowColor="#000000",this.Text.ShadowOffset=new CirnoGame.Vector2(2,2),this.Text.ShadowBlur=1,this.Text.FontSize=14,this.time=30+Bridge.Int.mul(e.length,20)|0}},methods:{Update:function(){CirnoGame.Entity.prototype.Update.call(this),this.time>0&&(this.time=this.time-1|0,this.time<1&&(this.alpha-=.05,this.alpha<=0&&(this.Alive=!1),this.time=1))},Draw:function(t){this.alpha<1&&(t.globalAlpha=this.alpha),this.Text.ForceUpdate(),this.Text.Position.X=Bridge.Int.clip32(this.Position.X)-(0|Bridge.Int.div(this.Text.spriteBuffer.width,2))|0,this.Text.Position.Y=Bridge.Int.clip32(this.Position.Y)-(0|Bridge.Int.div(this.Text.spriteBuffer.height,2))|0,this.Text.Draw(t),t.globalAlpha=1}}}),Bridge.define("CirnoGame.GameSprite",{inherits:[CirnoGame.Sprite],ctors:{ctor:function(){this.$initialize(),CirnoGame.Sprite.ctor.call(this)}},methods:{Update:function(){},Render:function(){}}}),Bridge.define("CirnoGame.Particle",{inherits:[CirnoGame.Entity],fields:{HP:0,alphatime:0},ctors:{init:function(){this.HP=12,this.alphatime=.2},ctor:function(t,e){this.$initialize(),CirnoGame.Entity.ctor.call(this,t),this.Ani=new CirnoGame.Animation(new(System.Collections.Generic.List$1(HTMLImageElement))(System.Array.init([e],HTMLImageElement)))}},methods:{Update:function(){var t;this.HP=this.HP-1|0,this.HP<=0&&(t=this.Ani.Alpha-this.alphatime,this.Ani.Alpha=t,0>=t&&(this.Alive=!1)),CirnoGame.Entity.prototype.Update.call(this)}}}),Bridge.define("CirnoGame.PlatformerControls",{inherits:[CirnoGame.EntityBehavior],fields:{_platformer:null,accel:0,jumpSpeed:0,maxSpeed:0,maxAirJumps:0,airJumps:0,airjumppower:0},ctors:{init:function(){this.accel=.35,this.jumpSpeed=2.25,this.maxSpeed=1.5,this.maxAirJumps=1,this.airJumps=0,this.airjumppower=.815},ctor:function(t){this.$initialize(),CirnoGame.EntityBehavior.ctor.call(this,t),this._platformer=t}},methods:{Update:function(){var t=this._platformer.Controller;t[System.Array.index(0,t)]&&this._platformer.Hspeed>-this.maxSpeed&&(this._platformer.Hspeed=Math.max(this._platformer.Hspeed-(this.accel+this._platformer.friction),-this.maxSpeed)),t[System.Array.index(1,t)]&&this._platformer.Hspeed<this.maxSpeed&&(this._platformer.Hspeed=Math.min(this._platformer.Hspeed+(this.accel+this._platformer.friction),this.maxSpeed));var e=5;this._platformer.onGround&&(this.airJumps=0),this._platformer.Vspeed>=0&&this._platformer.onGround?this._platformer.Pressed(e)&&this._platformer.onGround&&null==this._platformer.Ceiling&&(this._platformer.Vspeed=-this.jumpSpeed,this.entity.PlaySound("jump")):this.airJumps<this.maxAirJumps&&this._platformer.Pressed(e)&&null==this._platformer.Ceiling&&(this._platformer.Vspeed=-(this.jumpSpeed*this.airjumppower),this.airJumps=this.airJumps+1|0),this._platformer.Vspeed<0&&!t[System.Array.index(e,t)]&&(this._platformer.Vspeed+=2*this._platformer.gravity),CirnoGame.EntityBehavior.prototype.Update.call(this)}}}),Bridge.define("CirnoGame.PlayerBullet",{inherits:[CirnoGame.Entity,CirnoGame.IHarmfulEntity,CirnoGame.ILightSource],fields:{shooter:null,Duration:0,hitEntities:null,piercing:!1,spinrate:0,Gravity:null,Bounces:!1,attacksterrain:!1,digpower:0,_maxLightRadius:0,_touchDamage:0},props:{Attacker:{get:function(){return this.shooter}},IsHarmful:{get:function(){return!0}},lightFlicker:{get:function(){return!1}},lightPosition:{get:function(){return this.getCenter()}},maxLightRadius:{get:function(){return this.Ani.Alpha>=1?this._maxLightRadius:0},set:function(t){this._maxLightRadius=t}},touchDamage:{get:function(){return this._touchDamage},set:function(t){this._touchDamage=t}}},alias:["Attacker","CirnoGame$IHarmfulEntity$Attacker","IsHarmful","CirnoGame$IHarmfulEntity$IsHarmful","lightFlicker","CirnoGame$ILightSource$lightFlicker","lightPosition","CirnoGame$ILightSource$lightPosition","maxLightRadius","CirnoGame$ILightSource$maxLightRadius","touchDamage","CirnoGame$IHarmfulEntity$touchDamage","ontouchDamage","CirnoGame$IHarmfulEntity$ontouchDamage"],ctors:{init:function(){this.Duration=0,this.spinrate=0,this.Gravity=new CirnoGame.Vector2,this.attacksterrain=!1,this.digpower=.5,this._maxLightRadius=1.5,this._touchDamage=1},ctor:function(t,e,i){void 0===i&&(i="Reisenbullet"),this.$initialize(),CirnoGame.Entity.ctor.call(this,t),this.Ani=new CirnoGame.Animation(CirnoGame.AnimationLoader._this.GetAnimation(i)),this.shooter=e,this.piercing=!1,this.hitEntities=new(System.Collections.Generic.List$1(CirnoGame.Entity))}},methods:{GetHitbox:function(){if(null!=this.Ani&&null!=this.Ani.CurrentImage){var t=1.5*this.Ani.CurrentImage.height,e=t/2,i=CirnoGame.Vector2.Subtract$1(this.getCenter(),e,e);return new CirnoGame.Rectangle(i.X,i.Y,t,t)}return null},ontouchDamage:function(t){this.piercing||(this.Alive=!1);var e=!this.hitEntities.contains(Bridge.cast(t,CirnoGame.Entity));return e?(this.hitEntities.add(Bridge.cast(t,CirnoGame.Entity)),!0):!1},Update:function(){CirnoGame.Entity.prototype.Update.call(this),0!==this.spinrate&&(this.Ani.Rotation+=this.spinrate),0!==this.Gravity.RoughLength&&(this.Speed=CirnoGame.Vector2.op_Addition(this.Speed,this.Gravity)),this.Game.stageBounds.containsPoint(this.Position)||(this.Ani.X>0==this.Hspeed>0||this.Ani.X<0==this.Hspeed<0||this.Ani.Y>0==this.Vspeed>0||this.Ani.Y<0==this.Vspeed<0)&&(this.Alive=!1);var t=CirnoGame.Vector2.Add$1(this.Position,8,0),e=null;this.Bounces||(e=this.Game.TM.CheckForTile(new CirnoGame.Vector2(t.X,this.y))),null!=e&&e.enabled&&e.solid?(e.Breakable&&this.attacksterrain&&(this.PlaySound("hit"),e.Damage(this.digpower)),this.Alive=!1):this.Bounces&&(e=this.Game.TM.CheckForTile(CirnoGame.Vector2.op_Addition(t,new CirnoGame.Vector2(this.Speed.X))),null!=e&&e.enabled&&e.solidToSpeed(this.Speed.ToCardinal())&&(this.Speed.X=-this.Speed.X),e=this.Game.TM.CheckForTile(CirnoGame.Vector2.op_Addition(t,new CirnoGame.Vector2(0,this.Speed.Y))),null!=e&&e.enabled&&e.solidToSpeed(this.Speed.ToCardinal())&&(this.Speed.Y=-this.Speed.Y),e=this.Game.TM.CheckForTile(CirnoGame.Vector2.op_Addition(t,this.Speed)),null!=e&&e.enabled&&e.solidToSpeed(this.Speed.ToCardinal())&&(this.Speed.X=-this.Speed.X,this.Speed.Y=-this.Speed.Y)),this.Duration>0&&(this.Duration=this.Duration-1|0,this.Duration<=0&&(this.Duration=1,this.Ani.Alpha-=.2,this.Ani.Alpha<=0&&(this.Alive=!1)))}}}),Bridge.define("CirnoGame.RandomAI",{inherits:[CirnoGame.EntityBehavior],fields:{CE:null},ctors:{ctor:function(t){this.$initialize(),CirnoGame.EntityBehavior.ctor.call(this,t),this.CE=t,this.FramesPerTick=15}},methods:{Update:function(){if(CirnoGame.EntityBehavior.prototype.Update.call(this),Math.random()<.1){var t=this.CE.Controller;t[System.Array.index(0,t)]=!1,t[System.Array.index(1,t)]=!1,t[System.Array.index(2,t)]=!1,t[System.Array.index(3,t)]=!1,Math.random()<.5&&(t[System.Array.index(0,t)]=Math.random()<.5,t[System.Array.index(1,t)]=!t[System.Array.index(0,t)]),Math.random()<.5&&(t[System.Array.index(2,t)]=Math.random()<.5,t[System.Array.index(3,t)]=!t[System.Array.index(2,t)])}}}}),Bridge.define("CirnoGame.TextSprite",{inherits:[CirnoGame.Sprite],fields:{_Text:null,textInvallidated:!1,imageInvallidated:!1,TextImage:null,TextGraphic:null,_TextColor:null,_FontWeight:null,_FontFamily:null,_FontSize:0,_shadowBlur:0,_shadowOffset:null,_shadowColor:null},props:{Text:{get:function(){return this._Text},set:function(t){Bridge.referenceEquals(this._Text,t)||(this._Text=t,this.textInvallidated=!0)}},TextColor:{get:function(){return this._TextColor},set:function(t){Bridge.referenceEquals(this._TextColor,t)||(this._TextColor=t,this.textInvallidated=!0)}},FontWeight:{get:function(){return this._FontWeight},set:function(t){Bridge.referenceEquals(this._FontWeight,t)||(this._FontWeight=t,this.UpdateFont())}},FontFamily:{get:function(){return this._FontFamily},set:function(t){Bridge.referenceEquals(this._FontFamily,t)||(this._FontFamily=t,this.UpdateFont())}},FontSize:{get:function(){return this._FontSize},set:function(t){this._FontSize!==t&&(this._FontSize=t,this.UpdateFont())}},ShadowBlur:{get:function(){return this._shadowBlur},set:function(t){this._shadowBlur!==t&&(this._shadowBlur=t,this.imageInvallidated=!0)}},ShadowOffset:{get:function(){return this._shadowOffset.Clone()},set:function(t){CirnoGame.Vector2.op_Inequality(this._shadowOffset,t)&&t.X!==this._shadowOffset.X&&t.Y!==this._shadowOffset.Y&&(this._shadowOffset=t.Clone(),this.imageInvallidated=!0)}},ShadowColor:{get:function(){return this._shadowColor},set:function(t){Bridge.referenceEquals(this._shadowColor,t)||(this._shadowColor=t,this.imageInvallidated=!0)}}},ctors:{init:function(){this._FontWeight="normal",this._FontFamily="sans-serif",this._FontSize=10,this._shadowBlur=0,this._shadowOffset=new CirnoGame.Vector2,this._shadowColor="#000000"},ctor:function(){this.$initialize(),CirnoGame.Sprite.ctor.call(this),this.TextImage=document.createElement("canvas"),this.TextGraphic=this.TextImage.getContext("2d"),this.TextGraphic.imageSmoothingEnabled=!1,this.TextImage.style.imageRendering="pixelated",this.TextGraphic.fillStyle="#FFFFFF"}},methods:{UpdateFont:function(){this.TextGraphic.font=System.String.concat(this._FontWeight," ",this._FontSize,"px ",this._FontFamily),this.textInvallidated=!0,this.imageInvallidated=!0,this.TextGraphic.fillStyle=this._TextColor},RedrawBaseTextImage:function(){this.UpdateFont();for(var t=System.String.split(this._Text,[10].map(function(t){return String.fromCharCode(t)})),e=1*this.FontSize,i=0,n=0;n<t.length;){var r=this.TextGraphic.measureText(t[System.Array.index(n,t)]);i=Math.max(i,Bridge.Int.clip32(Math.ceil(r.width))),n=n+1|0}this.TextImage.height=Bridge.Int.clip32(e*(t.length+.25)),this.TextImage.width=i,this.UpdateFont();var o=0;for(n=0;n<t.length;)this.TextGraphic.fillText(t[System.Array.index(n,t)],0,this.FontSize+o),o+=e,n=n+1|0;this.textInvallidated=!1,this.imageInvallidated=!0},RenderTextImage:function(){if(this._shadowBlur<=0)this.spriteBuffer.width=this.TextImage.width,this.spriteBuffer.height=this.TextImage.height;else{var t=Bridge.Int.clip32(Math.ceil(this._shadowBlur+this._shadowBlur));this.spriteBuffer.width=this.TextImage.width+t|0,this.spriteBuffer.height=this.TextImage.height+t|0}this.spriteGraphics.shadowBlur=0,this.spriteGraphics.globalCompositeOperation="source-over",this._shadowBlur<=0?this.spriteGraphics.drawImage(this.TextImage,0,0):this.spriteGraphics.drawImage(this.TextImage,this._shadowBlur,this._shadowBlur),this._shadowBlur>0&&(this.spriteGraphics.shadowBlur=this._shadowBlur,this.spriteGraphics.shadowColor=this._shadowColor,this.spriteGraphics.shadowOffsetX=this._shadowOffset.X,this.spriteGraphics.shadowOffsetY=this._shadowOffset.Y,this.spriteGraphics.drawImage(this.spriteBuffer,0,0)),this.imageInvallidated=!1},ForceUpdate:function(){this.textInvallidated&&this.RedrawBaseTextImage(),this.imageInvallidated&&this.RenderTextImage()},Draw:function(t){this.ForceUpdate(),CirnoGame.Sprite.prototype.Draw.call(this,t)}}}),Bridge.define("CirnoGame.Tile",{inherits:[CirnoGame.Entity],fields:{tile:0},ctors:{ctor:function(t,e){this.$initialize(),CirnoGame.Entity.ctor.call(this,t),this.tile=e,this.Ani=new CirnoGame.Animation(CirnoGame.AnimationLoader.Get("images/land/brick")),this.Ani.CurrentFrame=e,this.Ani.ImageSpeed=0}},methods:{Draw:function(t){CirnoGame.Entity.prototype.Draw.call(this,t)}}}),Bridge.define("CirnoGame.TitleScreen",{inherits:[CirnoGame.Sprite],fields:{Title:null,Version:null,Desc:null,Controls:null,Credits:null,menu:null,game:null},ctors:{ctor:function(){this.$initialize(),CirnoGame.Sprite.ctor.call(this),this.spriteBuffer.width=CirnoGame.App.Canvas.width,this.spriteBuffer.height=Bridge.Int.clip32(this.spriteBuffer.width*CirnoGame.App.TargetAspect),this.Title=new CirnoGame.TextSprite,this.Title.FontSize=Bridge.Int.clip32(.06*this.spriteBuffer.width),this.Title.Text=CirnoGame.App.GameName,this.Title.TextColor="#77FFFF",this.Title.ShadowColor="#000000",this.Title.ShadowOffset=new CirnoGame.Vector2(2,2),this.Title.ShadowBlur=2,this.CenterTextWithFloats(this.Title,.5,.06),this.Version=new CirnoGame.TextSprite,this.Version.FontSize=Bridge.Int.clip32(.016*this.spriteBuffer.width),this.Version.Text=System.String.concat("Version:",CirnoGame.App.GameVersion),this.Version.TextColor="#FFFFFF",this.Version.ShadowColor="#000000",this.Version.ShadowOffset=new CirnoGame.Vector2(2,2),this.Version.ShadowBlur=2,this.CenterTextWithFloats(this.Version,.75,.11),this.Desc=new CirnoGame.TextSprite,this.Desc.FontSize=Bridge.Int.clip32(.03*this.spriteBuffer.width),this.Desc.TextColor="#FFFFFF",this.Desc.Text="Cirno has found herself in a strange tower filled with ghosts!\nReclaim your stolen energy sealed inside the orbs to extend your time.\nRemember the door's location and search for the gold key.",this.Desc.ShadowColor="#000000",this.Desc.ShadowOffset=new CirnoGame.Vector2(2,2),this.Desc.ShadowBlur=2,this.CenterTextWithFloats(this.Desc,.5,.2),this.Controls=new CirnoGame.TextSprite,this.Controls.FontSize=Bridge.Int.clip32(.025*this.spriteBuffer.width),this.Controls.TextColor="#FFFFFF",this.Controls.Text="Controls:\nLeft/Right=Move\nUp/Down=Aim(Up activates chests/doors)\nZ=Shoot\nX=Jump/Mid-air jump\nA=Place block below you(costs time)\nEnter=Pause\nM=Toggle mute",this.Controls.ShadowColor="#000000",this.Controls.ShadowOffset=new CirnoGame.Vector2(2,2),this.Controls.ShadowBlur=2,this.CenterTextWithFloats(this.Controls,.5,.4),this.Controls.Position.X=this.Desc.Position.X,this.menu=new CirnoGame.ButtonMenu(.8*this.spriteBuffer.width,.5*this.spriteBuffer.height,Bridge.Int.clip32(.05*this.spriteBuffer.width));var t=this.menu.AddButton("Start Game");t.OnClick=Bridge.fn.bind(this,$asm.$.CirnoGame.TitleScreen.f1),t.Position.X+=.38*this.spriteBuffer.width,t.Position.Y=.7*this.spriteBuffer.height,this.Credits=new CirnoGame.TextSprite,this.Credits.FontSize=Bridge.Int.clip32(.015*this.spriteBuffer.width),this.Credits.TextColor="#77FFFF",this.Credits.Text="Made by:RSGmaker                                                                                                           Touhou Project and it's characters are owned by ZUN",this.Credits.ShadowColor="#000000",this.Credits.ShadowOffset=new CirnoGame.Vector2(2,2),this.Credits.ShadowBlur=2,this.CenterTextWithFloats(this.Credits,.5,.98)}},methods:{CenterTextWithFloats:function(t,e,i){this.CenterText(t,new CirnoGame.Vector2(this.spriteBuffer.width*e,this.spriteBuffer.height*i))},CenterText:function(t,e){t.ForceUpdate(),t.Position.X=e.X-(0|Bridge.Int.div(t.spriteBuffer.width,2)),t.Position.Y=e.Y-(0|Bridge.Int.div(t.spriteBuffer.height,2))},Draw:function(t){CirnoGame.Sprite.prototype.Draw.call(this,t),this.Title.Draw(t),this.Version.Draw(t),this.Desc.Draw(t),this.Controls.Draw(t),this.menu.Draw(t),this.menu.Update(),this.Credits.Draw(t);var e=CirnoGame.KeyboardManager._this.CMouse.Clone();System.String.contains(CirnoGame.App.Div.style.left,"px")&&(e.X<.17*this.spriteBuffer.width&&e.Y>=.96*this.spriteBuffer.height?(CirnoGame.App.Div.style.cursor="pointer",CirnoGame.KeyboardManager._this.TappedMouseButtons.contains(0)&&(Bridge.global.location.href="https://rsgmaker.deviantart.com")):CirnoGame.App.Div.style.cursor=null)}}}),Bridge.ns("CirnoGame.TitleScreen",$asm.$),Bridge.apply($asm.$.CirnoGame.TitleScreen,{f1:function(){this.game.Start()}}),Bridge.define("CirnoGame.DoorKey",{inherits:[CirnoGame.CollectableItem],ctors:{ctor:function(t){this.$initialize(),CirnoGame.CollectableItem.ctor.call(this,t,"bigkey"),this.floats=!1,this.magnetDistance=20}},methods:{onCollected:function(t){this.Game.Door.Opened=!0;var e=new CirnoGame.FloatingMessage(this.Game,"Door Unlocked!");e.Text.TextColor="#77FFFF",e.Position=new CirnoGame.Vector2(this.x+8,this.y-20),this.Game.AddEntity(e)}}}),Bridge.define("CirnoGame.Game",{inherits:[CirnoGame.GameSprite],statics:{methods:{GetTeamColor:function(t){return 1===t?"#FF0000":2===t||0===t?"#0000FF":3===t?"#FFFF00":"#000000"}}},fields:{player:null,entities:null,camera:null,stageBounds:null,TM:null,GamePlaySettings:null,TimerSprite:null,defaultTimeRemaining:0,maxTimeRemaining:0,timeRemaining:0,totalTime:0,level:0,playing:!1,paused:!1,cameraWanderPoint:null,TS:null,skiprender:!1,ScoreSprite:null,EG:null,Door:null,Key:null,muted:!1,ShowHitbox:!1,freecam:!1},props:{running:{get:function(){return this.playing&&!this.paused}}},ctors:{init:function(){this.defaultTimeRemaining=18e4,this.maxTimeRemaining=3e5,this.totalTime=0,this.level=0,this.playing=!1,this.paused=!1,this.skiprender=!0,this.muted=!1,this.ShowHitbox=!1,this.freecam=!1},ctor:function(){this.$initialize(),CirnoGame.GameSprite.ctor.call(this),this.GamePlaySettings=new CirnoGame.GamePlaySettings,this.Door=new CirnoGame.ExitDoor(this),this.player=new CirnoGame.PlayerCharacter(this),this.player.HP=0,this.timeRemaining=this.defaultTimeRemaining,this.entities=new(System.Collections.Generic.List$1(CirnoGame.Entity)),this.stageBounds=new CirnoGame.Rectangle(0,0,4e3,2e3),this.TM=new CirnoGame.TileMap(this),this.TM.Seed=Bridge.Int.clip32(Math.random()*System.Int64([1410065407,2])),this.TM.position.Y=0;var t=CirnoGame.Rectangle.op_Subtraction(this.stageBounds,this.TM.position);t.width-=this.TM.tilesize,t.height-=this.TM.tilesize,this.player.Position.Y=this.stageBounds.height/3,this.player.Position.X=this.stageBounds.width/2,this.EG=CirnoGame.Helper.GetContext(document.createElement("canvas")),this.AddEntity(this.Door),this.spriteBuffer.width=CirnoGame.App.Canvas.width,this.spriteBuffer.height=Bridge.Int.clip32(this.spriteBuffer.width*CirnoGame.App.TargetAspect),this.camera=new CirnoGame.Camera(this.spriteBuffer.width,this.spriteBuffer.height),this.camera.Scale=4,this.camera.StageBounds=this.stageBounds,this.camera.Update(),this.camera.instawarp=!0,this.spriteGraphics.imageSmoothingEnabled=!1,this.StartNextLevel(),this.TimerSprite=new CirnoGame.TextSprite,this.TimerSprite.FontSize=0|Bridge.Int.div(this.spriteBuffer.height,24),this.TimerSprite.Text="3:00",this.TimerSprite.TextColor="#FFFFFF",this.TimerSprite.ShadowColor="#000000",this.TimerSprite.ShadowOffset=new CirnoGame.Vector2(3,3),this.TimerSprite.ShadowBlur=1,this.TimerSprite.Position.X=.47*this.spriteBuffer.width,this.TimerSprite.Position.Y=0|Bridge.Int.div(0|-this.TimerSprite.FontSize,8),this.ScoreSprite=new CirnoGame.TextSprite,this.ScoreSprite.FontSize=0|Bridge.Int.div(this.spriteBuffer.height,28),this.ScoreSprite.Text="Level:1 Score:0",this.ScoreSprite.TextColor="#FFFFFF",this.ScoreSprite.ShadowColor="#000000",this.ScoreSprite.ShadowOffset=new CirnoGame.Vector2(3,3),this.ScoreSprite.ShadowBlur=1,this.ScoreSprite.ForceUpdate(),this.ScoreSprite.Position.X=.98*this.spriteBuffer.width-this.ScoreSprite.spriteBuffer.width,this.ScoreSprite.Position.Y=0|Bridge.Int.div(0|-this.ScoreSprite.FontSize,8),this.Key=CirnoGame.AnimationLoader.Get("images/items/key").getItem(0),this.TS=new CirnoGame.TitleScreen,this.TS.game=this,this.SetMusic()}},methods:{ClearEntities:function(){for(var t=this.entities.toArray(),e=0;e<t.length;){var i=t[System.Array.index(e,t)];Bridge.referenceEquals(i,this.player)||Bridge.is(i,CirnoGame.ExitDoor)||(i.Alive=!1,this.RemoveEntity(i)),e=e+1|0}},StartNextLevel:function(){this.ClearEntities(),this.level=this.level+1|0;var t=CirnoGame.Rectangle.op_Subtraction(this.stageBounds,this.TM.position);t.width-=this.TM.tilesize,t.height-=this.TM.tilesize,this.TM.Generate(),CirnoGame.MapGenerator.BoxyGenerate(this),this.TM.DrawRect(t),this.TM.ApplyBreakable();for(var e=Math.min(18+2*this.level,28),i=0;e>i;)this.PlaceAndAddEntity(new CirnoGame.MRGhosty(this)),i=i+1|0;for(i=0;Bridge.identity(i,i=i+1|0)<=4;)this.PlaceAndAddEntity(new CirnoGame.Orb(this));for(i=0;Bridge.identity(i,i=i+1|0)<=3;)this.PlaceAndAddEntity(new CirnoGame.Chest(this)),this.PlaceAndAddEntity(new CirnoGame.KeyItem(this));for(i=0;Bridge.identity(i,i=i+1|0)<=1;)this.PlaceAndAddEntity(new CirnoGame.HealingItem(this));this.PlaceAndAddEntity(new CirnoGame.DoorKey(this)),this.player.invincibilitytime=180,this.camera.instawarp=!0,this.skiprender=!0,this.playing&&this.SetMusic()},SetMusic:function(){if(!this.playing)return void this.PlayMusic("theme2");var t=2,e=5,i=0|Bridge.Int.div(this.level,e);i%=t,this.PlayMusic("theme"+(i+1|0))},PlaceAndAddEntity:function(t){t.Position.CopyFrom(CirnoGame.MapRoom.FindAnyEmptySpot()),this.AddEntity(t)},Update:function(){if(CirnoGame.GameSprite.prototype.Update.call(this),this.playing&&CirnoGame.KeyboardManager._this.TappedButtons.contains(13)&&(this.paused=!this.paused,CirnoGame.KeyboardManager._this.TappedButtons.remove(13)),this.playing&&CirnoGame.KeyboardManager._this.TappedButtons.contains(77)&&(CirnoGame.AudioManager._this.StopAll(),this.muted=!this.muted,this.muted||this.SetMusic(),CirnoGame.KeyboardManager._this.TappedButtons.remove(77)),this.paused)this.TimerSprite.Text="Paused";else{this.UpdateControls();for(var t=0;t<this.entities.Count;){var e=this.entities.getItem(t);e.Alive&&e.Update(),e.Alive||(this.RemoveEntity(e),t=t-1|0),t=t+1|0}this.UpdateCollisions(),this.UpdateTime(),this.playing&&this.player.y<0&&(this.level=this.level-1|0,this.StartNextLevel())}},DoGameOver:function(){this.playing&&(this.entities.contains(this.player)&&this.RemoveEntity(this.player),this.playing=!1,this.StartNextLevel())},UpdateTime:function(){if(this.paused)return void(this.TimerSprite.Text="Paused");if(this.timeRemaining<0)return this.timeRemaining=0,this.TimerSprite.Text="0",void(this.player.HP>0?this.player.HP-=.004:this.DoGameOver());var t=this.timeRemaining/1e3,e=t/60,i=Bridge.Int.clip32(Math.floor(e)),n=t-Bridge.Int.mul(i,60),r="";i>0&&(r=""+i+":");var o="";10>n&&(o="0",10>t&&(o=" ")),r=System.String.concat(r,this.RestrictLength(System.String.concat(o,System.Single.format(Math.max(0,n))),4)),this.TimerSprite.Text=r},RestrictLength:function(t,e){return t.length>e?t.substr(0,e):t},UpdateCollisions:function(){for(var t=new(System.Collections.Generic.List$1(CirnoGame.Entity))(System.Linq.Enumerable.from(this.entities).where($asm.$.CirnoGame.Game.f1)),e=new(System.Collections.Generic.List$1(CirnoGame.Entity))(System.Linq.Enumerable.from(this.entities).where($asm.$.CirnoGame.Game.f2)),i=new CirnoGame.Rectangle,n=new CirnoGame.Rectangle,r=0;r<t.Count;){var o={v:t.getItem(r)};if(Bridge.is(o.v,CirnoGame.ICombatant)){var a={v:Bridge.cast(o.v,CirnoGame.ICombatant)},s=o.v.GetHitbox(),h=CirnoGame.Vector2.op_Multiply(o.v.Speed,.5);i.Set(s.x-h.X,s.y-h.Y,s.width,s.height);for(var l=new(System.Collections.Generic.List$1(CirnoGame.Entity))(System.Linq.Enumerable.from(e).where(function(t,e,i){return function(t){return!Bridge.referenceEquals(t,e.v)&&!Bridge.cast(t,CirnoGame.IHarmfulEntity).CirnoGame$IHarmfulEntity$Attacker.SameTeam(Bridge.cast(i.v,CirnoGame.Entity))}}(this,o,a))),m=0;m<l.Count;){var d=l.getItem(m),u=Bridge.cast(d,CirnoGame.IHarmfulEntity),c=d.GetHitbox(),p=CirnoGame.Vector2.op_Multiply(d.Speed,.5);if(n.Set(c.x-p.X,c.y-p.Y,c.width,c.height),s.isTouching(c)||i.isTouching(n)){if(u.CirnoGame$IHarmfulEntity$ontouchDamage(a.v)){var C=a.v.CirnoGame$ICombatant$HP;if(a.v.CirnoGame$ICombatant$onDamaged(u,u.CirnoGame$IHarmfulEntity$touchDamage),C>a.v.CirnoGame$ICombatant$HP&&Bridge.cast(a.v,CirnoGame.Entity).PlaySound("hit"),a.v.CirnoGame$ICombatant$HP<=0&&Bridge.cast(a.v,CirnoGame.Entity).HandledLocally){var g={};g.I=Bridge.cast(a.v,CirnoGame.Entity).ID,g.A=u.CirnoGame$IHarmfulEntity$Attacker.ID,g.S=Bridge.cast(u,CirnoGame.Entity).ID,this.SendEvent("Kill",g)}}this.Attack(a.v,u)}m=m+1|0}}r=r+1|0}},Attack:function(t,e){if(t.CirnoGame$ICombatant$HP>0&&e.CirnoGame$IHarmfulEntity$ontouchDamage(t)&&(t.CirnoGame$ICombatant$onDamaged(e,e.CirnoGame$IHarmfulEntity$touchDamage),Bridge.cast(t,CirnoGame.Entity).PlaySound("hit"),t.CirnoGame$ICombatant$HP<=0&&Bridge.cast(t,CirnoGame.Entity).HandledLocally)){var i={};i.I=Bridge.cast(t,CirnoGame.Entity).ID,i.A=e.CirnoGame$IHarmfulEntity$Attacker.ID,i.S=Bridge.cast(e,CirnoGame.Entity).ID,this.SendEvent("Kill",i)}},PlaySoundEffect:function(t,e){if(!this.muted){var i=1,n=50,r=200;if(CirnoGame.Vector2.op_Inequality(t,null)){var o=this.camera.Center.EstimatedDistance(t);if(o-=n,o>0){if(o>=r)return;i=1-o/r}}CirnoGame.AudioManager._this.Blast(System.String.concat("SFX/",e,".ogg"),i)}},AddEntity:function(t){this.entities.add(t)},RemoveEntity:function(t){t.onRemove(),this.entities.remove(t)},Render:function(){CirnoGame.GameSprite.prototype.Render.call(this);var t=this.spriteGraphics;this.skiprender&&(t=this.EG,this.skiprender=!1),this.UpdateCamera(),this.DrawBackground(t),t.save(),this.camera.Apply(t),this.TM.Draw(t),this.entities.forEach(function(e){e.Alive&&e.Visible&&e.Draw(t)}),t.restore(),this.playing?this.RenderGUI(t):(t.globalAlpha=.3,t.fillStyle="#000000",t.fillRect(0,0,this.spriteBuffer.width,this.spriteBuffer.height),t.globalAlpha=1,this.TS.Draw(t),this.player.score>0&&(this.ScoreSprite.Text="Level:"+this.level+" Score:"+this.player.score,this.ScoreSprite.ForceUpdate(),this.ScoreSprite.Position.X=.98*this.spriteBuffer.width-this.ScoreSprite.spriteBuffer.width,this.ScoreSprite.Draw(t)))},Start:function(){this.entities.contains(this.player)&&this.RemoveEntity(this.player),this.player=new CirnoGame.PlayerCharacter(this),this.AddEntity(this.player),this.playing=!0,this.level=0,this.StartNextLevel(),CirnoGame.App.Div.style.cursor=null,this.totalTime=0,this.timeRemaining=this.defaultTimeRemaining},PlayMusic:function(t){if(!this.muted){var e=CirnoGame.AudioManager._this.Get(System.String.concat("BGM/",t,".ogg"));e.IsPlaying||(CirnoGame.AudioManager._this.StopAllFromDirectory("BGM/"),e.Volume=.35,e.Loop=!0,e.Play())}},RenderGUI:function(t){var e=this.player,i="#00DD00";this.timeRemaining<=0&&(i="#FF0000"),t.globalAlpha=.8,this.DrawGauge(t,new CirnoGame.Vector2(0,0),new CirnoGame.Vector2(0|Bridge.Int.div(this.spriteBuffer.width,4),0|Bridge.Int.div(this.spriteBuffer.height,20)),5,e.HP/e.maxHP,i),t.globalAlpha=1,this.TimerSprite.Draw(t),this.ScoreSprite.Text="Level:"+this.level+" Score:"+this.player.score,this.ScoreSprite.ForceUpdate(),this.ScoreSprite.Position.X=.98*this.spriteBuffer.width-this.ScoreSprite.spriteBuffer.width,this.ScoreSprite.Draw(t),this.RenderIcons(t)},RenderIcons:function(t){var e=0|Bridge.Int.div(this.Key.height,this.Key.width),i=.02*this.spriteBuffer.width,n=.055*this.spriteBuffer.height,r=n,o=i/2,a=0,s=.0115*this.spriteBuffer.width;for(t.globalAlpha=.8;a<this.player.keys;)t.drawImage(this.Key,o,r,s,s*e),o+=i,a=a+1|0;t.globalAlpha=1},DrawGauge:function(t,e,i,n,r,o,a){void 0===a&&(a=!0);var s=t.globalAlpha;a&&(t.globalAlpha=.6*s,t.fillStyle="#000000",t.fillRect(e.X,e.Y,i.X,i.Y)),t.fillStyle=o,t.globalAlpha=1*s,t.fillRect(Bridge.Int.clip32(e.X)+n|0,Bridge.Int.clip32(e.Y)+n|0,(i.X-(n+n|0))*r,Bridge.Int.clip32(i.Y)-(n+n|0)|0),t.globalAlpha=.5*s;var h=t.createLinearGradient(0,0,0,i.Y);h.addColorStop(0,o),h.addColorStop(.4,"white"),h.addColorStop(1,o),t.fillStyle=h,t.fillRect(Bridge.Int.clip32(e.X)+n|0,Bridge.Int.clip32(e.Y)+n|0,(i.X-(n+n|0))*r,Bridge.Int.clip32(i.Y)-(n+n|0)|0),t.globalAlpha=s},SendEvent:function(t,e,i){void 0===i&&(i=!1);var n={};n.E=t,n.D=e,this.ProcessEvent(n)},ProcessEvent:function(t,e,i){void 0===e&&(e=null),void 0===i&&(i=0);var n=t.D,r=t.E;if(Bridge.referenceEquals(r,"Kill")){var o=this.EntityFromID(n.I);if(null!=o){var a=this.EntityFromID(n.A);if(Bridge.cast(o,CirnoGame.ICombatant).CirnoGame$ICombatant$onDeath(this.EntityFromID(n.S)),null!=a&&Bridge.is(a,CirnoGame.PlayerCharacter)){var s=Bridge.cast(a,CirnoGame.PlayerCharacter);s.score=s.score+Bridge.cast(o,CirnoGame.ICombatant).CirnoGame$ICombatant$PointsForKilling|0,s.onKill(Bridge.cast(o,CirnoGame.ICombatant))}}}},EntityFromID:function(t){for(var e=0;e<this.entities.Count;){var i=this.entities.getItem(e);if(Bridge.referenceEquals(i.ID,t))return i;e=e+1|0}return null},UpdateCamera:function(){var t,e;if(this.camera.speedmod=1,this.freecam){var i=16/this.camera.Scale,n=CirnoGame.KeyboardManager._this.PressedButtons;if(CirnoGame.HelperExtensions.ContainsB$1(System.Int32,n,Bridge.box(100,System.Int32))&&(this.camera.TargetPosition.X-=i),CirnoGame.HelperExtensions.ContainsB$1(System.Int32,n,Bridge.box(102,System.Int32))&&(this.camera.TargetPosition.X+=i),CirnoGame.HelperExtensions.ContainsB$1(System.Int32,n,Bridge.box(104,System.Int32))&&(this.camera.TargetPosition.Y-=i),CirnoGame.HelperExtensions.ContainsB$1(System.Int32,n,Bridge.box(98,System.Int32))&&(this.camera.TargetPosition.Y+=i),CirnoGame.HelperExtensions.ContainsB$1(System.Int32,n,Bridge.box(107,System.Int32))){var r=this.camera.Center;
this.camera.Scale*=1.01,this.camera.Center=r,this.camera.TargetPosition.X=this.camera.Position.X,this.camera.TargetPosition.Y=this.camera.Position.Y}if(CirnoGame.HelperExtensions.ContainsB$1(System.Int32,n,Bridge.box(109,System.Int32))){var o=this.camera.Center;this.camera.Scale*=.99,this.camera.Center=o,this.camera.TargetPosition.X=this.camera.Position.X,this.camera.TargetPosition.Y=this.camera.Position.Y}return CirnoGame.HelperExtensions.ContainsB$1(System.Int32,n,Bridge.box(36,System.Int32))&&(this.camera.CenteredTargetPosition=this.player.Position),CirnoGame.HelperExtensions.ContainsB$1(System.Int32,n,Bridge.box(13,System.Int32))&&(this.player.Position.X=this.camera.Center.X,this.player.Position.Y=this.camera.Center.Y),void this.camera.Update()}if(!this.playing)return this.camera.speedmod=.05,(CirnoGame.Vector2.op_Equality(this.camera.TargetPosition,null)||this.camera.Position.EstimatedDistance(this.camera.TargetPosition)<40)&&(Math.random()<.0035||this.camera.instawarp)&&(this.camera.CenteredTargetPosition=CirnoGame.MapRoom.FindAnyEmptySpot()),void this.camera.Update();if(!(this.player.HP<0)){var a=32*this.player.Hspeed,s=this.camera.CameraBounds.width/8;a+=this.player.Ani.Flipped?-s:s;var h=(CirnoGame.App.Canvas,this.camera.InvScale,Math.max(0,30*this.player.Vspeed));(t=this.player.Controller)[System.Array.index(2,t)]?h-=this.camera.CameraBounds.height/4:(e=this.player.Controller)[System.Array.index(3,e)]?h+=this.camera.CameraBounds.height/4:this.player.onGround?h-=this.camera.CameraBounds.height/10:h+=this.camera.CameraBounds.height/12;var l=(this.camera.TargetPosition,this.player.x+this.player.Width/2+a),m=this.player.y+this.player.Height/2+h;this.camera.CenteredTargetPosition=new CirnoGame.Vector2(l,m),this.camera.Update()}},DrawBackground:function(t){t.fillStyle="#77AAFF",t.fillRect(0,0,CirnoGame.App.Canvas.width,CirnoGame.App.Canvas.height)},UpdateControls:function(){var t=this.player,e=.7,i=t.Controller,n=CirnoGame.App.IC;if(null!=n){var r=n.getState(0),o=n.getState(1);i[System.Array.index(0,i)]=-e>=r,i[System.Array.index(1,i)]=r>=e,i[System.Array.index(2,i)]=-e>=o,i[System.Array.index(3,i)]=o>=e;var a=n.getMapControllerID$1(5);if(Bridge.referenceEquals(a,"Keyboard")||Bridge.referenceEquals(a,"Mouse"))i[System.Array.index(4,i)]=n.getPressed(2),i[System.Array.index(5,i)]=n.getPressed(3),i[System.Array.index(6,i)]=n.getPressed(4);else{var s=new CirnoGame.Vector2(n.getState(4),n.getState(5));s.RoughLength>.5}i[System.Array.index(4,i)]=n.getPressed(2),i[System.Array.index(5,i)]=n.getPressed(3),i[System.Array.index(6,i)]=n.getPressed(4)}}}}),Bridge.ns("CirnoGame.Game",$asm.$),Bridge.apply($asm.$.CirnoGame.Game,{f1:function(t){return Bridge.is(t,CirnoGame.ICombatant)&&null!=t.Ani.CurrentImage&&Bridge.cast(t,CirnoGame.ICombatant).CirnoGame$ICombatant$HP>0},f2:function(t){return Bridge.is(t,CirnoGame.IHarmfulEntity)&&null!=t.Ani.CurrentImage}}),Bridge.define("CirnoGame.HealingItem",{inherits:[CirnoGame.CollectableItem],ctors:{ctor:function(t){this.$initialize(),CirnoGame.CollectableItem.ctor.call(this,t,"heart"),this.floats=!1,this.magnetDistance=20}},methods:{CanCollect:function(t){return t.HP<t.maxHP},onCollected:function(t){t.HP=Math.min(t.HP+1,t.maxHP)}}}),Bridge.define("CirnoGame.KeyItem",{inherits:[CirnoGame.CollectableItem],ctors:{ctor:function(t){this.$initialize(),CirnoGame.CollectableItem.ctor.call(this,t,"key"),this.floats=!1,this.magnetDistance=20}},methods:{CanCollect:function(t){return t.keys<5},onCollected:function(t){t.keys=t.keys+1|0}}}),Bridge.define("CirnoGame.PlatformerEntity",{inherits:[CirnoGame.ControllableEntity],fields:{friction:0,onGround:!1,GravityEnabled:!1,gravity:0,maxFallSpeed:0,feetposition:0,headposition:0,Floor:null,Ceiling:null,LeftWall:null,RightWall:null},ctors:{init:function(){this.friction=.5,this.GravityEnabled=!0,this.gravity=.02,this.maxFallSpeed=2,this.feetposition=23,this.headposition=7},ctor:function(t){this.$initialize(),CirnoGame.ControllableEntity.ctor.call(this,t)}},methods:{Update:function(){if(CirnoGame.ControllableEntity.prototype.Update.call(this),this.GravityEnabled&&this.Vspeed<this.maxFallSpeed&&this.GravityEnabled&&(this.Vspeed=Math.min(this.Vspeed+this.gravity,this.maxFallSpeed)),this.ApplyFriction(),this.UpdateTerrainCollision(),this.onGround=null!=this.Floor&&this.Vspeed>=0,this.onGround){var t=this.Floor.GetTop(this.getCenter())-this.feetposition;this.y=t,this.Vspeed=0,this.onGround=!0}null!=this.Ceiling&&this.Vspeed<0&&(this.Vspeed=0,this.y=this.Ceiling.row*this.Game.TM.tilesize+this.Game.TM.position.Y+this.Game.TM.tilesize-this.headposition),null!=this.LeftWall&&(this.Hspeed=Math.max(0,this.Hspeed)),null!=this.RightWall&&(this.Hspeed=Math.min(0,this.Hspeed))},ApplyFriction:function(){this.Hspeed=CirnoGame.MathHelper.Decelerate(this.Hspeed,this.friction),this.GravityEnabled||(this.Vspeed=CirnoGame.MathHelper.Decelerate(this.Vspeed,this.friction))},GetFloor:function(){var t=null,e=this.Width/3,i=this.Height;return null!=t&&t.enabled&&t.topSolid||(t=this.Game.TM.CheckForTile(CirnoGame.Vector2.Add$1(this.Position,this.Width/2,i))),null!=t&&t.enabled&&t.topSolid||(t=this.Game.TM.CheckForTile(CirnoGame.Vector2.Add$1(this.Position,e,i))),null!=t&&t.enabled&&t.topSolid||(t=this.Game.TM.CheckForTile(CirnoGame.Vector2.Add$1(this.Position,this.Width-e,i))),null!=t&&t.enabled&&t.topSolid||(t=null),t},GetCeiling:function(){var t=null,e=this.Width/3,i=0+this.headposition;return null!=t&&t.enabled&&t.bottomSolid||(t=this.Game.TM.CheckForTile(CirnoGame.Vector2.Add$1(this.Position,e,i))),null!=t&&t.enabled&&t.bottomSolid||(t=this.Game.TM.CheckForTile(CirnoGame.Vector2.Add$1(this.Position,this.Width-e,i))),null!=t&&t.enabled&&t.bottomSolid||(t=null),t},CheckWall:function(t){var e=null;return this.IsTileObstacle(e,t)||(e=this.Game.TM.CheckForTile(CirnoGame.Vector2.Add$1(this.Position,t,this.Height/2-2))),this.IsTileObstacle(e,t)||(e=this.Game.TM.CheckForTile(CirnoGame.Vector2.Add$1(this.Position,t,this.Height-2))),this.IsTileObstacle(e,t)||(e=null),e},IsTileObstacle:function(t,e){if(null!=t&&t.enabled&&(t.leftSolid&&e>0||t.rightSolid&&0>e)&&(null==this.Floor||t.row<this.Floor.row)){var i=this.y+this.Height;if(t.GetHitbox().y<i-0)return!t.IsSlope}return!1},UpdateTerrainCollision:function(){this.Floor=this.GetFloor(),this.Ceiling=this.GetCeiling(),this.Vspeed<this.maxFallSpeed&&this.GravityEnabled&&(this.Vspeed=Math.min(this.Vspeed+this.gravity,this.maxFallSpeed));var t=!1;if(null!=this.Floor)for(var e=!0;e;){var i=this.Floor.GetTileData(0,-1);null!=i&&i.enabled&&i.solid?(this.Floor=i,t=!0):e=!1}if(t=!1,this.onGround=!1,null!=this.Floor&&this.Vspeed>=0){var n=this.Floor.GetTop(this.getCenter())-this.Height;(!this.Floor.platform||this.y<=n+this.Vspeed)&&this.y+(this.Vspeed+10)>=n&&(this.Vspeed>0&&(this.Vspeed=0,this.onGround=!0),this.y=n)}if(0!==this.Hspeed){var r=this.Hspeed>0?this.RightWall:this.LeftWall;null!=r&&(this.Hspeed=0)}var o=this.Width/3,a=Math.abs(this.Hspeed);if(this.Hspeed<0?a-=2-o:a+=this.Width-o+2,this.RightWall=this.CheckWall(a),a=-Math.abs(this.Hspeed),this.Hspeed<0?a-=2-o:a+=this.Width-o+2,this.LeftWall=this.CheckWall(a),null!=this.LeftWall&&Bridge.referenceEquals(this.LeftWall,this.RightWall)){var s=this.LeftWall.GetHitbox(),h=s.Center;CirnoGame.Vector2.op_Subtraction(h,this.Position).X>0?(this.x+=1,this.Hspeed<0&&(this.Hspeed=0)):(this.x-=1,this.Hspeed>0&&(this.Hspeed=0))}t&&this.UpdateTerrainCollision()}}}),Bridge.define("CirnoGame.Orb",{inherits:[CirnoGame.CollectableItem],ctors:{ctor:function(t){this.$initialize(),CirnoGame.CollectableItem.ctor.call(this,t,"orb")}},methods:{onCollected:function(t){var e=2e4;this.Game.timeRemaining>0?(this.Game.timeRemaining+=e,this.Game.timeRemaining=Math.min(this.Game.maxTimeRemaining,this.Game.timeRemaining)):this.Game.timeRemaining+=e}}}),Bridge.define("CirnoGame.PointItem",{inherits:[CirnoGame.CollectableItem],ctors:{ctor:function(t){this.$initialize(),CirnoGame.CollectableItem.ctor.call(this,t,"point"),this.floats=!1,this.magnetDistance=70,this.magnetSpeed*=8}},methods:{onCollected:function(t){t.score=t.score+5|0}}}),Bridge.define("CirnoGame.MRGhosty",{inherits:[CirnoGame.PlatformerEntity,CirnoGame.ICombatant,CirnoGame.IHarmfulEntity],fields:{animation:null,attackpower:0,defensepower:0},props:{Team:0,HP:0,PointsForKilling:{get:function(){return 1}},TargetPriority:{get:function(){return.5}},IsHarmful:{get:function(){return!0}},Attacker:{get:function(){return this}},touchDamage:{get:function(){return 1.5*this.attackpower}}},alias:["Team","CirnoGame$ICombatant$Team","HP","CirnoGame$ICombatant$HP","PointsForKilling","CirnoGame$ICombatant$PointsForKilling","TargetPriority","CirnoGame$ICombatant$TargetPriority","IsHarmful","CirnoGame$IHarmfulEntity$IsHarmful","Attacker","CirnoGame$IHarmfulEntity$Attacker","touchDamage","CirnoGame$IHarmfulEntity$touchDamage","onDamaged","CirnoGame$ICombatant$onDamaged","onDeath","CirnoGame$ICombatant$onDeath","onKill","CirnoGame$ICombatant$onKill","ontouchDamage","CirnoGame$IHarmfulEntity$ontouchDamage"],ctors:{init:function(){this.animation="???",this.attackpower=1,this.defensepower=1},ctor:function(t){this.$initialize(),CirnoGame.PlatformerEntity.ctor.call(this,t),this.ChangeAni(""),this.AddBehavior(new CirnoGame.FlightControls(this)),this.AddBehavior(new CirnoGame.RandomAI(this)),this.attackpower=1+.5*this.Game.level,this.defensepower=1+.5*this.Game.level,this.Game.playing&&(this.AddBehavior$1(CirnoGame.AimedShooter),this.GetBehavior(CirnoGame.AimedShooter).attackpower=this.attackpower,this.GetBehavior(CirnoGame.AimedShooter).maxtime=Math.max(480-10*this.Game.level,380)),this.GetBehavior(CirnoGame.FlightControls).maxSpeed*=.5,this.GravityEnabled=!1,this.Team=2,this.HP=2}},methods:{Update:function(){CirnoGame.PlatformerEntity.prototype.Update.call(this),this.Ani.Flipped=!(this.Hspeed<0),this.Ani.ImageSpeed=.125*(Math.abs(this.Hspeed)+Math.abs(this.Vspeed))},ChangeAni:function(t,e){void 0===e&&(e=!1),Bridge.referenceEquals(this.animation,t)||(null==this.Ani?this.Ani=new CirnoGame.Animation(CirnoGame.AnimationLoader.Get(System.String.concat("images/enemies/mrghost",t))):this.Ani.ChangeAnimation(CirnoGame.AnimationLoader.Get(System.String.concat("images/enemies/mrghost",t)),e),this.animation=t)},onDamaged:function(t,e){this.HP-=e/this.defensepower},onDeath:function(t){this.Alive=!1;var e=new CirnoGame.PointItem(this.Game);e.Position.CopyFrom(this.Position),e.collectionDelay=0|Bridge.Int.div(e.collectionDelay,2),this.Game.AddEntity(e),Math.random()<.13&&(e=new CirnoGame.HealingItem(this.Game),e.Position.CopyFrom(this.Position),e.Vspeed=-2,e.collectionDelay=0|Bridge.Int.div(e.collectionDelay,2),this.Game.AddEntity(e))},onKill:function(t){},ontouchDamage:function(t){return!0}}}),Bridge.define("CirnoGame.PlayerCharacter",{inherits:[CirnoGame.PlatformerEntity,CirnoGame.ICombatant],fields:{animation:null,shoottime:0,prefix:null,newInput:!1,tapTimer:null,shootRecharge:0,turntime:0,score:0,orbs:0,keys:0,maxHP:0,SpawnLocation:null,lives:0,frame:0,digpower:0,attackpower:0,defensepower:0,invincibilitytime:0,blockprice:0,invincibilitymod:0},props:{Team:0,HP:0,PointsForKilling:{get:function(){return 300}},TargetPriority:{get:function(){return.7}}},alias:["Team","CirnoGame$ICombatant$Team","HP","CirnoGame$ICombatant$HP","PointsForKilling","CirnoGame$ICombatant$PointsForKilling","TargetPriority","CirnoGame$ICombatant$TargetPriority","onDamaged","CirnoGame$ICombatant$onDamaged","onDeath","CirnoGame$ICombatant$onDeath","onKill","CirnoGame$ICombatant$onKill"],ctors:{init:function(){this.animation="???",this.shoottime=0,this.prefix="",this.shootRecharge=0,this.turntime=0,this.score=0,this.orbs=0,this.keys=0,this.maxHP=20,this.SpawnLocation=new CirnoGame.Vector2,this.lives=3,this.frame=0,this.digpower=1,this.attackpower=1,this.defensepower=1,this.invincibilitytime=0,this.blockprice=9,this.invincibilitymod=1},ctor:function(t){this.$initialize(),CirnoGame.PlatformerEntity.ctor.call(this,t),this.ChangeAni("stand"),this.AddBehavior(new CirnoGame.PlatformerControls(this)),this.tapTimer=System.Array.init(this.Controller.length,0,System.Int32),this.Team=0,this.HP=this.maxHP}},methods:{MoveToNewSpawn:function(t){this.SpawnLocation.CopyFrom(t),this.Position.CopyFrom(this.SpawnLocation)},shoot:function(){if(this.shoottime<1&&(this.prefix="s",this.ChangeAni(System.String.concat(this.prefix,this.animation))),this.shootRecharge<=0){var t=new CirnoGame.PlayerBullet(this.Game,this,"Images/misc/crystal");t.Hspeed=this.Ani.Flipped?-2.5:2.5,t.x=this.x+(this.Ani.Flipped?-4:12),t.y=this.y+10,this.Controller[System.Array.index(0,this.Controller)]||this.Controller[System.Array.index(1,this.Controller)]?this.Controller[System.Array.index(2,this.Controller)]?(t.Hspeed*=.9,t.Vspeed=-Math.abs(.7*t.Hspeed)):this.Controller[System.Array.index(3,this.Controller)]&&(t.Hspeed*=.9,t.Vspeed=Math.abs(.7*t.Hspeed)):this.Controller[System.Array.index(2,this.Controller)]?(t.Hspeed*=.8,t.Vspeed=-Math.abs(t.Hspeed),t.Hspeed*=.6):this.Controller[System.Array.index(3,this.Controller)]&&(t.Hspeed*=.8,t.Vspeed=Math.abs(t.Hspeed),t.Hspeed*=.6),t.x-=t.Hspeed,t.y-=t.Vspeed,t.attacksterrain=!0,t.digpower=.6667*this.digpower,t.touchDamage=this.attackpower,this.Game.AddEntity(t),this.shootRecharge=20}this.shoottime=50,this.turntime=0},Update:function(){CirnoGame.PlatformerEntity.prototype.Update.call(this),this.shoottime>0&&(this.shoottime=this.shoottime-1|0,this.shoottime<1&&(Bridge.referenceEquals(""+String.fromCharCode(this.animation.charCodeAt(0)),this.prefix)&&this.ChangeAni(this.animation.substr(1)),this.prefix="")),this.shootRecharge>0&&(this.shootRecharge=this.shootRecharge-1|0),this.onGround?(0!==this.Hspeed?this.ChangeAni(System.String.concat(this.prefix,"walk")):this.ChangeAni(System.String.concat(this.prefix,"stand")),this.Ani.ImageSpeed=Math.abs(.125*this.Hspeed)):(this.ChangeAni(System.String.concat(this.prefix,"jump")),this.Ani.ImageSpeed=.15+.7*(Math.abs(this.Hspeed)+Math.abs(this.Vspeed))),this.Ani.Flipped!==this.Hspeed<0||0===this.Hspeed&&this.onGround?this.turntime=this.turntime+1|0:this.turntime=0,this.Controller[System.Array.index(4,this.Controller)]&&(this.turntime=0),this.Pressed(4)&&this.shoot(),this.Pressed(6)&&this.PlaceBlock(),this.UpdateController(),this.turntime>14&&0!==this.Hspeed&&(this.Ani.Flipped=this.Hspeed<0),this.invincibilitytime>0?((1&this.frame)>0&&(this.Visible=!this.Visible),this.invincibilitytime-=1):this.Visible=!0,this.frame=this.frame+1|0},PlaceBlock:function(){1e3*this.blockprice;if(!(this.Game.timeRemaining<this.blockprice)){var t=(this.Width/3,this.Height),e=this.Game.TM.CheckForTile(CirnoGame.Vector2.Add$1(this.Position,this.Width/2,t));null==e||e.enabled&&e.solid||(e.solid=!0,e.Breakable=!0,e.enabled=!0,e.texture=4,e.UpdateTile(),e.HP=2*e.maxHP,this.Game.timeRemaining-=this.blockprice)}},ChangeAni:function(t,e){void 0===e&&(e=!1),Bridge.referenceEquals(this.animation,t)||(null==this.Ani?this.Ani=new CirnoGame.Animation(CirnoGame.AnimationLoader.Get(System.String.concat("images/cirno/",t))):this.Ani.ChangeAnimation(CirnoGame.AnimationLoader.Get(System.String.concat("images/cirno/",t)),e),Bridge.referenceEquals(this.animation,"stand")||(this.turntime=0),this.animation=t)},UpdateController:function(){this.newInput=!1;for(var t=0;t<this.Controller.length;)this.tapTimer[System.Array.index(t,this.tapTimer)]=this.tapTimer[System.Array.index(t,this.tapTimer)]+1|0,this.Controller[System.Array.index(t,this.Controller)]&&!this.LController[System.Array.index(t,this.LController)]&&(this.tapTimer[System.Array.index(t,this.tapTimer)]=0,this.newInput=!0),this.LController[System.Array.index(t,this.LController)]=this.Controller[System.Array.index(t,this.Controller)],t=t+1|0;this.newInput},onDamaged:function(t,e){this.invincibilitytime<=0&&(this.HP-=e/this.defensepower,this.invincibilitytime=45)},onDeath:function(t){Bridge.referenceEquals(this.Game.player,this)?this.Game.timeRemaining>0?(this.Position.CopyFrom(this.SpawnLocation),this.HP=this.maxHP,this.Game.timeRemaining*=.6667):this.Game.DoGameOver():(this.Position.CopyFrom(this.SpawnLocation),this.HP=this.maxHP)},onKill:function(t){},GetHitbox:function(){return null!=this.Ani&&null!=this.Ani.CurrentImage?new CirnoGame.Rectangle(this.Ani.X+this.Ani.CurrentImage.width/2,this.Ani.Y+this.Ani.CurrentImage.height/2,1,1):null}}})});