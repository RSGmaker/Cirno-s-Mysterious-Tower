Bridge.assembly("CirnoGame",function(){"use strict";Bridge.define("CirnoGame.GameMode",{statics:{fields:{TeamBattle:null,DeathMatch:null,gameModes:null},ctors:{init:function(){Bridge.ready(this.init)}},methods:{GetGameModesOfType:function(type){return new(System.Collections.Generic.List$1(CirnoGame.GameMode).$ctor1)(System.Linq.Enumerable.from(CirnoGame.GameMode.gameModes).where(function(G){return G.ModeType===type}))},GetGameModeByName:function(name){var ret=new(System.Collections.Generic.List$1(CirnoGame.GameMode).$ctor1)(System.Linq.Enumerable.from(CirnoGame.GameMode.gameModes).where(function(G){return Bridge.referenceEquals(G.Name,name)}));return ret.Count>0?ret.getItem(0):null},init:function(){CirnoGame.GameMode.TeamBattle==null&&(CirnoGame.GameMode.gameModes=new(System.Collections.Generic.List$1(CirnoGame.GameMode).ctor),CirnoGame.GameMode.TeamBattle=new CirnoGame.GameMode("Team Battle"),CirnoGame.GameMode.TeamBattle.Description="2 teams battle with limited lives\nuntil only 1 team remains.",CirnoGame.GameMode.DeathMatch=new CirnoGame.GameMode("Death Match"),CirnoGame.GameMode.DeathMatch.Description="A free for all match with\nlimited lives.",CirnoGame.GameMode.DeathMatch.Teams=!1)}}},$entryPoint:!0,props:{Teams:!1,StartingLives:0,Survival:!1,AllowOnlinePlay:!1,AllowCharacterSelect:!1,NumberOfPlayers:0,RespawnTime:0,Name:null,ModeType:0,unlocked:!1,Description:null},ctors:{ctor:function(name){this.$initialize();this.Teams=!0;this.StartingLives=3;this.Survival=!0;this.AllowOnlinePlay=!0;this.AllowCharacterSelect=!0;this.NumberOfPlayers=6;this.RespawnTime=390;this.Name=name;this.ModeType=CirnoGame.GameMode.ModeTypes.Skirmish;this.Description=System.String.concat("Missing description for ",name);this.unlocked=!0;CirnoGame.GameMode.gameModes.add(this)}}});Bridge.define("CirnoGame.EntityBehavior",{fields:{enabled:!1,FramesPerTick:0,entity:null},props:{BehaviorName:null},ctors:{init:function(){this.enabled=!0;this.FramesPerTick=0},ctor:function(entity){if(this.$initialize(),this.entity=entity,Bridge.referenceEquals(this.BehaviorName,"")||this.BehaviorName==null){var test=Bridge.getType(this),FN=test.$$fullname,s=FN.split(".");this.BehaviorName=s[System.Array.index(s.length-1|0,s)]}}},methods:{Update:function(){},Draw:function(){},SendCustomEvent:function(evt,triggerflush){triggerflush===void 0&&(triggerflush=!1);var D={};D.I=this.entity.ID;D.D=evt;D.T=this.BehaviorName;this.entity.Game.SendEvent("CBE",D,triggerflush)},CustomEvent:function(){}}});Bridge.define("CirnoGame.Animation",{fields:{Images:null,_currentImage:null,CurrentFrame:0,ImageSpeed:0,Position:null,AnimationTimeElapsed:0,StretchWidth:0,StretchHeight:0,Rotation:0,Alpha:0,Looping:!1,Looped:!1,FrameChanged:!1,Flipped:!1,_transformed:!1,_shadow:0,_shadowColor:null,BufferNeedsRedraw:!1,_hueColor:null,_hueRecolorStrength:0,_buffer:null,_bg:null},props:{CurrentImage:{get:function(){return this._currentImage},set:function(value){Bridge.referenceEquals(this._currentImage,value)||(this.BufferNeedsRedraw=!0);this._currentImage=value}},X:{get:function(){return this.Position.X},set:function(value){this.Position.X=value}},Y:{get:function(){return this.Position.Y},set:function(value){this.Position.Y=value}},Shadow:{get:function(){return this._shadow},set:function(value){this._shadow!==value&&(this._shadow=value,this.BufferNeedsRedraw=!0)}},Shadowcolor:{get:function(){return this._shadowColor},set:function(value){Bridge.referenceEquals(this._shadowColor,value)||(this._shadowColor=value,this.BufferNeedsRedraw=!0)}},HueColor:{get:function(){return this._hueColor},set:function(value){Bridge.referenceEquals(this._hueColor,value)||(this.BufferNeedsRedraw=!0);this._hueColor=value}},HueRecolorStrength:{get:function(){return this._hueRecolorStrength},set:function(value){this._hueRecolorStrength!==value&&(this.BufferNeedsRedraw=!0);this._hueRecolorStrength=value}}},ctors:{init:function(){this.StretchWidth=0;this.StretchHeight=0;this.Rotation=0;this.Alpha=1;this.Looping=!0;this.Looped=!1;this.FrameChanged=!1;this.Flipped=!1;this._transformed=!1;this.BufferNeedsRedraw=!0},ctor:function(data){this.$initialize();this.Images=data;this.Images==null&&(this.Images=new(System.Collections.Generic.List$1(HTMLImageElement).ctor));this.ImageSpeed=1;this.Position=new CirnoGame.Vector2;this.AnimationTimeElapsed=0;this.Shadow=0;this.Shadowcolor="#FFFFFF";this.HueColor="";this.HueRecolorStrength=.6;this._buffer=document.createElement("canvas");this._bg=this._buffer.getContext("2d");this.Images.Count>0&&this.SetImage()}},methods:{Update:function(){var LI=this.CurrentImage,last=Bridge.Int.clip32(this.CurrentFrame),current;if(this.CurrentFrame+=this.ImageSpeed,current=Bridge.Int.clip32(this.CurrentFrame),current!==last){if(this.Images.Count>0){while(current>=this.Images.Count&&current>0)this.Looping?(current=current-this.Images.Count|0,this.CurrentFrame-=this.Images.Count):this.CurrentFrame-=this.ImageSpeed;while(current<0)current=current+this.Images.Count|0,this.CurrentFrame+=this.Images.Count}this.SetImage()}this.Looped=!1;Bridge.referenceEquals(LI,this.CurrentImage)?this.FrameChanged=!1:(this.FrameChanged=!0,(this.ImageSpeed>0&&current===0||this.ImageSpeed<0&&current===(this.Images.Count-1|0))&&(this.Looped=!0));this.AnimationTimeElapsed=this.AnimationTimeElapsed+1|0},ChangeAnimation:function(ani,reset){reset===void 0&&(reset=!0);reset&&(this.CurrentFrame=0,this.AnimationTimeElapsed=0);this.Images=ani;this.SetImage()},SetImage:function(){var ln,current;if(this.Images.Count<2)this.CurrentFrame=0;else{for(ln=this.Images.Count;this.CurrentFrame<0;)this.CurrentFrame+=ln;while(this.CurrentFrame>=ln)this.CurrentFrame-=ln}current=Bridge.Int.clip32(this.CurrentFrame);current>=0&&current<this.Images.Count&&(this.CurrentImage=this.Images.getItem(current))},Draw:function(g){this.Draw$1(g,this.Position)},Draw$1:function(g,position){var x=position.X,y=position.Y,current,adv,x2,y2,C,CG,I,I1;if(this.CurrentImage!=null||(current=Bridge.Int.clip32(this.CurrentFrame),current>=0&&current<this.Images.Count&&(this.CurrentImage=this.Images.getItem(current)),this.CurrentImage!=null)){var X=x,Y=y,lastalpha=g.globalAlpha,centered=!1,useBuffer=!1;if(Bridge.referenceEquals(this.HueColor,"")||(this.BufferNeedsRedraw&&(adv=!0,this._bg.globalCompositeOperation="source-over",this._buffer.width=this.CurrentImage.width,this._buffer.height=this.CurrentImage.height,this._bg.drawImage(this.CurrentImage,0,0),this._bg.globalAlpha=this.HueRecolorStrength,this._bg.globalCompositeOperation="hue",this._bg.fillStyle=this.HueColor,this._bg.fillRect(0,0,this._buffer.width,this._buffer.height),adv&&(this._bg.globalAlpha=(1+this.HueRecolorStrength)/2,this._bg.globalCompositeOperation="source-over",this._bg.fillRect(0,0,this._buffer.width,this._buffer.height)),this._bg.globalAlpha=1,adv&&(this._bg.globalCompositeOperation="luminosity",this._bg.drawImage(this.CurrentImage,0,0)),this._bg.globalCompositeOperation="destination-in",this._bg.drawImage(this.CurrentImage,0,0),adv&&(this._bg.globalCompositeOperation="hue",this._bg.globalAlpha=this.HueRecolorStrength*.4,this._bg.drawImage(this.CurrentImage,0,0))),useBuffer=!0),this.Alpha<1){if(this.Alpha<=0)return;g.globalAlpha=g.globalAlpha*this.Alpha}x2=this.CurrentImage.width/2;y2=this.CurrentImage.height/2;X=-x2;Y=-y2;this._transformed||(g.save(),this._transformed=!0);g.translate(x+x2,y+y2);centered=!0;g.rotate(this.Rotation);this.Flipped&&(this._transformed||(g.save(),this._transformed=!0),g.scale(-1,1),centered||g.translate(this.CurrentImage.width,0));this.Shadow>0&&(g.shadowBlur=this.Shadow,g.shadowColor=this.Shadowcolor,!useBuffer&&this.BufferNeedsRedraw&&(this._bg.shadowBlur=0,this._buffer.width=this.CurrentImage.width,this._buffer.height=this.CurrentImage.height,this._bg.drawImage(this.CurrentImage,0,0),useBuffer=!0),useBuffer=!0,this.BufferNeedsRedraw&&(C=CirnoGame.Helper.CloneCanvas(this._buffer),CG=CirnoGame.Helper.GetContext(C),this._buffer.width=this._buffer.width+Bridge.Int.clip32(this.Shadow*2)|0,this._buffer.height=this._buffer.height+Bridge.Int.clip32(this.Shadow*2)|0,this._bg.shadowBlur=this.Shadow,this._bg.shadowColor=this.Shadowcolor,this.drawWithShadows(this._bg,C,this.Shadow,this.Shadow,0,0,this.Shadow/3),useBuffer=!0),X-=this.Shadow,Y-=this.Shadow,g.shadowBlur=0);this.StretchWidth===0&&this.StretchHeight===0?this.Shadow>0&&!1?(I=this.CurrentImage,useBuffer&&(I=this._buffer),this.drawWithShadows(g,I,X,Y,0,0,this.Shadow/3)):useBuffer?g.drawImage(this._buffer,X,Y):g.drawImage(this.CurrentImage,X,Y):this.Shadow>0&&!1?(I1=this.CurrentImage,useBuffer&&(I1=this._buffer),this.drawWithShadows(g,I1,X,Y,this.StretchWidth,this.StretchHeight,this.Shadow/3)):useBuffer?g.drawImage(this._buffer,X,Y,this.StretchWidth,this.StretchHeight):g.drawImage(this.CurrentImage,X,Y,this.StretchWidth,this.StretchHeight);this._transformed&&(g.restore(),this._transformed=!1);this.Shadow>0&&(g.shadowBlur=0);this.Alpha<1&&(g.globalAlpha=lastalpha);this.BufferNeedsRedraw=!1}},drawWithShadows:function(g,I,X,Y,W,H,size){W===0&&(W=I.width,H=I.height);g.shadowOffsetX=-size;g.drawImage(I,X,Y,W,H);g.shadowOffsetX=size;g.drawImage(I,X,Y,W,H);g.shadowOffsetX=0;g.shadowOffsetY=-size;g.drawImage(I,X,Y,W,H);g.shadowOffsetY=size;g.drawImage(I,X,Y,W,H);g.shadowOffsetY=0}}});Bridge.define("CirnoGame.AnimationLoader",{statics:{fields:{__this:null},props:{_this:{get:function(){if(CirnoGame.AnimationLoader.__this==null){CirnoGame.AnimationLoader.__this=new CirnoGame.AnimationLoader;throw new System.Exception("Animation loader not initiated.");}return CirnoGame.AnimationLoader.__this}}},methods:{Init:function(Archive){CirnoGame.AnimationLoader.__this=new CirnoGame.AnimationLoader;CirnoGame.AnimationLoader.__this.Archive=Archive},Get:function(ani){return CirnoGame.AnimationLoader._this.GetAnimation(ani)}}},fields:{_data:null,Archive:null},ctors:{ctor:function(){this.$initialize();this._data=new(System.Collections.Generic.Dictionary$2(System.String,System.Collections.Generic.List$1(HTMLImageElement)))}},methods:{GetAnimation:function(ani){var A,I,j,Sani;if(this._data.containsKey(ani))return this._data.get(ani);if(A=new(System.Collections.Generic.List$1(HTMLImageElement).ctor),I=this.Archive.GetImage(System.String.concat(ani,".png")),I!=null)A.add(I);else for(j=0,Sani=System.String.concat(ani,"_");;)if(I=this.Archive.GetImage(System.String.concat(Sani,Bridge.identity(j,j=j+1|0),".png")),I==null)break;else A.add(I);return this._data.set(ani,A),A}}});Bridge.define("CirnoGame.App",{main:function(){document.body.style.cssText="overflow: hidden;margin: 0;padding: 0;";CirnoGame.GamePadManager._this=new CirnoGame.GamePadManager;CirnoGame.GamePadManager._this.Update();Bridge.global.setTimeout(function(){CirnoGame.GamePadManager._this.Update();CirnoGame.App.IC=CirnoGame.InputControllerManager._this.Controllers.getItem(0);var IM=CirnoGame.InputControllerManager._this.Controllers.getItem(0).InputMapping.getItem(2)},5);var ok=!1;CirnoGame.JSONArchive.Open("Assets/Images.JSON",function(json){CirnoGame.App.JSON=json;CirnoGame.App.JSON.PreloadImages(function(){ok=!0;CirnoGame.App.Finish()})})},statics:{fields:{Frame:0,Div:null,Canvas:null,ScreenBounds:null,JSON:null,G:null,TargetAspect:0,_lSize:0,_missingTime:0,_lTime:0,totalTime:0,_frameRendered:!1,_gameRendered:!1,IC:null,CurrentView:null,GameName:null,GameVersion:null,DEBUG:!1},ctors:{init:function(){this.Frame=0;this._lSize=-1;this._missingTime=0;this._lTime=-1;this._frameRendered=!1;this._gameRendered=!1;this.GameName="Cirno's Mysterious Tower";this.GameVersion="0.4";this.DEBUG=!1}},methods:{Finish:function(){var LT,Canv,gg,OnF;CirnoGame.AnimationLoader.Init(CirnoGame.App.JSON);LT=document.getElementById("loadtext");LT.textContent="";document.body.style.cursor="auto";document.title=System.String.concat(CirnoGame.App.GameName," ",CirnoGame.App.GameVersion," by:RSGmaker");CirnoGame.App.Div=document.createElement("div");Canv=document.createElement("canvas");CirnoGame.App.Canvas=Canv;CirnoGame.App.TargetAspect=.75;Canv.width=1024;Canv.height=Bridge.Int.clip32(Canv.width*CirnoGame.App.TargetAspect);CirnoGame.App.ScreenBounds=new CirnoGame.Rectangle(0,0,Canv.width,Canv.height);CirnoGame.App.Div.appendChild(Canv);document.body.appendChild(CirnoGame.App.Div);CirnoGame.App.G=CirnoGame.App.Canvas.getContext("2d");CirnoGame.App.G.imageSmoothingEnabled=!1;CirnoGame.App.Canvas.style.imageRendering="pixelated";gg=CirnoGame.App.G;gg.webkitImageSmoothingEnabled=!1;gg.mozImageSmoothingEnabled=!1;CirnoGame.KeyboardManager.Init();CirnoGame.App.CurrentView=new CirnoGame.Game;OnF=CirnoGame.App.RAF;requestAnimationFrame(OnF)},updateWindow:function(){var size=Math.ceil(window.innerHeight*(1/CirnoGame.App.TargetAspect));size!==CirnoGame.App._lSize&&(CirnoGame.App.Canvas.style.width="100%",CirnoGame.App.Div.style.width=System.Double.format(size)+"px",CirnoGame.App.Div.style.position="relative",CirnoGame.App.Div.style.left=System.Double.format((Bridge.Int.div(window.innerWidth,2)|0)-size/2)+"px",size=CirnoGame.App._lSize)},UpdateInputs:function(){if(CirnoGame.App.IC!=null){var L=CirnoGame.InputControllerManager._this.Controllers;L.Count>1}CirnoGame.KeyboardManager.Update()},Update:function(time){var delta=0,G,T;if(CirnoGame.App.totalTime=time,time>=0&&(CirnoGame.App._lTime<0&&(CirnoGame.App._lTime=time),delta=time-CirnoGame.App._lTime,CirnoGame.App._missingTime+=delta,Bridge.is(CirnoGame.App.CurrentView,CirnoGame.Game)&&(G=Bridge.cast(CirnoGame.App.CurrentView,CirnoGame.Game),G.running&&(G.totalTime+=delta,G.timeRemaining>0&&(G.timeRemaining-=delta),G.timeRemaining<=0&&(G.timeRemaining=0)))),CirnoGame.App.updateWindow(),CirnoGame.App._missingTime>12)CirnoGame.App.CurrentView!=null&&CirnoGame.App.CurrentView.Update(),CirnoGame.App._missingTime-=16.666666666666668,CirnoGame.App._frameRendered=!1,CirnoGame.App._gameRendered=!1;else{CirnoGame.App._lTime=time;return}if(time>=0)for(CirnoGame.App._missingTime>=3e3&&(CirnoGame.App._missingTime=0),CirnoGame.App._missingTime>=1e4,T=16.666666666666668,!0&&(T+=8);CirnoGame.App._missingTime>=T;)CirnoGame.App.CurrentView!=null&&CirnoGame.App.CurrentView.Update(),CirnoGame.App._missingTime-=16.666666666666668;CirnoGame.App._lTime=time;CirnoGame.App.Frame=CirnoGame.App.Frame+1|0;CirnoGame.HelperExtensions.Clear(CirnoGame.App.G);CirnoGame.GamePadManager._this.Update();CirnoGame.App.CurrentView!=null&&(CirnoGame.App.CurrentView.Update(),CirnoGame.App.CurrentView.Render(),CirnoGame.App.G.drawImage(CirnoGame.App.CurrentView.spriteBuffer,0,0,CirnoGame.App.Canvas.width,CirnoGame.App.Canvas.height));CirnoGame.App.UpdateInputs()},RAF:function(){var OnF=CirnoGame.App.RAF,time;requestAnimationFrame(OnF);time=Bridge.global.performance.now();CirnoGame.App.Update(time)},ColorFromAhsb:function(a,h,s,b){var shade,fMax,fMid,fMin,iSextant,iMax,iMid,iMin;if(0===s)return shade=Bridge.Int.clip32(b/255),CirnoGame.App.RGBToInt(shade,shade,shade);.5<b?(fMax=b-b*s+s,fMin=b+b*s-s):(fMax=b+b*s,fMin=b-b*s);iSextant=Bridge.Int.clip32(Math.floor(h/60));300<=h&&(h-=360);h/=60;h-=2*Math.floor((iSextant+1)%6/2);fMid=0==iSextant%2?h*(fMax-fMin)+fMin:fMin-h*(fMax-fMin);iMax=System.Convert.toInt32(Bridge.box(fMax*255,System.Single,System.Single.format,System.Single.getHashCode));iMid=System.Convert.toInt32(Bridge.box(fMid*255,System.Single,System.Single.format,System.Single.getHashCode));iMin=System.Convert.toInt32(Bridge.box(fMin*255,System.Single,System.Single.format,System.Single.getHashCode));switch(iSextant){case 1:return CirnoGame.App.RGBToInt(iMid,iMax,iMin);case 2:return CirnoGame.App.RGBToInt(iMin,iMax,iMid);case 3:return CirnoGame.App.RGBToInt(iMin,iMid,iMax);case 4:return CirnoGame.App.RGBToInt(iMid,iMin,iMax);case 5:return CirnoGame.App.RGBToInt(iMax,iMin,iMid);default:return CirnoGame.App.RGBToInt(iMax,iMid,iMin)}},RGBToInt:function(R,G,B){return(R+(G<<8)|0)+(B<<16)|0}}}});Bridge.define("CirnoGame.Audio",{fields:{_AM:null,_audio:null,_hasPlayed:!1,_blast:null,lastplayed:0,_loop:!1,OnPlay:null,OnStop:null,lasttime:0},props:{ID:null,IsPlaying:{get:function(){return!(!this._hasPlayed||this._audio.paused||this._audio.currentTime===0)},set:function(value){value?this.Play():this.Pause()}},Loop:{get:function(){return this._loop},set:function(value){this._loop=value}},CurrentTime:{get:function(){return this._audio.currentTime},set:function(value){this._audio.currentTime=value}},Volume:{get:function(){return this._audio.volume},set:function(value){this._audio.volume=value}}},ctors:{init:function(){this.lastplayed=Number.NEGATIVE_INFINITY;this.lasttime=0},ctor:function(audio,ID,AudioManager){var self,maxvoices,voices;for(this.$initialize(),this._audio=audio,this.ID=ID,self=this,this._AM=AudioManager,this._audio.onplay=function(){self._OnPlay()},this._audio.onpause=function(){self._OnStop()},this._audio.onended=function(){self._OnEnd()},this._audio.ontimeupdate=function(){self._OnUpdate()},this._blast=new(System.Collections.Generic.List$1(HTMLAudioElement).ctor),maxvoices=6,voices=1;voices<maxvoices;)this._blast.add(Bridge.cast(this._audio.cloneNode(),HTMLAudioElement)),voices=voices+1|0}},methods:{Play:function(){return this.IsPlaying?!1:(this.lasttime=this.CurrentTime,this._audio.play(),this._hasPlayed=!0,!0)},Pause:function(){return this.IsPlaying?(this._audio.pause(),!0):!1},Stop:function(){return this.IsPlaying?(this._audio.pause(),this._audio.currentTime=0,!0):!1},Blast:function(volume){var T,i,A;if(volume===void 0&&(volume=1),T=CirnoGame.App.totalTime,!(T-this.lasttime<150))if(this.IsPlaying)for(i=0;i<this._blast.Count;)A=this._blast.getItem(i),(A.paused||A.currentTime<.1||A.played.length===0)&&(A.paused||A.currentTime===0||A.played.length===0)&&(A.volume=volume,A.play(),i=this._blast.Count,this.lasttime=T),i=i+1|0;else this.Volume=volume,this.Play(),this.lasttime=T},_OnPlay:function(){this._AM.OnPlay(this);this.OnPlay&&this.OnPlay(this)},_OnStop:function(){this._AM.OnStop(this);this.OnStop&&this.OnStop(this)},_OnEnd:function(){this._OnStop()},_OnUpdate:function(){this._loop&&(this.CurrentTime+(this.CurrentTime-this.lasttime)*.8>=this._audio.duration&&(this.CurrentTime=0,this.Play()),this.lasttime=this.CurrentTime)}}});Bridge.define("CirnoGame.AudioManager",{statics:{fields:{Directory:null,__this:null},props:{_this:{get:function(){return CirnoGame.AudioManager.__this==null&&(CirnoGame.AudioManager.__this=new CirnoGame.AudioManager),CirnoGame.AudioManager.__this}}},ctors:{init:function(){this.Directory=""}},methods:{Init:function(){CirnoGame.AudioManager.__this==null&&(CirnoGame.AudioManager.__this=new CirnoGame.AudioManager)}}},fields:{data:null,playing:null},ctors:{ctor:function(){this.$initialize();this.data=new(System.Collections.Generic.Dictionary$2(System.String,CirnoGame.Audio));this.playing=new(System.Collections.Generic.List$1(CirnoGame.Audio).ctor)}},methods:{Get:function(path){if(path=System.String.concat(CirnoGame.AudioManager.Directory,path),this.data.containsKey(path))return this.data.get(path);var AE=new Audio(path),A=new CirnoGame.Audio(AE,path,this);return this.data.add(path,A),A},Play:function(path,loop){loop===void 0&&(loop=!1);var A=this.Get(path);return A.Loop=loop,A.Play(),A},Blast:function(path,volume){volume===void 0&&(volume=1);var A=this.Get(path);A.Blast(volume)},Stop:function(path){var A=this.Get(path);A.Stop()},Pause:function(path){var A=this.Get(path);A.Pause()},OnPlay:function(audio){this.playing.contains(audio)||this.playing.add(audio)},OnStop:function(audio){this.playing.contains(audio)&&this.playing.remove(audio)},StopAllFromDirectory:function(directory){directory=System.String.concat(CirnoGame.AudioManager.Directory,directory);CirnoGame.HelperExtensions.ForEach(Bridge.global.CirnoGame.Audio,this.data.getValues(),function(A){System.String.startsWith(A.ID,directory)&&A.Stop()})},StopAll:function(){CirnoGame.HelperExtensions.ForEach(Bridge.global.CirnoGame.Audio,this.data.getValues(),function(A){A.Stop()})}}});Bridge.define("CirnoGame.ButtonMenu",{fields:{rows:null,MenuWidth:0,MenuHeight:0,FontSize:0,SelectionMenu:!1,Selected:null,Self:null,OnChoose:null,Position:null},props:{SelectedData:{get:function(){return this.Self.Selected!=null?this.Self.Selected.Data:null}},SelectedText:{get:function(){return this.Self.Selected!=null&&Bridge.is(this.Self.Selected.Contents,CirnoGame.TextSprite)?Bridge.cast(this.Self.Selected.Contents,CirnoGame.TextSprite).Text:null}}},ctors:{init:function(){this.Position=new CirnoGame.Vector2},ctor:function(menuWidth,menuHeight,FontSize,selectionMenu){selectionMenu===void 0&&(selectionMenu=!1);this.$initialize();this.rows=new(System.Collections.Generic.List$1(System.Collections.Generic.List$1(CirnoGame.ButtonSprite)).ctor);this.MenuWidth=menuWidth;this.MenuHeight=menuHeight;this.FontSize=FontSize;this.SelectionMenu=selectionMenu;this.Self=this}},methods:{GetAllButtons:function(){var all=new(System.Collections.Generic.List$1(CirnoGame.ButtonSprite).ctor);return this.rows.forEach(function(R){all.addRange(R)}),all},GetSpriteByData:function(data){var all=new(System.Collections.Generic.List$1(CirnoGame.ButtonSprite).$ctor1)(System.Linq.Enumerable.from(this.GetAllButtons()).where(function(B){return Bridge.referenceEquals(B.Data,data)}));return all.Count>0?all.getItem(0):null},AddButtons:function(buttonText){CirnoGame.HelperExtensions.ForEach(System.String,buttonText,Bridge.fn.bind(this,function(T){this.AddButton(T)}))},AddButton:function(buttonText,row,data){var T,B;return row===void 0&&(row=-1),data===void 0&&(data=null),T=new CirnoGame.TextSprite,T.Text=buttonText,T.FontSize=this.FontSize,B=new CirnoGame.ButtonSprite(T,Bridge.Int.clip32(this.FontSize*.1)),data!=null&&(B.Data=data),this.AddButton$1(B,row),B},AddButton$1:function(button,row){row===void 0&&(row=-1);this.rows.Count===0&&this.rows.add(new(System.Collections.Generic.List$1(CirnoGame.ButtonSprite).ctor));row===-1&&(row=this.rows.Count-1|0);button!=null&&(button.OnClick=Bridge.fn.bind(this,function(){this.Self.Select(button)}));this.rows.getItem(row).add(button)},Select:function(button){if(!Bridge.referenceEquals(this.Selected,button)||!this.SelectionMenu){this.Selected!=null&&this.SelectionMenu&&this.Selected.SetColorScheme$1(0);this.Selected=button;var OSC=this.OnChoose,self=this;this.SelectionMenu&&this.Selected!=null&&this.Selected.SetColorScheme$1(1);this.Selected!=null&&OSC&&self.OnChoose()}},CombineRows:function(){var all=new(System.Collections.Generic.List$1(CirnoGame.ButtonSprite).ctor);this.rows.forEach(function(R){all.addRange(R)});this.rows=new(System.Collections.Generic.List$1(System.Collections.Generic.List$1(CirnoGame.ButtonSprite)).ctor);this.rows.add(all)},addRow:function(){var ret=new(System.Collections.Generic.List$1(CirnoGame.ButtonSprite).ctor);return this.rows.add(ret),ret},BreakUp:function(totalRows){var all;this.CombineRows();all=this.rows.getItem(0);this.rows=new(System.Collections.Generic.List$1(System.Collections.Generic.List$1(CirnoGame.ButtonSprite)).ctor);for(var C=Math.ceil(all.Count/totalRows),row=this.addRow(),i=0;i<all.Count;)row.Count>=C&&(row=this.addRow()),this.AddButton$1(all.getItem(i)),i=i+1|0},CenterOn:function(sprite,Center){sprite.Draw(null);var S=sprite.Size,S2=CirnoGame.Vector2.op_Division(S,2);sprite.Position=CirnoGame.Vector2.op_Subtraction(Center,S2)},UpdateRow:function(index,y){var row=this.rows.getItem(index),X=this.MenuWidth/(row.Count+1),i=0,CX=X,B;for(CX+=this.Position.X;i<row.Count;)B=row.getItem(i),B!=null&&this.CenterOn(B,new CirnoGame.Vector2(CX,y)),CX+=X,i=i+1|0},Finish:function(totalRows){var y,CY,i;for(totalRows===void 0&&(totalRows=-1),totalRows>0&&this.BreakUp(totalRows),y=0,CY=0,totalRows>0&&this.rows.Count<totalRows?(y=this.MenuHeight/(this.rows.Count+1|0),CY=y):(y=this.MenuHeight/this.rows.Count,CY=0),CY+=this.Position.Y,i=0;i<this.rows.Count;)this.UpdateRow(i,CY),CY+=y,i=i+1|0},Update:function(mousePosition,clicked){mousePosition===void 0&&(mousePosition=null);clicked===void 0&&(clicked=!0);CirnoGame.Vector2.op_Equality(mousePosition,null)&&(mousePosition=CirnoGame.KeyboardManager._this.CMouse,clicked=CirnoGame.KeyboardManager._this.TappedMouseButtons.contains(0));clicked&&this.rows.forEach(function(R){R.forEach(function(B){B!=null&&B.CheckClick(mousePosition)})})},Draw:function(g){this.rows.forEach(function(R){R.forEach(function(B){B!=null&&B.Draw(g)})})}}});Bridge.define("CirnoGame.Sprite",{fields:{Position:null,spriteBuffer:null,Visible:!1,spriteGraphics:null},props:{Size:{get:function(){return new CirnoGame.Vector2(this.spriteBuffer.width,this.spriteBuffer.height)},set:function(value){CirnoGame.Vector2.op_Equality(value,null)&&(value=new CirnoGame.Vector2);this.spriteBuffer.width=Bridge.Int.clip32(value.X);this.spriteBuffer.height=Bridge.Int.clip32(value.Y)}}},ctors:{init:function(){this.Visible=!0},ctor:function(){this.$initialize();this.spriteBuffer=document.createElement("canvas");this.spriteGraphics=this.spriteBuffer.getContext("2d");this.spriteGraphics.imageSmoothingEnabled=!1;this.Position=new CirnoGame.Vector2}},methods:{GetGraphics:function(){return this.spriteGraphics},OnFrame:function(){},Draw:function(g){this.Visible&&g.drawImage(this.spriteBuffer,this.Position.X,this.Position.Y)},GetBounds:function(){return new CirnoGame.Rectangle(this.Position.X,this.Position.Y,this.spriteBuffer.width,this.spriteBuffer.height)}}});Bridge.define("CirnoGame.ButtonSprite.ColorScheme",{fields:{BorderColor:null,ButtonColor:null},ctors:{ctor:function(borderColor,buttonColor){borderColor===void 0&&(borderColor="#00AA33");buttonColor===void 0&&(buttonColor="#11CC55");this.$initialize();this.BorderColor=borderColor;this.ButtonColor=buttonColor}}});Bridge.define("CirnoGame.Camera",{fields:{instawarp:!1,Position:null,TargetPosition:null,LinearPanSpeed:0,LerpPanSpeed:0,_scale:0,speedmod:0,_invscale:0,_center:null,viewport_width:0,viewport_height:0,CameraBounds:null,StageBounds:null,tmp:null},props:{CenteredTargetPosition:{set:function(value){this.TargetPosition=new CirnoGame.Vector2(value.X-this.CameraBounds.width/2,value.Y-this.CameraBounds.height/2)}},Scale:{get:function(){return this._scale},set:function(value){this._scale=value;this._invscale=1/this._scale;this.UpdateCameraBounds()}},InvScale:{get:function(){return this._invscale},set:function(value){this._invscale=value;this._scale=1/this._invscale;this.UpdateCameraBounds()}},Center:{get:function(){var R=this.CameraBounds;return R.GetCenter(this._center),this._center},set:function(value){this.Position.X=value.X-this.CameraBounds.width/2;this.Position.Y=value.Y-this.CameraBounds.height/2}}},ctors:{init:function(){this.instawarp=!1;this.LinearPanSpeed=.8;this.LerpPanSpeed=.07;this._scale=1;this.speedmod=1;this._invscale=1;this._center=new CirnoGame.Vector2;this.viewport_width=1;this.viewport_height=1;this.tmp=new CirnoGame.Vector2},ctor:function(viewport_width,viewport_height){viewport_width===void 0&&(viewport_width=-1);viewport_height===void 0&&(viewport_height=-1);this.$initialize();this.Position=new CirnoGame.Vector2;this.TargetPosition=new CirnoGame.Vector2;this.viewport_width=viewport_width;this.viewport_height=viewport_height;this.CameraBounds=new CirnoGame.Rectangle(0,0,viewport_width,viewport_height);this._invscale=1/this._scale;this.UpdateCameraBounds()}},methods:{ScaleToSize:function(sizeInPixels){this.Scale=sizeInPixels/CirnoGame.App.Canvas.width},UpdateCameraBounds:function(){this.CameraBounds.width=this.viewport_width*this._invscale;this.CameraBounds.height=this.viewport_height*this._invscale},Update:function(){if(this.Position.X!==this.TargetPosition.X||this.Position.Y!==this.TargetPosition.Y){var dist=this.Position.Distance(this.TargetPosition),spd=this.LinearPanSpeed+dist*this.LerpPanSpeed;if(spd*=this.speedmod,dist<=spd||this.instawarp){this.Position.X=this.TargetPosition.X;this.Position.Y=this.TargetPosition.Y;this.instawarp=!1;return}this.tmp.CopyFrom(this.Position);this.tmp.Subtract(this.TargetPosition);this.tmp.SetAsNormalize(spd);this.Position.Subtract(this.tmp);this.StageBounds!=null&&(this.Position.X=CirnoGame.MathHelper.Clamp$1(this.Position.X,this.StageBounds.left,this.StageBounds.right-this.CameraBounds.width),this.Position.Y=CirnoGame.MathHelper.Clamp$1(this.Position.Y,this.StageBounds.top,this.StageBounds.bottom-this.CameraBounds.height),this.TargetPosition.X=CirnoGame.MathHelper.Clamp$1(this.TargetPosition.X,this.StageBounds.left,this.StageBounds.right-this.CameraBounds.width),this.TargetPosition.Y=CirnoGame.MathHelper.Clamp$1(this.TargetPosition.Y,this.StageBounds.top,this.StageBounds.bottom-this.CameraBounds.height))}this.CameraBounds.x=this.Position.X;this.CameraBounds.y=this.Position.Y},Apply:function(g){g.scale(this.Scale,this.Scale);g.translate(-this.Position.X,-this.Position.Y)}}});Bridge.define("CirnoGame.Entity",{fields:{Ani:null,Alive:!1,Visible:!1,Speed:null,Game:null,_behaviors:null,_behaviorTicks:null,data:null,ZOrder:0,ID:null,HideHitbox:!1,HandledLocally:!1,RemovedOnLevelEnd:!1,HitboxBuffer:null},props:{Hspeed:{get:function(){return this.Speed.X},set:function(value){this.Speed.X=value}},Vspeed:{get:function(){return this.Speed.Y},set:function(value){this.Speed.Y=value}},Position:{get:function(){return this.Ani.Position},set:function(value){this.Ani.Position=value}},x:{get:function(){return this.Ani.Position.X},set:function(value){this.Ani.Position.X=value}},y:{get:function(){return this.Ani.Position.Y},set:function(value){this.Ani.Position.Y=value}},Width:{get:function(){return this.Ani.CurrentImage!=null?this.Ani.CurrentImage.width:0}},Height:{get:function(){return this.Ani.CurrentImage!=null?this.Ani.CurrentImage.height:0}}},ctors:{init:function(){this.Alive=!0;this.Visible=!0;this.Speed=new CirnoGame.Vector2;this.data=new(System.Collections.Generic.Dictionary$2(System.String,System.Object));this.ZOrder=0;this.HandledLocally=!0;this.RemovedOnLevelEnd=!0;this.HitboxBuffer=new CirnoGame.Rectangle},ctor:function(game){this.$initialize();this.ID=CirnoGame.Helper.GetRandomString();this.Game=game}},methods:{AddBehavior$1:function(behavior){this._behaviors==null&&(this._behaviors=new(System.Collections.Generic.List$1(CirnoGame.EntityBehavior).ctor),this._behaviorTicks=new(System.Collections.Generic.List$1(System.Int32).ctor));this._behaviors.add(behavior);this._behaviorTicks.add(0)},AddBehavior:function(T){this._behaviors==null&&(this._behaviors=new(System.Collections.Generic.List$1(CirnoGame.EntityBehavior).ctor),this._behaviorTicks=new(System.Collections.Generic.List$1(System.Int32).ctor));var B=Bridge.createInstance(T,[this]);return this._behaviors.add(Bridge.cast(B,CirnoGame.EntityBehavior)),this._behaviorTicks.add(0),Bridge.unbox(B)},RemoveBehavior:function(behavior){this._behaviors==null&&(this._behaviors=new(System.Collections.Generic.List$1(CirnoGame.EntityBehavior).ctor),this._behaviorTicks=new(System.Collections.Generic.List$1(System.Int32).ctor));this._behaviors.contains(behavior)&&(this._behaviorTicks.removeAt(this._behaviors.indexOf(behavior)),this._behaviors.remove(behavior))},RemoveBehavior$1:function(T){var $t,L,behavior;if(this._behaviors!=null){L=new(System.Collections.Generic.List$1(CirnoGame.EntityBehavior).$ctor1)(System.Linq.Enumerable.from(this._behaviors).where(function(behavior){return Bridge.is(behavior,T)}));$t=Bridge.getEnumerator(L);try{while($t.moveNext())behavior=$t.Current,this.RemoveBehavior(behavior)}finally{Bridge.is($t,System.IDisposable)&&$t.System$IDisposable$dispose()}return}},GetBehavior:function(T){return this._behaviors==null?Bridge.getDefaultValue(T):Bridge.cast(System.Linq.Enumerable.from(this._behaviors).first(function(behavior){return Bridge.is(behavior,T)}),T)},GetBehavior$1:function(T,func){var L=new(System.Collections.Generic.List$1(CirnoGame.EntityBehavior).$ctor1)(System.Linq.Enumerable.from(this._behaviors).where(function(behavior){return Bridge.is(behavior,T)})),F=func;return Bridge.cast(System.Linq.Enumerable.from(L).first(F),T)},GetTeamColor:function(){return Bridge.is(this,CirnoGame.ICombatant)?this.Game.GamePlaySettings.GameMode.Teams?CirnoGame.Game.GetTeamColor(Bridge.cast(this,CirnoGame.ICombatant).CirnoGame$ICombatant$Team):Bridge.referenceEquals(this,this.Game.player)?CirnoGame.Game.GetTeamColor(1):CirnoGame.Game.GetTeamColor(2):""},SameTeam:function(combatant){var A,B,AA,BB;return this==combatant?!0:(A=this,B=combatant,A.PointsForKilling&&B.PointsForKilling&&(AA=A,BB=B,AA.Team==BB.Team))?this.Game.Teams?!0:AA.Team==0:!1},GetBehaviorFromName:function(Name){if(this._behaviors==null)return null;try{return System.Linq.Enumerable.from(this._behaviors).first(function(behavior){return Bridge.referenceEquals(behavior.BehaviorName,Name)})}catch($e1){$e1=System.Exception.create($e1);System.Console.WriteLine(System.String.concat("Behavior ",Name," was not found."))}return null},CustomEvent:function(){},PlaySound:function(sound){this.Game.PlaySoundEffect(this.getCenter(),sound)},getCenter:function(){return CirnoGame.Vector2.Add$1(this.Position,this.Width/2,this.Height/2)},GetHitbox:function(){if(this.Ani!=null&&this.Ani.CurrentImage!=null){var CI=this.Ani.CurrentImage;return this.HitboxBuffer.Set(this.Ani.X,this.Ani.Y,CI.width,CI.height),this.HitboxBuffer}return null},Update:function(){var $t,i,behavior;if(this.Ani.Position=CirnoGame.Vector2.op_Addition(this.Ani.Position,this.Speed),this.Ani.Update(),this._behaviors!=null)for(i=0;i<this._behaviors.Count;)behavior=this._behaviors.getItem(i),behavior.enabled&&Bridge.identity(this._behaviorTicks.getItem(i),($t=this._behaviorTicks.getItem(i)+1|0,this._behaviorTicks.setItem(i,$t),$t))>=behavior.FramesPerTick&&(this._behaviorTicks.setItem(i,0),behavior.Update()),i=i+1|0},RefreshBehaviorTick:function(T){var B=this.GetBehavior(T);B!=null&&this._behaviorTicks.setItem(this._behaviors.indexOf(B),B.FramesPerTick)},Draw:function(g){var $t,behavior;if(this.Ani.Draw(g),!this.HideHitbox&&this.Game.ShowHitbox&&this.DrawHitbox(g),this._behaviors!=null){$t=Bridge.getEnumerator(this._behaviors);try{while($t.moveNext())behavior=$t.Current,behavior.Draw(g)}finally{Bridge.is($t,System.IDisposable)&&$t.System$IDisposable$dispose()}}},DrawHitbox:function(g){var R=this.GetHitbox();R!=null&&(g.strokeStyle="#FFFF00",g.strokeRect(R.x,R.y,R.width,R.height))},onRemove:function(){}}});Bridge.define("CirnoGame.GameMode.ModeTypes",{$kind:"enum",statics:{fields:{Skirmish:0,Challenge:1,CallengeCoop:2}}});Bridge.define("CirnoGame.GamePad",{fields:{connected:!1,axes:null,buttons:null,id:null,index:System.Int64(0)},ctors:{ctor:function(pad){var length,i;for(this.$initialize(),this.id=pad.id,this.index=System.Int64(pad.index),this.connected=pad.connected,this.axes=pad.axes,length=pad.buttons.length,this.buttons=System.Array.init(length,null,CirnoGame.GamePadButton),i=0;i<length;)this.buttons[System.Array.index(i,this.buttons)]=pad.buttons[i],i=i+1|0}},methods:{Update:function(){for(var i=0;i<this.buttons.length;)this.buttons[System.Array.index(i,this.buttons)].tapped=!1,i=i+1|0},CombineData:function(pad){Bridge.referenceEquals(this.id,pad.id)&&(this.connected=pad.connected,this.axes=pad.axes,this.CombineButtonData(pad.buttons))},CombineButtonData:function(buttons){var Lb=buttons,i;for(this.buttons=buttons,i=0;i<buttons.length;)buttons[System.Array.index(i,buttons)].pressed&&!Lb[System.Array.index(i,Lb)].pressed&&(buttons[System.Array.index(i,buttons)].tapped=!0),i=i+1|0}}});Bridge.define("CirnoGame.GamePadButton",{fields:{tapped:!1,pressed:!1,value:0},ctors:{ctor:function(button){this.$initialize();this.pressed=button.pressed;this.value=button.value;this.tapped=!1}}});Bridge.define("CirnoGame.GamePadManager",{statics:{fields:{_this:null}},fields:{keyboard:null,gamepads:null,tempgamepads:null},props:{activeGamepads:{get:function(){return new(System.Collections.Generic.List$1(CirnoGame.GamePad).$ctor1)(System.Linq.Enumerable.from(this.gamepads).where(function(gamepad){return gamepad.connected}))}}},ctors:{ctor:function(){this.$initialize();this.gamepads=new(System.Collections.Generic.List$1(CirnoGame.GamePad).ctor);this.Update()}},methods:{CallBackTest:function(){Bridge.global.alert("Callback!")},GetPad:function(id){var L=new(System.Collections.Generic.List$1(CirnoGame.GamePad).$ctor1)(System.Linq.Enumerable.from(this.gamepads).where(function(gamepad){return Bridge.referenceEquals(gamepad.id,id)}));return L.Count>0?L.getItem(0):null},Update:function(){for(var i=0,pads,pad;i<this.gamepads.Count;)this.gamepads.getItem(i).Update(),i=i+1|0;for(i=0,this.tempgamepads=navigator.getGamepads()||navigator.webkitGetGamepads()||[],pads=new(System.Collections.Generic.List$1(CirnoGame.GamePad).ctor);i<this.tempgamepads.length;)this.tempgamepads[i]!=null&&(pad=new CirnoGame.GamePad(this.tempgamepads[i]),this._Update(pad),pads.add(pad)),i=i+1|0;for(i=0;i<pads.Count;){for(var id=pads.getItem(i).id,j=0,ok=!0;j<this.gamepads.Count;)Bridge.referenceEquals(this.gamepads.getItem(j).id,id)&&(ok=!1),j=j+1|0;ok&&this.gamepads.add(pads.getItem(i));i=i+1|0}},_Update:function(pad){for(var i=0,P;i<this.gamepads.Count;)P=this.gamepads.getItem(i),Bridge.referenceEquals(P.id,pad.id)&&P.CombineData(pad),i=i+1|0}}});Bridge.define("CirnoGame.GamePlaySettings",{fields:{Online:!1,MyCharacter:null,GameMode:null,MyTeam:0,BlueNPCs:0,RedNPCs:0,RoomID:null,ComputerAIModifier:0},ctors:{init:function(){this.Online=!1;this.MyCharacter="Reisen";this.MyTeam=1;this.BlueNPCs=3;this.RedNPCs=2;this.RoomID="";this.ComputerAIModifier=1},ctor:function(){this.$initialize();this.GameMode=CirnoGame.GameMode.TeamBattle}}});Bridge.define("CirnoGame.Helper",{statics:{fields:{_namespaces:null},ctors:{init:function(){this._namespaces=new(System.Collections.Generic.Dictionary$2(System.String,System.Object))}},methods:{GetRandomString:function(){return(Math.random()*(new Date).getTime()).toString(36)},GetType:function(FullName){var name=FullName,s,i,obj;if(Bridge.referenceEquals(name,"")||name==null||!System.String.contains(name,"."))return null;for(s=name.split("."),i=1,CirnoGame.Helper._namespaces.containsKey(s[System.Array.index(0,s)])?obj=CirnoGame.Helper._namespaces.get(s[System.Array.index(0,s)]):(obj=eval(s[System.Array.index(0,s)]),CirnoGame.Helper._namespaces.set(s[System.Array.index(0,s)],obj));i<s.length;){if(!obj)return null;obj=obj[s[System.Array.index(i,s)]];i=i+1|0}return obj},AddMultiple:function(T,array,item,number){while(number>0)array.push(item),number=number-1|0},Repeat:function(s,number){if(number<1)return"";for(var ret=s,i=number-1|0;i>0;)ret=System.String.concat(ret,s),i=i-1|0;return ret},CloneCanvas:function(C){var ret=document.createElement("canvas"),g;return ret.width=C.width,ret.height=C.height,g=ret.getContext("2d"),g.drawImage(C,0,0),ret},GetContext:function(C){return C.getContext("2d")},GetField:function(target,fieldName){var O=target,s;if(CirnoGame.Helper.Has(O,fieldName))return O[fieldName];if(O[System.String.concat("get",fieldName)])return O[System.String.concat("get",fieldName)]();s="";try{s=System.String.concat('Helper get field: Field "',fieldName,'" was not in '+target.GetType().FullName,".")}catch($e1){$e1=System.Exception.create($e1);s=System.String.concat('Helper get field: Field "',fieldName,'" was not in '+target,".")}return console.log(s),null},Has:function(target,fieldName){return typeof target[fieldName]!="undefined"},ReloadPage:function(){window.location.href=window.location.href},SetField:function(target,fieldName,data){var O=target,s;if(CirnoGame.Helper.Has(O,fieldName)){O[fieldName]=data;return}if(O[System.String.concat("set",fieldName)]){O[System.String.concat("set",fieldName)](data);return}s="";try{s=System.String.concat('Helper set field: Field "',fieldName,'" was not in '+target.GetType().FullName,".")}catch($e1){$e1=System.Exception.create($e1);s=System.String.concat('Helper set field: Field "',fieldName,'" was not in '+target,".")}console.log(s)},CopyFields:function(source,target,Fields){var i,f;for(Fields===void 0&&(Fields=null),Fields==null&&(Fields=Object.keys(source)),i=0;i<Fields.length;)f=Fields[System.Array.index(i,Fields)],CirnoGame.Helper.SetField(target,f,CirnoGame.Helper.GetField(source,f)),i=i+1|0},KeyCodeToString:function(keycode){var codenames=System.Array.init(["","","","CANCEL","","","HELP","","BACK_SPACE","TAB","","","CLEAR","ENTER","ENTER_SPECIAL","","SHIFT","CONTROL","ALT","PAUSE","CAPS_LOCK","KANA","EISU","JUNJA","FINAL","HANJA","","ESCAPE","CONVERT","NONCONVERT","ACCEPT","MODECHANGE","SPACE","PAGE_UP","PAGE_DOWN","END","HOME","LEFT","UP","RIGHT","DOWN","SELECT","PRINT","EXECUTE","PRINTSCREEN","INSERT","DELETE","","0","1","2","3","4","5","6","7","8","9","COLON","SEMICOLON","LESS_THAN","EQUALS","GREATER_THAN","QUESTION_MARK","AT","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","OS_KEY","","CONTEXT_MENU","","SLEEP","NUMPAD0","NUMPAD1","NUMPAD2","NUMPAD3","NUMPAD4","NUMPAD5","NUMPAD6","NUMPAD7","NUMPAD8","NUMPAD9","MULTIPLY","ADD","SEPARATOR","SUBTRACT","DECIMAL","DIVIDE","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12","F13","F14","F15","F16","F17","F18","F19","F20","F21","F22","F23","F24","","","","","","","","","NUM_LOCK","SCROLL_LOCK","WIN_OEM_FJ_JISHO","WIN_OEM_FJ_MASSHOU","WIN_OEM_FJ_TOUROKU","WIN_OEM_FJ_LOYA","WIN_OEM_FJ_ROYA","","","","","","","","","","CIRCUMFLEX","EXCLAMATION","DOUBLE_QUOTE","HASH","DOLLAR","PERCENT","AMPERSAND","UNDERSCORE","OPEN_PAREN","CLOSE_PAREN","ASTERISK","PLUS","PIPE","HYPHEN_MINUS","OPEN_CURLY_BRACKET","CLOSE_CURLY_BRACKET","TILDE","","","","","VOLUME_MUTE","VOLUME_DOWN","VOLUME_UP","","","SEMICOLON","EQUALS","COMMA","MINUS","PERIOD","SLASH","BACK_QUOTE","","","","","","","","","","","","","","","","","","","","","","","","","","","OPEN_BRACKET","BACK_SLASH","CLOSE_BRACKET","QUOTE","","META","ALTGR","","WIN_ICO_HELP","WIN_ICO_00","","WIN_ICO_CLEAR","","","WIN_OEM_RESET","WIN_OEM_JUMP","WIN_OEM_PA1","WIN_OEM_PA2","WIN_OEM_PA3","WIN_OEM_WSCTRL","WIN_OEM_CUSEL","WIN_OEM_ATTN","WIN_OEM_FINISH","WIN_OEM_COPY","WIN_OEM_AUTO","WIN_OEM_ENLW","WIN_OEM_BACKTAB","ATTN","CRSEL","EXSEL","EREOF","PLAY","ZOOM","","PA1","WIN_OEM_CLEAR",""],System.String),kc;return keycode>=0&&keycode<codenames.length?codenames[System.Array.index(keycode,codenames)]:(kc=keycode,String.FromCharCode(kc))},MakeShallowCopy:function(source,fieldNames){var target,Fields,i,f;for(fieldNames===void 0&&(fieldNames=null),target={},Fields=fieldNames,Fields==null&&(Fields=Object.keys(source)),i=0;i<Fields.length;)f=Fields[System.Array.index(i,Fields)],target[f]=CirnoGame.Helper.GetField(source,f),i=i+1|0;return target}}}});Bridge.define("CirnoGame.HelperExtensions",{statics:{methods:{Pick:function(T,list,RND){var $t,L,item;RND===void 0&&(RND=null);RND==null&&(RND=new System.Random.ctor);L=new(System.Collections.Generic.List$1(T).ctor);$t=Bridge.getEnumerator(list,T);try{while($t.moveNext())item=$t.Current,L.add(item)}finally{Bridge.is($t,System.IDisposable)&&$t.System$IDisposable$dispose()}return L.getItem(RND.next$1(L.Count))},ForEach:function(T,list,action){var $t,item;$t=Bridge.getEnumerator(list,T);try{while($t.moveNext())item=$t.Current,action(item)}finally{Bridge.is($t,System.IDisposable)&&$t.System$IDisposable$dispose()}},ForEach$1:function(T,list,methodName){var $t,item,A;$t=Bridge.getEnumerator(list,T);try{while($t.moveNext())item=$t.Current,A=Bridge.unbox(item[methodName]),A()}finally{Bridge.is($t,System.IDisposable)&&$t.System$IDisposable$dispose()}},AddIfNew:function(T,list,item){for(var i=0,ln=list.Count,A=item,B;i<ln;){if(B=list.getItem(i),A==B)return;i=i+1|0}list.add(item)},RemoveAll:function(T,list,predicate){for(var i=0,item;i<list.Count;)item=list.getItem(i),predicate(item)&&(list.remove(item),i=i-1|0),i=i+1|0},PushIfNew:function(T,list,val){CirnoGame.HelperExtensions.ContainsB(T,list,val)||list.push(val)},PushRange:function(T,list,val){val===void 0&&(val=[]);for(var i=0;i<val.length;)list.push(val[System.Array.index(i,val)]),i=i+1|0},Clear$1:function(T,list){for(var i=list.length;Bridge.identity(i,i=i-1|0)>0;)list.pop()},Clear:function(G){var C=G.canvas;G.clearRect(0,0,C.width,C.height)},ReplaceAll:function(T,list,Source,Destination){for(var i=-1,j,i=CirnoGame.HelperExtensions.IndexOf(T,list,Source,i+1|0,3),ln=Source.length;i>=0;){for(j=0;j<ln;)list[System.Array.index(i+j|0,list)]=Destination[System.Array.index(j,Destination)],j=j+1|0;i=CirnoGame.HelperExtensions.IndexOf(T,list,Source,i+1|0,3)}},WhereB:function(T,list,predicate){for(var ret=System.Array.init(0,null,System.Object),i=0,ln=list.length,item;i<ln;)item=list[System.Array.index(i,list)],predicate(item)&&ret.push(item),i=i+1|0;return Bridge.unbox(ret)},ContainsB$1:function(T,list,Value){var L=Bridge.unbox(list.items);return CirnoGame.HelperExtensions.ContainsB(T,L,Value)},ContainsB:function(T,list,Value){for(var i=0,ln=list.length,O;i<ln;){if(O=list[System.Array.index(i,list)],O==Value)return!0;i=i+1|0}return!1},IndexOf:function(T,list,Value,index,structureSize){var k,l,ok;index===void 0&&(index=0);structureSize===void 0&&(structureSize=1);for(var i=index,ln=list.length,vln=Value.length,O=Value[System.Array.index(0,Value)],A,B;i<ln&&i>=0;){for(i=list.indexOf(Bridge.unbox(O),i+1|0);i>=0&&i%structureSize>0;)i=list.indexOf(Bridge.unbox(O),i+1|0);if(i===-1)return-1;if(k=1,l=i+1|0,i<ln&&i>=0){for(ok=!0;ok&&k<vln;)A=list[System.Array.index(l,list)],B=Value[System.Array.index(k,Value)],Bridge.referenceEquals(A,B)||(ok=!1),k=k+1|0,l=l+1|0;if(ok)return i}}return-1},Identical:function(T,list,list2){var ln,i,A,B;if(Bridge.referenceEquals(list,list2))return!0;if(list==null||list2==null)return!1;if(ln=list.length,ln===list2.length){for(i=0;i<ln;){if(A=list[System.Array.index(i,list)],B=list2[System.Array.index(i,list2)],!Bridge.referenceEquals(A,B))return!1;i=i+1|0}return!0}return!1},ReverseOrderWithStructure:function(T,list,size){for(var ret=new(System.Collections.Generic.List$1(T).ctor),i=0,ln=list.length,j;i<ln;){for(j=0;j<size;)ret.insert(0,list[System.Array.index((size-1|0)-j|0,list)]),j=j+1|0;i=i+size|0}},IsInstanceOfTypeFast:function(T,instance){var C=Bridge.unbox(instance).ctor,A=Bridge.unbox(T.$$inheritors);return Bridge.referenceEquals(C,T)||A!=null&&A.indexOf(C)>=0}}}});Bridge.define("CirnoGame.ICombatant",{$kind:"interface"});Bridge.define("CirnoGame.IHarmfulEntity",{$kind:"interface"});Bridge.define("CirnoGame.ILightProducer",{$kind:"interface"});Bridge.define("CirnoGame.ILightSource",{$kind:"interface"});Bridge.define("CirnoGame.InputController",{statics:{fields:{NumberOfActions:0,GM:null},ctors:{init:function(){this.NumberOfActions=8}}},fields:{InputMapping:null},props:{id:null},ctors:{ctor:function(id){id===void 0&&(id="Keyboard");this.$initialize();this.id=id;this.InputMapping=new(System.Collections.Generic.List$1(CirnoGame.InputMap).ctor);Bridge.referenceEquals(id,"Keyboard")?this.initkeyboard():this.initgamepad();CirnoGame.InputController.GM==null&&(CirnoGame.GamePadManager._this==null&&(CirnoGame.GamePadManager._this=new CirnoGame.GamePadManager),CirnoGame.InputController.GM=CirnoGame.GamePadManager._this)}},methods:{CopyMap:function(){for(var fields=System.Array.init(["map","antimap","name","axis","controllerID"],System.String),ret=System.Array.init(this.InputMapping.Count,null,System.Object),i=0;i<ret.length;)ret[System.Array.index(i,ret)]=CirnoGame.Helper.MakeShallowCopy(this.InputMapping.getItem(i),fields),i=i+1|0;return ret},CopyFromMap:function(Map){for(var fields=System.Array.init(["map","antimap","name","axis","controllerID"],System.String),i=0,IM;i<Map.length;)i>=this.InputMapping.Count&&this.InputMapping.add(new CirnoGame.InputMap.ctor),IM=this.InputMapping.getItem(i),CirnoGame.Helper.CopyFields(Map[System.Array.index(i,Map)],IM,fields),i=i+1|0},initkeyboard:function(){for(var i=0,map;i<CirnoGame.InputController.NumberOfActions;)map=new CirnoGame.InputMap.$ctor1(-1),i===0&&(map.map=39,map.antimap=37),i===1&&(map.map=40,map.antimap=38),i===2&&(map.map=90),i===3&&(map.map=88),i===4&&(map.map=65),i===5&&(map.map=13),this.InputMapping.add(map),i=i+1|0},initgamepad:function(){for(var i=0,map;i<CirnoGame.InputController.NumberOfActions;)map=new CirnoGame.InputMap.$ctor1(-1),i===0&&(map.map=0,map.axis=!0),i===1&&(map.map=1,map.axis=!0),i>1&&(map.map=i-2|0),this.InputMapping.add(map),i=i+1|0},getState:function(action,map){map===void 0&&(map=null);map==null&&(map=this.InputMapping.getItem(action));var TID=this.id;return Bridge.referenceEquals(map.controllerID,"")||(TID=map.controllerID),Bridge.referenceEquals(TID,"Keyboard")?this.getKeyboardMapState(map):Bridge.referenceEquals(TID,"Mouse")?this.getMouseMapState(map):this.getGamepadMapState(map)},getPressed:function(action,map){return map===void 0&&(map=null),this.getState(action,map)>=.7},FindAnyPressedGamePadInput:function(){var ret=new CirnoGame.InputMap.ctor,L=CirnoGame.GamePadManager._this.activeGamepads;return(L.forEach(function(G){var GB,tmp,i;if(ret.map===-1)if(ret.controllerID=G.id,GB=System.Linq.Enumerable.from(G.buttons).where(function(B){return B.pressed}).toArray(CirnoGame.GamePadButton),GB.length>0)ret.axis=!1,tmp=GB[System.Array.index(0,GB)],ret.map=new(System.Collections.Generic.List$1(CirnoGame.GamePadButton).$ctor1)(G.buttons).indexOf(tmp);else for(i=0;i<G.axes.length&&ret.map===-1;)Math.abs(G.axes[System.Array.index(i,G.axes)])>.7&&Math.abs(G.axes[System.Array.index(i,G.axes)])<2&&(ret.axis=!0,ret.map=i,G.axes[System.Array.index(i,G.axes)]<0&&(ret.name="anti",ret.antimap=i)),i=i+1|0}),ret.map!==-1)?ret:null},getMapControllerID:function(map){return Bridge.referenceEquals(map.controllerID,"")?this.id:map.controllerID},getMapControllerID$1:function(action){return this.getMapControllerID(this.InputMapping.getItem(action))},getGamepadMapState:function(map){var TID=this.id,P;return(Bridge.referenceEquals(map.controllerID,"")||(TID=map.controllerID),P=CirnoGame.GamePadManager._this.GetPad(TID),P==null||!P.connected)?0:map.axis?P.axes[System.Array.index(map.map,P.axes)]:P.buttons[System.Array.index(map.map,P.buttons)].pressed?1:map.antimap>=0&&P.buttons[System.Array.index(map.antimap,P.buttons)].pressed?-1:0},getKeyboardMapState:function(map){var L=CirnoGame.KeyboardManager._this.PressedButtons;return L.contains(map.map)?1:L.contains(map.antimap)?-1:0},getMouseMapState:function(map){var L=CirnoGame.KeyboardManager._this.PressedMouseButtons;return L.contains(map.map)?1:L.contains(map.antimap)?-1:0}}});Bridge.define("CirnoGame.InputControllerManager",{statics:{fields:{__this:null},props:{_this:{get:function(){return CirnoGame.InputControllerManager.__this==null&&(CirnoGame.InputControllerManager.__this=new CirnoGame.InputControllerManager),CirnoGame.InputControllerManager.__this}}},methods:{Init:function(){CirnoGame.InputControllerManager.__this==null&&(CirnoGame.InputControllerManager.__this=new CirnoGame.InputControllerManager)}}},fields:{Controllers:null},ctors:{ctor:function(){this.$initialize();this.Controllers=new(System.Collections.Generic.List$1(CirnoGame.InputController).ctor);this.Controllers.add(new CirnoGame.InputController);for(var gamepads=CirnoGame.GamePadManager._this.activeGamepads,i=0;i<gamepads.Count;)this.Controllers.add(new CirnoGame.InputController(gamepads.getItem(i).id)),i=i+1|0}}});Bridge.define("CirnoGame.InputMap",{fields:{map:0,antimap:0,name:null,axis:!1,controllerID:null},ctors:{init:function(){this.map=-1;this.antimap=-1;this.name="";this.axis=!1;this.controllerID=""},ctor:function(){this.$initialize();this.axis=!1},$ctor1:function(map,antimap,axis){antimap===void 0&&(antimap=-1);axis===void 0&&(axis=!1);this.$initialize();this.map=map;this.antimap=antimap;this.axis=axis}}});Bridge.define("CirnoGame.JSONArchive",{statics:{methods:{Open:function(ArchiveFile,action){var XHR=new XMLHttpRequest;XHR.onload=function(){action(new CirnoGame.JSONArchive(XHR.responseText))};XHR.open("GET",ArchiveFile,!1);XHR.send()}}},fields:{Data:null,Images:null},ctors:{init:function(){this.Data=new(System.Collections.Generic.Dictionary$2(System.String,System.String));this.Images=new(System.Collections.Generic.Dictionary$2(System.String,HTMLImageElement))},ctor:function(Archive){var A;this.$initialize();for(var D=JSON.parse(Archive),i=0,ln=D.length;i<ln;)A=D[System.Array.index(Bridge.identity(i,i=i+1|0),D)],this.Data.set(A[System.Array.index(0,A)].toLowerCase(),A[System.Array.index(1,A)])}},methods:{PreloadImages:function(action,delay){var K,i,A;for(delay===void 0&&(delay=100),K=System.Linq.Enumerable.from(this.Data.getKeys()).toArray(),i=0;i<this.Data.count;)A=K[System.Array.index(i,K)],this.GetImage(A),i=i+1|0;Bridge.global.setTimeout(action,delay)},GetData:function(file){var f=file.toLowerCase();return this.Data.containsKey(f)?this.Data.get(f):null},GetImage:function(file){var f=file.toLowerCase(),D,ret;return this.Images.containsKey(f)?this.Images.get(f):(D=this.GetData(f),D==null)?null:(ret=new Image,ret.onload=function(){console.log(System.String.concat("loaded ",f," from JSON!"))},ret.src=System.String.concat("data:image/png;base64,",D),this.Images.set(f,ret),ret)}}});Bridge.define("CirnoGame.KeyboardManager",{statics:{fields:{__this:null},props:{_this:{get:function(){return CirnoGame.KeyboardManager.__this==null&&(CirnoGame.KeyboardManager.__this=new CirnoGame.KeyboardManager),CirnoGame.KeyboardManager.__this}}},methods:{Init:function(){CirnoGame.KeyboardManager.__this==null&&(CirnoGame.KeyboardManager.__this=new CirnoGame.KeyboardManager)},Update:function(){CirnoGame.KeyboardManager.__this.TappedButtons.clear();CirnoGame.KeyboardManager.__this.TappedMouseButtons.clear()},NeverinBounds:function(){return!CirnoGame.App.ScreenBounds.containsPoint$1(CirnoGame.KeyboardManager._this.CMouse.X,CirnoGame.KeyboardManager._this.CMouse.Y)},onKeyDown:function(evt){var keyCode=evt.keyCode;return(CirnoGame.KeyboardManager.__this.PressedButtons.contains(keyCode)||(CirnoGame.KeyboardManager.__this.PressedButtons.add(keyCode),CirnoGame.KeyboardManager.__this.TappedButtons.add(keyCode)),keyCode>=37&&keyCode<=40||keyCode===32||keyCode===112)?!1:!0},onKeyUp:function(evt){var keyCode=evt.keyCode;CirnoGame.KeyboardManager.__this.PressedButtons.contains(keyCode)&&CirnoGame.KeyboardManager.__this.PressedButtons.remove(keyCode)},onMouseDown:function(evt){var btn=evt.button;return CirnoGame.KeyboardManager.__this.PressedMouseButtons.contains(btn)||(CirnoGame.KeyboardManager.__this.PressedMouseButtons.add(btn),CirnoGame.KeyboardManager.__this.TappedMouseButtons.add(btn)),btn<1},onMouseUp:function(evt){var btn=evt.button;return CirnoGame.KeyboardManager.__this.PressedMouseButtons.contains(btn)&&CirnoGame.KeyboardManager.__this.PressedMouseButtons.remove(btn),btn<1},onMouseMove:function(evt){if(CirnoGame.KeyboardManager._this.MousePosition=new CirnoGame.Vector2(evt.clientX,evt.clientY),!(System.String.indexOf(CirnoGame.App.Div.style.left,"px")<0)){var left=System.Single.parse(System.String.replaceAll(CirnoGame.App.Div.style.left,"px","")),x=evt.clientX-left,y=evt.clientY,scale=CirnoGame.App.Canvas.width/System.Single.parse(System.String.replaceAll(CirnoGame.App.Div.style.width,"px",""));CirnoGame.KeyboardManager._this.CMouse=new CirnoGame.Vector2(x*scale,y*scale)}}}},fields:{PressedButtons:null,TappedButtons:null,PressedMouseButtons:null,TappedMouseButtons:null,MousePosition:null,CMouse:null},ctors:{init:function(){this.MousePosition=new CirnoGame.Vector2;this.CMouse=new CirnoGame.Vector2},ctor:function(){var KD,KU,MM,MD,MU,NB;this.$initialize();this.PressedButtons=new(System.Collections.Generic.List$1(System.Int32).ctor);this.TappedButtons=new(System.Collections.Generic.List$1(System.Int32).ctor);this.PressedMouseButtons=new(System.Collections.Generic.List$1(System.Int32).ctor);this.TappedMouseButtons=new(System.Collections.Generic.List$1(System.Int32).ctor);KD=CirnoGame.KeyboardManager.onKeyDown;document.onkeydown=KD;KU=CirnoGame.KeyboardManager.onKeyUp;document.onkeyup=KU;MM=CirnoGame.KeyboardManager.onMouseMove;document.onmousemove=MM;MD=CirnoGame.KeyboardManager.onMouseDown;document.onmousedown=MD;MU=CirnoGame.KeyboardManager.onMouseUp;document.onmouseup=MU;NB=CirnoGame.KeyboardManager.NeverinBounds;document.oncontextmenu=NB}}});Bridge.define("CirnoGame.MapGenerator",{statics:{fields:{rootroom:null,doorroom:null,keyroom:null,blank:null},ctors:{init:function(){this.blank=new CirnoGame.TileData}},methods:{AttemptCreateLever:function(game,Target){for(var lever;;)if(lever=CirnoGame.RoomOpeningLever.FindAndPlaceOnWall(game,CirnoGame.MapRoom.FindAnyEmptySpot(),Target),lever!=null)return lever;return null},FindEmptySpace:function(game){for(var map=game.TM,bounds=game.stageBounds,i=0,ret=new CirnoGame.Vector2,tmp=new CirnoGame.Vector2;i<2e3;){if(ret.X=bounds.left+Math.random()*(bounds.width-map.tilesize),ret.Y=bounds.top+Math.random()*(bounds.bottom-map.tilesize),!map.CheckForTile(ret).visible&&(tmp.X=ret.X,tmp.Y=ret.Y-map.tilesize,!map.CheckForTile(ret).visible))return ret;i=i+1|0}return null},pathMiner:function(game,X,Y,Xdir,YDir,limit){var XD,YD;if(!(limit<=0)){var player=game.player,map=game.TM,bounds=game.stageBounds,pow=1;for(YDir!==0&&(pow=2);!0&&Math.random()<Math.pow(.95,pow);)X=X+Xdir|0,Y=Y+YDir|0,CirnoGame.MapGenerator.Erase(map,X,Y,3),Math.random()<.2*pow?Xdir===0?X=X+(Math.random()<.5?1:-1)|0:Y=Y+(Math.random()<.5?1:-1)|0:Math.random()<.02*pow&&limit>4&&(limit=Bridge.Int.div(limit,2)|0,XD=Math.random()<.5?YDir:-YDir|0,YD=Math.random()<.5?Xdir:-Xdir|0,CirnoGame.MapGenerator.pathMiner(game,X,Y,XD,YD,limit));limit=limit-1|0;limit>1&&CirnoGame.MapGenerator.roomMiner(game,X,Y,Xdir,YDir,limit)}},roomMiner:function(game,X,Y,Xdir,YDir,limit){var SZ,XD,YD;limit<=0||(SZ=Bridge.Int.clip32(4+Math.random()*4),X=X+Bridge.Int.mul(Xdir,Bridge.Int.div(SZ,2)|0)|0,Y=Y+Bridge.Int.mul(YDir,Bridge.Int.div(SZ,2)|0)|0,CirnoGame.MapGenerator.EraseAndRando(game.TM,X,Y,Bridge.Int.mul(SZ,2)+2|0),XD=Xdir,YD=YDir,(Math.random()<.2||YD!==0&&Math.random()<.65||YD<0)&&(XD=Math.random()<.5?YDir:-YDir|0,YD=Math.random()<.5?Xdir:-Xdir|0,YD<0&&(YD=-YD|0)),Xdir=XD,YDir=YD,X=X+Bridge.Int.mul(Xdir,Bridge.Int.div(SZ,2)|0)|0,Y=Y+Bridge.Int.mul(YDir,Bridge.Int.div(SZ,2)|0)|0,limit=limit-1|0,CirnoGame.MapGenerator.pathMiner(game,X,Y,Xdir,YDir,limit))},Erase:function(TM,column,row,size){TM.ClearRect$1(column-(Bridge.Int.div(size,2)|0)|0,row-(Bridge.Int.div(size,2)|0)|0,size,size)},EraseAndRando:function(TM,column,row,size){var SX=column-(Bridge.Int.div(size,2)|0)|0,SY=row-(Bridge.Int.div(size,2)|0)|0;TM.ClearRect$1(SX,SY,size,size);TM._GenRect(SX,SY,SX+size|0,SY+size|0)}}},fields:{game:null,started:!1,root:null,roomtotal:0,generated:!1,finished:!1,attempts:0},ctors:{init:function(){this.started=!1;this.generated=!1;this.finished=!1;this.attempts=0}},methods:{Generate:function(rooms){var roomMinimum,R,L;if(rooms===void 0&&(rooms=1),!this.generated){var map=this.game.TM,bounds=this.game.stageBounds,SX=Bridge.Int.div(map.columns,2)|0,SY=Bridge.Int.div(map.rows,3)|0;if(!this.started){if(console.log("started boxy generate"),this.root=new CirnoGame.MapRoom,this.root.SX=SX,this.root.SY=SY,this.root.EX=(SX+6|0)+Bridge.Int.clip32(Math.random()*10)|0,this.root.EY=(SY+6|0)+Bridge.Int.clip32(Math.random()*10)|0,this.root.game=this.game,CirnoGame.MapGenerator.rootroom=this.root,CirnoGame.MapRoom.PlacedRooms=new(System.Collections.Generic.List$1(CirnoGame.MapRoom).ctor),CirnoGame.MapRoom.OpenRooms=new(System.Collections.Generic.List$1(CirnoGame.MapRoom).ctor),roomMinimum=10+Math.min(this.game.level,4)|0,this.roomtotal=roomMinimum+Bridge.Int.clip32(Math.random()*roomMinimum)|0,!this.root.PlaceAndExpand()){console.log("Couldn't generate root room.");this.generated=!0;return}this.attempts=400;this.started=!0}if(R=this.root,CirnoGame.MapRoom.OpenRooms.Count<this.roomtotal&&this.attempts>0)while(rooms>0&&CirnoGame.MapRoom.OpenRooms.Count<this.roomtotal&&this.attempts>0)L=CirnoGame.HelperExtensions.Pick(Bridge.global.CirnoGame.MapRoom,CirnoGame.MapRoom.FindValidUnplacedRooms()),L.PlaceAndExpand(),this.attempts=this.attempts-1|0,rooms=rooms-1|0;else this.generated=!0,console.log("basic generation completed")}},finishGeneration:function(){var player,RR,secrets,L,lever,V,PC;if(!this.generated){console.log("finishgeneration() was called before basic generation was completed, aborting...");return}for(player=this.game.player,RR=CirnoGame.Rectangle.op_Subtraction(this.game.stageBounds,this.game.TM.position),RR.width-=this.game.TM.tilesize,RR.height-=this.game.TM.tilesize,this.game.TM.DrawRect(RR),this.game.TM.ApplyBreakable(),secrets=Math.random()<.3?1:0,secrets>0&&Math.random()<.3&&(secrets=secrets+1|0);secrets>0;)L=CirnoGame.HelperExtensions.Pick(Bridge.global.CirnoGame.MapRoom,CirnoGame.MapRoom.FindValidUnplacedRooms()),L.PlaceAndExpand()&&(L.MakeSecret(),lever=CirnoGame.MapGenerator.AttemptCreateLever(this.game,L),this.game.AddEntity(lever),console.log("Placed secret room at:"+L.SX+","+L.SY)),secrets=secrets-1|0;V=CirnoGame.MapGenerator.FindEmptySpace(this.game);CirnoGame.MapGenerator.keyroom=null;CirnoGame.Vector2.op_Inequality(V,null)?(this.game.Door.Position.CopyFrom(V),this.game.Door.DropToGround(),CirnoGame.MapGenerator.doorroom=CirnoGame.MapRoom.FindRoom(this.game.Door.Position),CirnoGame.MapGenerator.doorroom==null&&console.log("Door room could not be determined..."),PC=player,PC.MoveToNewSpawn(this.game.Door.Position),console.log("spawning at:"+Bridge.Int.clip32(V.X)+","+Bridge.Int.clip32(V.Y))):console.log("cannot locate a spawn point...");this.finished=!0},forceGeneration:function(){if(this.finished){console.log("cant force generate, an already generated map.");return}this.generated||this.Generate(this.attempts+1|0);this.finishGeneration()}}});Bridge.define("CirnoGame.MapRoom",{statics:{fields:{PlacedRooms:null,OpenRooms:null,RNG:null},ctors:{init:function(){this.PlacedRooms=new(System.Collections.Generic.List$1(CirnoGame.MapRoom).ctor);this.OpenRooms=new(System.Collections.Generic.List$1(CirnoGame.MapRoom).ctor);this.RNG=new System.Random.ctor}},methods:{FindValidUnplacedRooms:function(){for(var L=new(System.Collections.Generic.List$1(CirnoGame.MapRoom).ctor),i=0,ln=CirnoGame.MapRoom.OpenRooms.Count,P;i<ln;)P=CirnoGame.MapRoom.OpenRooms.getItem(i),L.addRange(System.Linq.Enumerable.from(P.ExitRooms).where(function(F){return F.CanBePlaced()&&!F.placed})),i=i+1|0;return L},FindRoom:function(V){var L=System.Linq.Enumerable.from(CirnoGame.MapRoom.OpenRooms).where(function(R){return R.ContainsPosition(V)}).toArray(CirnoGame.MapRoom);return L.length>0?L[System.Array.index(0,L)]:null},FindAnyEmptySpot:function(){var i,ret;if(CirnoGame.MapRoom.OpenRooms.Count<1)return null;for(i=0;i<10;){if(ret=CirnoGame.HelperExtensions.Pick(Bridge.global.CirnoGame.MapRoom,CirnoGame.MapRoom.OpenRooms,CirnoGame.MapRoom.RNG).FindEmptySpot(),CirnoGame.Vector2.op_Inequality(ret,null))return ret;i=i+1|0}return null}}},fields:{SX:0,SY:0,EX:0,EY:0,placed:!1,secret:!1,ExitRooms:null,parent:null,goldchests:null,game:null},ctors:{init:function(){this.placed=!1;this.secret=!1;this.ExitRooms=new(System.Collections.Generic.List$1(CirnoGame.MapRoom).ctor);this.goldchests=System.Array.init(0,null,CirnoGame.Chest)}},methods:{IsValid:function(){var map=this.game.TM;return this.SX>=0&&this.SY>=0&&this.EX<map.columns&&this.EY<map.rows?!0:!1},CanBePlaced:function(){var map=this.game.TM;return this.IsValid()&&map.IsRectSolid(this.SX,this.SY,this.EX,this.EY)?!0:!1},GenerateAdjacentRooms:function(){var M=this.GenerateAdjacentRoom(-1,0);M!=null&&this.ExitRooms.add(M);M=this.GenerateAdjacentRoom(1,0);M!=null&&this.ExitRooms.add(M);Math.random()<.5&&(M=this.GenerateAdjacentRoom(0,-1),M!=null&&this.ExitRooms.add(M),M=this.GenerateAdjacentRoom(0,1),M!=null&&this.ExitRooms.add(M))},GenerateAdjacentRoom:function(Xdir,Ydir){var min=5,max=13,dif=max-min|0,W=Bridge.Int.clip32(min+Math.random()*dif),M;min=min-1|0;max=max-4|0;dif=max-min|0;var H=Bridge.Int.clip32(min+Math.random()*dif),X=-1,Y=-1,SX=this.SX,SY=this.SY,EX=this.EX,EY=this.EY;return(Xdir!==0?(SY=SY-(H-2|0)|0,Y=Bridge.Int.clip32(SY+Math.random()*(EY-SY|0)),X=Xdir<0?SX-W|0:EX):Ydir!==0&&(SX=SX-(W-2|0)|0,X=Bridge.Int.clip32(SX+Math.random()*(EX-SX|0)),Y=Ydir<0?SY-H|0:EY),X>=0&&Y>=0&&(M=new CirnoGame.MapRoom,M.SX=X,M.SY=Y,M.EX=X+W|0,M.EY=Y+H|0,M.parent=this,M.game=this.game,M.CanBePlaced()))?M:null},ContainsTile:function(X,Y){return X>=this.SX&&Y>=this.SY&&X<this.EX&&Y<this.EY},ContainsPosition:function(V){var X=Bridge.Int.clip32((V.X-this.game.TM.position.X)/this.game.TM.tilesize),Y=Bridge.Int.clip32((V.Y-this.game.TM.position.Y)/this.game.TM.tilesize);return X>=this.SX&&Y>=this.SY&&X<this.EX&&Y<this.EY},PlaceAndExpand:function(){return this.ExitRooms.Count<1&&!this.placed&&this.CanBePlaced()?(this.Place(),this.placed&&this.GenerateAdjacentRooms(),this.placed):(this.placed||this.parent!=null&&CirnoGame.HelperExtensions.ContainsB$1(Bridge.global.CirnoGame.MapRoom,this.parent.ExitRooms,this)&&this.parent.ExitRooms.remove(this),!1)},GenerateGoldChests:function(){var locked=!CirnoGame.MapRoom.OpenRooms.contains(this),V=this.FindEmptySpot(),chest=new CirnoGame.Chest(this.game),V2,attempts;for(this.goldchests.push(chest),chest.ForceLocked=locked,chest.Position.CopyFrom(V),chest.Goldify(),this.game.AddEntity(chest),V2=this.FindEmptySpot(),attempts=0;Bridge.identity(attempts,attempts=attempts+1|0)<5&&(CirnoGame.Vector2.op_Equality(V2,null)||Math.abs(V2.X-V.X)<16);)V2=this.FindEmptySpot();CirnoGame.Vector2.op_Inequality(V2,null)&&Math.abs(V2.X-V.X)>16&&(chest=new CirnoGame.Chest(this.game),this.goldchests.push(chest),chest.Position.CopyFrom(V2),chest.ForceLocked=locked,chest.Goldify(),this.game.AddEntity(chest))},NMakeSecret:function(){var TM=this.game.TM,W=this.EX-this.SX|0,H=this.EY-this.SY|0;TM.DrawRect$1(this.SX,this.SY,W,H);TM.SetBreakableRect(this.SX,this.SY,W,H,!1);TM.ClearRect$1(this.SX+1|0,this.SY+1|0,W-2|0,H-2|0);CirnoGame.MapRoom.OpenRooms.contains(this)&&CirnoGame.MapRoom.OpenRooms.remove(this);this.secret=!0;this.GenerateGoldChests();this.ForceRedraw()},MakeSecret:function(){var TM=this.game.TM,W=this.EX-this.SX|0,H=this.EY-this.SY|0;TM.FillRect(this.SX,this.SY,W,H);TM.SetBreakableRect(this.SX,this.SY,W,H,!1);TM.SetBreakableRect(this.SX+1|0,this.SY+1|0,W-2|0,H-2|0,!0);CirnoGame.MapRoom.OpenRooms.contains(this)&&CirnoGame.MapRoom.OpenRooms.remove(this);this.secret=!0},NUnleashSecret:function(){var TM=this.game.TM;TM.ClearOuterRect(this.SX,this.SY,this.EX-this.SX|0,this.EY-this.SY|0,!1);CirnoGame.MapRoom.OpenRooms.add(this);CirnoGame.HelperExtensions.ForEach(Bridge.global.CirnoGame.Chest,this.goldchests,function(C){C.ForceLocked=!1});this.ForceRedraw()},UnleashSecret:function(){var TM=this.game.TM;TM.ClearRect$1(this.SX+1|0,this.SY+1|0,(this.EX-this.SX|0)-2|0,(this.EY-this.SY|0)-2|0);TM._GenRect(this.SX,this.SY,this.EX,this.EY);CirnoGame.MapRoom.OpenRooms.add(this);this.GenerateGoldChests();this.ForceRedraw()},ClearRoom:function(){var TM=this.game.TM;TM.ClearRect$1(this.SX,this.SY,this.EX-this.SX|0,this.EY-this.SY|0)},GeneratePlatforms:function(){var TM=this.game.TM;TM._GenRect(this.SX,this.SY,this.EX,this.EY)},Place:function(){var TM=this.game.TM;TM.ClearRect$1(this.SX,this.SY,this.EX-this.SX|0,this.EY-this.SY|0);TM._GenRect(this.SX,this.SY,this.EX,this.EY);this.BridgeToParent();CirnoGame.MapRoom.PlacedRooms.add(this);CirnoGame.MapRoom.OpenRooms.add(this);this.placed=!0},BridgeToParent:function(){var X=0,Y=0,BX,range,BY,range1,TM;if(this.parent!=null&&this.parent.placed){if(this.EX<this.parent.SX)X=-1;else if(this.SX>this.parent.EX)X=1;else if(this.EY<this.parent.SY)Y=-1;else if(this.SY>this.parent.EY)Y=1;else return;var LX=0,LY=0,W=0,H=0;Y!==0?(BX=System.Array.init([Math.max(this.SX,this.parent.SX),Math.min(this.EX,this.parent.EX)],System.Int32),W=Math.random()<.5?1:2,range=(BX[System.Array.index(1,BX)]-BX[System.Array.index(0,BX)]|0)-(W-1|0)|0,LX=BX[System.Array.index(0,BX)]+Bridge.Int.clip32(Math.random()*range)|0,LY=Y<0?this.EY-2|0:this.SY+2|0,H=5):(BY=System.Array.init([Math.max(this.SY,this.parent.SY),Math.min(this.EY,this.parent.EY)],System.Int32),H=Math.random()<.5?1:2,range1=(BY[System.Array.index(1,BY)]-BY[System.Array.index(0,BY)]|0)-(H-1|0)|0,LY=BY[System.Array.index(0,BY)]+Bridge.Int.clip32(Math.random()*range1)|0,LX=X<0?this.EX-2|0:this.SX+2|0,W=5);TM=this.game.TM;TM.ClearRect$1(LX,LY,W,H)}},ApplyBreakable:function(){var TM=this.game.TM;TM.ApplyBreakableRect(this.SX-2|0,this.SY-2|0,(this.EX-this.SX|0)+4|0,(this.EY-this.SY|0)+4|0)},ForceRedraw:function(){var TM=this.game.TM,X=this.SX-2|0,Y=this.SY-2|0,W=(this.EX-this.SX|0)+4|0,H=(this.EY-this.SY|0)+4|0;TM.bg.clearRect(Bridge.Int.mul(Bridge.Int.clip32(TM.tilesize),X),Bridge.Int.mul(Bridge.Int.clip32(TM.tilesize),Y),Bridge.Int.mul(Bridge.Int.clip32(TM.tilesize),W),Bridge.Int.mul(Bridge.Int.clip32(TM.tilesize),H));TM.Redraw(TM.bg,X,Y,W,H)},FindEmptySpot:function(){for(var W=this.EX-this.SX|0,H=this.EY-this.SY|0,i=0,map=this.game.TM;i<50;){var X=Bridge.Int.clip32(this.SX+Math.random()*W),Y=Bridge.Int.clip32(this.SY+Math.random()*H),T=map.GetTile(X,Y);if(T!=null&&(!T.enabled||!T.solid)&&(T=map.GetTile(X,Y-1|0),T!=null&&(!T.enabled||!T.solid)))return new CirnoGame.Vector2(map.position.X+X*map.tilesize,map.position.Y+Y*map.tilesize);i=i+1|0}return null}}});Bridge.define("CirnoGame.MathHelper",{statics:{fields:{PI:0,PI2:0,PIOver2:0},ctors:{init:function(){this.PI=3.14159274;this.PI2=6.28318548;this.PIOver2=1.57079637}},methods:{DistanceBetweenPoints:function(A,B){return CirnoGame.MathHelper.DistanceBetweenPoints$1(A.X,A.Y,B.X,B.Y)},DistanceBetweenPoints$1:function(x1,y1,x2,y2){return Math.sqrt(Math.pow(x1-x2,2)+Math.pow(y1-y2,2))},Clamp$1:function(value,min,max){return Math.min(max,Math.max(min,value))},Clamp:function(value,min,max){return min===void 0&&(min=0),max===void 0&&(max=1),Math.min(max,Math.max(min,value))},Lerp$1:function(value1,value2,amount){return value1+(value2-value1)*amount},Lerp:function(D1,D2,lerp){return lerp=CirnoGame.MathHelper.Clamp(lerp),D1*(1-lerp)+D2*lerp},DegreesToRadians:function(degrees){return degrees*.0174532924},RadiansToDegrees:function(radians){return radians*57.29578},GetAngle$1:function(a,b){return Math.atan2(b.Y-a.Y,b.X-a.X)},GetAngle:function(a){return Math.atan2(a.Y,a.X)},RoughDistanceBetweenPoints:function(a,b){return CirnoGame.Vector2.op_Subtraction(a,b).RoughLength},MagnitudeOfRectangle:function(R){return R.width+R.height},WrapRadians:function(radian){while(radian<-3.14159274)radian+=CirnoGame.MathHelper.PI2;while(radian>=CirnoGame.MathHelper.PI)radian-=CirnoGame.MathHelper.PI2;return radian},incrementTowards:function(current,destination,speed){return current<destination&&(current+=speed,current>destination&&(current=destination)),current>destination&&(current-=speed,current<destination&&(current=destination)),current},incrementTowards$1:function(current,destination,incspeed,decspeed){return current<destination&&(current+=incspeed,current>destination&&(current=destination)),current>destination&&(current-=decspeed,current<destination&&(current=destination)),current},RadianToVector:function(radian){return new CirnoGame.Vector2(Math.cos(radian),Math.sin(radian))},Within:function(val,min,max){return val>=min&&val<=max},Mean:function(val){val===void 0&&(val=[]);for(var ret=0,i=0;i<val.length;)ret+=val[System.Array.index(i,val)],i=i+1|0;return ret/val.length},Decelerate:function(momentum,deceleration){var dir=momentum>=0;return(momentum=(dir?momentum:-momentum)-deceleration,momentum<0)?0:dir?momentum:-momentum}}}});Bridge.define("CirnoGame.Point",{fields:{X:0,Y:0},ctors:{ctor:function(x,y){x===void 0&&(x=0);y===void 0&&(y=0);this.$initialize();this.X=x;this.Y=y}}});Bridge.define("CirnoGame.Rectangle",{statics:{methods:{op_Addition:function(A,B){return new CirnoGame.Rectangle(A.x+B.X,A.y+B.Y,A.width,A.height)},op_Subtraction:function(A,B){return new CirnoGame.Rectangle(A.x-B.X,A.y-B.Y,A.width,A.height)}}},fields:{x:0,y:0,width:0,height:0},props:{left:{get:function(){return this.x},set:function(value){this.x=value}},top:{get:function(){return this.y},set:function(value){this.y=value}},right:{get:function(){return this.x+this.width},set:function(value){this.width=value-this.x}},bottom:{get:function(){return this.y+this.height},set:function(value){this.height=value-this.y}},points:{get:function(){var ret=System.Array.init(8,0,System.Single),i=0;return ret[System.Array.index(Bridge.identity(i,i=i+1|0),ret)]=this.x,ret[System.Array.index(Bridge.identity(i,i=i+1|0),ret)]=this.y,ret[System.Array.index(Bridge.identity(i,i=i+1|0),ret)]=this.right,ret[System.Array.index(Bridge.identity(i,i=i+1|0),ret)]=this.y,ret[System.Array.index(Bridge.identity(i,i=i+1|0),ret)]=this.right,ret[System.Array.index(Bridge.identity(i,i=i+1|0),ret)]=this.bottom,ret[System.Array.index(Bridge.identity(i,i=i+1|0),ret)]=this.x,ret[System.Array.index(Bridge.identity(i,i=i+1|0),ret)]=this.bottom,ret}},Center:{get:function(){return new CirnoGame.Vector2(this.left+this.width/2,this.top+this.height/2)}},Min:{get:function(){return new CirnoGame.Vector2(this.x,this.y)},set:function(value){CirnoGame.Vector2.op_Equality(value,null)||(this.x=value.X,this.y=value.Y)}},Max:{get:function(){return new CirnoGame.Vector2(this.right,this.bottom)},set:function(value){CirnoGame.Vector2.op_Equality(value,null)||(this.right=value.X,this.bottom=value.Y)}}},ctors:{init:function(){this.x=0;this.y=0;this.width=0;this.height=0},ctor:function(x,y,width,height){x===void 0&&(x=0);y===void 0&&(y=0);width===void 0&&(width=0);height===void 0&&(height=0);this.$initialize();this.x=x;this.y=y;this.width=width;this.height=height}},methods:{CopyFrom:function(R){this.x=R.x;this.y=R.y;this.width=R.width;this.height=R.height},GetCenter:function(OUT){OUT.X=this.left+this.width/2;OUT.Y=this.top+this.height/2},containsPoint$1:function(x,y){return x>=this.x&&y>=this.y&&x<=this.right&&y<=this.bottom?!0:!1},containsPoint:function(point){return point.X>=this.x&&point.Y>=this.y&&point.X<=this.right&&point.Y<=this.bottom?!0:!1},intersects:function(R){for(var p=R.points,contain=!1,outside=!1,i=0;i<p.length;)this.containsPoint$1(p[System.Array.index(Bridge.identity(i,i=i+1|0),p)],p[System.Array.index(Bridge.identity(i,i=i+1|0),p)])?contain=!0:outside=!0;return contain&&outside?!0:R.left<this.left&&R.right>this.right&&(this.top<=R.top&&this.bottom>=R.top||this.top<=R.bottom&&this.bottom>=R.bottom)?!0:R.top<this.top&&R.bottom>this.bottom&&(this.left<=R.left&&this.right>=R.left||this.left<=R.right&&this.right>=R.right)?!0:!1},isTouching:function(R){if(R==null)return!1;for(var p=R.points,i=0;i<p.length;)if(this.containsPoint$1(p[System.Array.index(Bridge.identity(i,i=i+1|0),p)],p[System.Array.index(Bridge.identity(i,i=i+1|0),p)]))return!0;return this.intersects(R)?!0:!1},Set:function(x,y,width,height){x===void 0&&(x=0);y===void 0&&(y=0);width===void 0&&(width=0);height===void 0&&(height=0);this.x=x;this.y=y;this.width=width;this.height=height}}});Bridge.define("CirnoGame.RectangleI",{statics:{methods:{op_Addition:function(A,B){return new CirnoGame.RectangleI(A.x+B.X|0,A.y+B.Y|0,A.width,A.height)},op_Subtraction:function(A,B){return new CirnoGame.RectangleI(A.x-B.X|0,A.y-B.Y|0,A.width,A.height)}}},fields:{x:0,y:0,width:0,height:0},props:{left:{get:function(){return this.x},set:function(value){this.x=value}},top:{get:function(){return this.y},set:function(value){this.y=value}},right:{get:function(){return this.x+this.width|0},set:function(value){this.width=value-this.x|0}},bottom:{get:function(){return this.y+this.height|0},set:function(value){this.height=value-this.y|0}},points:{get:function(){var ret=System.Array.init(8,0,System.Int32),i=0;return ret[System.Array.index(Bridge.identity(i,i=i+1|0),ret)]=this.x,ret[System.Array.index(Bridge.identity(i,i=i+1|0),ret)]=this.y,ret[System.Array.index(Bridge.identity(i,i=i+1|0),ret)]=this.right,ret[System.Array.index(Bridge.identity(i,i=i+1|0),ret)]=this.y,ret[System.Array.index(Bridge.identity(i,i=i+1|0),ret)]=this.right,ret[System.Array.index(Bridge.identity(i,i=i+1|0),ret)]=this.bottom,ret[System.Array.index(Bridge.identity(i,i=i+1|0),ret)]=this.x,ret[System.Array.index(Bridge.identity(i,i=i+1|0),ret)]=this.bottom,ret}},Center:{get:function(){return new CirnoGame.Point(this.left+(Bridge.Int.div(this.width,2)|0)|0,this.top+(Bridge.Int.div(this.height,2)|0)|0)}},Min:{get:function(){return new CirnoGame.Point(this.x,this.y)},set:function(value){value!=null&&(this.x=value.X,this.y=value.Y)}},Max:{get:function(){return new CirnoGame.Point(this.right,this.bottom)},set:function(value){value!=null&&(this.right=value.X,this.bottom=value.Y)}}},ctors:{init:function(){this.x=0;this.y=0;this.width=0;this.height=0},ctor:function(x,y,width,height){x===void 0&&(x=0);y===void 0&&(y=0);width===void 0&&(width=0);height===void 0&&(height=0);this.$initialize();this.x=x;this.y=y;this.width=width;this.height=height}},methods:{containsPoint$1:function(x,y){return x>=this.x&&y>=this.y&&x<=this.right&&y<=this.bottom?!0:!1},containsPoint:function(point){return point.X>=this.x&&point.Y>=this.y&&point.X<=this.right&&point.Y<=this.bottom?!0:!1},intersects:function(R){for(var p=R.points,contain=!1,outside=!1,i=0;i<p.length;)this.containsPoint$1(p[System.Array.index(Bridge.identity(i,i=i+1|0),p)],p[System.Array.index(Bridge.identity(i,i=i+1|0),p)])?contain=!0:outside=!0;return contain&&outside?!0:R.left<this.left&&R.right>this.right&&(this.top<=R.top&&this.bottom>=R.top||this.top<=R.bottom&&this.bottom>=R.bottom)?!0:R.top<this.top&&R.bottom>this.bottom&&(this.left<=R.left&&this.right>=R.left||this.left<=R.right&&this.right>=R.right)?!0:!1},isTouching:function(R){if(R==null)return!1;for(var p=R.points,i=0;i<p.length;)if(this.containsPoint$1(p[System.Array.index(Bridge.identity(i,i=i+1|0),p)],p[System.Array.index(Bridge.identity(i,i=i+1|0),p)]))return!0;return this.intersects(R)?!0:!1}}});Bridge.define("CirnoGame.Renderer",{fields:{view:null},ctors:{ctor:function(width,height,backgroundColor){width===void 0&&(width=800);height===void 0&&(height=600);backgroundColor===void 0&&(backgroundColor=1087931);this.$initialize();this.view=new PIXI.Application(width,height,{backgroundColor:backgroundColor})}}});Bridge.define("CirnoGame.TileData",{fields:{texture:0,row:0,column:0,enabled:!1,map:null,visible:!1,topSolid:!1,rightSolid:!1,leftSolid:!1,bottomSolid:!1,CanSlope:!1,Breakable:!1,HP:0,maxHP:0,opaque:!1,_hitbox:null,SteppedOn:null,HR:null},props:{solid:{get:function(){return this.topSolid&&this.rightSolid&&this.leftSolid&&this.bottomSolid},set:function(value){this.topSolid=value;this.leftSolid=value;this.rightSolid=value;this.bottomSolid=value}},platform:{get:function(){return this.topSolid&&!this.rightSolid&&!this.leftSolid&&!this.bottomSolid}},IsSlope:{get:function(){return this.SlopeDirection!==0}},SlopeDirection:{get:function(){var Bottom,Top,Tsolid;if(!this.CanSlope||(Bottom=this.GetTileData(0,1),!(Bottom!=null&&Bottom.enabled&&Bottom.solid)))return 0;var Left=this.GetTileData(-1,0),Right=this.GetTileData(1,0),Lsolid=Left!=null&&Left.enabled&&Left.solid,Rsolid=Right!=null&&Right.enabled&&Right.solid;return!this.CanSlope||!this.solid||Lsolid&&Rsolid||!Rsolid&&!Lsolid?0:(Top=this.GetTileData(0,-1),Tsolid=Top!=null&&Top.enabled&&Top.solid,Tsolid)?0:Rsolid?1:-1}}},ctors:{init:function(){this.Breakable=!1;this.HP=4;this.maxHP=4;this.opaque=!0;this.HR=new CirnoGame.Rectangle}},methods:{Clone:function(){var T=new CirnoGame.TileData;return T.texture=this.texture,T.enabled=this.enabled,T.map=this.map,T.visible=this.visible,T.topSolid=this.topSolid,T.rightSolid=this.rightSolid,T.leftSolid=this.leftSolid,T.bottomSolid=this.bottomSolid,T.CanSlope=this.CanSlope,T},Damage:function(damage){return this.HP-=damage,this.HP<=0&&this.topSolid?(this.solid=!1,this.visible=!1,this.enabled=!1,this.UpdateTile(),this.SpawnParticles(),!0):(this.map.RedrawTile(this.column,this.row,!1),!1)},UpdateTile:function(){this.map.RedrawTile(this.column,this.row)},SpawnParticles:function(){var tx=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(this.texture,0,this.map.tiles.Count-1|0)),T=this.map.tiles.getItem(tx),sz=Bridge.Int.clip32(this.map.tilesize/2),G=this.map.game,HB=this.GetHitbox(),spd=1,C=document.createElement("canvas"),g,P;C.width=sz;C.height=sz;g=CirnoGame.Helper.GetContext(C);g.drawImage(T,0,0,sz,sz,0,0,sz,sz);P=new CirnoGame.Particle(G,C);P.Hspeed=-spd|0;P.Vspeed=-spd|0;P.x=HB.left;P.y=HB.top;G.AddEntity(P);C=document.createElement("canvas");C.width=sz;C.height=sz;g=CirnoGame.Helper.GetContext(C);g.drawImage(T,sz,0,sz,sz,0,0,sz,sz);P=new CirnoGame.Particle(G,C);P.Hspeed=spd;P.Vspeed=-spd|0;P.x=HB.left+sz;P.y=HB.top;G.AddEntity(P);C=document.createElement("canvas");C.width=sz;C.height=sz;g=CirnoGame.Helper.GetContext(C);g.drawImage(T,0,sz,sz,sz,0,0,sz,sz);P=new CirnoGame.Particle(G,C);P.Hspeed=-spd|0;P.Vspeed=spd;P.x=HB.left;P.y=HB.top+sz;G.AddEntity(P);C=document.createElement("canvas");C.width=sz;C.height=sz;g=CirnoGame.Helper.GetContext(C);g.drawImage(T,sz,sz,sz,sz,0,0,sz,sz);P=new CirnoGame.Particle(G,C);P.Hspeed=spd;P.Vspeed=spd;P.x=HB.left+sz;P.y=HB.top+sz;G.AddEntity(P)},GetHitbox:function(){var tsz=this.map.tilesize,pos=this.map.position;return this.HR.Set(pos.X+this.column*tsz,pos.Y+this.row*tsz,tsz,tsz),this.HR},GetHitbox2:function(OUT){var tsz=this.map.tilesize,pos=this.map.position;OUT.x=pos.X+this.column*tsz;OUT.y=pos.Y+this.row*tsz;OUT.width=tsz;OUT.height=tsz},GetTileData:function(relativeX,relativeY){return this.map.GetTile(this.column+relativeX|0,this.row+relativeY|0)},solidToSpeed:function(angle){return this.enabled?angle.RoughLength===0?this.solid:angle.X>0&&this.leftSolid||angle.X<0&&this.rightSolid||angle.Y>0&&this.topSolid||angle.Y>0&&this.bottomSolid?!0:!1:!1},GetTop:function(position){var direction=this.SlopeDirection,tsz=this.map.tilesize,pos,R,Y;return direction===0?(pos=this.map.position,pos.Y+this.row*tsz):(R=this.GetHitbox(),Y=(R.right-position.X)/R.width*tsz,direction>0&&(Y=tsz-Y),Y=Math.min(tsz,Math.max(0,Y)),R.bottom-Y)}}});Bridge.define("CirnoGame.TileMap",{fields:{position:null,tilesize:0,rows:0,columns:0,data:null,tiles:null,cracks:null,game:null,buffer:null,bg:null,RND:null,Seed:0,needRedraw:!1,AllowSkyBridge:!1,rtmp:null},ctors:{init:function(){this.Seed=0;this.AllowSkyBridge=!1;this.rtmp=new CirnoGame.Rectangle},ctor:function(game,Seed){Seed===void 0&&(Seed=-1);this.$initialize();this.RND=new System.Random.ctor;this.position=new CirnoGame.Vector2;this.tilesize=16;this.rows=Bridge.Int.clip32(Math.ceil((-this.position.Y*2+game.stageBounds.bottom)/this.tilesize));this.columns=Bridge.Int.clip32(Math.ceil((-this.position.X*2+game.stageBounds.right)/this.tilesize));this.data=System.Array.create(null,null,CirnoGame.TileData,this.columns,this.rows);this.tiles=CirnoGame.AnimationLoader.Get("images/land/brick");this.cracks=CirnoGame.AnimationLoader.Get("images/land/cracks");this.game=game;this.buffer=document.createElement("canvas");this.bg=this.buffer.getContext("2d");this.Seed=Seed<0?this.RND.next():Seed;this.Generate()}},methods:{IsRectSolid:function(sX,sY,eX,eY){for(var X=sX,Y=sY,T;Y<eY;){for(X=sY;X<eX;){if(T=this.data.get([X,Y]),!(T.enabled&&T.topSolid))return!1;X=X+1|0}Y=Y+1|0}return!0},ForceRedraw:function(){this.needRedraw=!0},Randomize:function(){for(var row=0,column=0,T;row<this.rows;){while(column<this.columns)T=new CirnoGame.TileData,T.row=row,T.column=column,T.texture=1,T.enabled=this.RND.nextDouble()<.15||row>=(this.rows-1|0),T.topSolid=T.enabled,T.enabled&&row>=(this.rows-1|0)?(T.texture=2,T.solid=!0):T.enabled&&this.RND.nextDouble()<.3&&(T.solid=!0,T.texture=0,this.RND.nextDouble()<.5&&(T.texture=3)),T.visible=T.enabled,T.map=this,this.data.set([column,row],T),column=column+1|0;column=0;row=row+1|0}},Generate:function(){this.RND=new System.Random.$ctor1(this.Seed);this._Gen();this.needRedraw=!0},_Gen:function(){for(var heightmap=System.Array.init(this.columns,0,System.Int32),max=Bridge.Int.clip32(this.rows*.6),X=0,s,oheightmap;X<this.columns;)heightmap[System.Array.index(X,heightmap)]=Bridge.Int.clip32(this.RND.nextDouble()*max),X=X+1|0;for(s=0;s<2;){for(oheightmap=heightmap,heightmap=System.Array.init(this.columns,0,System.Int32),X=0;X<this.columns;)heightmap[System.Array.index(X,heightmap)]=this.blur(oheightmap,X,8),X=X+1|0;X=1;s=s+1|0}while(X<(this.columns-1|0)){var A=heightmap[System.Array.index(X-1|0,heightmap)],B=heightmap[System.Array.index(X+1|0,heightmap)],H=heightmap[System.Array.index(X,heightmap)];A>H==B>H&&H!==A&&(heightmap[System.Array.index(X,heightmap)]=Bridge.Int.div(A+B|0,2)|0);X=X+1|0}for(var row=0,column=0,LT=null,bridgeChance=.9,RNDbridge=0;row<this.rows;){while(column<this.columns){var H1=this.rows-heightmap[System.Array.index(column,heightmap)]|0,fill=row>=H1,T=new CirnoGame.TileData;T.row=row;T.column=column;T.texture=1;T.enabled=fill||row>=(this.rows-1|0);T.topSolid=T.enabled;T.bottomSolid=T.enabled;T.enabled&&row>=(this.rows-1|0)?(T.texture=2,T.solid=!0):T.enabled&&(T.solid=!0,T.texture=4,T.CanSlope=!0,this.RND.nextDouble()<.5&&(T.texture=5),row>H1&&this.RND.nextDouble()<.02&&(T.texture=6));T.enabled||(this.AllowSkyBridge&&row===20&&this.RND.nextDouble()<.93||(row+4|0)>=H1&&(row+2|0)<H1&&this.RND.nextDouble()<.025||LT!=null&&LT.enabled&&LT.texture===1&&this.RND.nextDouble()<bridgeChance?(T.enabled=!0,T.topSolid=T.enabled,bridgeChance-=.075):(RNDbridge<1&&this.RND.nextDouble()<.015&&(RNDbridge=this.RND.next$1(8)),RNDbridge>0?(T.enabled=!0,T.topSolid=T.enabled,RNDbridge=RNDbridge-1|0):this.RND.nextDouble()<.035?(T.enabled=!0,T.topSolid=T.enabled):!0&&(T.enabled=!0,T.topSolid=T.enabled,T.CanSlope=Math.random()<.5)));T.enabled&&T.texture===1||(bridgeChance=.9);T.visible=T.enabled;T.map=this;T.solid=!0;this.data.set([column,row],T);LT=T;column=column+1|0}column=0;row=row+1|0}},_GenRect:function(SX,SY,EX,EY){var fill,T;SX=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(SX,0,this.columns-1|0));SY=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(SY,0,this.rows-1|0));EX=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(EX,0,this.columns-1|0));EY=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(EY,0,this.rows-1|0));for(var row=SY,column=SX,LT=null,RNDbridge=0;row<EY;){while(column<EX)fill=!1,T=new CirnoGame.TileData,T.row=row,T.column=column,T.texture=1,T.enabled=fill||row>=(this.rows-1|0),T.topSolid=T.enabled,T.bottomSolid=T.enabled,T.enabled||(RNDbridge<1&&this.RND.nextDouble()<.034&&(RNDbridge=2+this.RND.next$1(4)|0),RNDbridge>0?(T.enabled=!0,T.topSolid=T.enabled,T.CanSlope=!0,RNDbridge=RNDbridge-1|0):this.RND.nextDouble()<.03&&(T.enabled=!0,T.topSolid=T.enabled,T.CanSlope=!0)),T.visible=T.enabled,T.map=this,T.solid=!0,this.data.set([column,row],T),LT=T,column=column+1|0;column=SX;row=row+1|0}},SetBreakableRect:function(column,row,Width,Height,breakable){var SX=column,SY=row,EX=SX+Width|0,EY=SY+Height|0,TT;SX=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(SX,0,this.columns-1|0));SY=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(SY,0,this.rows-1|0));EX=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(EX,0,this.columns-1|0));EY=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(EY,0,this.rows-1|0));var X=SX,Y=SY,T=new CirnoGame.TileData;for(T.row=Y,T.column=X,T.texture=1,T.enabled=!0,T.visible=!0,T.map=this,T.solid=!0,breakable?(T.texture=1,Math.random()<.02&&(T.texture=Math.random()<.5?5:6),T.Breakable=!0):(T.texture=0,T.Breakable=!1);Y<EY;){for(X=SX;X<EX;)TT=this.data.get([X,Y]),TT==null&&(TT=T.Clone()),T.solid&&(TT.texture=T.texture,TT.Breakable=T.Breakable),X=X+1|0;Y=Y+1|0}},FillRect:function(column,row,Width,Height){var SX=column,SY=row,EX=SX+Width|0,EY=SY+Height|0,TT;SX=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(SX,0,this.columns-1|0));SY=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(SY,0,this.rows-1|0));EX=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(EX,0,this.columns-1|0));EY=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(EY,0,this.rows-1|0));var X=SX,Y=SY,T=new CirnoGame.TileData;for(T.row=Y,T.column=X,T.texture=1,T.enabled=!0,T.visible=!0,T.map=this,T.solid=!0;Y<EY;){for(X=SX;X<EX;)TT=T.Clone(),TT.column=X,TT.row=Y,this.data.set([X,Y],TT),X=X+1|0;Y=Y+1|0}},DrawRect$1:function(column,row,Width,Height){for(var X=column,Y=row,TX=X,TY=Y,EX=X+Width|0,EY=Y+Height|0,T,T1,T2,T3;TX<EX;)T=new CirnoGame.TileData,T.row=TY,T.column=TX,T.texture=1,T.enabled=!0,T.visible=!0,T.map=this,T.solid=!0,this.SetTile(TX,TY,T),TX=TX+1|0;for(TX=X,TY=EY;TX<EX;)T1=new CirnoGame.TileData,T1.row=TY,T1.column=TX,T1.texture=1,T1.enabled=!0,T1.visible=!0,T1.map=this,T1.solid=!0,this.SetTile(TX,TY,T1),TX=TX+1|0;for(TX=X,TY=Y;TY<EY;)T2=new CirnoGame.TileData,T2.row=TY,T2.column=TX,T2.texture=1,T2.enabled=!0,T2.visible=!0,T2.map=this,T2.solid=!0,this.SetTile(TX,TY,T2),TY=TY+1|0;for(TX=EX,TY=Y;TY<EY;)T3=new CirnoGame.TileData,T3.row=TY,T3.column=TX,T3.texture=1,T3.enabled=!0,T3.visible=!0,T3.map=this,T3.solid=!0,this.SetTile(TX,TY,T3),TY=TY+1|0},DrawRect:function(rect){this.DrawRect$1(Bridge.Int.clip32(rect.left/this.tilesize),Bridge.Int.clip32(rect.top/this.tilesize),Bridge.Int.clip32(rect.width/this.tilesize),Bridge.Int.clip32(rect.height/this.tilesize))},SetAll:function(T){for(var X=0,Y=0,TD;Y<this.rows;){for(X=0;X<this.columns;)TD=T.Clone(),TD.column=X,TD.row=Y,this.data.set([X,Y],T),X=X+1|0;Y=Y+1|0}},ClearOuterRect:function(column,row,width,height,bottom){var TX,TY,TT,TT1,TT2,TT3;bottom===void 0&&(bottom=!0);var SX=column,SY=row,EX=SX+width|0,EY=SY+height|0;SX=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(SX,0,this.columns-1|0));SY=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(SY,0,this.rows-1|0));EX=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(EX,0,this.columns-1|0));EY=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(EY,0,this.rows-1|0));var X=SX,Y=SY,T=new CirnoGame.TileData;for(T.map=this,T.visible=!1,T.solid=!1,TX=X,TY=Y;TX<(EX-1|0);)TT=T.Clone(),TT.column=TX,TT.row=TY,this.SetTile(TX,TY,TT),TX=TX+1|0;if(TX=X,TY=EY,bottom)while(TX<EX)TT1=T.Clone(),TT1.column=TX,TT1.row=TY,this.SetTile(TX,TY,TT1),TX=TX+1|0;for(TX=X,TY=Y;TY<(EY-1|0);)TT2=T.Clone(),TT2.column=TX,TT2.row=TY,this.SetTile(TX,TY,TT2),TY=TY+1|0;for(TX=EX,TY=Y;TY<(EY-1|0);)TT3=T.Clone(),TT3.column=TX,TT3.row=TY,this.SetTile(TX,TY,TT3),TY=TY+1|0},ClearRect$1:function(column,row,width,height){var SX=column,SY=row,EX=SX+width|0,EY=SY+height|0,TT;SX=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(SX,0,this.columns-1|0));SY=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(SY,0,this.rows-1|0));EX=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(EX,0,this.columns-1|0));EY=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(EY,0,this.rows-1|0));var X=SX,Y=SY,T=new CirnoGame.TileData;for(T.map=this,T.visible=!1,T.solid=!1,T.enabled=!1;Y<EY;){for(X=SX;X<EX;)TT=T.Clone(),TT.column=X,TT.row=Y,this.data.set([X,Y],TT),X=X+1|0;Y=Y+1|0}},ClearRect:function(rect){var SX=Bridge.Int.clip32(rect.left/this.tilesize),SY=Bridge.Int.clip32(rect.top/this.tilesize),EX=Bridge.Int.clip32(rect.right/this.tilesize),EY=Bridge.Int.clip32(rect.height/this.tilesize),X=SX,Y=SY,T=new CirnoGame.TileData,TT;for(T.map=this,T.visible=!1,T.solid=!1;Y<EY;){for(X=SX;X<EX;)TT=T.Clone(),TT.column=X,TT.row=Y,this.data.set([X,Y],TT),X=X+1|0;Y=Y+1|0}},SetTile:function(column,row,T){column>=0&&row>=0&&column<System.Array.getLength(this.data,0)&&row<System.Array.getLength(this.data,1)&&this.data.set([column,row],T)},blur:function(array,index,blur){blur===void 0&&(blur=1);var total=0,ret=0,i=0,ind=index;for(ind>=0&&ind<array.length&&(total=total+1|0,ret=ret+array[System.Array.index(ind,array)]|0);i<blur;)ind=ind-1|0,ind>=0&&ind<array.length&&(total=total+1|0,ret=ret+array[System.Array.index(ind,array)]|0),i=i+1|0;for(i=0;i<blur;)ind=ind+1|0,ind>=0&&ind<array.length&&(total=total+1|0,ret=ret+array[System.Array.index(ind,array)]|0),i=i+1|0;return Bridge.Int.div(ret,total)|0},CheckForTile:function(position){var TP=this.position,PX=Bridge.Int.clip32((position.X-TP.X)/this.tilesize),PY=Bridge.Int.clip32((position.Y-TP.Y)/this.tilesize);return PX>=0&&PX<this.columns&&PY>=0&&PY<this.rows?this.data.get([PX,PY]):null},GetTile:function(column,row){return column>=0&&row>=0&&column<this.columns&&row<this.rows?this.data.get([column,row]):null},_Draw:function(){if(this.needRedraw){var W=Bridge.Int.clip32(Math.ceil(this.columns*this.tilesize)),H=Bridge.Int.clip32(Math.ceil(this.rows*this.tilesize));this.buffer.width!==W||this.buffer.height!==H?(this.buffer.width=W,this.buffer.height=H):this.bg.clearRect(0,0,this.buffer.width,this.buffer.height);this.Redraw(this.bg);this.needRedraw=!1}},Draw:function(g){this._Draw();this.rtmp.CopyFrom(this.game.camera.CameraBounds);this.rtmp.x-=1;this.rtmp.y-=1;this.rtmp.width+=2;this.rtmp.height+=2;var CB=this.rtmp;g.drawImage(this.buffer,CB.left-this.position.X,CB.top-this.position.Y,CB.width,CB.height,CB.left,CB.top,CB.width,CB.height)},RedrawTile:function(X,Y,updateNeighbors){var TX,TY,TX1,TY1;updateNeighbors===void 0&&(updateNeighbors=!0);updateNeighbors?(TX=Bridge.Int.mul(X-1|0,Bridge.Int.clip32(this.tilesize)),TY=Bridge.Int.mul(Y-1|0,Bridge.Int.clip32(this.tilesize)),this.bg.clearRect(TX,TY,Bridge.Int.mul(Bridge.Int.clip32(this.tilesize),3),Bridge.Int.mul(Bridge.Int.clip32(this.tilesize),3)),this.Redraw(this.bg,X-1|0,Y-1|0,3,3)):(TX1=Bridge.Int.mul(X,Bridge.Int.clip32(this.tilesize)),TY1=Bridge.Int.mul(Y,Bridge.Int.clip32(this.tilesize)),this.bg.clearRect(TX1,TY1,this.tilesize,this.tilesize),this.Redraw(this.bg,X,Y,1,1))},Redraw:function(g,SX,SY,W,H){var PX,PY,EX,EY,T,tex,dmg,sd,P,AD,ADist,AD1,ADist1,texture,AD2,ADist2;SX===void 0&&(SX=-1);SY===void 0&&(SY=-1);W===void 0&&(W=-1);H===void 0&&(H=-1);PX=this.position.X;PY=this.position.Y;PX=0;PY=0;SX===-1&&(SX=0);SY===-1&&(SY=0);W===-1&&(W=this.columns);H===-1&&(H=this.rows);EX=SX+W|0;EY=SY+H|0;SX=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(SX,0,this.columns));SY=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(SY,0,this.rows));EX=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(EX,0,this.columns));EY=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(EY,0,this.rows));var X=PX+SX*this.tilesize,Y=PY+SY*this.tilesize,row=SY,column=SX,BG=this.tiles.getItem(2),BG2=System.Array.init([this.tiles.getItem(3),this.tiles.getItem(9),this.tiles.getItem(10)],HTMLImageElement),tilesC=this.tiles.Count,R=new CirnoGame.Rectangle,doorroom=CirnoGame.MapGenerator.doorroom,keyroom=CirnoGame.MapGenerator.keyroom,keyroomcolor="#558822",gradcolor="#000077",Agradcolor="#CC0000",DX=0,DY=0;for(doorroom!=null&&(DX=Bridge.Int.div(doorroom.SX+doorroom.EX|0,2)|0,DY=Bridge.Int.div(doorroom.SY+doorroom.EY|0,2)|0);row<EY;){while(column<EX){if(T=this.data.get([column,row]),tex=Math.min(this.tiles.Count-1|0,T.texture),T.enabled&&tex>=0&&tex<tilesC){if(g.drawImage(this.tiles.getItem(tex),X,Y),T.Breakable&&T.HP<T.maxHP&&(dmg=Bridge.Int.clip32(Math.max(1,Math.min(Bridge.Math.round(T.maxHP-T.HP,0,6),3)))-1|0,g.drawImage(this.cracks.getItem(dmg),X,Y)),sd=T.SlopeDirection,sd!==0){if(g.globalCompositeOperation="destination-out",T.GetHitbox2(R),R.x-=this.position.X,R.y-=this.position.Y,g.beginPath(),g.moveTo(R.left,R.top),P=new CirnoGame.Vector2(R.left+R.width/2,R.top+R.height/2),sd>0?g.lineTo(R.left,R.bottom):g.lineTo(R.right,R.bottom),g.lineTo(R.right,R.top),g.lineTo(R.left,R.top),g.fill(),g.globalCompositeOperation="destination-over",keyroom!=null&&keyroom.ContainsTile(column,row))g.globalAlpha=.17,g.fillStyle=keyroomcolor,g.fillRect(X,Y,this.tilesize,this.tilesize),g.globalAlpha=1;else if(doorroom!=null){AD=5;ADist=Math.min(Math.abs(column-DX|0),Math.abs(row-DY|0));ADist<5&&(AD=AD+Bridge.Int.mul(5-ADist|0,1)|0);var Dist=Math.max((Math.abs(column-DX|0)+Math.abs(row-DY|0)|0)-AD|0,0),A=.5-Dist*.03,G=gradcolor;A<0&&(A=-A*.5-.22,G=Agradcolor,A>.3&&(A=.6-A,A<0&&(G=gradcolor,A=0)));A>0&&(g.globalAlpha=A,g.fillStyle=G,g.fillRect(X,Y,this.tilesize,this.tilesize),g.globalAlpha=1)}g.drawImage(BG,X,Y);g.globalCompositeOperation="source-over"}else if(!T.opaque){if(g.globalCompositeOperation="destination-over",keyroom!=null&&keyroom.ContainsTile(column,row))g.globalAlpha=.17,g.fillStyle=keyroomcolor,g.fillRect(X,Y,this.tilesize,this.tilesize),g.globalAlpha=1;else if(doorroom!=null){AD1=5;ADist1=Math.min(Math.abs(column-DX|0),Math.abs(row-DY|0));ADist1<5&&(AD1=AD1+Bridge.Int.mul(5-ADist1|0,1)|0);var Dist1=Math.max((Math.abs(column-DX|0)+Math.abs(row-DY|0)|0)-AD1|0,0),A1=.5-Dist1*.03,G1=gradcolor;A1<0&&(A1=-A1*.5-.22,G1=Agradcolor,A1>.3&&(A1=.6-A1,A1<0&&(G1=gradcolor,A1=0)));A1>0&&(g.globalAlpha=A1,g.fillStyle=G1,g.fillRect(X,Y,this.tilesize,this.tilesize),g.globalAlpha=1)}g.drawImage(BG,X,Y);g.globalCompositeOperation="source-over"}}else if(texture=BG,Math.random()>=.97&&(texture=CirnoGame.HelperExtensions.Pick(Bridge.global.HTMLImageElement,BG2)),g.drawImage(texture,X,Y),keyroom!=null&&keyroom.ContainsTile(column,row))g.globalAlpha=.17,g.fillStyle=keyroomcolor,g.fillRect(X,Y,this.tilesize,this.tilesize),g.globalAlpha=1;else if(doorroom!=null){AD2=5;ADist2=Math.min(Math.abs(column-DX|0),Math.abs(row-DY|0));ADist2<5&&(AD2=AD2+Bridge.Int.mul(5-ADist2|0,1)|0);var Dist2=Math.max((Math.abs(column-DX|0)+Math.abs(row-DY|0)|0)-AD2|0,0),A2=.5-Dist2*.03,G2=gradcolor;A2<0&&(A2=-A2*.5-.22,G2=Agradcolor,A2>.3&&(A2=.6-A2,A2<0&&(G2=gradcolor,A2=0)));A2>0&&(g.globalAlpha=A2,g.fillStyle=G2,g.fillRect(X,Y,this.tilesize,this.tilesize),g.globalAlpha=1)}column=column+1|0;X+=this.tilesize}X=PX+SX*this.tilesize;Y+=this.tilesize;column=SX;row=row+1|0}},IsExposed:function(X,Y){for(var row=Y-2|0,column=X-2|0,TDRaw=this.data,ind=0,lind=0,T,ind=Bridge.Int.mul(column,this.rows),ind=ind+row|0;row<=(Y+2|0);){for(lind=ind;column<=(X+2|0);){if(row>=0&&column>=0&&row<this.rows&&column<this.columns&&(T=TDRaw[System.Array.index(ind,TDRaw)],!T.enabled||!T.solid))return!0;column=column+1|0;ind=ind+this.rows|0}ind=lind;ind=ind+1|0;row=row+1|0;column=X-2|0}return!1},ApplyBreakableRect:function(SX,SY,W,H){var EX,EY,row,column,T,TT;for(SX===void 0&&(SX=-1),SY===void 0&&(SY=-1),W===void 0&&(W=-1),H===void 0&&(H=-1),SX===-1&&(SX=0),SY===-1&&(SY=0),W===-1&&(W=this.columns),H===-1&&(H=this.rows),EX=SX+W|0,EY=SY+H|0,SX=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(SX,0,this.columns)),SY=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(SY,0,this.rows)),EX=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(EX,0,this.columns)),EY=Bridge.Int.clip32(CirnoGame.MathHelper.Clamp$1(EY,0,this.rows)),row=SX,column=SY;row<EY;){while(column<EX)T=this.data.get([column,row]),TT=T.Clone(),TT.column=column,TT.row=row,this.data.set([column,row],TT),T=TT,this.IsExposed(column,row)?(T.texture=1,Math.random()<.02&&(T.texture=Math.random()<.5?5:6),T.Breakable=!0):(T.texture=0,T.Breakable=!1),column=column+1|0;row=row+1|0;column=SX}this.needRedraw=!0},ApplyBreakable:function(){for(var row=0,column=0,TDRaw=this.data,ind=0,lind=0,T,TT;row<this.rows;){for(lind=ind;column<this.columns;)T=TDRaw[System.Array.index(ind,TDRaw)],TT=T.Clone(),TT.column=column,TT.row=row,TDRaw[System.Array.index(ind,TDRaw)]=TT,T=TT,this.IsExposed(column,row)?(T.texture=1,Math.random()<.02&&(T.texture=Math.random()<.5?5:6),T.Breakable=!0):(T.texture=0,T.Breakable=!1),column=column+1|0,ind=ind+this.rows|0;ind=lind;row=row+1|0;column=0;ind=ind+1|0}this.needRedraw=!0},testTexture:function(){for(var row=0,column=0,T;row<this.rows;){while(column<this.columns)T=this.data.get([column,row]),T.texture=Math.random()<.5?0:1,column=column+1|0;row=row+1|0;column=0}this.needRedraw=!0}}});Bridge.define("CirnoGame.Vector2",{statics:{props:{Empty:{get:function(){return new CirnoGame.Vector2}}},methods:{FromRadian:function(radian){return CirnoGame.MathHelper.RadianToVector(radian)},Add:function(A,B){return new CirnoGame.Vector2(A.X+B.X,A.Y+B.Y)},Add$1:function(A,X,Y){return new CirnoGame.Vector2(A.X+X,A.Y+Y)},Subtract:function(A,B){return new CirnoGame.Vector2(A.X-B.X,A.Y-B.Y)},Subtract$1:function(A,X,Y){return new CirnoGame.Vector2(A.X-X,A.Y-Y)},op_Equality:function(A,B){var OA=A,OB=B;return(OA==null||OB==null)&&(OA!=null||OB!=null)?!1:OA==null&&OB==null?!0:A.X===B.X&&A.Y===B.Y},op_Inequality:function(A,B){return!CirnoGame.Vector2.op_Equality(A,B)},op_Multiply:function(A,scale){return new CirnoGame.Vector2(A.X*scale,A.Y*scale)},op_Division:function(A,scale){return new CirnoGame.Vector2(A.X/scale,A.Y/scale)},op_Addition:function(A,B){return new CirnoGame.Vector2(A.X+B.X,A.Y+B.Y)},op_Subtraction:function(A,B){return new CirnoGame.Vector2(A.X-B.X,A.Y-B.Y)}}},fields:{X:0,Y:0},props:{Length:{get:function(){return Math.sqrt(this.X*this.X+this.Y*this.Y)}},EstimatedLength:{get:function(){var A=Math.abs(this.X),B=Math.abs(this.Y),tmp;return B>A&&(tmp=A,A=B,B=tmp),B*=.34,A+B}},RoughLength:{get:function(){return Math.abs(this.X)+Math.abs(this.Y)}}},ctors:{ctor:function(x,y){x===void 0&&(x=0);y===void 0&&(y=0);this.$initialize();this.X=x;this.Y=y}},methods:{Distance:function(P){var XX=this.X-P.X,YY=this.Y-P.Y;return Math.sqrt(XX*XX+YY*YY)},EstimatedDistance:function(P){var A=Math.abs(this.X-P.X),B=Math.abs(this.Y-P.Y),tmp;return B>A&&(tmp=A,A=B,B=tmp),B*=.34,A+B},Multiply:function(f){this.X*=f;this.Y*=f},RoughNormalize:function(length){length===void 0&&(length=1);var D=this.Length/length;return new CirnoGame.Vector2(this.X/D,this.Y/D)},Normalize:function(length){length===void 0&&(length=1);var distance=Math.sqrt(this.X*this.X+this.Y*this.Y),V=new CirnoGame.Vector2;return V.X=this.X/distance,V.Y=this.Y/distance,V.X*=length,V.Y*=length,V},SetAsNormalize:function(length){length===void 0&&(length=1);var distance=Math.sqrt(this.X*this.X+this.Y*this.Y);this.X=this.X/distance;this.Y=this.Y/distance;this.X*=length;this.Y*=length},ToCardinal:function(){var x=this.X,y=this.Y,A=Math.abs(this.X),B=Math.abs(this.Y);return B>A?x=0:A>B&&(y=0),new CirnoGame.Vector2(x,y)},Equals:function(o){var B=o;return CirnoGame.Vector2.op_Inequality(this,B)&&CirnoGame.Vector2.op_Equality(B,null)?!1:B.X===this.X&&B.Y===this.Y},equals:function(o){if(Bridge.is(o,CirnoGame.Vector2)){var B=Bridge.cast(o,CirnoGame.Vector2);return CirnoGame.Vector2.op_Inequality(this,B)&&CirnoGame.Vector2.op_Equality(B,null)?!1:B.X===this.X&&B.Y===this.Y}return Bridge.equals(this,o)},ToAngle:function(){return CirnoGame.MathHelper.WrapRadians(CirnoGame.MathHelper.GetAngle(this))},Clone:function(){return new CirnoGame.Vector2(this.X,this.Y)},CopyFrom:function(V){CirnoGame.Vector2.op_Equality(V,null)||(this.X=V.X,this.Y=V.Y)},Rotate:function(radian){var angle=this.ToAngle()+radian;return CirnoGame.Vector2.FromRadian(angle).Normalize(this.Length)},Add:function(V){this.X+=V.X;this.Y+=V.Y},Subtract:function(V){this.X-=V.X;this.Y-=V.Y}}});Bridge.define("CirnoGame.AimedShooter",{inherits:[CirnoGame.EntityBehavior],fields:{time:0,maxtime:0,Target:null,maxDistance:0,maxShadow:0,attackpower:0,bulletSpeed:0,bulletDuration:0,ignoresterrain:!1,bulletgraphic:null,attackTelegraphTime:0},ctors:{init:function(){this.time=0;this.maxtime=480;this.maxDistance=130;this.maxShadow=5;this.attackpower=1;this.bulletSpeed=.5;this.bulletDuration=900;this.ignoresterrain=!1;this.bulletgraphic="ebullet";this.attackTelegraphTime=60},ctor:function(entity){this.$initialize();CirnoGame.EntityBehavior.ctor.call(this,entity);entity.Ani.Shadowcolor="#FF0000"}},methods:{Update:function(){CirnoGame.EntityBehavior.prototype.Update.call(this);this.UpdateTarget();var A=this.entity.Ani;this.Target!=null?(A.Shadow=this.time<this.attackTelegraphTime?this.maxShadow:0,this.time=this.time-1|0,this.time<=0&&(this.ResetTimer(),this.Shoot())):A.Shadow=0},UpdateTarget:function(){if(this.Target!=null)if(this.Target.Position.EstimatedDistance(this.entity.Position)>this.maxDistance)this.Target=null;else return;var T=this.entity.Game.player;T.Position.EstimatedDistance(this.entity.Position)<this.maxDistance&&(this.Target=T,this.ResetTimer())},ResetTimer:function(){this.time=Bridge.Int.div(this.maxtime,2)|0;this.time=this.time+Bridge.Int.clip32(Bridge.Math.round(this.time*Math.random(),0,6))|0},Shoot:function(){var P,D;this.Target==null||Bridge.cast(this.Target,CirnoGame.ICombatant).CirnoGame$ICombatant$HP<=0||(P=new CirnoGame.PlayerBullet(this.entity.Game,this.entity,System.String.concat("images/misc/",this.bulletgraphic)),P.Position.CopyFrom(this.entity.getCenter()),D=CirnoGame.Vector2.op_Subtraction(this.Target.getCenter(),P.Position),D.SetAsNormalize(this.bulletSpeed),P.Hspeed=D.X,P.Vspeed=D.Y,P.touchDamage=this.attackpower,P.ignoresterrain=this.ignoresterrain,P.Duration=this.bulletDuration,this.entity.Game.AddEntity(P))}}});Bridge.define("CirnoGame.ButtonSprite",{inherits:[CirnoGame.Sprite],fields:{_buttonNeedsRerender:!1,_buttonBuffer:null,_buttonGraphic:null,Data:null,_contents:null,_borderSize:0,_borderColor:null,LockedClickSound:null,ClickSound:null,_buttonColor:null,ColorSchemes:null,locked:!1,OnClick:null,LContentSize:null},props:{Contents:{get:function(){return this._contents},set:function(value){Bridge.referenceEquals(this._contents,value)||(this._contents=value,this._buttonNeedsRerender=!0)}},BorderSize:{get:function(){return this._borderSize},set:function(value){this._borderSize!==value&&(this._borderSize=value,this._buttonNeedsRerender=!0)}},BorderColor:{get:function(){return this._borderColor},set:function(value){Bridge.referenceEquals(this._borderColor,value)||(this._borderColor=value,this._buttonNeedsRerender=!0)}},ButtonColor:{get:function(){return this._buttonColor},set:function(value){Bridge.referenceEquals(this._buttonColor,value)||(this._buttonColor=value,this._buttonNeedsRerender=!0)}}},ctors:{init:function(){this.LockedClickSound="hit";this.ClickSound="select";this.locked=!1;this.LContentSize=new CirnoGame.Vector2},ctor:function(contents,borderSize,borderColor,buttonColor,data){borderSize===void 0&&(borderSize=2);borderColor===void 0&&(borderColor="#00AA33");buttonColor===void 0&&(buttonColor="#11CC55");data===void 0&&(data=null);this.$initialize();CirnoGame.Sprite.ctor.call(this);this.Contents=contents;this.BorderSize=borderSize;this.BorderColor=borderColor;this.ButtonColor=buttonColor;this._buttonBuffer=new CirnoGame.Sprite;this._buttonBuffer.Size=contents.Size;this._buttonGraphic=this._buttonBuffer.GetGraphics();this._buttonNeedsRerender=!0;this.ColorSchemes=new(System.Collections.Generic.List$1(CirnoGame.ButtonSprite.ColorScheme).ctor);this.ColorSchemes.add(new CirnoGame.ButtonSprite.ColorScheme(borderColor,buttonColor));this.ColorSchemes.add(new CirnoGame.ButtonSprite.ColorScheme("#FFFFFF","#FF0000"));this.ColorSchemes.add(new CirnoGame.ButtonSprite.ColorScheme("#777777","#CCCCCC"));this.Data=data;data==null&&Bridge.is(contents,CirnoGame.TextSprite)&&(this.Data=Bridge.cast(contents,CirnoGame.TextSprite).Text);this.Draw(null)}},methods:{SetColorScheme:function(scheme){this.BorderColor=scheme.BorderColor;this.ButtonColor=scheme.ButtonColor},SetColorScheme$1:function(index){var C=this.ColorSchemes.getItem(index);this.SetColorScheme(C)},drawButton:function(){var g=this._buttonGraphic,sz=this._borderSize+this._borderSize|0,size;this._buttonBuffer.Size=CirnoGame.Vector2.op_Addition(this.Contents.Size,new CirnoGame.Vector2(sz,sz));size=this._buttonBuffer.Size;g.fillStyle=this._borderColor;g.fillRect(0,0,size.X,size.Y);g.fillStyle=this.ButtonColor;g.fillRect(this._borderSize,this._borderSize,Bridge.Int.clip32(size.X)-sz|0,Bridge.Int.clip32(size.Y)-sz|0);var color="rgba(255,255,255,0)",grd=g.createLinearGradient(0,0,0,size.Y);grd.addColorStop(0,color);grd.addColorStop(.4,"rgba(255,255,255,0.7)");grd.addColorStop(1,color);g.fillStyle=grd;g.fillRect(0,0,this._buttonBuffer.Size.X,this._buttonBuffer.Size.Y)},Lock:function(setcolorscheme){(setcolorscheme===void 0&&(setcolorscheme=!0),this.locked)||(this.locked=!0,setcolorscheme&&this.SetColorScheme$1(2))},Unlock:function(setcolorscheme){(setcolorscheme===void 0&&(setcolorscheme=!0),this.locked)&&(this.locked=!1,setcolorscheme&&this.SetColorScheme$1(0))},CheckClick:function(mousePosition){if(this.Visible&&this.GetBounds().containsPoint(mousePosition)){if(this.locked)return Bridge.referenceEquals(this.LockedClickSound,"")||this.LockedClickSound==null||CirnoGame.AudioManager._this.Blast(System.String.concat("SFX/",this.LockedClickSound,".ogg")),!1;Bridge.referenceEquals(this.ClickSound,"")||this.ClickSound==null||CirnoGame.AudioManager._this.Blast(System.String.concat("SFX/",this.ClickSound,".ogg"));var tmp=this.OnClick;return tmp&&this.OnClick(),!0}return!1},Draw:function(g){(this._contents.Size.X!==this.LContentSize.X||this._contents.Size.Y!==this.LContentSize.Y)&&(this._buttonNeedsRerender=!0,this.LContentSize=this._contents.Size.Clone());this._buttonNeedsRerender&&(this.drawButton(),this._buttonNeedsRerender=!1);this.Size=this._buttonBuffer.Size.Clone();this._buttonBuffer.Draw(this.spriteGraphics);this.Contents.Position=new CirnoGame.Vector2(this._borderSize,this._borderSize);this.Contents.Draw(this.spriteGraphics);g!=null&&CirnoGame.Sprite.prototype.Draw.call(this,g)}}});Bridge.define("CirnoGame.Chest",{inherits:[CirnoGame.Entity],fields:{KeysNeeded:0,ForceLocked:!1,TupleNames:null},props:{Premium:!1,Golden:!1,Opened:!1,Heart:!1},ctors:{init:function(){this.KeysNeeded=1;this.ForceLocked=!1;this.TupleNames=System.Array.init(["Null","Single","Double","Triple","Quadruple","Quintuple","Sextuple","Septuple","Octuple","Nonuple","Decuple"],System.String)},ctor:function(game){this.$initialize();CirnoGame.Entity.ctor.call(this,game);this.Ani=new CirnoGame.Animation(CirnoGame.AnimationLoader._this.GetAnimation("images/misc/chest"));this.Ani.ImageSpeed=0;Math.random()<.2?this.Heartify():Math.random()<.05&&this.Premiumify()}},methods:{Premiumify:function(){var P=this.Ani.Position;this.Ani=new CirnoGame.Animation(CirnoGame.AnimationLoader._this.GetAnimation("images/misc/premiumchest"));this.Ani.ImageSpeed=0;this.Ani.Position.CopyFrom(P);this.KeysNeeded=2;this.Premium=!0;this.Golden=!1;this.Heart=!1},Goldify:function(){var P=this.Ani.Position;this.Ani=new CirnoGame.Animation(CirnoGame.AnimationLoader._this.GetAnimation("images/misc/goldchest"));this.Ani.ImageSpeed=0;this.Ani.Position.CopyFrom(P);this.KeysNeeded=0;this.Golden=!0;this.Premium=!1;this.Heart=!1},Heartify:function(){var P=this.Ani.Position;this.Ani=new CirnoGame.Animation(CirnoGame.AnimationLoader._this.GetAnimation("images/misc/pinkchest"));this.Ani.ImageSpeed=0;this.Ani.Position.CopyFrom(P);this.Heart=!0;this.Premium=!1},Update:function(){var F,P;CirnoGame.Entity.prototype.Update.call(this);F=this.GetFloor();F==null?this.Vspeed=2:(this.Vspeed=0,this.y=F.GetHitbox().top-this.Ani.CurrentImage.height);P=this.Game.player;P.Position.EstimatedDistance(this.Position)<16&&(this.ForceLocked?P.Controller[System.Array.index(2,P.Controller)]&&P.MSG.ChangeText("It's sealed with magic..."):!this.Opened&&P.Controller[System.Array.index(2,P.Controller)]&&P.keys>=this.KeysNeeded&&(P.keys=P.keys-this.KeysNeeded|0,this.Open(P)))},Open:function(player){var commonchance,CI,P,H,H1,PC,Plat,FM;if(!this.Opened){this.PlaySound("chestopen");this.Ani.CurrentFrame=1;this.Ani.SetImage();this.Ani.Update();this.Opened=!0;for(var M="",ok=!0,S="",color="#FFFFFF",picker=null;ok;){var common=System.Array.init(["point","point","point","point","point","point","tripleheart"],System.String),rare=System.Array.init(["attackpower","defensepower","mining"],System.String),legendary=System.Array.init(["triplejump","cheaperblocks","invincibility","repeater","movespeed"],System.String),heartTable=System.Array.init(["supertripleheart"],System.String),R=Math.random(),C;this.Heart?(C=CirnoGame.HelperExtensions.Pick(System.String,heartTable),S="common",color="#FFFFFF"):((picker==null||Math.random()<.2)&&(commonchance=.65-this.Game.level*.25,R<commonchance&&!this.Golden&&!this.Premium?(picker=common,S="common",color="#FFFFFF"):(R=Math.random(),this.Premium&&(R+=.04),R<.91?(picker=rare,S="rare",color="#FFBB33"):(picker=legendary,S="legendary",color="#FF55FF"))),C=CirnoGame.HelperExtensions.Pick(System.String,picker));ok=!1;switch(C){case"point":P=new CirnoGame.PointItem(this.Game);P.Position.CopyFrom(this.Position);P.Vspeed=-2;P.Hspeed=-2;P.collectionDelay=30;this.Game.AddEntity(P);P=new CirnoGame.PointItem(this.Game);P.Position.CopyFrom(this.Position);P.Vspeed=-2;P.Hspeed=2;P.collectionDelay=30;this.Game.AddEntity(P);M="Points";break;case"heart":if(player.HP>=player.maxHP){ok=!0;break}H=new CirnoGame.HealingItem(this.Game);H.Position.CopyFrom(this.Position);H.Vspeed=-2;H.collectionDelay=30;this.Game.AddEntity(H);M="Heal";break;case"tripleheart":if(player.HP>player.maxHP/3&&!this.Heart){ok=!0;break}H1=new CirnoGame.HealingItem(this.Game);H1.Position.CopyFrom(this.Position);H1.Vspeed=-2;H1.Hspeed=-2;H1.collectionDelay=30;this.Game.AddEntity(H1);H1=new CirnoGame.HealingItem(this.Game);H1.Position.CopyFrom(this.Position);H1.Vspeed=-2;H1.Hspeed=0;H1.collectionDelay=30;this.Game.AddEntity(H1);H1=new CirnoGame.HealingItem(this.Game);H1.Position.CopyFrom(this.Position);H1.Vspeed=-2;H1.Hspeed=2;H1.collectionDelay=30;this.Game.AddEntity(H1);M="Heal x3";break;case"supertripleheart":if(player.HP>player.maxHP/3&&!this.Heart){ok=!0;break}H1=new CirnoGame.HealingItem(this.Game);H1.Position.CopyFrom(this.Position);H1.Vspeed=-2;H1.Hspeed=-2;H1.healingPower*=1.5;H1.collectionDelay=30;this.Game.AddEntity(H1);H1=new CirnoGame.HealingItem(this.Game);H1.Position.CopyFrom(this.Position);H1.Vspeed=-2;H1.Hspeed=0;H1.healingPower*=1.5;H1.collectionDelay=30;this.Game.AddEntity(H1);H1=new CirnoGame.HealingItem(this.Game);H1.Position.CopyFrom(this.Position);H1.Vspeed=-2;H1.Hspeed=2;H1.healingPower*=1.5;H1.collectionDelay=30;this.Game.AddEntity(H1);M="Heal+";break;case"singleorb":if(this.Game.timeRemaining>0){ok=!0;break}CI=new CirnoGame.Orb(this.Game);CI.Position.CopyFrom(this.Position);CI.Vspeed=-2;CI.Hspeed=-2;CI.collectionDelay=30;this.Game.AddEntity(CI);M="Orb";break;case"mining":player.digpower<2?player.digpower+=.5:ok=!0;M="Mining Power "+System.Single.format(player.digpower)+"x";break;case"triplejump":PC=player.GetBehavior(CirnoGame.PlatformerControls);PC.maxAirJumps<2?PC.maxAirJumps=2:ok=!0;M="Triple Jump";break;case"cheaperblocks":if(player.blockprice!==3){ok=!0;break}player.blockprice=1;M="Blocks are cheaper now";break;case"movespeed":if(player.data.containsKey("movespeed")){ok=!0;break}player.data.set("movespeed",!0);Plat=player.GetBehavior(CirnoGame.PlatformerControls);Plat.maxSpeed*=1.07;Plat.accel*=1.07;M="Movement speed+";break;case"invincibility":if(player.invincibilitymod!==1){ok=!0;break}player.invincibilitymod=2;M="Invincibility extended";break;case"attackpower":player.attackpower+=1;M="Attack Power "+Bridge.Int.clip32(player.attackpower);break;case"defensepower":player.defensepower+=1;M="Defensive Power "+Bridge.Int.clip32(player.defensepower);break;case"repeater":if(player.totalshots>2){ok=!0;break}player.totalshots=player.totalshots+1|0;M=System.String.concat(this.TupleNames[System.Array.index(player.totalshots,this.TupleNames)]," shot");break;default:ok=!0}}ok||Bridge.referenceEquals(M,"")||(FM=new CirnoGame.FloatingMessage(this.Game,M),FM.Text.TextColor=color,FM.Position=new CirnoGame.Vector2(this.x+8,this.y-20),this.Game.AddEntity(FM),Bridge.referenceEquals(S,"")||Bridge.referenceEquals(S,"common")?this.PlaySound("jump"):this.PlaySound("ok2B"))}},GetFloor:function(){var T=null,W=this.Width/3,Y=this.Height;return T!=null&&T.enabled&&T.topSolid||(T=this.Game.TM.CheckForTile(CirnoGame.Vector2.Add$1(this.Position,this.Width/2,Y))),T!=null&&T.enabled&&T.topSolid||(T=this.Game.TM.CheckForTile(CirnoGame.Vector2.Add$1(this.Position,W,Y))),T!=null&&T.enabled&&T.topSolid||(T=this.Game.TM.CheckForTile(CirnoGame.Vector2.Add$1(this.Position,this.Width-W,Y))),T!=null&&T.enabled&&T.topSolid||(T=null),T}}});Bridge.define("CirnoGame.CollectableItem",{inherits:[CirnoGame.Entity],fields:{floats:!1,magnetDistance:0,magnetSpeed:0,maxFallSpeed:0,fallaccel:0,itemName:null,collectionDelay:0,sound:null},ctors:{init:function(){this.floats=!0;this.magnetDistance=35;this.magnetSpeed=8;this.maxFallSpeed=2;this.fallaccel=.1;this.collectionDelay=10;this.sound="powerup"},ctor:function(game,itemName){this.$initialize();CirnoGame.Entity.ctor.call(this,game);this.Ani=new CirnoGame.Animation(CirnoGame.AnimationLoader.Get(System.String.concat("images/items/",itemName)));this.Ani.SetImage();this.itemName=itemName}},methods:{CanCollect:function(){return!0},Update:function(){var C,player,F;if(this.collectionDelay>0&&(this.collectionDelay=this.collectionDelay-1|0),player=this.Game.player,this.collectionDelay<=0&&player.HP>0&&this.CanCollect(player)&&(C=player.getCenter()).EstimatedDistance(this.Position)<this.magnetDistance){var C2=this.getCenter(),P=CirnoGame.Vector2.op_Subtraction(C,C2),ln=P.Length,spd=this.magnetSpeed,fspd=spd/Math.max(1,ln);if(ln<=fspd){this.Alive=!1;this.Hspeed=0;this.Vspeed=0;this.Position.CopyFrom(this.Game.player.Position);this.onCollected(this.Game.player);this.PlaySound(this.sound);return}P=P.Normalize(fspd);this.Hspeed=P.X;this.Vspeed=P.Y}else this.floats?(this.Hspeed=CirnoGame.MathHelper.Decelerate(this.Hspeed,.1),this.Vspeed=CirnoGame.MathHelper.Decelerate(this.Vspeed,.1)):(F=this.GetFloor(),F==null?this.Vspeed=this.Vspeed<this.maxFallSpeed?Math.min(this.Vspeed+this.fallaccel,this.maxFallSpeed):this.maxFallSpeed:(this.Vspeed=0,this.y=F.GetHitbox().top-this.Ani.CurrentImage.height),this.Hspeed=CirnoGame.MathHelper.Decelerate(this.Hspeed,.1));CirnoGame.Entity.prototype.Update.call(this)},GetFloor:function(){var T=null,W=this.Width/3,Y=this.Height;return T!=null&&T.enabled&&T.topSolid||(T=this.Game.TM.CheckForTile(CirnoGame.Vector2.Add$1(this.Position,this.Width/2,Y))),T!=null&&T.enabled&&T.topSolid||(T=this.Game.TM.CheckForTile(CirnoGame.Vector2.Add$1(this.Position,W,Y))),T!=null&&T.enabled&&T.topSolid||(T=this.Game.TM.CheckForTile(CirnoGame.Vector2.Add$1(this.Position,this.Width-W,Y))),T!=null&&T.enabled&&T.topSolid||(T=null),T}}});Bridge.define("CirnoGame.ControllableEntity",{inherits:[CirnoGame.Entity],fields:{Controller:null,LController:null},ctors:{ctor:function(game){this.$initialize();CirnoGame.Entity.ctor.call(this,game);this.Controller=System.Array.init(7,!1,System.Boolean);this.LController=System.Array.init(this.Controller.length,!1,System.Boolean)}},methods:{Pressed:function(button){return this.Controller[System.Array.index(button,this.Controller)]!==this.LController[System.Array.index(button,this.LController)]&&this.Controller[System.Array.index(button,this.Controller)]},Released:function(button){return this.Controller[System.Array.index(button,this.Controller)]!==this.LController[System.Array.index(button,this.LController)]&&!this.Controller[System.Array.index(button,this.Controller)]}}});Bridge.define("CirnoGame.ConveyorBelt",{inherits:[CirnoGame.Entity],fields:{TTD:null,tmp:null},ctors:{init:function(){this.tmp=new CirnoGame.Vector2},ctor:function(game){this.$initialize();CirnoGame.Entity.ctor.call(this,game);this.Ani=new CirnoGame.Animation(CirnoGame.AnimationLoader._this.GetAnimation("images/misc/conveyor"));this.Ani.ImageSpeed=.15;this.Ani.SetImage()}},methods:{SetDown:function(){for(var TM=this.Game.TM,TZ=TM.tilesize,TD=TM.CheckForTile(this.Position),attempts=0,direction=TZ;!(TD!=null&&TD.solid&&TD.visible)&&attempts<20;)this.y+=direction,TD=TM.CheckForTile(this.Position);if(attempts>=20){this.Alive=!1;return}this.x=TD.column*TZ+TM.position.X;this.y=(TD.row-1|0)*TZ+TM.position.Y;this.TTD=TD;this.Ani.Flipped=(TD.row&4)>0;this.TTD.SteppedOn=this.Ani.Flipped?function(E){E.Hspeed+=.36}:function(E){E.Hspeed-=.36}},Update:function(){var Pos=this.Ani.Position,TM=this.Game.TM,TD,redraw;if(this.tmp.X=Pos.X,this.tmp.Y=Pos.Y+TM.tilesize,TD=TM.CheckForTile(this.tmp),!Bridge.referenceEquals(TD,this.TTD)&&this.Alive){this.TTD.SteppedOn=null;this.Alive=!1;return}if(TD!=null&&TD.solid&&TD.visible&&TD.opaque)TD.HP<3.25&&this.Ani.ImageSpeed>0&&(this.Ani.ImageSpeed=0,this.TTD.SteppedOn=null);else if(this.Alive){this.Alive=!1;this.TTD.SteppedOn=null;return}TD.CanSlope&&(redraw=!1,TD.SlopeDirection!==0&&(redraw=!0),TD.CanSlope=!1,redraw&&TD.UpdateTile());CirnoGame.Entity.prototype.Update.call(this)}}});Bridge.define("CirnoGame.ExitDoor",{inherits:[CirnoGame.Entity],fields:{reset:0,RT:null,_Opened:!1},props:{Opened:{get:function(){return this._Opened},set:function(value){this._Opened=value;this._Opened?(this.Ani.CurrentFrame=1,this.Ani.SetImage()):(this.Ani.CurrentFrame=0,this.Ani.SetImage())}}},ctors:{init:function(){this.reset=0;this._Opened=!1},ctor:function(game){this.$initialize();CirnoGame.Entity.ctor.call(this,game);this.Ani=new CirnoGame.Animation(CirnoGame.AnimationLoader.Get("images/misc/door"));this.Ani.ImageSpeed=0;this.Ani.SetImage();this.RemovedOnLevelEnd=!1}},methods:{DropToGround:function(){for(var F,FB,T;this.GetFloor()==null;)this.y+=16;F=this.GetFloor();FB=F.GetHitbox();this.x=FB.left;this.y=FB.top-32;T=this.Game.TM.GetTile(F.column,F.row-1|0);T!=null&&T.enabled&&T.topSolid&&(this.y-=16,F=T,console.log("dug door out of the ground"));this.RT=F;this.reset=0},Update:function(){var P,time,F;if(CirnoGame.Entity.prototype.Update.call(this),this._Opened){if(P=this.Game.player,P.Position.EstimatedDistance(this.Position)<20&&P.Controller[System.Array.index(2,P.Controller)]){this.Opened=!1;P.score=P.score+Bridge.Int.mul(this.Game.level,10)|0;new CirnoGame.HealingItem(this.Game).onCollected(P);time=13e3;this.Game.timeRemaining>0?(this.Game.timeRemaining+=time,this.Game.timeRemaining=Math.min(this.Game.defaultTimeRemaining,this.Game.timeRemaining)):this.Game.timeRemaining+=time;this.Game.StartNextLevel()}this.reset<2&&(this.reset=this.reset+1|0,F=this.RT,F!=null&&this.reset===2&&(F.Breakable=!1,F.texture=0,this.Game.TM.RedrawTile(F.column,F.row)))}},GetFloor:function(){var T=null,W=this.Width/3,Y=this.Height;return T!=null&&T.enabled&&T.topSolid||(T=this.Game.TM.CheckForTile(CirnoGame.Vector2.Add$1(this.Position,this.Width/2,Y))),T!=null&&T.enabled&&T.topSolid||(T=this.Game.TM.CheckForTile(CirnoGame.Vector2.Add$1(this.Position,W,Y))),T!=null&&T.enabled&&T.topSolid||(T=this.Game.TM.CheckForTile(CirnoGame.Vector2.Add$1(this.Position,this.Width-W,Y))),T!=null&&T.enabled&&T.topSolid||(T=null),T}}});Bridge.define("CirnoGame.FlightControls",{inherits:[CirnoGame.EntityBehavior],fields:{accel:0,maxSpeed:0,_platformer:null},ctors:{init:function(){this.accel=.35;this.maxSpeed=1.7},ctor:function(entity){this.$initialize();CirnoGame.EntityBehavior.ctor.call(this,entity);this._platformer=entity}},methods:{Update:function(){var controller=this._platformer.Controller;controller[System.Array.index(0,controller)]&&this._platformer.Hspeed>-this.maxSpeed&&(this._platformer.Hspeed=Math.max(this._platformer.Hspeed-(this.accel+this._platformer.friction),-this.maxSpeed));controller[System.Array.index(1,controller)]&&this._platformer.Hspeed<this.maxSpeed&&(this._platformer.Hspeed=Math.min(this._platformer.Hspeed+(this.accel+this._platformer.friction),this.maxSpeed));controller[System.Array.index(2,controller)]&&this._platformer.Vspeed>-this.maxSpeed&&(this._platformer.Vspeed=Math.max(this._platformer.Vspeed-(this.accel+this._platformer.friction),-this.maxSpeed));controller[System.Array.index(3,controller)]&&this._platformer.Vspeed<this.maxSpeed&&(this._platformer.Vspeed=Math.min(this._platformer.Vspeed+(this.accel+this._platformer.friction),this.maxSpeed));CirnoGame.EntityBehavior.prototype.Update.call(this)}}});Bridge.define("CirnoGame.FloatingMessage",{inherits:[CirnoGame.Entity],fields:{time:0,Text:null,alpha:0,autokill:!1},ctors:{init:function(){this.time=30;this.alpha=1;this.autokill=!0},ctor:function(game,text){this.$initialize();CirnoGame.Entity.ctor.call(this,game);this.Ani=new CirnoGame.Animation(null);this.Text=new CirnoGame.TextSprite;this.Text.Text=text;this.Text.TextColor="#FFFFFF";this.Text.ShadowColor="#000000";this.Text.ShadowOffset=new CirnoGame.Vector2(2,2);this.Text.ShadowBlur=1;this.Text.FontSize=14;this.time=30+Bridge.Int.mul(text.length,20)|0}},methods:{ChangeText:function(text,color){color===void 0&&(color=null);this.Text.Text=text;this.time=30+Bridge.Int.mul(text.length,20)|0;this.alpha=1;color!=null&&(this.Text.TextColor=color)},Update:function(){CirnoGame.Entity.prototype.Update.call(this);this.time>0&&(this.time=this.time-1|0,this.time<1&&this.alpha>0&&(this.alpha-=.05,this.alpha<=0&&(this.alpha=0,this.autokill&&(this.Alive=!1)),this.time=1))},Draw:function(g){if(this.alpha<1){if(this.alpha<=0)return;g.globalAlpha=this.alpha}this.Text.ForceUpdate();this.Text.Position.X=Bridge.Int.clip32(this.Position.X)-(Bridge.Int.div(this.Text.spriteBuffer.width,2)|0)|0;this.Text.Position.Y=Bridge.Int.clip32(this.Position.Y)-(Bridge.Int.div(this.Text.spriteBuffer.height,2)|0)|0;this.Text.Draw(g);g.globalAlpha=1}}});Bridge.define("CirnoGame.GameSprite",{inherits:[CirnoGame.Sprite],ctors:{ctor:function(){this.$initialize();CirnoGame.Sprite.ctor.call(this)}},methods:{Update:function(){},Render:function(){}}});Bridge.define("CirnoGame.Particle",{inherits:[CirnoGame.Entity],fields:{HP:0,alphatime:0},ctors:{init:function(){this.HP=12;this.alphatime=.2},ctor:function(game,image){this.$initialize();CirnoGame.Entity.ctor.call(this,game);this.Ani=new CirnoGame.Animation(new(System.Collections.Generic.List$1(HTMLImageElement).$ctor1)(System.Array.init([image],HTMLImageElement)))}},methods:{Update:function(){var $t;this.HP=this.HP-1|0;this.HP<=0&&($t=this.Ani.Alpha-this.alphatime,this.Ani.Alpha=$t,$t)<=0&&(this.Alive=!1);CirnoGame.Entity.prototype.Update.call(this)}}});Bridge.define("CirnoGame.PlatformerControls",{inherits:[CirnoGame.EntityBehavior],fields:{_platformer:null,accel:0,jumpSpeed:0,maxSpeed:0,maxAirJumps:0,airJumps:0,airjumppower:0},ctors:{init:function(){this.accel=.35;this.jumpSpeed=2.25;this.maxSpeed=1.5;this.maxAirJumps=1;this.airJumps=0;this.airjumppower=.815},ctor:function(entity){this.$initialize();CirnoGame.EntityBehavior.ctor.call(this,entity);this._platformer=entity}},methods:{Update:function(){var againstwall=!1,controller=this._platformer.Controller,X=0,jumpbutton;controller[System.Array.index(0,controller)]&&!controller[System.Array.index(1,controller)]&&this._platformer.Hspeed>-this.maxSpeed&&(this._platformer.Hspeed=Math.max(this._platformer.Hspeed-(this.accel+this._platformer.friction),-this.maxSpeed),X=-1,this._platformer.RightWall!=null&&(againstwall=!0));controller[System.Array.index(1,controller)]&&!controller[System.Array.index(0,controller)]&&this._platformer.Hspeed<this.maxSpeed&&(this._platformer.Hspeed=Math.min(this._platformer.Hspeed+(this.accel+this._platformer.friction),this.maxSpeed),X=1,this._platformer.LeftWall!=null&&(againstwall=!0));jumpbutton=5;this._platformer.onGround&&(this.airJumps=0);this._platformer.Vspeed>=0&&this._platformer.onGround?this._platformer.Pressed(jumpbutton)&&this._platformer.onGround&&this._platformer.Ceiling==null&&(this._platformer.Vspeed=-this.jumpSpeed,this.entity.PlaySound("jump")):this.airJumps<this.maxAirJumps&&this._platformer.Pressed(jumpbutton)&&this._platformer.Ceiling==null&&(this._platformer.Vspeed=-(this.jumpSpeed*this.airjumppower),this.airJumps=this.airJumps+1|0);this._platformer.Vspeed<0&&!controller[System.Array.index(jumpbutton,controller)]&&(this._platformer.Vspeed+=this._platformer.gravity*2);CirnoGame.EntityBehavior.prototype.Update.call(this)}}});Bridge.define("CirnoGame.PlayerBullet",{inherits:[CirnoGame.Entity,CirnoGame.IHarmfulEntity,CirnoGame.ILightSource],fields:{shooter:null,Duration:0,hitEntities:null,piercing:!1,spinrate:0,Gravity:null,Bounces:!1,attacksterrain:!1,digpower:0,ignoresterrain:!1,_maxLightRadius:0,_touchDamage:0},props:{Attacker:{get:function(){return this.shooter}},IsHarmful:{get:function(){return!0}},lightFlicker:{get:function(){return!1}},lightPosition:{get:function(){return this.getCenter()}},maxLightRadius:{get:function(){return this.Ani.Alpha>=1?this._maxLightRadius:0},set:function(value){this._maxLightRadius=value}},touchDamage:{get:function(){return this._touchDamage},set:function(value){this._touchDamage=value}}},alias:["Attacker","CirnoGame$IHarmfulEntity$Attacker","IsHarmful","CirnoGame$IHarmfulEntity$IsHarmful","lightFlicker","CirnoGame$ILightSource$lightFlicker","lightPosition","CirnoGame$ILightSource$lightPosition","maxLightRadius","CirnoGame$ILightSource$maxLightRadius","touchDamage","CirnoGame$IHarmfulEntity$touchDamage","ontouchDamage","CirnoGame$IHarmfulEntity$ontouchDamage"],ctors:{init:function(){this.Duration=0;this.spinrate=0;this.Gravity=new CirnoGame.Vector2;this.attacksterrain=!1;this.digpower=.5;this.ignoresterrain=!1;this._maxLightRadius=1.5;this._touchDamage=1},ctor:function(game,shooter,graphic){graphic===void 0&&(graphic="Reisenbullet");this.$initialize();CirnoGame.Entity.ctor.call(this,game);this.Ani=new CirnoGame.Animation(CirnoGame.AnimationLoader._this.GetAnimation(graphic));this.shooter=shooter;this.piercing=!1;this.hitEntities=new(System.Collections.Generic.List$1(CirnoGame.Entity).ctor)}},methods:{GetHitbox:function(){if(this.Ani!=null&&this.Ani.CurrentImage!=null){var s=this.Ani.CurrentImage.height*1.5,so2=s/2,V=CirnoGame.Vector2.Subtract$1(this.getCenter(),so2,so2);return new CirnoGame.Rectangle(V.X,V.Y,s,s)}return null},ontouchDamage:function(target){this.piercing||(this.Alive=!1);var ok=!this.hitEntities.contains(Bridge.cast(target,CirnoGame.Entity));return ok?(this.hitEntities.add(Bridge.cast(target,CirnoGame.Entity)),!0):!1},Update:function(){var center,T;CirnoGame.Entity.prototype.Update.call(this);this.spinrate!==0&&(this.Ani.Rotation+=this.spinrate);this.Gravity.RoughLength!==0&&(this.Speed=CirnoGame.Vector2.op_Addition(this.Speed,this.Gravity));this.Game.stageBounds.containsPoint(this.Position)||(this.Ani.X>0==this.Hspeed>0||this.Ani.X<0==this.Hspeed<0||this.Ani.Y>0==this.Vspeed>0||this.Ani.Y<0==this.Vspeed<0)&&(this.Alive=!1);center=CirnoGame.Vector2.Add$1(this.Position,8,0);this.ignoresterrain||(T=null,this.Bounces||(T=this.Game.TM.CheckForTile(new CirnoGame.Vector2(center.X,this.y))),T!=null&&T.enabled&&T.solid?(this.attacksterrain&&(T.Breakable?T.Damage(this.digpower)?this.PlaySound("thunk4"):this.PlaySound("thunk"):this.PlaySound("plink")),this.Alive=!1):this.Bounces&&(T=this.Game.TM.CheckForTile(CirnoGame.Vector2.op_Addition(center,new CirnoGame.Vector2(this.Speed.X))),T!=null&&T.enabled&&T.solidToSpeed(this.Speed.ToCardinal())&&(this.Speed.X=-this.Speed.X),T=this.Game.TM.CheckForTile(CirnoGame.Vector2.op_Addition(center,new CirnoGame.Vector2(0,this.Speed.Y))),T!=null&&T.enabled&&T.solidToSpeed(this.Speed.ToCardinal())&&(this.Speed.Y=-this.Speed.Y),T=this.Game.TM.CheckForTile(CirnoGame.Vector2.op_Addition(center,this.Speed)),T!=null&&T.enabled&&T.solidToSpeed(this.Speed.ToCardinal())&&(this.Speed.X=-this.Speed.X,this.Speed.Y=-this.Speed.Y)));this.Duration>0&&(this.Duration=this.Duration-1|0,this.Duration<=0&&(this.Duration=1,this.Ani.Alpha-=.2,this.Ani.Alpha<=0&&(this.Alive=!1)))}}});Bridge.define("CirnoGame.RandomAI",{inherits:[CirnoGame.EntityBehavior],fields:{CE:null},ctors:{ctor:function(entity){this.$initialize();CirnoGame.EntityBehavior.ctor.call(this,entity);this.CE=entity;this.FramesPerTick=15}},methods:{Update:function(){if(CirnoGame.EntityBehavior.prototype.Update.call(this),Math.random()<.1){var Controller=this.CE.Controller;Controller[System.Array.index(0,Controller)]=!1;Controller[System.Array.index(1,Controller)]=!1;Controller[System.Array.index(2,Controller)]=!1;Controller[System.Array.index(3,Controller)]=!1;Math.random()<.5&&(Controller[System.Array.index(0,Controller)]=Math.random()<.5,Controller[System.Array.index(1,Controller)]=!Controller[System.Array.index(0,Controller)]);Math.random()<.5&&(Controller[System.Array.index(2,Controller)]=Math.random()<.5,Controller[System.Array.index(3,Controller)]=!Controller[System.Array.index(2,Controller)])}}}});Bridge.define("CirnoGame.RoomOpeningLever",{inherits:[CirnoGame.Entity],statics:{fields:{TEST:null},methods:{FindAndPlaceOnWall:function(game,P,Target){var T=game.TM.CheckForTile(P),T2,T3,ret;if(T!=null)for(var X=T.column,Y=T.row,XD=Math.random()<.5?-1:1;;)if(X=X+XD|0,T2=game.TM.GetTile(X,Y),T2!=null){if(T2.enabled&&T2.solid)return T3=game.TM.GetTile(X-XD|0,Y+1|0),T3!=null&&T3.enabled&&T3.solid?null:(ret=new CirnoGame.RoomOpeningLever(game,new CirnoGame.Point(X,Y),Target,XD===1),ret.Alive?ret:null)}else return null;return null}}},fields:{Room:null,Block:null},props:{Activated:!1},ctors:{ctor:function(game,Tile,Target,flipped){var T,R;flipped===void 0&&(flipped=!1);this.$initialize();CirnoGame.Entity.ctor.call(this,game);this.Ani=new CirnoGame.Animation(CirnoGame.AnimationLoader._this.GetAnimation("images/misc/lever"));this.Ani.ImageSpeed=0;this.Block=Tile;T=game.TM.GetTile(Tile.X,Tile.Y);CirnoGame.RoomOpeningLever.TEST=this;T!=null&&T.solid?(Target!=null&&(this.Room=Target),T.Breakable=!1,T.CanSlope=!1,R=T.GetHitbox(),flipped?(this.Ani.Position.X=R.left-16,this.Ani.Flipped=!0):this.Ani.Position.X=R.right,this.Ani.Position.Y=R.top):this.Alive=!1}},methods:{Update:function(){var T,P;CirnoGame.Entity.prototype.Update.call(this);T=this.Game.TM.GetTile(this.Block.X,this.Block.X);T!=null&&T.enabled&&T.solid?(T.Breakable=!1,T.CanSlope=!1):(this.Alive=!1,this.Room!=null&&(this.Room.ClearRoom(),this.Room.GeneratePlatforms(),this.Room.ApplyBreakable(),this.Room.ForceRedraw()));P=this.Game.player;!this.Activated&&P.Position.EstimatedDistance(this.Position)<16&&P.Controller[System.Array.index(2,P.Controller)]&&this.Activate()},Activate:function(){this.Activated||(this.Activated=!0,this.PlaySound("open2"),this.Ani.CurrentFrame=1,this.Ani.SetImage(),this.Ani.Update(),this.Room.UnleashSecret())}}});Bridge.define("CirnoGame.TextSprite",{inherits:[CirnoGame.Sprite],fields:{_Text:null,textInvallidated:!1,imageInvallidated:!1,TextImage:null,TextGraphic:null,_TextColor:null,_FontWeight:null,_FontFamily:null,_FontSize:0,_shadowBlur:0,_shadowOffset:null,_shadowColor:null},props:{Text:{get:function(){return this._Text},set:function(value){Bridge.referenceEquals(this._Text,value)||(this._Text=value,this.textInvallidated=!0)}},TextColor:{get:function(){return this._TextColor},set:function(value){Bridge.referenceEquals(this._TextColor,value)||(this._TextColor=value,this.textInvallidated=!0)}},FontWeight:{get:function(){return this._FontWeight},set:function(value){Bridge.referenceEquals(this._FontWeight,value)||(this._FontWeight=value,this.UpdateFont())}},FontFamily:{get:function(){return this._FontFamily},set:function(value){Bridge.referenceEquals(this._FontFamily,value)||(this._FontFamily=value,this.UpdateFont())}},FontSize:{get:function(){return this._FontSize},set:function(value){this._FontSize!==value&&(this._FontSize=value,this.UpdateFont())}},ShadowBlur:{get:function(){return this._shadowBlur},set:function(value){this._shadowBlur!==value&&(this._shadowBlur=value,this.imageInvallidated=!0)}},ShadowOffset:{get:function(){return this._shadowOffset.Clone()},set:function(value){CirnoGame.Vector2.op_Inequality(this._shadowOffset,value)&&value.X!==this._shadowOffset.X&&value.Y!==this._shadowOffset.Y&&(this._shadowOffset=value.Clone(),this.imageInvallidated=!0)}},ShadowColor:{get:function(){return this._shadowColor},set:function(value){Bridge.referenceEquals(this._shadowColor,value)||(this._shadowColor=value,this.imageInvallidated=!0)}}},ctors:{init:function(){this._FontWeight="normal";this._FontFamily="sans-serif";this._FontSize=10;this._shadowBlur=0;this._shadowOffset=new CirnoGame.Vector2;this._shadowColor="#000000"},ctor:function(){this.$initialize();CirnoGame.Sprite.ctor.call(this);this.TextImage=document.createElement("canvas");this.TextGraphic=this.TextImage.getContext("2d");this.TextGraphic.imageSmoothingEnabled=!1;this.TextImage.style.imageRendering="pixelated";this.TextGraphic.fillStyle="#FFFFFF"}},methods:{UpdateFont:function(){this.TextGraphic.font=System.String.concat(this._FontWeight," ",this._FontSize,"px ",this._FontFamily);this.textInvallidated=!0;this.imageInvallidated=!0;this.TextGraphic.fillStyle=this._TextColor},RedrawBaseTextImage:function(){var TM,Y;this.UpdateFont();for(var lines=System.String.split(this._Text,[10].map(function(i){return String.fromCharCode(i)})),H=this.FontSize*1,W=0,i=0;i<lines.length;)TM=this.TextGraphic.measureText(lines[System.Array.index(i,lines)]),W=Math.max(W,Bridge.Int.clip32(Math.ceil(TM.width))),i=i+1|0;for(this.TextImage.height=Bridge.Int.clip32(H*(lines.length+.25)),this.TextImage.width=W,this.UpdateFont(),Y=0,i=0;i<lines.length;)this.TextGraphic.fillText(lines[System.Array.index(i,lines)],0,this.FontSize+Y),Y+=H,i=i+1|0;this.textInvallidated=!1;this.imageInvallidated=!0},RenderTextImage:function(){if(this._shadowBlur<=0)this.spriteBuffer.width=this.TextImage.width,this.spriteBuffer.height=this.TextImage.height;else{var S=Bridge.Int.clip32(Math.ceil(this._shadowBlur+this._shadowBlur));this.spriteBuffer.width=this.TextImage.width+S|0;this.spriteBuffer.height=this.TextImage.height+S|0}if(this.spriteGraphics.shadowBlur=0,this.spriteGraphics.globalCompositeOperation="source-over",this.TextImage.width<=0){this.imageInvallidated=!1;return}this._shadowBlur<=0?this.spriteGraphics.drawImage(this.TextImage,0,0):this.spriteGraphics.drawImage(this.TextImage,this._shadowBlur,this._shadowBlur);this._shadowBlur>0&&(this.spriteGraphics.shadowBlur=this._shadowBlur,this.spriteGraphics.shadowColor=this._shadowColor,this.spriteGraphics.shadowOffsetX=this._shadowOffset.X,this.spriteGraphics.shadowOffsetY=this._shadowOffset.Y,this.spriteGraphics.drawImage(this.spriteBuffer,0,0));this.imageInvallidated=!1},ForceUpdate:function(){this.textInvallidated&&this.RedrawBaseTextImage();this.imageInvallidated&&this.RenderTextImage()},Draw:function(g){this.ForceUpdate();CirnoGame.Sprite.prototype.Draw.call(this,g)}}});Bridge.define("CirnoGame.Tile",{inherits:[CirnoGame.Entity],fields:{tile:0},ctors:{ctor:function(game,tile){this.$initialize();CirnoGame.Entity.ctor.call(this,game);this.tile=tile;this.Ani=new CirnoGame.Animation(CirnoGame.AnimationLoader.Get("images/land/brick"));this.Ani.CurrentFrame=tile;this.Ani.ImageSpeed=0}},methods:{Draw:function(g){CirnoGame.Entity.prototype.Draw.call(this,g)}}});Bridge.define("CirnoGame.TitleScreen",{inherits:[CirnoGame.Sprite],fields:{Title:null,Version:null,Desc:null,Controls:null,Credits:null,menu:null,Controller:null,game:null},ctors:{ctor:function(){var B,CB;this.$initialize();CirnoGame.Sprite.ctor.call(this);this.spriteBuffer.width=CirnoGame.App.Canvas.width;this.spriteBuffer.height=Bridge.Int.clip32(this.spriteBuffer.width*CirnoGame.App.TargetAspect);this.Title=new CirnoGame.TextSprite;this.Title.FontSize=Bridge.Int.clip32(this.spriteBuffer.width*.06);this.Title.Text=CirnoGame.App.GameName;this.Title.TextColor="#77FFFF";this.Title.ShadowColor="#000000";this.Title.ShadowOffset=new CirnoGame.Vector2(2,2);this.Title.ShadowBlur=2;this.CenterTextWithFloats(this.Title,.5,.06);this.Version=new CirnoGame.TextSprite;this.Version.FontSize=Bridge.Int.clip32(this.spriteBuffer.width*.016);this.Version.Text=System.String.concat("Version:",CirnoGame.App.GameVersion);this.Version.TextColor="#FFFFFF";this.Version.ShadowColor="#000000";this.Version.ShadowOffset=new CirnoGame.Vector2(2,2);this.Version.ShadowBlur=2;this.CenterTextWithFloats(this.Version,.75,.11);this.Desc=new CirnoGame.TextSprite;this.Desc.FontSize=Bridge.Int.clip32(this.spriteBuffer.width*.03);this.Desc.TextColor="#FFFFFF";this.Desc.Text="Cirno has found herself in a strange tower filled with ghosts!\nReclaim your stolen energy sealed inside the orbs to extend your time.\nRemember the door's location and search for the gold key.";this.Desc.ShadowColor="#000000";this.Desc.ShadowOffset=new CirnoGame.Vector2(2,2);this.Desc.ShadowBlur=2;this.CenterTextWithFloats(this.Desc,.5,.2);this.Controls=new CirnoGame.TextSprite;this.Controls.FontSize=Bridge.Int.clip32(this.spriteBuffer.width*.025);this.Controls.TextColor="#FFFFFF";this.Controls.Text="Keyboard Controls:\nLeft/Right=Move\nUp/Down=Aim(Up activates chests/doors)\nZ=Shoot\nX=Jump/Mid-air jump\nA=Place block below you(costs time)\nEnter=Pause\nM=Toggle mute";this.Controls.ShadowColor="#000000";this.Controls.ShadowOffset=new CirnoGame.Vector2(2,2);this.Controls.ShadowBlur=2;this.CenterTextWithFloats(this.Controls,.5,.4);this.Controls.Position.X=this.Desc.Position.X;this.menu=new CirnoGame.ButtonMenu(this.spriteBuffer.width*.8,this.spriteBuffer.height*.5,Bridge.Int.clip32(this.spriteBuffer.width*.05));B=this.menu.AddButton("Start Game");B.OnClick=Bridge.fn.bind(this,function(){this.game.Start()});B.Position.X+=this.spriteBuffer.width*.38;B.Position.Y=this.spriteBuffer.height*.7;CB=this.menu.AddButton(System.String.concat("Controller:",CirnoGame.App.IC.id));this.Controller=CB;CB.OnClick=function(){var ind=CirnoGame.InputControllerManager._this.Controllers.indexOf(CirnoGame.App.IC),TS,W;ind=ind+1|0;ind>=CirnoGame.InputControllerManager._this.Controllers.Count&&(ind=ind-CirnoGame.InputControllerManager._this.Controllers.Count|0);CirnoGame.App.IC=CirnoGame.InputControllerManager._this.Controllers.getItem(ind);TS=CB.Contents;W=TS.spriteBuffer.width;TS.Text=System.String.concat("Controller:",CirnoGame.App.IC.id);TS.ForceUpdate();CB.Position.X-=Bridge.Int.div(TS.spriteBuffer.width-W|0,2)|0};CB.Position.X+=this.spriteBuffer.width*.38;CB.Position.Y=B.Position.Y+this.spriteBuffer.height*.15;CB.Lock();this.Credits=new CirnoGame.TextSprite;this.Credits.FontSize=Bridge.Int.clip32(this.spriteBuffer.width*.015);this.Credits.TextColor="#77FFFF";this.Credits.Text="Made by:RSGmaker                                                                                                           Touhou Project and it's characters are owned by ZUN";this.Credits.ShadowColor="#000000";this.Credits.ShadowOffset=new CirnoGame.Vector2(2,2);this.Credits.ShadowBlur=2;this.CenterTextWithFloats(this.Credits,.5,.98)}},methods:{CenterTextWithFloats:function(T,X,Y){this.CenterText(T,new CirnoGame.Vector2(this.spriteBuffer.width*X,this.spriteBuffer.height*Y))},CenterText:function(T,Location){T.ForceUpdate();T.Position.X=Location.X-(Bridge.Int.div(T.spriteBuffer.width,2)|0);T.Position.Y=Location.Y-(Bridge.Int.div(T.spriteBuffer.height,2)|0)},Draw:function(g){CirnoGame.Sprite.prototype.Draw.call(this,g);this.Controller.locked&&CirnoGame.InputControllerManager._this.Controllers.Count>1&&this.Controller.Unlock();this.Title.Draw(g);this.Version.Draw(g);this.Desc.Draw(g);this.Controls.Draw(g);this.menu.Draw(g);this.menu.Update();this.Credits.Draw(g);var M=CirnoGame.KeyboardManager._this.CMouse.Clone();System.String.contains(CirnoGame.App.Div.style.left,"px")&&(M.X<this.spriteBuffer.width*.17&&M.Y>=this.spriteBuffer.height*.96?(CirnoGame.App.Div.style.cursor="pointer",CirnoGame.KeyboardManager._this.TappedMouseButtons.contains(0)&&(Bridge.global.location.href="https://rsgmaker.deviantart.com")):CirnoGame.App.Div.style.cursor=null)}}});Bridge.define("CirnoGame.Turret",{inherits:[CirnoGame.Entity,CirnoGame.ICombatant],fields:{attackpower:0,TTD:null},props:{Team:0,HP:0,PointsForKilling:{get:function(){return 1}},TargetPriority:{get:function(){return.5}}},alias:["Team","CirnoGame$ICombatant$Team","HP","CirnoGame$ICombatant$HP","PointsForKilling","CirnoGame$ICombatant$PointsForKilling","TargetPriority","CirnoGame$ICombatant$TargetPriority","onDamaged","CirnoGame$ICombatant$onDamaged","onDeath","CirnoGame$ICombatant$onDeath","onKill","CirnoGame$ICombatant$onKill"],ctors:{init:function(){this.attackpower=1},ctor:function(game){if(this.$initialize(),CirnoGame.Entity.ctor.call(this,game),this.Ani=new CirnoGame.Animation(CirnoGame.AnimationLoader._this.GetAnimation("images/enemies/turret")),this.Ani.ImageSpeed=0,this.attackpower=1+this.Game.level*.55,this.attackpower*=2,this.HP=0,this.Team=2,this.Game.playing){var A=this.AddBehavior(CirnoGame.AimedShooter);A.attackpower=this.attackpower;A.maxtime=Math.max(480-Bridge.Int.mul(this.Game.level,10)|0,380);A.maxtime=Bridge.Int.clip32(A.maxtime*1.25);A.ignoresterrain=!0;A.maxDistance*=1.3;A.maxShadow=1;A.bulletSpeed*=.8;A.bulletDuration=540;A.bulletgraphic="turretbullet";A.attackTelegraphTime=A.attackTelegraphTime+A.attackTelegraphTime|0}}},methods:{getCenter:function(){return CirnoGame.Vector2.Add$1(this.Position,5,5)},onDamaged:function(){},onDeath:function(){},onKill:function(){},SetDown:function(forcedown){forcedown===void 0&&(forcedown=!1);var TM=this.Game.TM,TZ=TM.tilesize,TD=TM.CheckForTile(this.Position),attempts=0,direction=Math.random()<.5?TZ:-TZ;for(forcedown&&(direction=TZ);!(TD!=null&&TD.solid&&TD.visible)&&attempts<20;)this.y+=direction,TD=TM.CheckForTile(this.Position);if(attempts>=20){this.Alive=!1;return}this.x=TD.column*TZ+TM.position.X;this.y=TD.row*TZ+TM.position.Y;this.TTD=TD},Update:function(){var TD=this.Game.TM.CheckForTile(this.Position),P,redraw;if((TD==null||!TD.solid||!TD.visible||!TD.opaque)&&this.Alive){this.Alive=!1;P=new CirnoGame.PointItem(this.Game);P.Position.CopyFrom(this.Position);P.collectionDelay=Bridge.Int.div(P.collectionDelay,2)|0;this.Game.AddEntity(P);Math.random()<.15&&(P=new CirnoGame.HealingItem(this.Game),P.Position.CopyFrom(this.Position),P.Vspeed=-2,P.collectionDelay=Bridge.Int.div(P.collectionDelay,2)|0,this.Game.AddEntity(P));return}TD.CanSlope&&(redraw=!1,TD.SlopeDirection!==0&&(redraw=!0),TD.CanSlope=!1,redraw&&TD.UpdateTile());this.Ani.Shadow>0?this.Ani.ImageSpeed=.25:this.Ani.ImageSpeed>0&&(this.Ani.ImageSpeed=0,this.Ani.CurrentFrame=0,this.Ani.SetImage());CirnoGame.Entity.prototype.Update.call(this)}}});Bridge.define("CirnoGame.DoorKey",{inherits:[CirnoGame.CollectableItem],ctors:{ctor:function(game){this.$initialize();CirnoGame.CollectableItem.ctor.call(this,game,"bigkey");this.floats=!1;this.magnetDistance=20;this.sound="key"}},methods:{onCollected:function(){this.Game.Door.Opened=!0;var FM=new CirnoGame.FloatingMessage(this.Game,"Door Unlocked!");FM.Text.TextColor="#77FFFF";FM.Position=new CirnoGame.Vector2(this.x+8,this.y-20);this.Game.AddEntity(FM)},Update:function(){CirnoGame.CollectableItem.prototype.Update.call(this);this.y<=0&&this.Game.LevelRestart()}}});Bridge.define("CirnoGame.Game",{inherits:[CirnoGame.GameSprite],statics:{methods:{GetTeamColor:function(team){return team===1?"#FF0000":team===2||team===0?"#0000FF":team===3?"#FFFF00":"#000000"},pulse:function(value,max){return Math.abs(value%Bridge.Int.mul(max,2)-max|0)}}},fields:{player:null,entities:null,harmful:null,combatants:null,camera:null,stageBounds:null,TM:null,GamePlaySettings:null,TimerSprite:null,StatsSprite:null,defaultTimeRemaining:0,lastStand:0,baseLifeCost:0,timeRemaining:0,displayTimeRemaining:0,totalTime:0,level:0,playing:!1,paused:!1,cameraWanderPoint:null,TS:null,Teams:!1,skiprender:!1,ScoreSprite:null,EG:null,Door:null,Key:null,BigKey:null,hasLevel:!1,generator:null,muted:!1,lastPauseButtonState:!1,frame:0,fadein:0,ShowHitbox:!1,freecam:!1},props:{running:{get:function(){return this.playing&&!this.paused&&this.fadein<=0&&this.generator==null}}},ctors:{init:function(){this.defaultTimeRemaining=15e4;this.lastStand=3e4;this.baseLifeCost=15e3;this.totalTime=0;this.level=0;this.playing=!1;this.paused=!1;this.Teams=!0;this.skiprender=!0;this.hasLevel=!1;this.muted=!1;this.lastPauseButtonState=!1;this.frame=0;this.fadein=0;this.ShowHitbox=!1;this.freecam=!1},ctor:function(){this.$initialize();CirnoGame.GameSprite.ctor.call(this);this.GamePlaySettings=new CirnoGame.GamePlaySettings;this.Door=new CirnoGame.ExitDoor(this);this.entities=new(System.Collections.Generic.List$1(CirnoGame.Entity).ctor);this.combatants=new(System.Collections.Generic.List$1(CirnoGame.Entity).ctor);this.harmful=new(System.Collections.Generic.List$1(CirnoGame.Entity).ctor);this.player=new CirnoGame.PlayerCharacter(this);this.player.HP=0;this.timeRemaining=this.defaultTimeRemaining;this.displayTimeRemaining=this.timeRemaining;this.stageBounds=new CirnoGame.Rectangle(0,0,4e3,2e3);this.TM=new CirnoGame.TileMap(this);this.TM.Seed=Bridge.Int.clip32(Math.random()*System.Int64([1410065407,2]));this.TM.position.Y=0;var R=CirnoGame.Rectangle.op_Subtraction(this.stageBounds,this.TM.position);R.width-=this.TM.tilesize;R.height-=this.TM.tilesize;this.player.Position.Y=this.stageBounds.height/3;this.player.Position.X=this.stageBounds.width/2;this.EG=CirnoGame.Helper.GetContext(document.createElement("canvas"));this.AddEntity(this.Door);this.spriteBuffer.width=CirnoGame.App.Canvas.width;this.spriteBuffer.height=Bridge.Int.clip32(this.spriteBuffer.width*CirnoGame.App.TargetAspect);this.camera=new CirnoGame.Camera(this.spriteBuffer.width,this.spriteBuffer.height);this.camera.Scale=3.5;this.camera.StageBounds=this.stageBounds;this.camera.Update();this.camera.instawarp=!0;this.spriteGraphics.imageSmoothingEnabled=!1;this.StartNextLevel();this.TimerSprite=new CirnoGame.TextSprite;this.TimerSprite.FontSize=Bridge.Int.div(this.spriteBuffer.height,24)|0;this.TimerSprite.Text="2:30";this.TimerSprite.TextColor="#FFFFFF";this.TimerSprite.ShadowColor="#000000";this.TimerSprite.ShadowOffset=new CirnoGame.Vector2(3,3);this.TimerSprite.ShadowBlur=1;this.TimerSprite.Position.X=this.spriteBuffer.width*.47;this.TimerSprite.Position.Y=Bridge.Int.div(-this.TimerSprite.FontSize|0,8)|0;this.StatsSprite=new CirnoGame.TextSprite;this.StatsSprite.FontSize=Bridge.Int.div(this.spriteBuffer.height,40)|0;this.StatsSprite.Text="";this.StatsSprite.TextColor="#FFFFFF";this.StatsSprite.ShadowColor="#000000";this.StatsSprite.ShadowOffset=new CirnoGame.Vector2(3,3);this.StatsSprite.ShadowBlur=1;this.StatsSprite.Position.X=this.spriteBuffer.width*.01;this.StatsSprite.Position.Y=this.spriteBuffer.height*.97+Bridge.Int.mul(Bridge.Int.div(-this.StatsSprite.FontSize|0,8)|0,2);this.StatsSprite.Visible=!1;this.ScoreSprite=new CirnoGame.TextSprite;this.ScoreSprite.FontSize=Bridge.Int.div(this.spriteBuffer.height,28)|0;this.ScoreSprite.Text="Level:1 Score:0";this.ScoreSprite.TextColor="#FFFFFF";this.ScoreSprite.ShadowColor="#000000";this.ScoreSprite.ShadowOffset=new CirnoGame.Vector2(3,3);this.ScoreSprite.ShadowBlur=1;this.ScoreSprite.ForceUpdate();this.ScoreSprite.Position.X=this.spriteBuffer.width*.98-this.ScoreSprite.spriteBuffer.width;this.ScoreSprite.Position.Y=Bridge.Int.div(-this.ScoreSprite.FontSize|0,8)|0;this.Key=CirnoGame.AnimationLoader.Get("images/items/key").getItem(0);this.BigKey=CirnoGame.AnimationLoader.Get("images/items/bigkey").getItem(0);this.TS=new CirnoGame.TitleScreen;this.TS.game=this;this.SetMusic()}},methods:{ClearEntities:function(){for(var L=this.entities.toArray(),i=0,E;i<L.length;)E=L[System.Array.index(i,L)],E.RemovedOnLevelEnd&&(E.Alive=!1,this.RemoveEntity(E)),i=i+1|0},StartNextLevel:function(){var R,MP;this.ClearEntities();CirnoGame.RoomOpeningLever.TEST=null;this.level=this.level+1|0;R=CirnoGame.Rectangle.op_Subtraction(this.stageBounds,this.TM.position);R.width-=this.TM.tilesize;R.height-=this.TM.tilesize;this.TM.Generate();this.hasLevel?(this.generator=new CirnoGame.MapGenerator,this.generator.game=this,this.fadein=.8,this.generator.Generate(3)):(MP=new CirnoGame.MapGenerator,MP.game=this,MP.forceGeneration(),this.generator=null,this.hasLevel=!0,this.finalizeLevel())},finalizeLevel:function(){for(var ghosts=Bridge.Int.clip32(Math.min(18+Bridge.Int.mul(this.level,2)|0,28)*1.05),i=0,spike,T,TD,TDD,T2,tmp,extrabelts,TD1,T3,key,attempts;i<ghosts;){if(Math.random()<.5)this.PlaceAndAddEnemy(new CirnoGame.MRGhosty(this));else if(spike=Math.random()<.25,Math.random()<.8)T=new CirnoGame.Turret(this),this.PlaceAndAddEnemy(T),T.SetDown(spike),spike&&(TD=T.TTD,TD!=null&&this.TM.rows>(TD.row+1|0)&&(TDD=this.TM.data.get([TD.column,TD.row+1|0]),TDD.enabled&&TDD.solid&&(T.Alive=!1,TD.texture=7,TD.Breakable=!1,TD.CanSlope=!1,TD.opaque=!1,TD.SteppedOn=Bridge.fn.bind(this,function(E){var IC=E;if(IC.blockprice>0&&IC.invincibilitytime<=0){IC.onDamaged(null,1.5+this.level*1.5);if(IC.PlaySound("damaged"),IC.HP<=0)IC.onDeath(null)}}))));else{for(T2=new CirnoGame.ConveyorBelt(this),this.PlaceAndAddEnemy(T2),tmp=new CirnoGame.Vector2,tmp.CopyFrom(T2.Position),extrabelts=1,Math.random()<.35&&(extrabelts=2,Math.random()<.35&&(extrabelts=3));extrabelts>0;)tmp.X+=this.TM.tilesize,TD1=this.TM.CheckForTile(tmp),TD1!=null&&TD1.solid&&TD1.visible&&TD1.opaque?extrabelts=0:(T3=new CirnoGame.ConveyorBelt(this),T3.Position=tmp,this.AddEntity(T3),this.AddEntity(T3),T3.SetDown()),extrabelts=extrabelts-1|0;T2.SetDown()}i=i+1|0}for(i=0;Bridge.identity(i,i=i+1|0)<=4;)this.PlaceAndAddEntity(new CirnoGame.Orb(this));for(i=0;Bridge.identity(i,i=i+1|0)<=3;)this.PlaceAndAddEntity(new CirnoGame.Chest(this)),this.PlaceAndAddEntity(new CirnoGame.KeyItem(this));for(i=0;Bridge.identity(i,i=i+1|0)<=1;)this.PlaceAndAddEntity(new CirnoGame.HealingItem(this));for(key=new CirnoGame.DoorKey(this),attempts=0,this.PlaceAndAddEntity(key);Math.abs(key.x-this.player.x)<70&&attempts<5;)console.log("Door key is too close, repositioning key..."),key.Position.CopyFrom(CirnoGame.MapRoom.FindAnyEmptySpot()),attempts=attempts+1|0;CirnoGame.MapGenerator.keyroom=CirnoGame.MapRoom.FindRoom(key.Position);this.player.invincibilitytime=180;this.camera.instawarp=!0;this.skiprender=!0;this.playing&&this.SetMusic()},SetMusic:function(){if(!this.playing){this.PlayMusic("theme3");return}var S=Bridge.Int.div(this.level,5)|0;S=S%3;this.PlayMusic("theme"+(S+1|0))},PlaceAndAddEntity:function(E){E.Position.CopyFrom(CirnoGame.MapRoom.FindAnyEmptySpot());this.AddEntity(E)},PlaceAndAddEnemy:function(E){E.Position.CopyFrom(CirnoGame.MapRoom.FindAnyEmptySpot());for(var attempts=1;E.Position.EstimatedDistance(this.player.Position)<128&&attempts<5;)console.log("Enemy spawned too close, repositioning enemy..."),E.Position.CopyFrom(CirnoGame.MapRoom.FindAnyEmptySpot()),attempts=attempts+1|0;this.AddEntity(E);this.AddEntity(E)},Update:function(){var i,E;if(CirnoGame.GameSprite.prototype.Update.call(this),this.frame=this.frame+1|0,this.generator!=null){this.frame%2==0&&this.UpdateGenerator();return}if(this.Teams=this.GamePlaySettings.GameMode.Teams,this.playing&&CirnoGame.App.IC.getPressed(5)&&!this.lastPauseButtonState&&(this.paused=!this.paused),this.lastPauseButtonState=CirnoGame.App.IC.getPressed(5),this.playing&&CirnoGame.KeyboardManager._this.TappedButtons.contains(77)&&(CirnoGame.AudioManager._this.StopAll(),this.muted=!this.muted,this.muted||this.SetMusic(),CirnoGame.KeyboardManager._this.TappedButtons.remove(77)),this.paused)this.TimerSprite.Text="Paused",this.StatsSprite.Text="Attack:"+System.Single.format(this.player.attackpower)+"  Defense:"+System.Single.format(this.player.defensepower),this.StatsSprite.Visible=!0;else{for(this.UpdateControls(),this.StatsSprite.Visible=!1,i=0;i<this.entities.Count;)E=this.entities.getItem(i),E.Alive&&E.Update(),E.Alive||(this.RemoveEntity(E),i=i-1|0),i=i+1|0;this.UpdateCollisions();this.UpdateTime();this.playing&&this.player.y<0&&this.LevelRestart()}},UpdateGenerator:function(){this.generator.generated?this.generator.finishGeneration():this.generator.Generate();this.generator.finished&&(this.generator=null,this.finalizeLevel())},LevelRestart:function(){this.level=this.level-1|0;this.StartNextLevel()},DoGameOver:function(){this.playing&&(this.entities.contains(this.player)&&this.RemoveEntity(this.player),this.playing=!1,this.StartNextLevel())},UpdateTime:function(){var $t,prefix;if(this.paused){this.TimerSprite.Text="Paused";return}if(this.timeRemaining<=0){this.timeRemaining=0;this.TimerSprite.Text="0";this.TimerSprite.TextColor="#FF0000";this.player.HP>0?this.player.HP-=.006:this.DoGameOver();return}this.TimerSprite.TextColor=this.timeRemaining<this.baseLifeCost?"#FF0000":this.timeRemaining<this.lastStand?"#FFFF00":"#FFFFFF";this.displayTimeRemaining<this.timeRemaining?(this.displayTimeRemaining+=150,this.displayTimeRemaining>=this.timeRemaining&&(this.displayTimeRemaining=this.timeRemaining)):this.displayTimeRemaining>this.timeRemaining&&(this.displayTimeRemaining-=150,this.displayTimeRemaining<=this.timeRemaining&&(this.displayTimeRemaining=this.timeRemaining));var totalseconds=this.displayTimeRemaining/1e3,totalminutes=totalseconds/60,minutes=Bridge.Int.clip32(Math.floor(totalminutes)),seconds=totalseconds-Bridge.Int.mul(minutes,60),S="";minutes>0&&(S=""+minutes+":");prefix="";seconds<10&&(prefix="0",totalseconds<10&&(prefix=" "));S=System.String.concat(S,this.RestrictLength(System.String.concat(prefix,System.Single.format(Math.max(0,seconds))),4));totalseconds>=60&&System.String.indexOf(S,".")>=0&&(S=($t=S.split("."))[System.Array.index(0,$t)]);this.TimerSprite.Text=S},RestrictLength:function(s,length){return s.length>length?s.substr(0,length):s},UpdateCollisions:function(){for(var combatants=new(System.Collections.Generic.List$1(CirnoGame.Entity).$ctor1)(System.Linq.Enumerable.from(this.combatants).where(function(entity){return entity.Ani.CurrentImage!=null&&entity.CirnoGame$ICombatant$HP>0})),harmfulEntity=new(System.Collections.Generic.List$1(CirnoGame.Entity).$ctor1)(System.Linq.Enumerable.from(this.harmful).where(function(entity){return entity.Ani.CurrentImage!=null})),R2=new CirnoGame.Rectangle,OR2=new CirnoGame.Rectangle,i=0,count=combatants.Count,spd=new CirnoGame.Vector2,spd2=new CirnoGame.Vector2,LHP,damaged,D;i<count;){var E={v:combatants.getItem(i)},EI={v:E.v},R=E.v.GetHitbox();spd.CopyFrom(E.v.Speed);spd.Multiply(.5);R2.Set(R.x-spd.X,R.y-spd.Y,R.width,R.height);for(var L=new(System.Collections.Generic.List$1(CirnoGame.Entity).$ctor1)(System.Linq.Enumerable.from(harmfulEntity).where(function($me,E,EI){return function(entity){return!Bridge.referenceEquals(entity,E.v)&&!entity.CirnoGame$IHarmfulEntity$Attacker.SameTeam(EI.v)}}(this,E,EI))),j=0,ln=L.Count;j<ln;){var tmp=L.getItem(j),HE=tmp,OR=tmp.GetHitbox();spd2.CopyFrom(tmp.Speed);spd2.Multiply(.5);OR2.Set(OR.x-spd2.X,OR.y-spd2.Y,OR.width,OR.height);(R.isTouching(OR)||R2.isTouching(OR2))&&(HE.CirnoGame$IHarmfulEntity$ontouchDamage(EI.v)&&(LHP=EI.v.CirnoGame$ICombatant$HP,EI.v.CirnoGame$ICombatant$onDamaged(HE,HE.CirnoGame$IHarmfulEntity$touchDamage),damaged=LHP>EI.v.CirnoGame$ICombatant$HP,damaged&&(Bridge.referenceEquals(EI.v,this.player)?EI.v.PlaySound("damaged"):EI.v.PlaySound("hit")),EI.v.CirnoGame$ICombatant$HP<=0&&EI.v.HandledLocally&&(D={},D.I=EI.v.ID,D.A=HE.CirnoGame$IHarmfulEntity$Attacker.ID,D.S=HE.ID,this.SendEvent("Kill",D))),this.Attack(EI.v,HE));j=j+1|0}i=i+1|0}},Attack:function(target,source){if(target.CirnoGame$ICombatant$HP>0&&source.CirnoGame$IHarmfulEntity$ontouchDamage(target)&&(target.CirnoGame$ICombatant$onDamaged(source,source.CirnoGame$IHarmfulEntity$touchDamage),target.CirnoGame$ICombatant$HP<=0&&Bridge.cast(target,CirnoGame.Entity).HandledLocally)){var D={};D.I=Bridge.cast(target,CirnoGame.Entity).ID;D.A=source.CirnoGame$IHarmfulEntity$Attacker.ID;D.S=Bridge.cast(source,CirnoGame.Entity).ID;this.SendEvent("Kill",D)}},calcdamage:function(attack,defense){attack>defense?(attack-=defense,defense=0):(defense-=attack,attack=0);var scaleslowdown=2;return attack+=scaleslowdown,defense+=scaleslowdown,attack/defense},PlaySoundEffect:function(source,sound){var dist;if(!this.muted){var vol=1,maxLength=200;if(CirnoGame.Vector2.op_Inequality(source,null)&&(dist=this.camera.Center.EstimatedDistance(source),dist-=50,dist>0)){if(dist>=maxLength)return;vol=1-dist/maxLength}CirnoGame.AudioManager._this.Blast(System.String.concat("SFX/",sound,".ogg"),vol)}},AddEntity:function(E){this.entities.add(E);Bridge.is(E,CirnoGame.ICombatant)&&this.combatants.add(E);Bridge.is(E,CirnoGame.IHarmfulEntity)&&this.harmful.add(E)},RemoveEntity:function(E){E.onRemove();this.entities.remove(E);Bridge.is(E,CirnoGame.ICombatant)&&this.combatants.remove(E);Bridge.is(E,CirnoGame.IHarmfulEntity)&&this.harmful.remove(E)},Render:function(){CirnoGame.GameSprite.prototype.Render.call(this);var g=this.spriteGraphics;if(this.generator!=null){g.globalAlpha=.125;g.fillStyle="#000000";g.fillRect(0,0,this.spriteBuffer.width,this.spriteBuffer.height);g.globalAlpha=1;g=this.EG;return}this.skiprender&&(g=this.EG,this.skiprender=!1);this.UpdateCamera();this.DrawBackground(g);g.save();this.camera.Apply(g);this.TM.Draw(g);this.entities.forEach(function(E){E.Alive&&E.Visible&&E.Draw(g)});g.restore();this.playing?this.RenderGUI(g):(g.globalAlpha=.3,g.fillStyle="#000000",g.fillRect(0,0,this.spriteBuffer.width,this.spriteBuffer.height),g.globalAlpha=1,this.TS.Draw(g),this.player.score>0&&(this.ScoreSprite.Text="Level:"+this.level+" Score:"+this.player.score,this.ScoreSprite.ForceUpdate(),this.ScoreSprite.Position.X=this.spriteBuffer.width*.98-this.ScoreSprite.spriteBuffer.width,this.ScoreSprite.Draw(g)));this.fadein>0&&(g.globalAlpha=this.fadein,g.fillStyle="#000000",g.fillRect(0,0,this.spriteBuffer.width,this.spriteBuffer.height),g.globalAlpha=1,this.fadein-=.25)},Start:function(){this.entities.contains(this.player)&&this.RemoveEntity(this.player);this.player=new CirnoGame.PlayerCharacter(this);this.AddEntity(this.player);this.playing=!0;this.level=0;this.StartNextLevel();CirnoGame.App.Div.style.cursor=null;this.totalTime=0;this.timeRemaining=this.defaultTimeRemaining;this.displayTimeRemaining=this.timeRemaining},PlayMusic:function(song){if(!this.muted){var M=CirnoGame.AudioManager._this.Get(System.String.concat("BGM/",song,".ogg"));M.IsPlaying||(CirnoGame.AudioManager._this.StopAllFromDirectory("BGM/"),M.Volume=.35,M.Loop=!0,M.Play())}},RenderGUI:function(g){var PC=this.player,color="#00DD00",border="#000000",borderalpha=.6,N,val;this.timeRemaining<this.baseLifeCost&&(color=this.timeRemaining<=0?"#CC0088":"#FF0000",PC.HP<=PC.maxHP/2&&(N=CirnoGame.Game.pulse(Bridge.Int.clip32(this.totalTime/1.7),180),borderalpha+=N/45,val=System.String.alignString(System.Int32.format(N,"X2"),-6,48),border=System.String.concat("#",val)));g.globalAlpha=.8;this.DrawGauge(g,new CirnoGame.Vector2(0,0),new CirnoGame.Vector2(Bridge.Int.div(this.spriteBuffer.width,4)|0,Bridge.Int.div(this.spriteBuffer.height,20)|0),5,PC.HP/PC.maxHP,color,!0,border,borderalpha);g.globalAlpha=1;this.TimerSprite.Draw(g);this.StatsSprite.Draw(g);this.ScoreSprite.Text="Level:"+this.level+" Score:"+this.player.score;this.ScoreSprite.ForceUpdate();this.ScoreSprite.Position.X=this.spriteBuffer.width*.98-this.ScoreSprite.spriteBuffer.width;this.ScoreSprite.Draw(g);this.RenderIcons(g)},RenderIcons:function(g){var R=Bridge.Int.div(this.Key.height,this.Key.width)|0,W=this.spriteBuffer.width*.02,H=this.spriteBuffer.height*.055,Y=H,X=W/2,i=0,sz=this.spriteBuffer.width*.0115;if(g.globalAlpha=.8,this.Door.Opened){var DA=this.BigKey,Dsz=sz*1.5,DR=Bridge.Int.div(DA.height,DA.width)|0;g.drawImage(DA,X,Y,Dsz,Dsz*R);X+=W}while(i<this.player.keys)g.drawImage(this.Key,X,Y,sz,sz*R),X+=W,i=i+1|0;g.globalAlpha=1},DrawGauge:function(g,position,size,border,progress,color,drawborder,bordercolor,borderalpha){var alpha,grd;drawborder===void 0&&(drawborder=!0);bordercolor===void 0&&(bordercolor="#000000");borderalpha===void 0&&(borderalpha=.6);alpha=g.globalAlpha;drawborder&&(g.globalAlpha=borderalpha*alpha,g.fillStyle=bordercolor,g.fillRect(position.X,position.Y,size.X,size.Y));g.fillStyle=color;g.globalAlpha=1*alpha;g.fillRect(Bridge.Int.clip32(position.X)+border|0,Bridge.Int.clip32(position.Y)+border|0,(size.X-(border+border|0))*progress,Bridge.Int.clip32(size.Y)-(border+border|0)|0);g.globalAlpha=.5*alpha;grd=g.createLinearGradient(0,0,0,size.Y);grd.addColorStop(0,color);grd.addColorStop(.4,"white");grd.addColorStop(1,color);g.fillStyle=grd;g.fillRect(Bridge.Int.clip32(position.X)+border|0,Bridge.Int.clip32(position.Y)+border|0,(size.X-(border+border|0))*progress,Bridge.Int.clip32(size.Y)-(border+border|0)|0);g.globalAlpha=alpha},SendEvent:function(eventName,data,triggerflush){triggerflush===void 0&&(triggerflush=!1);var D={};D.E=eventName;D.D=data;this.ProcessEvent(D)},ProcessEvent:function(msg,user,latency){var D,evt,entity,attacker,PC;if(user===void 0&&(user=null),latency===void 0&&(latency=0),D=msg.D,evt=msg.E,Bridge.referenceEquals(evt,"Kill")&&(entity=this.EntityFromID(D.I),entity!=null&&(attacker=this.EntityFromID(D.A),Bridge.cast(entity,CirnoGame.ICombatant).CirnoGame$ICombatant$onDeath(this.EntityFromID(D.S)),attacker!=null&&Bridge.is(attacker,CirnoGame.PlayerCharacter)))){PC=Bridge.cast(attacker,CirnoGame.PlayerCharacter);PC.score=PC.score+Bridge.cast(entity,CirnoGame.ICombatant).CirnoGame$ICombatant$PointsForKilling|0;PC.onKill(Bridge.cast(entity,CirnoGame.ICombatant))}},EntityFromID:function(ID){for(var i=0,E;i<this.entities.Count;){if(E=this.entities.getItem(i),Bridge.referenceEquals(E.ID,ID))return E;i=i+1|0}return null},UpdateCamera:function(){var $t,$t1,spd,PB,CC,CC1,TEST,T,HB;if(this.camera.speedmod=1,this.freecam){spd=16/this.camera.Scale;PB=CirnoGame.KeyboardManager._this.PressedButtons;CirnoGame.HelperExtensions.ContainsB$1(System.Int32,PB,Bridge.box(100,System.Int32))&&(this.camera.TargetPosition.X-=spd);CirnoGame.HelperExtensions.ContainsB$1(System.Int32,PB,Bridge.box(102,System.Int32))&&(this.camera.TargetPosition.X+=spd);CirnoGame.HelperExtensions.ContainsB$1(System.Int32,PB,Bridge.box(104,System.Int32))&&(this.camera.TargetPosition.Y-=spd);CirnoGame.HelperExtensions.ContainsB$1(System.Int32,PB,Bridge.box(98,System.Int32))&&(this.camera.TargetPosition.Y+=spd);CirnoGame.HelperExtensions.ContainsB$1(System.Int32,PB,Bridge.box(107,System.Int32))&&(CC=this.camera.Center,this.camera.Scale*=1.01,this.camera.Center=CC,this.camera.TargetPosition.X=this.camera.Position.X,this.camera.TargetPosition.Y=this.camera.Position.Y);CirnoGame.HelperExtensions.ContainsB$1(System.Int32,PB,Bridge.box(109,System.Int32))&&(CC1=this.camera.Center,this.camera.Scale*=.99,this.camera.Center=CC1,this.camera.TargetPosition.X=this.camera.Position.X,this.camera.TargetPosition.Y=this.camera.Position.Y);CirnoGame.HelperExtensions.ContainsB$1(System.Int32,PB,Bridge.box(36,System.Int32))&&(this.camera.CenteredTargetPosition=this.player.Position);CirnoGame.HelperExtensions.ContainsB$1(System.Int32,PB,Bridge.box(13,System.Int32))&&(this.player.Position.X=this.camera.Center.X,this.player.Position.Y=this.camera.Center.Y);this.camera.Update();return}if(!this.playing){this.camera.speedmod=.05;(CirnoGame.Vector2.op_Equality(this.camera.TargetPosition,null)||this.camera.Position.EstimatedDistance(this.camera.TargetPosition)<40)&&(Math.random()<.0035||this.camera.instawarp)&&(this.camera.CenteredTargetPosition=CirnoGame.MapRoom.FindAnyEmptySpot());this.camera.Update();return}if(this.freecam&&(CirnoGame.KeyboardManager._this.PressedButtons.contains(101)||CirnoGame.KeyboardManager._this.PressedButtons.contains(111))){if(TEST=CirnoGame.RoomOpeningLever.TEST,CirnoGame.KeyboardManager._this.PressedButtons.contains(106)&&!TEST.Activated&&TEST.Activate(),TEST!=null){TEST.Activated||CirnoGame.KeyboardManager._this.PressedButtons.contains(111)?(T=this.TM.GetTile(TEST.Room.SX,TEST.Room.SY),HB=T.GetHitbox(),this.camera.CenteredTargetPosition=new CirnoGame.Vector2(HB.left,HB.top)):this.camera.CenteredTargetPosition=TEST.Position;CirnoGame.KeyboardManager._this.TappedButtons.contains(32)&&(this.player.Position.X=this.camera.Center.X,this.player.Position.Y=this.camera.Center.Y);this.camera.Update();return}this.player.MSG.ChangeText("No lever on map")}if(!(this.player.HP<0)){var D=this.player.Hspeed*32,lookAheadRate=.3,H=this.camera.CameraBounds.width/8;D+=this.player.Ani.Flipped?-H:H;var C=CirnoGame.App.Canvas,IS=this.camera.InvScale,V=Math.max(0,this.player.Vspeed*30);($t=this.player.Controller)[System.Array.index(2,$t)]?V-=this.camera.CameraBounds.height/3:($t1=this.player.Controller)[System.Array.index(3,$t1)]?V+=this.camera.CameraBounds.height/3:this.player.onGround?V-=this.camera.CameraBounds.height/10:V+=this.camera.CameraBounds.height/12;var TP=this.camera.TargetPosition,X=this.player.x+this.player.Width/2+D*lookAheadRate,Y=this.player.y+this.player.Height/2+V*lookAheadRate;this.camera.CenteredTargetPosition=new CirnoGame.Vector2(X,Y);this.camera.Update()}},DrawBackground:function(g){g.fillStyle="#77AAFF";g.fillRect(0,0,CirnoGame.App.Canvas.width,CirnoGame.App.Canvas.height)},UpdateControls:function(){var PC=this.player,threshhold=.7,C=PC.Controller,IC=CirnoGame.App.IC,x,y,cid,aim,o;IC!=null&&(x=IC.getState(0),y=IC.getState(1),C[System.Array.index(0,C)]=x<=-threshhold,C[System.Array.index(1,C)]=x>=threshhold,C[System.Array.index(2,C)]=y<=-threshhold,C[System.Array.index(3,C)]=y>=threshhold,cid=IC.getMapControllerID$1(5),Bridge.referenceEquals(cid,"Keyboard")||Bridge.referenceEquals(cid,"Mouse")?(C[System.Array.index(4,C)]=IC.getPressed(2),C[System.Array.index(5,C)]=IC.getPressed(3),C[System.Array.index(6,C)]=IC.getPressed(4)):(aim=new CirnoGame.Vector2(IC.getState(4),IC.getState(5)),aim.RoughLength>.5),C[System.Array.index(4,C)]=IC.getPressed(2),C[System.Array.index(5,C)]=IC.getPressed(3),C[System.Array.index(6,C)]=IC.getPressed(4),o={})}}});Bridge.define("CirnoGame.HealingItem",{inherits:[CirnoGame.CollectableItem],fields:{healingPower:0},ctors:{init:function(){this.healingPower=2.5},ctor:function(game){this.$initialize();CirnoGame.CollectableItem.ctor.call(this,game,"heart");this.floats=!1;this.magnetDistance=20;this.sound="ok"}},methods:{CanCollect:function(player){return player.HP<player.maxHP},onCollected:function(player){player.HP=Math.min(player.HP+this.healingPower,player.maxHP)}}});Bridge.define("CirnoGame.KeyItem",{inherits:[CirnoGame.CollectableItem],ctors:{ctor:function(game){this.$initialize();CirnoGame.CollectableItem.ctor.call(this,game,"key");this.floats=!1;this.magnetDistance=20;this.sound="smallkey"}},methods:{CanCollect:function(player){return player.keys<5},onCollected:function(player){player.keys=player.keys+1|0}}});Bridge.define("CirnoGame.PlatformerEntity",{inherits:[CirnoGame.ControllableEntity],fields:{friction:0,onGround:!1,GravityEnabled:!1,gravity:0,maxFallSpeed:0,feetposition:0,headposition:0,Floor:null,Ceiling:null,LeftWall:null,RightWall:null},ctors:{init:function(){this.friction=.5;this.GravityEnabled=!0;this.gravity=.02;this.maxFallSpeed=2;this.feetposition=23;this.headposition=7},ctor:function(game){this.$initialize();CirnoGame.ControllableEntity.ctor.call(this,game)}},methods:{Update:function(){if(CirnoGame.ControllableEntity.prototype.Update.call(this),this.GravityEnabled&&this.Vspeed<this.maxFallSpeed&&this.GravityEnabled&&(this.Vspeed=Math.min(this.Vspeed+this.gravity,this.maxFallSpeed)),this.ApplyFriction(),this.UpdateTerrainCollision(),this.onGround=this.Floor!=null&&this.Vspeed>=0,this.onGround){var Y=this.Floor.GetTop(this.getCenter())-this.feetposition;this.y=Y;this.Vspeed=0;this.onGround=!0}this.Ceiling!=null&&this.Vspeed<0&&(this.Vspeed=0,this.y=this.Ceiling.row*this.Game.TM.tilesize+this.Game.TM.position.Y+this.Game.TM.tilesize-this.headposition);this.LeftWall!=null&&(this.Hspeed=Math.max(0,this.Hspeed));this.RightWall!=null&&(this.Hspeed=Math.min(0,this.Hspeed))},ApplyFriction:function(){this.Hspeed=CirnoGame.MathHelper.Decelerate(this.Hspeed,this.friction);this.GravityEnabled||(this.Vspeed=CirnoGame.MathHelper.Decelerate(this.Vspeed,this.friction))},GetFloor:function(){var T=null,W=this.Width/3,Y=this.Height;return T!=null&&T.enabled&&T.topSolid||(T=this.Game.TM.CheckForTile(CirnoGame.Vector2.Add$1(this.Position,this.Width/2,Y))),T!=null&&T.enabled&&T.topSolid||(T=this.Game.TM.CheckForTile(CirnoGame.Vector2.Add$1(this.Position,W,Y))),T!=null&&T.enabled&&T.topSolid||(T=this.Game.TM.CheckForTile(CirnoGame.Vector2.Add$1(this.Position,this.Width-W,Y))),T!=null&&T.enabled&&T.topSolid||(T=null),T},GetCeiling:function(){var T=null,W=this.Width/3,Y=0+this.headposition;return T!=null&&T.enabled&&T.bottomSolid||(T=this.Game.TM.CheckForTile(CirnoGame.Vector2.Add$1(this.Position,W,Y))),T!=null&&T.enabled&&T.bottomSolid||(T=this.Game.TM.CheckForTile(CirnoGame.Vector2.Add$1(this.Position,this.Width-W,Y))),T!=null&&T.enabled&&T.bottomSolid||(T=null),T},CheckWall:function(X){var T=null;return this.IsTileObstacle(T,X)||(T=this.Game.TM.CheckForTile(CirnoGame.Vector2.Add$1(this.Position,X,this.Height/2-2))),this.IsTileObstacle(T,X)||(T=this.Game.TM.CheckForTile(CirnoGame.Vector2.Add$1(this.Position,X,this.Height-2))),this.IsTileObstacle(T,X)||(T=null),T},IsTileObstacle:function(T,X){if(T!=null&&T.enabled&&(T.leftSolid&&X>0||T.rightSolid&&X<0)&&(this.Floor==null||T.row<this.Floor.row)){var Y=this.y+this.Height;if(T.GetHitbox().y<+Y)return!T.IsSlope}return!1},UpdateTerrainCollision:function(){var stuck,c,T,Y,wall,W,X,R,V;if(this.Floor=this.GetFloor(),this.Ceiling=this.GetCeiling(),this.Floor!=null&&this.Floor.SteppedOn&&this.Floor.SteppedOn(this),this.Vspeed<this.maxFallSpeed&&this.GravityEnabled&&(this.Vspeed=Math.min(this.Vspeed+this.gravity,this.maxFallSpeed)),stuck=!1,this.Floor!=null)for(c=!0;c;)T=this.Floor.GetTileData(0,-1),T!=null&&T.enabled&&T.solid?(this.Floor=T,stuck=!0):c=!1;stuck=!1;this.onGround=!1;this.Floor!=null&&this.Vspeed>=0&&(Y=this.Floor.GetTop(this.getCenter())-this.Height,(!this.Floor.platform||this.y<=Y+this.Vspeed)&&this.y+(this.Vspeed+10)>=Y&&(this.Vspeed>0&&(this.Vspeed=0,this.onGround=!0),this.y=Y));this.Hspeed!==0&&(wall=this.Hspeed>0?this.RightWall:this.LeftWall,wall!=null&&(this.Hspeed=0));W=this.Width/3;X=Math.abs(this.Hspeed);this.Hspeed<0?X-=2-W:X+=this.Width-W+2;this.RightWall=this.CheckWall(X);X=-Math.abs(this.Hspeed);this.Hspeed<0?X-=2-W:X+=this.Width-W+2;this.LeftWall=this.CheckWall(X);this.LeftWall!=null&&Bridge.referenceEquals(this.LeftWall,this.RightWall)&&(R=this.LeftWall.GetHitbox(),V=R.Center,CirnoGame.Vector2.op_Subtraction(V,this.Position).X>0?(this.x+=1,this.Hspeed<0&&(this.Hspeed=0)):(this.x-=1,this.Hspeed>0&&(this.Hspeed=0)));stuck&&this.UpdateTerrainCollision()}}});Bridge.define("CirnoGame.Orb",{inherits:[CirnoGame.CollectableItem],ctors:{ctor:function(game){this.$initialize();CirnoGame.CollectableItem.ctor.call(this,game,"orb");this.magnetDistance=55;this.sound="timeorb"}},methods:{onCollected:function(){var time=1e3*(13-Math.min(this.Game.level-.15,7));time+=250;this.Game.timeRemaining>0?(this.Game.timeRemaining+=time,this.Game.timeRemaining=Math.min(this.Game.defaultTimeRemaining,this.Game.timeRemaining)):this.Game.timeRemaining+=time}}});Bridge.define("CirnoGame.PointItem",{inherits:[CirnoGame.CollectableItem],ctors:{ctor:function(game){this.$initialize();CirnoGame.CollectableItem.ctor.call(this,game,"point");this.floats=!1;this.magnetDistance=70;this.magnetSpeed*=8}},methods:{onCollected:function(player){player.score=player.score+5|0}}});Bridge.define("CirnoGame.MRGhosty",{inherits:[CirnoGame.PlatformerEntity,CirnoGame.ICombatant,CirnoGame.IHarmfulEntity],fields:{animation:null,attackpower:0,defensepower:0},props:{Team:0,HP:0,PointsForKilling:{get:function(){return 1}},TargetPriority:{get:function(){return.5}},IsHarmful:{get:function(){return!0}},Attacker:{get:function(){return this}},touchDamage:{get:function(){return this.attackpower*1.5}}},alias:["Team","CirnoGame$ICombatant$Team","HP","CirnoGame$ICombatant$HP","PointsForKilling","CirnoGame$ICombatant$PointsForKilling","TargetPriority","CirnoGame$ICombatant$TargetPriority","IsHarmful","CirnoGame$IHarmfulEntity$IsHarmful","Attacker","CirnoGame$IHarmfulEntity$Attacker","touchDamage","CirnoGame$IHarmfulEntity$touchDamage","onDamaged","CirnoGame$ICombatant$onDamaged","onDeath","CirnoGame$ICombatant$onDeath","onKill","CirnoGame$ICombatant$onKill","ontouchDamage","CirnoGame$IHarmfulEntity$ontouchDamage"],ctors:{init:function(){this.animation="???";this.attackpower=1;this.defensepower=1},ctor:function(game){this.$initialize();CirnoGame.PlatformerEntity.ctor.call(this,game);this.ChangeAni("");this.AddBehavior$1(new CirnoGame.FlightControls(this));this.AddBehavior$1(new CirnoGame.RandomAI(this));this.attackpower=1+this.Game.level*.55;this.defensepower=1+this.Game.level*.55;this.Game.playing&&(this.AddBehavior(CirnoGame.AimedShooter),this.GetBehavior(CirnoGame.AimedShooter).attackpower=this.attackpower,this.GetBehavior(CirnoGame.AimedShooter).maxtime=Math.max(480-Bridge.Int.mul(this.Game.level,10)|0,380));this.GetBehavior(CirnoGame.FlightControls).maxSpeed*=.5;this.GravityEnabled=!1;this.Team=2;this.HP=2}},methods:{Update:function(){CirnoGame.PlatformerEntity.prototype.Update.call(this);this.Ani.Flipped=this.Hspeed<0;this.Ani.ImageSpeed=(Math.abs(this.Hspeed)+Math.abs(this.Vspeed))*.125},ChangeAni:function(animation,reset){(reset===void 0&&(reset=!1),Bridge.referenceEquals(this.animation,animation))||(this.Ani==null?this.Ani=new CirnoGame.Animation(CirnoGame.AnimationLoader.Get(System.String.concat("images/enemies/mrghost",animation))):this.Ani.ChangeAnimation(CirnoGame.AnimationLoader.Get(System.String.concat("images/enemies/mrghost",animation)),reset),this.animation=animation)},onDamaged:function(source,amount){this.HP-=this.Game.calcdamage(amount,this.defensepower)},onDeath:function(){this.Alive=!1;var P=new CirnoGame.PointItem(this.Game);P.Position.CopyFrom(this.Position);P.collectionDelay=Bridge.Int.div(P.collectionDelay,2)|0;this.Game.AddEntity(P);Math.random()<.15&&(P=new CirnoGame.HealingItem(this.Game),P.Position.CopyFrom(this.Position),P.Vspeed=-2,P.collectionDelay=Bridge.Int.div(P.collectionDelay,2)|0,this.Game.AddEntity(P))},onKill:function(){},ontouchDamage:function(){return!0}}});Bridge.define("CirnoGame.PlayerCharacter",{inherits:[CirnoGame.PlatformerEntity,CirnoGame.ICombatant],fields:{animation:null,shoottime:0,prefix:null,newInput:!1,tapTimer:null,shootRecharge:0,turntime:0,score:0,orbs:0,keys:0,energyRecharge:0,maxEnergy:0,energy:0,maxHP:0,regenRate:0,SpawnLocation:null,lives:0,frame:0,digpower:0,attackpower:0,defensepower:0,invincibilitytime:0,blockprice:0,invincibilitymod:0,currentshot:0,shotdelay:0,currentshotdelay:0,totalshots:0,MSG:null},props:{Team:0,HP:0,PointsForKilling:{get:function(){return 300}},TargetPriority:{get:function(){return.7}}},alias:["Team","CirnoGame$ICombatant$Team","HP","CirnoGame$ICombatant$HP","PointsForKilling","CirnoGame$ICombatant$PointsForKilling","TargetPriority","CirnoGame$ICombatant$TargetPriority","onDamaged","CirnoGame$ICombatant$onDamaged","onDeath","CirnoGame$ICombatant$onDeath","onKill","CirnoGame$ICombatant$onKill"],ctors:{init:function(){this.animation="???";this.shoottime=0;this.prefix="";this.shootRecharge=0;this.turntime=0;this.score=0;this.orbs=0;this.keys=0;this.energyRecharge=.026;this.maxEnergy=4;this.energy=4;this.maxHP=20;this.regenRate=1;this.SpawnLocation=new CirnoGame.Vector2;this.lives=3;this.frame=0;this.digpower=1;this.attackpower=1;this.defensepower=1;this.invincibilitytime=0;this.blockprice=3;this.invincibilitymod=1;this.currentshot=0;this.shotdelay=5;this.currentshotdelay=0;this.totalshots=1},ctor:function(game){this.$initialize();CirnoGame.PlatformerEntity.ctor.call(this,game);this.ChangeAni("stand");this.AddBehavior(CirnoGame.PlatformerControls);this.tapTimer=System.Array.init(this.Controller.length,0,System.Int32);this.Team=0;this.HP=this.maxHP;this.MSG=new CirnoGame.FloatingMessage(game,"");this.MSG.Text.TextColor="#FFFFFF";this.MSG.autokill=!1;game.AddEntity(this.MSG);this.MSG.RemovedOnLevelEnd=!1;this.RemovedOnLevelEnd=!1}},methods:{MoveToNewSpawn:function(NewSpawnLocation){this.SpawnLocation.CopyFrom(NewSpawnLocation);this.Position.CopyFrom(this.SpawnLocation)},shoot:function(){this.energy<1||(this.shoottime<1&&(this.prefix="s",this.ChangeAni(System.String.concat(this.prefix,this.animation))),this.shootRecharge<=0&&(this.currentshot=1,this.DoShot(),this.energy-=1,this.currentshotdelay=0,this.shootRecharge=16),this.shoottime=50,this.turntime=0)},DoShot:function(){var PB=new CirnoGame.PlayerBullet(this.Game,this,"Images/misc/crystal");PB.Hspeed=this.Ani.Flipped?-2.5:2.5;PB.x=this.x+(this.Ani.Flipped?-4:12);PB.y=this.y+10;this.Controller[System.Array.index(0,this.Controller)]||this.Controller[System.Array.index(1,this.Controller)]?this.Controller[System.Array.index(2,this.Controller)]?(PB.Hspeed*=.9,PB.Vspeed=-Math.abs(PB.Hspeed*.7)):this.Controller[System.Array.index(3,this.Controller)]&&(PB.Hspeed*=.9,PB.Vspeed=Math.abs(PB.Hspeed*.7)):this.Controller[System.Array.index(2,this.Controller)]?(PB.Hspeed*=.8,PB.Vspeed=-Math.abs(PB.Hspeed),PB.Hspeed*=.6):this.Controller[System.Array.index(3,this.Controller)]&&(PB.Hspeed*=.8,PB.Vspeed=Math.abs(PB.Hspeed),PB.Hspeed*=.6);PB.x-=PB.Hspeed;PB.y-=PB.Vspeed;PB.attacksterrain=this.currentshot===1;PB.digpower=this.digpower*.6667;PB.touchDamage=this.attackpower/((this.totalshots-1)/2+1);this.Game.AddEntity(PB)},Update:function(){CirnoGame.PlatformerEntity.prototype.Update.call(this);this.MSG.Position.X=this.Position.X;this.MSG.Position.Y=this.Position.Y-10;this.shoottime>0&&(this.shoottime=this.shoottime-1|0,this.shoottime<1&&(Bridge.referenceEquals(""+String.fromCharCode(this.animation.charCodeAt(0)),this.prefix)&&this.ChangeAni(this.animation.substr(1)),this.prefix=""));this.onGround?(this.Hspeed!==0?this.ChangeAni(System.String.concat(this.prefix,"walk")):this.ChangeAni(System.String.concat(this.prefix,"stand")),this.Ani.ImageSpeed=Math.abs(this.Hspeed*.125)):(this.ChangeAni(System.String.concat(this.prefix,"jump")),this.Ani.ImageSpeed=.15+(Math.abs(this.Hspeed)+Math.abs(this.Vspeed))*.7);this.turntime=this.Ani.Flipped!==this.Hspeed<0||this.Hspeed===0&&this.onGround?this.turntime+1|0:0;this.currentshot<this.totalshots?(this.currentshotdelay=this.currentshotdelay+1|0,this.currentshotdelay>=this.shotdelay&&(this.currentshotdelay=0,this.currentshot=this.currentshot+1|0,this.DoShot())):(this.shootRecharge>0&&(this.shootRecharge=this.shootRecharge-1|0),this.energy=Math.min(this.energy+this.energyRecharge,this.maxEnergy));this.Controller[System.Array.index(4,this.Controller)]&&(this.turntime=0);this.Controller[System.Array.index(4,this.Controller)]&&this.shoot();this.Pressed(6)&&this.PlaceBlock();this.UpdateController();this.turntime>8&&this.Hspeed!==0&&(this.Ani.Flipped=this.Hspeed<0);this.invincibilitytime>0?((this.frame&1)>0&&(this.Visible=!this.Visible),this.invincibilitytime-=1):this.Visible=!0;this.HP<10?(this.Ani.Alpha=CirnoGame.Game.pulse(this.frame,50)/50+.15+this.HP*.1,this.Ani.HueRecolorStrength=.4,this.Ani.HueColor=this.Ani.Alpha<.85?"#CC0000":""):(this.Ani.Alpha=1,this.Ani.HueColor="");this.frame=this.frame+1|0},PlaceBlock:function(){var price=1e3*this.blockprice;if(!(this.Game.timeRemaining<this.blockprice)){var W=this.Width/3,Y=this.Height,T=this.Game.TM.CheckForTile(CirnoGame.Vector2.Add$1(this.Position,this.Width/2,Y));T==null||T.enabled&&T.solid||(T.solid=!0,T.Breakable=!0,T.enabled=!0,T.texture=4,T.CanSlope=!1,T.UpdateTile(),T.HP=T.maxHP*2,this.Game.timeRemaining-=price)}},ChangeAni:function(animation,reset){(reset===void 0&&(reset=!1),Bridge.referenceEquals(this.animation,animation))||(this.Ani==null?this.Ani=new CirnoGame.Animation(CirnoGame.AnimationLoader.Get(System.String.concat("images/cirno/",animation))):this.Ani.ChangeAnimation(CirnoGame.AnimationLoader.Get(System.String.concat("images/cirno/",animation)),reset),Bridge.referenceEquals(this.animation,"stand")||(this.turntime=0),this.animation=animation)},UpdateController:function(){this.newInput=!1;for(var i=0;i<this.Controller.length;)this.tapTimer[System.Array.index(i,this.tapTimer)]=this.tapTimer[System.Array.index(i,this.tapTimer)]+1|0,this.Controller[System.Array.index(i,this.Controller)]&&!this.LController[System.Array.index(i,this.LController)]&&(this.tapTimer[System.Array.index(i,this.tapTimer)]=0,this.newInput=!0),this.LController[System.Array.index(i,this.LController)]=this.Controller[System.Array.index(i,this.Controller)],i=i+1|0;this.newInput},onDamaged:function(source,amount){this.invincibilitytime<=0&&(this.HP-=this.Game.calcdamage(amount,this.defensepower),this.invincibilitytime=50*this.invincibilitymod)},onRemove:function(){CirnoGame.PlatformerEntity.prototype.onRemove.call(this);this.Game.RemoveEntity(this.MSG)},onDeath:function(){this.invincibilitytime*=3;Bridge.referenceEquals(this.Game.player,this)?this.Game.timeRemaining>=this.Game.baseLifeCost?(this.Position.CopyFrom(this.SpawnLocation),this.HP=this.maxHP,this.Game.timeRemaining-=this.Game.baseLifeCost,this.Game.camera.instawarp=!0,this.Game.skiprender=!0):this.Game.DoGameOver():(this.Position.CopyFrom(this.SpawnLocation),this.HP=this.maxHP)},onKill:function(){},GetHitbox:function(){return this.Ani!=null&&this.Ani.CurrentImage!=null?new CirnoGame.Rectangle(this.Ani.X+this.Ani.CurrentImage.width/2,this.Ani.Y+this.Ani.CurrentImage.height/2,1,1):null}}})});
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAiZmlsZSI6ICJDaXJub0dhbWUubWluLmpzIiwKICAic291cmNlUm9vdCI6ICIiLAogICJzb3VyY2VzIjogW10sCiAgIm5hbWVzIjogW10sCiAgIm1hcHBpbmdzIjogIiIsCiAgInNvdXJjZXNDb250ZW50IjogW10KfQo=
